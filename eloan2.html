<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Loan Management</title>
    
    <script>
        // Set dark mode preference if needed
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        #confirmModal {
            z-index: 1060; /* This ensures the confirmation dialog is always on top */
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 1050; /* Changed from 50 to 1050 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal {
            max-height: 90vh;
            overflow-y: auto;
        }
        .filter-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        @media print {
            body * { visibility: hidden; }
            #receiptModal, #receiptModal * { visibility: visible; }
            #receiptModal { position: absolute; left: 0; top: 0; width: 100%; }
        }
        .loan-details-card {
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .dark .loan-details-card {
             background-color: rgba(0, 0, 0, 0.2);
             border: 1px solid rgba(255,255,255,0.1);
        }
        #tableViewModal .modal {
            max-width: 90%;
        }
        .sortable-header {
            cursor: pointer;
        }
        .sortable-header:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .dark .sortable-header:hover {
             background-color: rgba(255,255,255,0.05);
        }
        .collapsible-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .borrower-card.expanded .collapsible-body {
            max-height: 10000px; /* Large enough to fit content */
            transition: max-height 0.5s ease-in;
        }
        .chevron-icon {
            transition: transform 0.3s;
        }
        .borrower-card.expanded .chevron-icon {
            transform: rotate(180deg);
        }
        /* --- NEW: Timeline styles for payment history --- */
        .payment-timeline {
            position: relative;
            padding-left: 20px;
        }
        .payment-timeline::before {
            content: '';
            position: absolute;
            left: 5px;
            top: 5px;
            bottom: 5px;
            width: 2px;
            background-color: #cbd5e1; /* gray-300 */
        }
        .dark .payment-timeline::before {
            background-color: #4b5563; /* gray-600 */
        }
        .timeline-item {
            position: relative;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 9999px;
            background-color: #fff;
            border: 2px solid #6366f1; /* indigo-500 */
        }
        .dark .timeline-item::before {
            background-color: #1f2937; /* gray-800 */
        }
        .timeline-item:last-child::after {
             content: '';
             position: absolute;
             left: -20px;
             bottom: -5px; /* Adjust to align with the line */
             width: 12px;
             height: 12px;
             border-radius: 9999px;
             background-color: #10b981; /* emerald-500 */
             border: 2px solid #fff;
        }
        /* --- NEW: Spinner Styles --- */
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loading-button .button-text {
            display: none;
        }
        .loading-button .spinner-icon {
            display: inline-block;
        }
        .spinner-icon {
             display: none;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-800">
        <div class="max-w-md w-full bg-white dark:bg-gray-700 p-8 rounded-xl shadow-lg text-center">
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-2">
                Smart Loan Tracker
            </h2>
            <p class="mb-6 text-gray-600 dark:text-gray-300">Please sign in to continue</p>
            <button id="googleSignInButton" class="w-full inline-flex justify-center items-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 174 58.4l-62.5 62.5C338.3 99.9 294.9 88 248 88c-88.3 0-160 71.7-160 160s71.7 160 160 160c92.6 0 145.5-68.2 149.9-105.5H248V256h239.8c1.3 7.8 2.2 15.6 2.2 23.8z"></path></svg>
                <span class="button-text">Sign in with Google</span>
                <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
        </div>
    </div>

    <div id="mainApp" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl hidden">

        <header class="bg-white dark:bg-gray-800 shadow-md rounded-xl p-6 mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Smart Loan Tracker</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage product and money loans with interest calculation.</p>
                </div>
                <div class="flex items-center mt-4 sm:mt-0 flex-wrap gap-2">
                     <button id="tableViewButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Table View</button>
                     <button id="settingsButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Settings</button>
                     <button id="manageLoanerButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-lg hidden">Manage Loaners</button>
                     <button id="howItWorksButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">How It Works</button>
                     <button id="importButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Import CSV</button>
                     <button id="exportButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Export CSV</button>
                    <div class="text-sm text-gray-600 dark:text-gray-300 text-right">
                        <span class="font-semibold">Logged in as:</span>
                        <span id="loggedInUser" class="break-all"></span>
                    </div>
                    <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Logout</button>
                </div>
            </div>
        </header>

        <div id="notificationArea" class="mb-8 space-y-2"></div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-8">
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md">
                    <button id="addNewLoanerButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md shadow-lg">
                         <span class="button-text">ADD NEW LOAN</span>
                        <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-center border-b dark:border-gray-700 pb-4 mb-5">
                        <h2 class="text-2xl font-semibold">Summary & Profits</h2>
                         <div id="summaryFilterButtons" class="flex space-x-1 mt-4 sm:mt-0">
                            <button data-filter="weekly" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Weekly</button>
                            <button data-filter="monthly" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Monthly</button>
                            <button data-filter="custom" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Custom</button>
                        </div>
                    </div>
                    <div id="summaryDateRange" class="hidden flex items-center space-x-2 mb-4">
                        <input type="date" id="startDate" class="text-xs p-1 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                        <span>to</span>
                        <input type="date" id="endDate" class="text-xs p-1 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                    </div>
                    <div id="summaryContent" class="space-y-3 text-sm">
                        <div class="flex justify-between"><span>Principal:</span> <span id="totalPrincipal" class="font-medium">₱0.00</span></div>
                        <div class="flex justify-between"><span>Interest:</span> <span id="totalInterest" class="font-medium text-blue-600">₱0.00</span></div>
                        <div class="flex justify-between"><span>Penalty:</span> <span id="totalPenalties" class="font-medium text-orange-600 dark:text-orange-500">₱0.00</span></div>
                        <div class="flex justify-between font-bold border-t dark:border-gray-700 pt-2"><span>Total Potential Profit:</span> <span id="totalProfit" class="text-green-600">₱0.00</span></div>
                        <div class="flex justify-between mt-4"><span>Active Loans:</span> <span id="activeLoans" class="font-medium">0</span></div>
                        <div class="flex justify-between"><span>Completed Loans:</span> <span id="completedLoans" class="font-medium">0</span></div>
                    </div>
                    <div class="mt-6">
                        <canvas id="loanTypeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
               <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mb-8">
                    <h2 class="text-2xl font-semibold border-b dark:border-gray-700 pb-4 mb-5">My Activity</h2>
                    <div id="activityContent" class="space-y-3 text-sm">
                        <div class="flex justify-between"><span>Loans Created:</span> <span id="loansCreated" class="font-medium">0</span></div>
                        <div class="flex justify-between"><span>Payments Recorded:</span> <span id="paymentsRecorded" class="font-medium">0</span></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <div class="border-b dark:border-gray-700 pb-4 mb-5">
                        <div class="flex flex-col sm:flex-row justify-between items-center">
                             <h2 class="text-2xl font-semibold">Borrower Records</h2>
                             <div class="mt-4 sm:mt-0">
                                <input type="text" id="searchLoaner" placeholder="Search by name..." class="w-full sm:w-auto px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm dark:bg-gray-700">
                            </div>
                        </div>
                        <div id="filterButtons" class="flex flex-wrap gap-2 mt-4">
                            <button data-filter="all" class="filter-btn active px-3 py-1 rounded-md text-sm">All</button>
                            <button data-filter="active" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Active</button>
                            <button data-filter="due" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Due Today</button>
                            <button data-filter="due-tomorrow" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Due Tomorrow</button>
                            <button data-filter="overdue" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">With Penalty</button>
                            <button data-filter="paid" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Paid</button>
                            <button data-filter="Product" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Product</button>
                            <button data-filter="E-Loan" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">E-Loan</button>
                            <button data-filter="Long Term E-Loan" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Long Term</button>
                        </div>
                    </div>
                    <div id="borrowerList" class="space-y-2">
                        <p id="loadingMessage" class="text-center text-gray-500 dark:text-gray-400 py-8">Please log in to see records.</p>
                    </div>
                    <div id="paginationControls" class="flex justify-center items-center mt-6 space-x-2"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="alertModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-sm m-4">
            <div class="p-6">
                <h3 id="alertTitle" class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Alert</h3>
                <div class="mt-2"><p id="alertMessage" class="text-sm text-gray-500 dark:text-gray-400">Your message here.</p></div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="alertOkButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    <span class="button-text">OK</span>
                    <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 id="confirmTitle" class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Confirmation</h3>
                        <div class="mt-2"><p id="confirmMessage" class="text-sm text-gray-500 dark:text-gray-400">Are you sure?</p></div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmOkButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    <span class="button-text">Confirm</span>
                    <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <button type="button" id="confirmCancelButton" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <div id="existingBorrowerModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4c0-1.193.52-2.267 1.343-3.072M9 17a9 9 0 100-14 9 9 0 000 14z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Existing Borrower Found</h3>
                        <div class="mt-2">
                            <p id="existingBorrowerMessage" class="text-sm text-gray-500 dark:text-gray-400">A borrower with this name already exists. How would you like to proceed?</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-3">
                <button type="button" id="addToExistingButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:w-auto sm:text-sm">
                    <span class="button-text">Add to Existing Record</span>
                    <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <button type="button" id="addAsNewButton" class="mt-3 sm:mt-0 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none sm:w-auto sm:text-sm">
                     <span class="button-text">Create New Borrower</span>
                    <svg class="spinner-icon w-5 h-5 text-gray-700 dark:text-gray-300 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                 <button type="button" id="existingBorrowerCancelButton" class="mt-3 sm:mt-0 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <div id="addLoanModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                 <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Add New Loan</h3>
                     <button id="closeAddLoanButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <form id="addLoanForm" class="space-y-4"></form>
            </div>
        </div>
    </div>
    
    <div id="editLoanModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                 <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Edit Loan</h3>
                     <button id="closeEditLoanButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <form id="editLoanForm" class="space-y-4"></form>
            </div>
        </div>
    </div>

    <div id="manageLoanerModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-3xl m-4">
            <div class="p-6">
                <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Manage Loaners</h3>
                     <button id="closeManageLoanerButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <input type="text" id="manageLoanerSearch" placeholder="Search by name..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700">
                    </div>
                    <div id="loanerListContainer" class="space-y-2">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loanerHistoryModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-2xl m-4">
            <div class="p-6">
                <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white" id="loanerHistoryTitle">Loan History</h3>
                     <button id="closeLoanerHistoryButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-md mb-4">
                     <h4 class="text-lg font-medium text-gray-900 dark:text-white">Loan Score: <span id="loanScoreValue" class="font-bold">N/A</span></h4>
                     <button id="resetLoanScoreBtn" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-md transition">Reset Score</button>
                </div>
                <div id="loanerHistoryLog" class="space-y-4">
                    </div>
            </div>
        </div>
    </div>
    
     <div id="editLoanerModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                 <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Edit Loaner Details</h3>
                     <button id="closeEditLoanerButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                 <form id="editLoanerForm" class="space-y-4">
                    <div>
                        <label for="editLoanerName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loaner's Name</label>
                        <input type="text" id="editLoanerName" name="borrowerName" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                    </div>
                     <div>
                        <label for="editLoanerContact" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Contact Details</label>
                        <textarea id="editLoanerContact" name="contactDetails" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm"></textarea>
                    </div>
                     <div class="flex items-center">
                        <input id="banLoanerCheckbox" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                        <label for="banLoanerCheckbox" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Ban this Loaner</label>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="editLoanerDeleteButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">
                            <span class="button-text">Delete Loaner</span>
                            <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg">
                            <span class="button-text">Save Changes</span>
                            <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                    </div>
                 </form>
            </div>
        </div>
    </div>

    <div id="tableViewModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 m-4">
            <div class="p-6">
                 <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">All Loans Table View</h3>
                     <button id="closeTableViewButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white text-3xl">&times;</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" data-sort="borrowerName">Borrower</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Loan Type</th>
                                <th scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" data-sort="loanAmount">Principal</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Interest</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Penalty</th>
                                <th scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" data-sort="totalDue">Total Due</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Loan Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="loanTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="partialPaymentModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-sm m-4">
            <div class="p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Make a Payment</h3>
                <form id="partialPaymentForm" class="mt-4 space-y-4">
                    <div>
                        <label for="paymentAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Amount (₱)</label>
                        <input type="number" id="paymentAmount" name="paymentAmount" required min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <p id="paymentDetails" class="text-xs text-gray-500 dark:text-gray-400"></p>
                    <div class="bg-gray-50 dark:bg-gray-700 -mx-6 -mb-6 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                            <span class="button-text">Submit Payment</span>
                            <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                        <button type="button" id="closePartialPaymentButton" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="editNotesModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Edit Loan Notes</h3>
                <form id="editNotesForm" class="mt-4 space-y-4">
                    <textarea id="loanNotesText" rows="4" class="block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    <div class="sm:flex sm:flex-row-reverse">
                        <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                            <span class="button-text">Save Notes</span>
                            <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                        <button type="button" id="closeEditNotesButton" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="howItWorksModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl m-4">
            <div class="p-6">
                <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">How It Works: Loan Logic & Calculations</h3>
                     <button id="closeHowItWorksButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <div class="mt-4 space-y-4 text-gray-700 dark:text-gray-300">
                    <div>
                        <h4 class="font-bold text-lg">Loan Types</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>Product:</strong> Defaults to 0% interest. Used for tracking physical items with a monetary value.</li>
                            <li><strong>E-Loan:</strong> Defaults to 20% interest, 1 payment, and weekly frequency. Designed for short-term cash loans.</li>
                            <li><strong>Long Term E-Loan:</strong> Defaults to 20% interest. For cash loans with multiple payments.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Core Calculations</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>Interest:</strong> Calculated as a simple, one-time percentage of the principal: <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">Principal * (Interest Rate / 100)</code>.</li>
                            <li><strong>Installment Amount:</strong> The total amount (Principal + Interest) is divided equally by the number of payments: <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">(Principal + Interest) / Number of Payments</code>.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Penalty System</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li>A penalty of 5% of the original loan amount is applied for <span class="font-bold">each day</span> an installment is overdue.</li>
                            <li><strong>Formula:</strong> <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">(Principal * 0.05) * Days Delayed</code>.</li>
                            <li>The total penalty is the sum of penalties for all overdue, unpaid installments.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Button Functions</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>PAY:</strong> Opens a modal to enter a partial or full payment amount for an installment.</li>
                            <li><strong>PAID:</strong> A shortcut to fully settle an installment, including any accrued penalties.</li>
                            <li><strong>RESCHEDULE:</strong> Reschedules the due date for the selected installment and all future ones.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="settingsModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-2xl m-4">
            <div class="p-6">
                 <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Application Settings</h3>
                     <button id="closeSettingsButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white">Loan Defaults</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Set default values for new loans.</p>
                        <form id="loanDefaultsForm" class="mt-2 space-y-4">
                            <div>
                                <label for="defaultPenaltyRateInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Default Penalty Rate (%) per day</label>
                                <input type="number" id="defaultPenaltyRateInput" min="0" step="0.01" class="block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                 <label for="defaultELoanInterest" class="block text-sm font-medium text-gray-700 dark:text-gray-300">E-Loan Default Interest Rate (%)</label>
                                 <input type="number" id="defaultELoanInterest" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                <span class="button-text">Save Defaults</span>
                                <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                        </form>
                    </div>

                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white">Authorized Emails</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">These users can access the application.</p>
                        <div id="authorizedEmailsList" class="mt-4 space-y-2">
                            </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white">Add New Authorized Email</h4>
                        <form id="addEmailForm" class="mt-2 flex gap-2">
                            <input type="email" id="newAuthEmail" placeholder="user@example.com" required class="flex-grow block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                <span class="button-text">Add</span>
                                <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <input type="file" id="csvFileInput" class="hidden" accept=".csv">

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, serverTimestamp, where, getDoc, setDoc, arrayUnion, arrayRemove, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- Environment and Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'product-loan-app-dev';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { // Fallback configuration for local development
                apiKey: "AIzaSyB_eeYSYZPeYRr3m3xiX7OLoRzsd37yNwI",
                authDomain: "e-loan-9457a.firebaseapp.com",
                projectId: "e-loan-9457a",
                storageBucket: "e-loan-9457a.firebasestorage.app",
                messagingSenderId: "905622570857",
                appId: "1:905622570857:web:5dfb76c60f9e5d9fdedff8",
                measurementId: "G-SQF73TTGMX"
            };

        // Initialize Firebase App, Auth, and Firestore
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- Global State ---
        let currentUser = null;
        let confirmCallback = null;
        let unsubscribeFromBorrowers = null;
        let allBorrowers = [];
        let currentFilter = 'all';
        let loanTypeChart = null;
        const primaryAdmin = 'cristinemae111@gmail.com';
        let sortState = { column: 'loanDate', direction: 'desc' };
        let expandedBorrowerIds = new Set();
        let currentPage = 1; 
        const loansPerPage = 10;
        let appSettings = {};
        let currentUserRole = 'user';
        let historyModalOpen = false;

        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const googleSignInButton = document.getElementById('googleSignInButton');
        
        // --- Custom Modals ---
        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }
        document.getElementById('alertOkButton').addEventListener('click', () => document.getElementById('alertModal').style.display = 'none');

        function showConfirm(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        document.getElementById('confirmOkButton').addEventListener('click', () => {
            if (confirmCallback) confirmCallback(true); // Pass true for confirmation
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        });
        document.getElementById('confirmCancelButton').addEventListener('click', () => {
            if (confirmCallback) confirmCallback(false); // Pass false for cancellation
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        });

        function toggleButtonSpinner(button, show) {
            if (!button) return;
            const textSpan = button.querySelector('.button-text');
            const spinnerSvg = button.querySelector('.spinner-icon');

            if (show) {
                button.disabled = true;
                if (textSpan) textSpan.style.display = 'none';
                if (spinnerSvg) spinnerSvg.style.display = 'inline-block';
            } else {
                button.disabled = false;
                if (textSpan) textSpan.style.display = 'inline-block';
                if (spinnerSvg) spinnerSvg.style.display = 'none';
            }
        }
        
        // --- Authentication ---
        googleSignInButton.addEventListener('click', () => {
            toggleButtonSpinner(googleSignInButton, true);
            signInWithPopup(auth, provider).catch(error => {
                console.error("Google Sign-In Error:", error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    showAlert('Sign-In Failed', `Error: ${error.message}`);
                }
                toggleButtonSpinner(googleSignInButton, false);
            });
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                checkAuthorization(user);
            } else {
                currentUser = null;
                showLoginScreen();
                toggleButtonSpinner(googleSignInButton, false);
            }
        });

        async function checkAuthorization(user) {
            const configRef = doc(db, `artifacts/${appId}/config/app_settings`);
            try {
                let configSnap = await getDoc(configRef);
                if (!configSnap.exists()) {
                    await setDoc(configRef, { 
                        authorizedEmails: [primaryAdmin],
                        defaultPenaltyRate: 5,
                        defaultELoanInterest: 20,
                        userRoles: { [primaryAdmin]: 'admin' }
                    });
                    configSnap = await getDoc(configRef);
                }
                
                const data = configSnap.data();
                const authorizedEmails = data.authorizedEmails || [];
                const userRoles = data.userRoles || {};
                
                appSettings = {
                    authorizedEmails: authorizedEmails,
                    defaultPenaltyRate: data.defaultPenaltyRate || 5,
                    defaultELoanInterest: data.defaultELoanInterest || 20,
                    userRoles: userRoles
                };
                
                currentUserRole = appSettings.userRoles[user.email] || 'user';

                if (appSettings.authorizedEmails.includes(user.email)) {
                    currentUser = user;
                    showMainApp(user);
                } else {
                    showAlert('Access Denied', 'Your email is not authorized to access this application.');
                    signOut(auth);
                }
            } catch (error) {
                console.error("Error checking authorization:", error);
                showAlert('Authorization Error', 'Could not verify your access rights. Please try again.');
                signOut(auth);
            }
        }
        
        // --- App Initialization ---
        function initializeMainAppEventListeners() {
            document.getElementById('logoutButton').addEventListener('click', () => {
                if (unsubscribeFromBorrowers) unsubscribeFromBorrowers();
                signOut(auth);
            });
            
            if (currentUserRole === 'admin') {
                document.getElementById('settingsButton').style.display = 'inline-block';
                document.getElementById('manageLoanerButton').style.display = 'inline-block';
            } else {
                document.getElementById('settingsButton').style.display = 'none';
                document.getElementById('manageLoanerButton').style.display = 'none';
            }
            
            document.getElementById('settingsButton').addEventListener('click', openSettingsModal);
            document.getElementById('closeSettingsButton').addEventListener('click', () => document.getElementById('settingsModal').style.display = 'none');
            document.getElementById('addEmailForm').addEventListener('submit', handleAddAuthorizedEmail);
            document.getElementById('loanDefaultsForm').addEventListener('submit', handleSaveDefaults);
            
            document.getElementById('manageLoanerButton').addEventListener('click', openManageLoanerModal);
            document.getElementById('closeManageLoanerButton').addEventListener('click', () => document.getElementById('manageLoanerModal').style.display = 'none');
            document.getElementById('manageLoanerSearch').addEventListener('input', renderManageLoanerList);
            document.getElementById('closeEditLoanerButton').addEventListener('click', () => document.getElementById('editLoanerModal').style.display = 'none');
            document.getElementById('editLoanerForm').addEventListener('submit', handleEditLoanerSubmit);
            document.getElementById('editLoanerDeleteButton').addEventListener('click', handleDeleteLoaner);
            document.getElementById('closeLoanerHistoryButton').addEventListener('click', () => document.getElementById('loanerHistoryModal').style.display = 'none');
            document.getElementById('resetLoanScoreBtn').addEventListener('click', handleResetLoanScore);
            
            document.getElementById('tableViewButton').addEventListener('click', () => document.getElementById('tableViewModal').style.display = 'flex');
            document.getElementById('closeTableViewButton').addEventListener('click', () => document.getElementById('tableViewModal').style.display = 'none');

            document.getElementById('importButton').addEventListener('click', (e) => {
                toggleButtonSpinner(e.target, true);
                document.getElementById('csvFileInput').click();
            });
            document.getElementById('exportButton').addEventListener('click', (e) => {
                toggleButtonSpinner(e.target, true);
                exportToCSV(allBorrowers);
                setTimeout(() => toggleButtonSpinner(e.target, false), 1000); // Simulate export time
            });
            document.getElementById('csvFileInput').addEventListener('change', (e) => importFromCSV(e.target.files[0]));

            document.getElementById('closePartialPaymentButton').addEventListener('click', () => document.getElementById('partialPaymentModal').style.display = 'none');
            document.getElementById('closeEditNotesButton').addEventListener('click', () => document.getElementById('editNotesModal').style.display = 'none');
            document.getElementById('closeEditLoanButton').addEventListener('click', () => document.getElementById('editLoanModal').style.display = 'none');

            const addLoanForm = document.getElementById('addLoanForm');
            addLoanForm.innerHTML = `
                <div>
                    <label for="modalBorrowerName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Borrower's Name</label>
                    <input type="text" id="modalBorrowerName" name="borrowerName" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="modalLoanType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Type</label>
                    <select id="modalLoanType" name="loanType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="Product">Product</option>
                        <option value="E-Loan">E-Loan</option>
                        <option value="Long Term E-Loan">Long Term E-Loan</option>
                    </select>
                </div>
                <div id="modalProductNameField">
                    <label for="modalProductName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Product Name</label>
                    <input type="text" id="modalProductName" name="productName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="modalLoanAmount" id="modalLoanAmountLabel" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Amount (₱)</label>
                        <input type="number" id="modalLoanAmount" name="loanAmount" min="0" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div id="interestRateSection">
                        <label for="modalInterestRate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Interest Rate (%)</label>
                        <input type="number" id="modalInterestRate" name="interestRate" min="0" step="0.1" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div id="customInterestSection" class="hidden">
                        <label for="modalCustomInterest" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Interest (₱)</label>
                        <input type="number" id="modalCustomInterest" name="customInterest" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="flex items-center">
                        <input id="customInterestCheckbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="customInterestCheckbox" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Custom Interest</label>
                    </div>
                    <div>
                        <label for="modalNumberOfPayments" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Number of Payments (Gives)</label>
                        <input type="number" id="modalNumberOfPayments" name="numberOfPayments" min="1" step="1" value="1" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modalPaymentFrequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Frequency</label>
                        <select id="modalPaymentFrequency" name="paymentFrequency" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="weekly">Weekly</option>
                            <option value="bi-weekly">Bi-Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="one-time">One-time</option>
                        </select>
                    </div>
                </div>
                 <div>
                    <label for="modalLoanNotes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes (Optional)</label>
                    <textarea id="modalLoanNotes" name="loanNotes" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                 <div>
                    <label for="modalContactDetails" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Contact Details (Optional)</label>
                    <textarea id="modalContactDetails" name="contactDetails" rows="2" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="modalLoanDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Date</label>
                    <input type="date" id="modalLoanDate" name="loanDate" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg">
                    <span class="button-text">Add Loan Record</span>
                    <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            `;
            
            document.getElementById('addNewLoanerButton').addEventListener('click', () => {
                document.getElementById('addLoanForm').reset();
                document.getElementById('modalInterestRate').value = appSettings.defaultELoanInterest;
                document.getElementById('addLoanModal').style.display = 'flex';
                document.getElementById('modalLoanType').dispatchEvent(new Event('change'));
                document.getElementById('customInterestCheckbox').dispatchEvent(new Event('change'));
            });

            document.getElementById('closeAddLoanButton').addEventListener('click', () => document.getElementById('addLoanModal').style.display = 'none');
            
            const loanAmountLabel = document.getElementById('modalLoanAmountLabel');
            const interestRateInput = document.getElementById('modalInterestRate');
            const numberOfPaymentsInput = document.getElementById('modalNumberOfPayments');
            const paymentFrequencySelect = document.getElementById('modalPaymentFrequency');
            const productNameField = document.getElementById('modalProductNameField');

            document.getElementById('modalLoanType').addEventListener('change', (e) => {
                if (e.target.value === 'E-Loan') {
                    productNameField.style.display = 'none';
                    loanAmountLabel.textContent = 'Loan Amount (₱)';
                    interestRateInput.value = appSettings.defaultELoanInterest;
                    numberOfPaymentsInput.value = 1;
                    paymentFrequencySelect.value = 'weekly';
                } else if (e.target.value === 'Long Term E-Loan') {
                     productNameField.style.display = 'none';
                     loanAmountLabel.textContent = 'Loan Amount (₱)';
                     interestRateInput.value = appSettings.defaultELoanInterest;
                } else if (e.target.value === 'Product') {
                    productNameField.style.display = 'block';
                    loanAmountLabel.textContent = 'Product Amount (₱)';
                    interestRateInput.value = 0;
                }
            });
            
            const customInterestCheckbox = document.getElementById('customInterestCheckbox');
            const interestRateSection = document.getElementById('interestRateSection');
            const customInterestSection = document.getElementById('customInterestSection');

            customInterestCheckbox.addEventListener('change', (e) => {
                if(e.target.checked) {
                    interestRateSection.style.display = 'none';
                    customInterestSection.style.display = 'block';
                    interestRateInput.value = 0; 
                } else {
                    interestRateSection.style.display = 'block';
                    customInterestSection.style.display = 'none';
                }
            });

            document.getElementById('howItWorksButton').addEventListener('click', () => document.getElementById('howItWorksModal').style.display = 'flex');
            document.getElementById('closeHowItWorksButton').addEventListener('click', () => document.getElementById('howItWorksModal').style.display = 'none');
            
            document.getElementById('searchLoaner').addEventListener('input', () => {
                currentPage = 1;
                renderBorrowerList();
            });

            document.getElementById('filterButtons').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    currentPage = 1;
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('#filterButtons .filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    e.target.classList.add('active', 'bg-indigo-600', 'text-white');
                    e.target.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    renderBorrowerList();
                }
            });

            document.getElementById('summaryFilterButtons').addEventListener('click', (e) => {
                 if (e.target.classList.contains('filter-btn')) {
                    const filter = e.target.dataset.filter;
                    document.querySelectorAll('#summaryFilterButtons .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    if (filter === 'custom') {
                        document.getElementById('summaryDateRange').style.display = 'flex';
                    } else {
                        document.getElementById('summaryDateRange').style.display = 'none';
                        updateSummary(allBorrowers, filter);
                    }
                }
            });

            [document.getElementById('startDate'), document.getElementById('endDate')].forEach(input => {
                input.addEventListener('change', () => {
                    updateSummary(allBorrowers, 'custom');
                });
            });
            
            addLoanForm.addEventListener('submit', async (e) => {
                toggleButtonSpinner(e.submitter, true);
                try {
                    await handleAddLoanSubmit(e);
                } finally {
                    toggleButtonSpinner(e.submitter, false);
                }
            });

            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    if (sortState.column === column) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.column = column;
                        sortState.direction = 'asc';
                    }
                    renderLoanTable();
                });
            });

            // Set default summary filter button
            document.querySelector('#summaryFilterButtons .filter-btn[data-filter="monthly"]').classList.add('active');
        }

        function showMainApp(user) {
            document.getElementById('loggedInUser').textContent = user.email;
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
            initializeMainAppEventListeners();
            loadBorrowers();
        }

        function showLoginScreen() {
            mainApp.style.display = 'none';
            loginScreen.style.display = 'flex';
            const borrowerList = document.getElementById('borrowerList');
            if (borrowerList) {
                borrowerList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-8">Please log in to see records.</p>';
            }
        }

        // --- Firestore Paths ---
        const borrowersPath = `artifacts/${appId}/borrowers`;
        const configPath = `artifacts/${appId}/config/app_settings`;
        const activityLogPath = `artifacts/${appId}/activityLog`;

        // --- Firestore Operations ---
        function loadBorrowers() {
            if (!currentUser) return;
            
            const loadingMsgEl = document.getElementById('loadingMessage');
            if(loadingMsgEl) loadingMsgEl.textContent = 'Loading borrower records...';

            const q = query(collection(db, borrowersPath));
            const activityQ = query(collection(db, activityLogPath));

            unsubscribeFromBorrowers = onSnapshot(q, (querySnapshot) => {
                allBorrowers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allBorrowers.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                
                renderBorrowerList();
                renderLoanTable();
                updateSummary(allBorrowers, 'monthly');
                updateNotifications(allBorrowers);

            }, (error) => {
                console.error("Error fetching borrowers: ", error);
                if (loadingMsgEl) loadingMsgEl.textContent = 'Error loading data. Please check console and refresh.';
                showAlert('Data Error', 'Could not fetch records from the database.');
            });

            onSnapshot(activityQ, (querySnapshot) => {
                const activityLog = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Safeguard the sort function to prevent errors with missing timestamps
                activityLog.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                    const timeB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                    return timeB - timeA;
                });
                renderActivityLog(activityLog);
            }, (error) => {
                console.error("Error fetching activity log:", error);
            });
        }
        
        async function handleAddLoanSubmit(e) {
            e.preventDefault();
            if (!currentUser) return showAlert('Error', 'You are not logged in.');

            const borrowerName = document.getElementById('modalBorrowerName').value.trim();
            if (!borrowerName) return showAlert('Validation Error', 'Borrower name is required.');

            const loanAmount = parseFloat(document.getElementById('modalLoanAmount').value);
            if (isNaN(loanAmount) || loanAmount <= 0) return showAlert('Validation Error', 'Please enter a valid loan amount.');

            const loanDate = document.getElementById('modalLoanDate').value;
            if (!loanDate) return showAlert('Validation Error', 'Loan date is required.');

            const isCustomInterest = document.getElementById('customInterestCheckbox').checked;
            const interestRate = parseFloat(document.getElementById('modalInterestRate').value) || 0;
            const customInterest = parseFloat(document.getElementById('modalCustomInterest').value) || 0;
            const contactDetails = document.getElementById('modalContactDetails').value.trim();
            
            const newLoan = {
                loanId: crypto.randomUUID(),
                loanType: document.getElementById('modalLoanType').value,
                loanAmount: loanAmount,
                interestRate: isCustomInterest ? 0 : interestRate,
                customInterest: isCustomInterest ? customInterest : 0,
                isCustomInterest: isCustomInterest,
                numberOfPayments: parseInt(document.getElementById('modalNumberOfPayments').value) || 1,
                paymentFrequency: document.getElementById('modalPaymentFrequency').value,
                loanDate: loanDate,
                notes: document.getElementById('modalLoanNotes').value.trim(),
                status: 'Active',
                paidPenalties: 0,
                reloanHistory: [],
                createdBy: currentUser.email
            };

            if (newLoan.loanType === 'Product') {
                const productName = document.getElementById('modalProductName').value.trim();
                if (!productName) return showAlert('Validation Error', 'Please enter a product name.');
                newLoan.productName = productName;
            }

            const paymentSchedule = [];
            const totalInterest = newLoan.isCustomInterest ? newLoan.customInterest : newLoan.loanAmount * (newLoan.interestRate / 100);
            const installmentAmount = (newLoan.loanAmount + totalInterest) / newLoan.numberOfPayments;
            let nextDueDate = new Date(newLoan.loanDate);

            for(let i = 0; i < newLoan.numberOfPayments; i++) {
                 if (newLoan.paymentFrequency === 'weekly') nextDueDate.setDate(nextDueDate.getDate() + 7);
                 else if (newLoan.paymentFrequency === 'bi-weekly') nextDueDate.setDate(nextDueDate.getDate() + 14);
                 else if (newLoan.paymentFrequency === 'monthly') nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                 else if (newLoan.paymentFrequency === 'one-time') nextDueDate = new Date(newLoan.loanDate);
                
                paymentSchedule.push({
                    dueDate: nextDueDate.toISOString().split('T')[0],
                    amount: installmentAmount,
                    status: 'Pending',
                    paidAmount: 0,
                    paidDate: null,
                    paymentHistory: [] 
                });
            }
            newLoan.paymentSchedule = paymentSchedule;
            newLoan.returnDate = paymentSchedule[paymentSchedule.length - 1].dueDate;

            document.getElementById('addLoanModal').style.display = 'none';

            const q = query(collection(db, borrowersPath), where("borrowerName", "==", borrowerName));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                await createNewBorrower(borrowerName, contactDetails, newLoan);
            } else {
                const existingBorrowerDoc = querySnapshot.docs[0];
                showExistingBorrowerChoice(borrowerName, newLoan, existingBorrowerDoc.id);
            }
        }

        function showExistingBorrowerChoice(borrowerName, newLoan, existingBorrowerId) {
            const modal = document.getElementById('existingBorrowerModal');
            const msgEl = document.getElementById('existingBorrowerMessage');
            const addToExistingBtn = document.getElementById('addToExistingButton');
            const addAsNewBtn = document.getElementById('addAsNewButton');
            const cancelBtn = document.getElementById('existingBorrowerCancelButton');

            msgEl.textContent = `A borrower named '${borrowerName}' already exists. How would you like to proceed?`;
            
            addToExistingBtn.onclick = async () => {
                toggleButtonSpinner(addToExistingBtn, true);
                try {
                    await updateExistingBorrower(existingBorrowerId, newLoan);
                } finally {
                    toggleButtonSpinner(addToExistingBtn, false);
                    modal.style.display = 'none';
                }
            };

            addAsNewBtn.onclick = async () => {
                toggleButtonSpinner(addAsNewBtn, true);
                try {
                    await createNewBorrower(borrowerName, newLoan);
                } finally {
                    toggleButtonSpinner(addAsNewBtn, false);
                    modal.style.display = 'none';
                }
            };

            cancelBtn.onclick = () => {
                modal.style.display = 'none';
            };

            modal.style.display = 'flex';
        }


        async function createNewBorrower(name, contactDetails, loan) {
            try {
                await addDoc(collection(db, borrowersPath), {
                    borrowerName: name,
                    contactDetails: contactDetails,
                    loans: [loan],
                    isBanned: false,
                    loanScore: 0,
                    createdAt: serverTimestamp()
                });
                await addDoc(collection(db, activityLogPath), {
                    action: 'created new loaner',
                    details: `for ${name}`,
                    timestamp: serverTimestamp(),
                    user: currentUser.email
                });
                document.getElementById('addLoanForm').reset();
                showAlert('Success', `New borrower '${name}' created with a new loan record.`);
            } catch (error) {
                console.error("Error creating new borrower: ", error);
                showAlert('Database Error', 'Failed to create new borrower.');
            }
        }

        async function updateExistingBorrower(docId, loan) {
             try {
                const borrowerRef = doc(db, borrowersPath, docId);
                const borrowerSnap = await getDoc(borrowerRef);
                if (borrowerSnap.data().isBanned) {
                    showAlert('Action Denied', 'This borrower is banned and cannot receive new loans.');
                    return;
                }
                await updateDoc(borrowerRef, {
                    loans: arrayUnion(loan)
                });
                await addDoc(collection(db, activityLogPath), {
                    action: 'added new loan',
                    details: `for ${borrowerSnap.data().borrowerName}`,
                    timestamp: serverTimestamp(),
                    user: currentUser.email
                });
                document.getElementById('addLoanForm').reset();
                showAlert('Success', `New loan added to existing borrower.`);
            } catch (error) {
                console.error("Error updating existing borrower: ", error);
                showAlert('Database Error', 'Failed to update borrower record.');
            }
        }
        
        // --- Settings Management ---
        async function openSettingsModal() {
            const listEl = document.getElementById('authorizedEmailsList');
            listEl.innerHTML = '<p>Loading...</p>';
            
            document.getElementById('defaultPenaltyRateInput').value = appSettings.defaultPenaltyRate;
            document.getElementById('defaultELoanInterest').value = appSettings.defaultELoanInterest;
            
            document.getElementById('settingsModal').style.display = 'flex';

            try {
                const configSnap = await getDoc(doc(db, configPath));
                if (configSnap.exists()) {
                    renderAuthorizedEmails(configSnap.data().authorizedEmails || []);
                } else {
                    listEl.innerHTML = '<p>No authorized emails found.</p>';
                }
            } catch(e) {
                console.error(e);
                listEl.innerHTML = '<p class="text-red-500">Error loading emails.</p>';
            }
        }
        
        async function handleSaveDefaults(e) {
            if (currentUserRole !== 'admin') return showAlert('Access Denied', 'You do not have permission to perform this action.');
            e.preventDefault();
            const newPenaltyRate = parseFloat(document.getElementById('defaultPenaltyRateInput').value);
            const newELoanInterest = parseFloat(document.getElementById('defaultELoanInterest').value);

            if (isNaN(newPenaltyRate) || newPenaltyRate < 0) {
                return showAlert('Validation Error', 'Please enter a valid penalty rate (0 or higher).');
            }
            if (isNaN(newELoanInterest) || newELoanInterest < 0) {
                 return showAlert('Validation Error', 'Please enter a valid E-Loan interest rate (0 or higher).');
            }
            
            toggleButtonSpinner(e.submitter, true);
            try {
                await updateDoc(doc(db, configPath), {
                    defaultPenaltyRate: newPenaltyRate,
                    defaultELoanInterest: newELoanInterest
                });
                await addDoc(collection(db, activityLogPath), {
                    action: 'updated default settings',
                    details: ``,
                    timestamp: serverTimestamp(),
                    user: currentUser.email
                });
                appSettings.defaultPenaltyRate = newPenaltyRate;
                appSettings.defaultELoanInterest = newELoanInterest;
                showAlert('Success', 'Default settings saved successfully.');
            } catch (error) {
                console.error("Error saving defaults:", error);
                showAlert('Error', 'Could not save default settings.');
            } finally {
                toggleButtonSpinner(e.submitter, false);
                document.getElementById('settingsModal').style.display = 'none';
            }
        }

        function renderAuthorizedEmails(emails) {
            const listEl = document.getElementById('authorizedEmailsList');
            listEl.innerHTML = '';
            emails.forEach(email => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                item.innerHTML = `<span class="text-sm">${email}</span>`;

                if (email !== primaryAdmin) {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Remove';
                    deleteButton.className = 'text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600';
                    deleteButton.onclick = async () => {
                        toggleButtonSpinner(deleteButton, true);
                        try {
                             await handleDeleteAuthorizedEmail(email);
                        } finally {
                             toggleButtonSpinner(deleteButton, false);
                        }
                    };
                    item.appendChild(deleteButton);
                } else {
                     item.innerHTML += `<span class="text-xs font-semibold text-indigo-600 dark:text-indigo-400">ADMIN</span>`;
                }
                listEl.appendChild(item);
            });
        }

        async function handleAddAuthorizedEmail(e) {
            if (currentUserRole !== 'admin') return showAlert('Access Denied', 'You do not have permission to perform this action.');
            e.preventDefault();
            const input = document.getElementById('newAuthEmail');
            const email = input.value.trim();
            if (!email) return;
            
            toggleButtonSpinner(e.submitter, true);
            try {
                await updateDoc(doc(db, configPath), { authorizedEmails: arrayUnion(email) });
                await addDoc(collection(db, activityLogPath), {
                    action: 'added new email',
                    details: `${email}`,
                    timestamp: serverTimestamp(),
                    user: currentUser.email
                });
                showAlert('Success', `${email} has been added.`);
                input.value = '';
                openSettingsModal();
            } catch (error) {
                console.error("Error adding email:", error);
                showAlert('Error', 'Could not add email.');
            } finally {
                toggleButtonSpinner(e.submitter, false);
            }
        }

        async function handleDeleteAuthorizedEmail(email) {
            if (currentUserRole !== 'admin') return showAlert('Access Denied', 'You do not have permission to perform this action.');
            showConfirm('Confirm Deletion', `Are you sure you want to remove ${email}?`, async () => {
                 try {
                    await updateDoc(doc(db, configPath), { authorizedEmails: arrayRemove(email) });
                    await addDoc(collection(db, activityLogPath), {
                        action: 'removed email',
                        details: `${email}`,
                        timestamp: serverTimestamp(),
                        user: currentUser.email
                    });
                    showAlert('Success', `${email} has been removed.`);
                    openSettingsModal();
                } catch (error) {
                    console.error("Error removing email:", error);
                    showAlert('Error', 'Could not remove email.');
                }
            });
        }

        // --- Manage Loaners ---
        function openManageLoanerModal() {
            document.getElementById('manageLoanerModal').style.display = 'flex';
            renderManageLoanerList();
        }

        function renderManageLoanerList() {
            const container = document.getElementById('loanerListContainer');
            const searchTerm = document.getElementById('manageLoanerSearch').value.toLowerCase();
            container.innerHTML = '';
            
            const filtered = allBorrowers.filter(b => b.borrowerName.toLowerCase().includes(searchTerm));
            
            if (filtered.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-4">No loaners found.</p>`;
            } else {
                filtered.forEach(borrower => {
                    const item = document.createElement('div');
                    const isBannedTag = borrower.isBanned ? `<span class="bg-red-200 text-red-800 text-xs px-2 py-1 rounded-full ml-2">Banned</span>` : '';
                    item.className = 'flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600';
                    item.innerHTML = `
                        <div class="flex-1">
                            <span class="font-medium text-gray-900 dark:text-white">${borrower.borrowerName}</span>
                            ${isBannedTag}
                        </div>
                        <div class="flex space-x-2">
                             <button class="edit-loaner-btn text-indigo-600 dark:text-indigo-400 font-bold text-xs">Edit</button>
                        </div>
                    `;
                    item.dataset.borrowerId = borrower.id;
                    item.querySelector('.edit-loaner-btn').addEventListener('click', () => {
                        openEditLoanerModal(borrower);
                    });
                    container.appendChild(item);
                });
            }
        }

        function openEditLoanerModal(borrower) {
            const modal = document.getElementById('editLoanerModal');
            const nameInput = document.getElementById('editLoanerName');
            const contactInput = document.getElementById('editLoanerContact');
            const banCheckbox = document.getElementById('banLoanerCheckbox');
            
            nameInput.value = borrower.borrowerName;
            contactInput.value = borrower.contactDetails || '';
            banCheckbox.checked = borrower.isBanned || false;
            
            modal.dataset.borrowerId = borrower.id;
            modal.style.display = 'flex';
        }

        async function handleEditLoanerSubmit(e) {
            e.preventDefault();
            const modal = document.getElementById('editLoanerModal');
            const borrowerId = modal.dataset.borrowerId;
            const name = document.getElementById('editLoanerName').value.trim();
            const contact = document.getElementById('editLoanerContact').value.trim();
            const isBanned = document.getElementById('banLoanerCheckbox').checked;

            if (!name) return showAlert('Validation Error', 'Loaner name cannot be empty.');
            
            toggleButtonSpinner(e.submitter, true);
            try {
                const borrowerRef = doc(db, borrowersPath, borrowerId);
                await updateDoc(borrowerRef, {
                    borrowerName: name,
                    contactDetails: contact,
                    isBanned: isBanned
                });
                await addDoc(collection(db, activityLogPath), {
                    action: 'updated loaner details',
                    details: `for ${name}`,
                    timestamp: serverTimestamp(),
                    user: currentUser.email
                });
                showAlert('Success', 'Loaner details updated successfully.');
                modal.style.display = 'none';
            } catch (error) {
                console.error("Error updating loaner:", error);
                showAlert('Error', 'Failed to update loaner details.');
            } finally {
                toggleButtonSpinner(e.submitter, false);
            }
        }

        async function handleDeleteLoaner(e) {
            e.preventDefault();
            const modal = document.getElementById('editLoanerModal');
            const borrowerId = modal.dataset.borrowerId;
            const borrowerToDelete = allBorrowers.find(b => b.id === borrowerId); // Get borrower info first
            if (!borrowerToDelete) {
                showAlert('Error', 'Could not find the borrower to delete.');
                return;
            }
            
            showConfirm('Delete Loaner', 'Are you sure you want to delete this loaner and ALL their records? This cannot be undone.', async (confirmed) => {
                if (!confirmed) return; // Stop if the user cancels

                toggleButtonSpinner(e.target, true);
                try {
                    await deleteDoc(doc(db, borrowersPath, borrowerId));
                    await addDoc(collection(db, activityLogPath), {
                        action: 'deleted loaner',
                        details: `${borrowerToDelete.borrowerName}`, // Use the stored name
                        timestamp: serverTimestamp(),
                        user: currentUser.email
                    });
                    showAlert('Success', 'Loaner and all records deleted.');
                    modal.style.display = 'none';
                    document.getElementById('manageLoanerModal').style.display = 'none';
                } catch (error) {
                    console.error("Error deleting loaner:", error);
                    showAlert('Error', 'Failed to delete loaner record.');
                } finally {
                    toggleButtonSpinner(e.target, false);
                }
            });
        }
        
        // --- UI Rendering ---
        function renderBorrowerList() {
            const loadingMessageEl = document.getElementById('loadingMessage');
            if (loadingMessageEl) loadingMessageEl.style.display = 'none';

            const borrowerList = document.getElementById('borrowerList');
            borrowerList.innerHTML = '';
            
            const searchTerm = document.getElementById('searchLoaner').value.toLowerCase();
            let filteredBorrowers = allBorrowers.filter(b => b.borrowerName.toLowerCase().includes(searchTerm));
            const today = new Date();
            today.setHours(0,0,0,0);
            const todayStr = today.toISOString().split('T')[0];
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            if (currentFilter !== 'all') {
                 filteredBorrowers = filteredBorrowers.filter(borrower => {
                    return borrower.loans.some(loan => {
                        if (['Product', 'E-Loan', 'Long Term E-Loan'].includes(currentFilter)) {
                            return loan.loanType === currentFilter;
                        }
                        
                        if (currentFilter === 'due') {
                            return loan.status === 'Active' && loan.paymentSchedule?.some(p => p.status !== 'Paid' && p.dueDate === todayStr);
                        }

                        if (currentFilter === 'due-tomorrow') {
                            return loan.status === 'Active' && loan.paymentSchedule?.some(p => p.status !== 'Paid' && p.dueDate === tomorrowStr);
                        }
                        
                        if (currentFilter === 'overdue') {
                             return loan.status !== 'Paid' && loan.paymentSchedule?.some(p => p.status !== 'Paid' && new Date(p.dueDate) < new Date(todayStr));
                        }

                        const isFullyPaid = loan.status === 'Paid';
                        
                        if (['active', 'paid'].includes(currentFilter)) {
                             const isOverdue = loan.status !== 'Paid' && loan.paymentSchedule?.some(p => p.status !== 'Paid' && new Date(p.dueDate) < new Date(todayStr));
                             if (currentFilter === 'active') return !isFullyPaid && !isOverdue;
                             if (currentFilter === 'paid') return isFullyPaid;
                        }
                        return false;
                    });
                });
            }

            // Corrected Pagination Logic
            const totalBorrowers = filteredBorrowers.length;
            const totalPages = Math.ceil(totalBorrowers / loansPerPage);
            
            const startIndex = (currentPage - 1) * loansPerPage;
            const endIndex = startIndex + loansPerPage;
            const paginatedBorrowers = filteredBorrowers.slice(startIndex, endIndex);


            if (paginatedBorrowers.length === 0) {
                 borrowerList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No records found for the current filters.</p>`;
            } else {
                paginatedBorrowers.forEach(borrower => {
                    const borrowerCard = createBorrowerCard(borrower);
                    if (borrowerCard) { 
                        borrowerList.appendChild(borrowerCard);
                    }
                });
            }
            
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const paginationControls = document.getElementById('paginationControls');
            paginationControls.innerHTML = '';
            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.className = 'px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-700';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderBorrowerList();
                }
            });
            paginationControls.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.className = 'text-sm text-gray-700 dark:text-gray-300';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            paginationControls.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.className = 'px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-700';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderBorrowerList();
                }
            });
            paginationControls.appendChild(nextButton);
        }
        
        function updateNotifications(borrowers) {
            const notificationArea = document.getElementById('notificationArea');
            notificationArea.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            let dueTodayCount = 0;
            let dueTomorrowCount = 0;

            borrowers.forEach(b => {
                b.loans.forEach(loan => {
                     if (loan.status === 'Active' && loan.paymentSchedule) {
                        loan.paymentSchedule.forEach(p => {
                            if (p.status !== 'Paid') {
                                if (p.dueDate === todayStr) dueTodayCount++;
                                if (p.dueDate === tomorrowStr) dueTomorrowCount++;
                            }
                        });
                    }
                });
            });

            if (dueTodayCount > 0) {
                const notification = document.createElement('div');
                notification.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md cursor-pointer';
                notification.innerHTML = `<p class="font-bold">Due Today</p><p>You have ${dueTodayCount} loan payment(s) due today.</p>`;
                notification.addEventListener('click', () => {
                    document.querySelector('#filterButtons .filter-btn[data-filter="due"]').click();
                });
                notificationArea.appendChild(notification);
            }
            if (dueTomorrowCount > 0) {
                const notification = document.createElement('div');
                notification.className = 'bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md cursor-pointer';
                notification.innerHTML = `<p class="font-bold">Due Tomorrow</p><p>You have ${dueTomorrowCount} loan payment(s) due tomorrow.</p>`;
                notification.addEventListener('click', () => {
                    document.querySelector('#filterButtons .filter-btn[data-filter="due-tomorrow"]').click();
                });
                notificationArea.appendChild(notification);
            }
        }

        function updateSummary(borrowers, filter) {
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            let totalPrincipal = 0, totalInterest = 0, totalPenalties = 0, activeLoans = 0, completedLoans = 0;
            const loanTypeCounts = {};

            borrowers.forEach(b => {
                b.loans.forEach(loan => {
                    const loanDate = new Date(loan.loanDate);
                    let includeInSummary = false;
                    if (filter === 'weekly') {
                        const oneWeekAgo = new Date(); oneWeekAgo.setDate(currentDate.getDate() - 7);
                        if (loanDate >= oneWeekAgo) includeInSummary = true;
                    } else if (filter === 'monthly') {
                        const oneMonthAgo = new Date(); oneMonthAgo.setMonth(currentDate.getMonth() - 1);
                        if (loanDate >= oneMonthAgo) includeInSummary = true;
                    } else if (filter === 'custom' && document.getElementById('startDate').value && document.getElementById('endDate').value) {
                         const start = new Date(document.getElementById('startDate').value);
                         const end = new Date(document.getElementById('endDate').value);
                         if (loanDate >= start && loanDate <= end) includeInSummary = true;
                    } else {
                        includeInSummary = true;
                    }

                    if (includeInSummary) {
                        totalPrincipal += loan.loanAmount;
                        totalInterest += loan.isCustomInterest ? loan.customInterest : loan.loanAmount * (loan.interestRate / 100);
                        loanTypeCounts[loan.loanType] = (loanTypeCounts[loan.loanType] || 0) + 1;
                    }
                    
                    if (loan.status !== 'Paid' && loan.paymentSchedule) {
                         loan.paymentSchedule.forEach(p => {
                            if (p.status !== 'Paid' && new Date(p.dueDate) < currentDate) {
                                const daysDelayed = Math.ceil((currentDate - new Date(p.dueDate)) / (1000 * 3600 * 24));
                                totalPenalties += (loan.loanAmount * (appSettings.defaultPenaltyRate / 100)) * daysDelayed;
                            }
                        });
                    }

                    if (loan.status === 'Paid') completedLoans++;
                    else activeLoans++;
                });
            });

            document.getElementById('totalPrincipal').textContent = `₱${totalPrincipal.toFixed(2)}`;
            document.getElementById('totalInterest').textContent = `₱${totalInterest.toFixed(2)}`;
            document.getElementById('totalPenalties').textContent = `₱${totalPenalties.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `₱${(totalInterest + totalPenalties).toFixed(2)}`;
            document.getElementById('activeLoans').textContent = activeLoans;
            document.getElementById('completedLoans').textContent = completedLoans;
            
            if (loanTypeChart) {
                loanTypeChart.data.labels = Object.keys(loanTypeCounts);
                loanTypeChart.data.datasets[0].data = Object.values(loanTypeCounts);
                loanTypeChart.update();
            } else {
                 const ctx = document.getElementById('loanTypeChart').getContext('2d');
                 loanTypeChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(loanTypeCounts),
                        datasets: [{
                            label: 'Loan Types',
                            data: Object.values(loanTypeCounts),
                            backgroundColor: ['rgba(129, 140, 248, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)'],
                            borderColor: ['rgba(129, 140, 248, 1)', 'rgba(59, 130, 246, 1)', 'rgba(16, 185, 129, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Loan Type Distribution' } } },
                });
            }
        }
        
        function calculateLoanScore(borrower) {
            let score = 100; // Base score
            const today = new Date();
            
            borrower.loans.forEach(loan => {
                if (loan.status === 'Paid') {
                    score += 5; // Reward for a completed loan
                }
                
                if (loan.paymentSchedule) {
                    loan.paymentSchedule.forEach(payment => {
                        const dueDate = new Date(payment.dueDate);
                        if (payment.status === 'Paid' && new Date(payment.paidDate) <= dueDate) {
                            score += 2; // Reward for on-time payment
                        } else if (payment.status === 'Paid' && new Date(payment.paidDate) > dueDate) {
                            score -= 3; // Penalty for late payment
                        }
                        if (payment.status !== 'Paid' && dueDate < today) {
                            score -= 5; // Larger penalty for being overdue
                        }
                    });
                }
            });
            
            return Math.max(0, Math.min(100, score)); // Keep score between 0 and 100
        }

        async function handleResetLoanScore() {
            const borrowerId = document.getElementById('editLoanerModal').dataset.borrowerId;
            if (!borrowerId) return;
            const borrowerRef = doc(db, borrowersPath, borrowerId);
            try {
                await updateDoc(borrowerRef, { loanScore: 100 });
                await addDoc(collection(db, activityLogPath), {
                    action: 'reset loan score',
                    details: `for ${allBorrowers.find(b => b.id === borrowerId)?.borrowerName}`,
                    timestamp: serverTimestamp(),
                    user: currentUser.email
                });
                showAlert('Success', 'Loan score reset to 100.');
            } catch (error) {
                console.error("Error resetting loan score:", error);
                showAlert('Error', 'Failed to reset loan score.');
            }
        }

        function renderActivityLog(logEntries) {
            const logContainer = document.getElementById('activityContent');
            logContainer.innerHTML = '';
            
            if (logEntries.length === 0) {
                 logContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-4">No recent activity.</p>`;
            } else {
                logEntries.slice(0, 4).forEach(entry => {
                    const logItem = document.createElement('div');
                    logItem.className = 'border-b dark:border-gray-700 pb-2 mb-2';
                    const date = entry.timestamp.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    logItem.innerHTML = `<p class="text-sm"><strong>${date}</strong>: ${entry.user.split('@')[0]} ${entry.action} ${entry.details}.</p>`;
                    logContainer.appendChild(logItem);
                });
            }
        }

      function createBorrowerCard(borrower) {
            const card = document.createElement('div');
            card.className = 'borrower-card bg-gray-50 dark:bg-gray-800/50 rounded-lg border dark:border-gray-700 shadow-md';
            card.dataset.borrowerId = borrower.id;
            
            let loansHtml = '';
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0); 
            const todayStr = currentDate.toISOString().split('T')[0];
            let activeLoanCount = 0;
            let overdueLoanCount = 0;

            borrower.loans.forEach((loan) => {
                const isFullyPaid = loan.status === 'Paid';
                let hasDelayedPayment = false;
                if (!isFullyPaid && loan.paymentSchedule) {
                    hasDelayedPayment = loan.paymentSchedule.some(p => p.status !== 'Paid' && new Date(p.dueDate) < currentDate);
                }
                const isDueToday = loan.status === 'Active' && loan.paymentSchedule?.some(p => p.status !== 'Paid' && p.dueDate === todayStr);
                const overallStatus = isFullyPaid ? 'Paid' : hasDelayedPayment ? 'Overdue' : 'Active';
                
                if (overallStatus === 'Active') activeLoanCount++;
                if (overallStatus === 'Overdue') overdueLoanCount++;

                let totalPenalty = 0;
                if (hasDelayedPayment) {
                    loan.paymentSchedule.forEach(p => {
                        if (p.status !== 'Paid' && new Date(p.dueDate) < currentDate) {
                            const timeDiff = currentDate.getTime() - new Date(p.dueDate).getTime();
                            const daysDelayed = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                            totalPenalty += (loan.loanAmount * (appSettings.defaultPenaltyRate / 100)) * daysDelayed;
                        }
                    });
                }
                
                const title = loan.loanType === 'Product' ? `Product: ${loan.productName}` : loan.loanType;
                const interest = loan.isCustomInterest ? loan.customInterest : loan.loanAmount * (loan.interestRate / 100);
                const totalDue = loan.loanAmount + interest + totalPenalty;
                const principalLabel = loan.loanType === 'Product' ? 'Product Price' : 'Principal';

                let scheduleHtml = '';
                if(loan.paymentSchedule?.length > 0) {
                    scheduleHtml = '<h4 class="font-semibold text-gray-700 dark:text-gray-300 mt-3 mb-2 col-span-full text-sm">Payment Schedule</h4>';
                    loan.paymentSchedule.forEach((payment, index) => {
                        const isPaymentPaid = payment.status === 'Paid';
                        const dueDate = new Date(payment.dueDate);
                        const isPaymentDelayed = !isPaymentPaid && dueDate < currentDate;
                        
                        let paymentDetailsHtml;
                        let actionButtonsHtml = '';
                        let daysDelayed = 0;

                        
                        if (!isPaymentPaid) {
                            actionButtonsHtml = `<button data-borrower-id="${borrower.id}" data-loan-id="${loan.loanId}" data-payment-index="${index}" class="mark-as-paid-btn bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded">
                                <span class="button-text">PAID</span>
                                <svg class="spinner-icon w-4 h-4 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                            <button data-borrower-id="${borrower.id}" data-loan-id="${loan.loanId}" data-payment-index="${index}" class="payment-paid-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded">
                                <span class="button-text">PAY</span>
                                <svg class="spinner-icon w-4 h-4 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>`;
                            
                            const rescheduleButtonText = loan.loanType === 'Product' ? 'RESCHEDULE' : 'RELOAN';
                            actionButtonsHtml += `<button data-borrower-id="${borrower.id}" data-loan-id="${loan.loanId}" data-payment-index="${index}" class="reschedule-btn bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold py-1 px-2 rounded">
                                <span class="button-text">${rescheduleButtonText}</span>
                                <svg class="spinner-icon w-4 h-4 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>`;
                        } else {
                            actionButtonsHtml = `<span class="text-xs font-bold text-green-700">PAID</span>`;
                             if(payment.paidDate) {
                                actionButtonsHtml += `<span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(${new Date(payment.paidDate).toLocaleDateString()})</span>`;
                            }
                        }

                        let installmentPenalty = 0;
                        if (isPaymentDelayed) {
                            const timeDiff = currentDate.getTime() - dueDate.getTime();
                            daysDelayed = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                            installmentPenalty = (loan.loanAmount * (appSettings.defaultPenaltyRate / 100)) * daysDelayed;
                        }
                        
                        const totalInstallmentDue = payment.amount + installmentPenalty;
                        const paidAmount = payment.paidAmount || 0;
                        let remainingAmount = totalInstallmentDue - paidAmount;
                        if (remainingAmount < 0) remainingAmount = 0;

                        let paymentHistoryHtml = '';
                        if (payment.paymentHistory && payment.paymentHistory.length > 0) {
                            let runningBalance = totalInstallmentDue;
                            paymentHistoryHtml = `
                                <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                                    <h5 class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Payment Summary:</h5>
                                    <div class="payment-timeline space-y-2">
                                        ${payment.paymentHistory.map(p => {
                                            const paidPrincipal = p.paidPrincipal || 0;
                                            const paidInterest = p.paidInterest || 0;
                                            const paidPenalty = p.paidPenalty || 0;
                                            const totalPaid = paidPrincipal + paidInterest + paidPenalty;
                                            return `
                                            <div class="timeline-item">
                                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                                    <span class="font-medium text-gray-700 dark:text-gray-300">₱${totalPaid.toFixed(2)}</span> paid on ${new Date(p.date).toLocaleDateString()}
                                                </p>
                                                <p class="text-xs text-blue-600 dark:text-blue-400 font-semibold">
                                                    (P: ₱${paidPrincipal.toFixed(2)}, I: ₱${paidInterest.toFixed(2)}, Pen: ₱${paidPenalty.toFixed(2)})
                                                </p>
                                            </div>
                                        `}).join('')}
                                    </div>
                                </div>`;
                        }


                        if (isPaymentPaid) {
                             paymentDetailsHtml = `<span class="text-gray-600 dark:text-gray-400">- Paid: ₱${paidAmount.toFixed(2)}</span> ${paymentHistoryHtml}`;
                        } else {
                             paymentDetailsHtml = `
                                <div class="text-sm mt-1 space-x-2">
                                    <span class="text-yellow-600">Due: ₱${payment.amount.toFixed(2)}</span>
                                    <span class="text-orange-600 dark:text-orange-500">Penalty: ₱${installmentPenalty.toFixed(2)}</span>
                                    <span class="text-green-600">Remaining Balance: ₱${remainingAmount.toFixed(2)}</span>
                                </div>
                                ${paymentHistoryHtml}
                             `;
                        }
                        
                        scheduleHtml += `
                            <div class="col-span-full p-2 rounded-md ${isPaymentPaid ? 'bg-green-100 dark:bg-green-900/50' : (isPaymentDelayed ? 'bg-red-100 dark:bg-red-900/50' : (payment.dueDate === todayStr ? 'bg-yellow-100 dark:bg-yellow-900/50' : 'bg-gray-100 dark:bg-gray-700'))}">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-medium text-xs">${index + 1}. Due: ${payment.dueDate}</span>
                                        ${isPaymentDelayed ? `<span class="ml-2 text-xs font-bold text-red-700">DELAYED (${daysDelayed} day/s)</span>` : ''}
                                        ${!isPaymentDelayed && payment.dueDate === todayStr ? `<span class="ml-2 text-xs font-bold text-yellow-700">DUE TODAY</span>` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2">${actionButtonsHtml}</div>
                                </div>
                                ${paymentDetailsHtml}
                            </div>`;
                    });
                }
                
                let reloanSummary = '';
                if (loan.reloanHistory && loan.reloanHistory.length > 0) {
                    reloanSummary = `<span class="text-xs bg-orange-100 text-orange-800 font-medium px-2 py-1 rounded-full">Reloaned ${loan.reloanHistory.length} time(s)</span>`;
                }
                
                const isNotesDisabled = isFullyPaid ? 'disabled' : '';
                const notesBtnClass = isFullyPaid ? 'bg-gray-400 cursor-not-allowed' : 'bg-gray-500 hover:bg-gray-600';


                loansHtml += `
                    <div class="loan-details-card p-3 rounded-lg shadow-inner space-y-2">
                        <div class="flex justify-between items-start">
                             <div class="flex items-center gap-2 flex-wrap">
                                <h4 class="font-bold text-md text-indigo-800 dark:text-indigo-300">${title}</h4>
                                ${reloanSummary}
                             </div>
                             <span class="text-xs font-semibold px-2 py-1 rounded-full ${overallStatus === 'Paid' ? 'bg-green-200 text-green-800' : overallStatus === 'Overdue' ? 'bg-red-200 text-red-800' : 'bg-yellow-200 text-yellow-800'}">${overallStatus}</span>
                        </div>
                        ${loan.notes ? `<div class="text-xs italic text-gray-600 dark:text-gray-400 p-2 bg-gray-100 dark:bg-gray-900/50 rounded-md">${loan.notes}</div>` : ''}
                        <div class="text-sm text-gray-500 dark:text-gray-400 pt-2 border-t dark:border-gray-700/50 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 items-start">
                            <div>
                                <p><strong>Loan Date:</strong> ${loan.loanDate}</p>
                                <p><strong>Final Due:</strong> ${loan.returnDate}</p>
                            </div>
                            <div class="md:text-right">
                                <p><strong>${principalLabel}:</strong> ₱${loan.loanAmount.toFixed(2)}</p>
                                <p><strong>Interest:</strong> ₱${interest.toFixed(2)}</p>
                                ${totalPenalty > 0 ? `<p class="font-bold text-orange-600 dark:text-orange-500"><strong>Penalty:</strong> ₱${totalPenalty.toFixed(2)}</p>` : ''}
                                <p class="font-bold"><strong>Total Due:</strong> ₱${totalDue.toFixed(2)}</p>
                            </div>
                            <div class="col-span-full space-y-1">${scheduleHtml}</div>
                        </div>
                         <div class="mt-3 pt-2 border-t dark:border-gray-700/50 flex justify-end space-x-2">
                             <button data-borrower-id="${borrower.id}" data-loan-id="${loan.loanId}" class="edit-notes-btn text-white text-xs font-bold py-1 px-3 rounded-md transition ${notesBtnClass}" ${isNotesDisabled}>
                                <span class="button-text">Notes</span>
                                <svg class="spinner-icon w-4 h-4 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                             </button>
                             <button data-borrower-id="${borrower.id}" data-loan-id="${loan.loanId}" class="edit-loan-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-1 px-3 rounded-md transition">
                                <span class="button-text">Edit Loan</span>
                                <svg class="spinner-icon w-4 h-4 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                            <button data-borrower-id="${borrower.id}" data-loan-id="${loan.loanId}" class="delete-loan-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-md transition">
                                <span class="button-text">Delete Loan</span>
                                <svg class="spinner-icon w-4 h-4 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
            });

            if (!loansHtml) return null;

            const originalBorrower = allBorrowers.find(b => b.id === borrower.id);
            let totalActive = 0,
                totalOverdue = 0,
                totalPaid = 0;
            originalBorrower.loans.forEach(loan => {
                const isFullyPaid = loan.status === 'Paid';
                if (isFullyPaid) {
                    totalPaid++;
                } else {
                    const hasDelayedPayment = loan.paymentSchedule.some(p => p.status !== 'Paid' && new Date(p.dueDate) < currentDate);
                    if (hasDelayedPayment) totalOverdue++;
                    else totalActive++;
                }
            });


            let summaryHtml = `<span class="text-sm text-green-600">${totalPaid} Paid</span>`;
            if (totalActive > 0) summaryHtml += `, <span class="text-sm text-yellow-600">${totalActive} Active</span>`;
            if (totalOverdue > 0) summaryHtml += `, <span class="text-sm text-red-600">${totalOverdue} Overdue</span>`;

            card.innerHTML = `
                <div class="borrower-card-header p-4 cursor-pointer flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-xl text-gray-900 dark:text-white">${borrower.borrowerName}</h3>
                        <div class="flex gap-2 items-center mt-1">
                           ${summaryHtml}
                        </div>
                    </div>
                    <svg class="chevron-icon w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="collapsible-body px-4 pb-4">
                    <div class="space-y-3">${loansHtml}</div>
                    <div class="mt-4 pt-3 border-t dark:border-gray-700 flex justify-end">
                         <button data-borrower-id="${borrower.id}" class="delete-borrower-btn bg-gray-200 dark:bg-gray-700 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-700 dark:text-red-300 text-xs font-bold py-1 px-3 rounded-md transition">
                            <span class="button-text">Delete All Records for this Borrower</span>
                            <svg class="spinner-icon w-4 h-4 text-red-700 dark:text-red-300 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                         </button>
                    </div>
                </div>
            `;

            card.querySelector('.borrower-card-header').addEventListener('click', (e) => {
                if (e.target.closest('button')) return;
                const isExpanded = card.classList.toggle('expanded');
                if (isExpanded) {
                    expandedBorrowerIds.add(borrower.id);
                } else {
                    expandedBorrowerIds.delete(borrower.id);
                }
            });

            if (expandedBorrowerIds.has(borrower.id)) {
                card.classList.add('expanded');
            }

            card.querySelectorAll('.payment-paid-btn').forEach(btn => btn.addEventListener('click', e => handlePaymentClick(e)));
            card.querySelectorAll('.mark-as-paid-btn').forEach(btn => btn.addEventListener('click', e => handleMarkAsPaidClick(e)));
            card.querySelectorAll('.reschedule-btn').forEach(btn => btn.addEventListener('click', e => handleRescheduleClick(e)));
            card.querySelectorAll('.edit-notes-btn').forEach(btn => btn.addEventListener('click', e => handleEditNotesClick(e)));
            card.querySelectorAll('.edit-loan-btn').forEach(btn => btn.addEventListener('click', e => handleEditLoanClick(e)));

            // --- CORRECTED DELETE LOAN LOGIC ---
            card.querySelectorAll('.delete-loan-btn').forEach(btn => btn.addEventListener('click', e => {
                const { borrowerId, loanId } = e.currentTarget.dataset;
                showConfirm('Delete Loan', 'Are you sure you want to delete this specific loan record?', async (confirmed) => {
                    if (!confirmed) return; // <-- This is the fix

                    toggleButtonSpinner(e.currentTarget, true);
                    const borrowerDoc = allBorrowers.find(b => b.id === borrowerId);
                    const updatedLoans = borrowerDoc.loans.filter(l => l.loanId !== loanId);
                    try {
                        if (updatedLoans.length === 0) {
                             // If no loans left, you might want to keep the borrower for history or delete them.
                             // This example keeps the borrower but empties their loans.
                             await updateDoc(doc(db, borrowersPath, borrowerId), { loans: [] });
                        } else {
                            await updateDoc(doc(db, borrowersPath, borrowerId), { loans: updatedLoans });
                        }
                        showAlert('Success', 'Loan record deleted.');
                    } catch(error) {
                        console.error("Error deleting loan:", error);
                        showAlert('Error', 'Failed to delete loan.');
                    } finally {
                        toggleButtonSpinner(e.currentTarget, false);
                    }
                });
            }));

            // --- CORRECTED DELETE BORROWER LOGIC ---
            card.querySelector('.delete-borrower-btn').addEventListener('click', e => {
                const { borrowerId } = e.currentTarget.dataset;
                showConfirm('Delete Borrower', 'Are you sure you want to delete this borrower and ALL their loan records? This action cannot be undone.', async (confirmed) => {
                    if (!confirmed) return; // <-- This is the fix

                    toggleButtonSpinner(e.currentTarget, true);
                    try {
                        await deleteDoc(doc(db, borrowersPath, borrowerId));
                         showAlert('Success', 'Borrower and all their records have been deleted.');
                    } catch(error) {
                        console.error("Error deleting borrower:", error);
                        showAlert('Error', 'Failed to delete borrower.');
                    } finally {
                        toggleButtonSpinner(e.currentTarget, false);
                    }
                });
            });

            return card;
        }

        async function handlePaymentClick(e) {
            const { borrowerId, loanId, paymentIndex } = e.currentTarget.dataset;
            const borrowerRef = doc(db, borrowersPath, borrowerId);
            const borrowerSnap = await getDoc(borrowerRef);
            if (!borrowerSnap.exists()) {
                showAlert('Error', 'Borrower not found in database.');
                return;
            }
            const borrowerDoc = borrowerSnap.data();
            const loan = borrowerDoc.loans.find(l => l.loanId === loanId);
            const payment = loan.paymentSchedule[paymentIndex];

            // --- CORRECTED DATE LOGIC ---
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
            const dueDate = new Date(payment.dueDate);
            dueDate.setHours(0, 0, 0, 0); // Also set to start of day

            const loanInterest = loan.isCustomInterest ? loan.customInterest : loan.loanAmount * (loan.interestRate / 100);
            const installmentPrincipal = loan.loanAmount / loan.numberOfPayments;
            const installmentInterest = loanInterest / loan.numberOfPayments;

            let installmentPenalty = 0;
            // Only apply penalty if the due date is strictly before today
            if (dueDate < today) {
                const daysDelayed = Math.max(0, Math.ceil((today - dueDate) / (1000 * 3600 * 24)));
                installmentPenalty = (loan.loanAmount * (appSettings.defaultPenaltyRate / 100)) * daysDelayed;
            }

            const totalInstallmentDue = installmentPrincipal + installmentInterest + installmentPenalty;
            const remainingAmount = totalInstallmentDue - (payment.paidAmount || 0);

            const modal = document.getElementById('partialPaymentModal');
            const form = document.getElementById('partialPaymentForm');
            const amountInput = document.getElementById('paymentAmount');
            const detailsEl = document.getElementById('paymentDetails');
            
            amountInput.value = remainingAmount > 0 ? remainingAmount.toFixed(2) : "0.00";
            amountInput.max = remainingAmount > 0 ? remainingAmount.toFixed(2) : "0.00";
            detailsEl.textContent = `Principal Due: ₱${installmentPrincipal.toFixed(2)}, Interest Due: ₱${installmentInterest.toFixed(2)}, Penalty Due: ₱${installmentPenalty.toFixed(2)}, Total Paid: ₱${(payment.paidAmount || 0).toFixed(2)}`;
            
            form.onsubmit = async (submitEvent) => {
                toggleButtonSpinner(submitEvent.submitter, true);
                try {
                    submitEvent.preventDefault();
                    let paymentAmount = parseFloat(amountInput.value);
                    if (isNaN(paymentAmount) || paymentAmount <= 0) {
                        return showAlert('Invalid Amount', `Please enter a valid amount.`);
                    }

                    const updatedLoans = JSON.parse(JSON.stringify(borrowerDoc.loans));
                    const loanToUpdate = updatedLoans.find(l => l.loanId === loanId);
                    const paymentToUpdate = loanToUpdate.paymentSchedule[paymentIndex];

                    const paidBreakdown = {
                        date: new Date().toISOString(),
                        amount: paymentAmount,
                        paidPrincipal: 0,
                        paidInterest: 0,
                        paidPenalty: 0,
                        recordedBy: currentUser.email
                    };
                    
                    // --- CORRECTED PAYMENT DISTRIBUTION LOGIC ---
                    const alreadyPaidPenalty = paymentToUpdate.paymentHistory?.reduce((sum, p) => sum + (p.paidPenalty || 0), 0) || 0;
                    const alreadyPaidInterest = paymentToUpdate.paymentHistory?.reduce((sum, p) => sum + (p.paidInterest || 0), 0) || 0;
                    const alreadyPaidPrincipal = paymentToUpdate.paymentHistory?.reduce((sum, p) => sum + (p.paidPrincipal || 0), 0) || 0;

                    let remainingPayment = paymentAmount;
                    
                    let penaltyToPay = installmentPenalty - alreadyPaidPenalty;
                    if (remainingPayment > 0 && penaltyToPay > 0) {
                         const penaltyPaid = Math.min(remainingPayment, penaltyToPay);
                         paidBreakdown.paidPenalty = penaltyPaid;
                         remainingPayment -= penaltyPaid;
                    }
                    
                    let interestToPay = installmentInterest - alreadyPaidInterest;
                    if (remainingPayment > 0 && interestToPay > 0) {
                        const interestPaid = Math.min(remainingPayment, interestToPay);
                        paidBreakdown.paidInterest = interestPaid;
                        remainingPayment -= interestPaid;
                    }

                    let principalToPay = installmentPrincipal - alreadyPaidPrincipal;
                    if (remainingPayment > 0 && principalToPay > 0) {
                        const principalPaid = Math.min(remainingPayment, principalToPay);
                        paidBreakdown.paidPrincipal = principalPaid;
                        remainingPayment -= principalPaid;
                    }
                    
                    if (!paymentToUpdate.paymentHistory) {
                        paymentToUpdate.paymentHistory = [];
                    }
                    paymentToUpdate.paymentHistory.push(paidBreakdown);

                    paymentToUpdate.paidAmount = (paymentToUpdate.paidAmount || 0) + paymentAmount;
                    const newRemaining = totalInstallmentDue - paymentToUpdate.paidAmount;

                    if (newRemaining <= 0.01) { 
                        paymentToUpdate.status = 'Paid';
                        paymentToUpdate.paidDate = new Date().toISOString();
                    } else {
                        paymentToUpdate.status = 'Partially Paid';
                    }

                    const allPaid = loanToUpdate.paymentSchedule.every(p => p.status === 'Paid');
                    if (allPaid) {
                        loanToUpdate.status = 'Paid';
                    }

                    await updateDoc(doc(db, borrowersPath, borrowerId), { loans: updatedLoans });
                    await addDoc(collection(db, activityLogPath), {
                        action: 'recorded a payment',
                        details: `for a loan for ${borrowerDoc.borrowerName}`,
                        timestamp: serverTimestamp(),
                        user: currentUser.email
                    });
                    modal.style.display = 'none';
                    showAlert('Success', 'Payment has been recorded.');
                } finally {
                    toggleButtonSpinner(submitEvent.submitter, false);
                }
            };

            modal.style.display = 'flex';
        }

        async function handleMarkAsPaidClick(e) {
            const { borrowerId, loanId, paymentIndex } = e.currentTarget.dataset;
            const button = e.currentTarget; // Keep track of the button
            toggleButtonSpinner(button, true); // Show spinner immediately

            showConfirm('Mark as Paid', 'Are you sure you want to mark this installment as fully paid?', async (confirmed) => {
                 if (!confirmed) {
                    toggleButtonSpinner(button, false);
                    return;
                }
                try {
                    const borrowerRef = doc(db, borrowersPath, borrowerId);
                    const borrowerSnap = await getDoc(borrowerRef);
                    if (!borrowerSnap.exists()) {
                        showAlert('Error', 'Borrower not found in database.');
                        return;
                    }
                    const borrowerDoc = borrowerSnap.data();
                    const updatedLoans = JSON.parse(JSON.stringify(borrowerDoc.loans));
                    const loanToUpdate = updatedLoans.find(l => l.loanId === loanId);
                    const paymentToUpdate = loanToUpdate.paymentSchedule[paymentIndex];

                    const loanInterest = loanToUpdate.isCustomInterest ? loanToUpdate.customInterest : loanToUpdate.loanAmount * (loanToUpdate.interestRate / 100);
                    const installmentPrincipal = loanToUpdate.loanAmount / loanToUpdate.numberOfPayments;
                    const installmentInterest = loanInterest / loanToUpdate.numberOfPayments;

                    let installmentPenalty = 0;
                    if (new Date(paymentToUpdate.dueDate) < new Date()) {
                        const daysDelayed = Math.max(0, Math.ceil((new Date() - new Date(paymentToUpdate.dueDate)) / (1000 * 3600 * 24)));
                        installmentPenalty = (loanToUpdate.loanAmount * (appSettings.defaultPenaltyRate / 100)) * daysDelayed;
                    }
                    
                    const totalInstallmentDue = installmentPrincipal + installmentInterest + installmentPenalty;
                    const remainingAmount = totalInstallmentDue - (paymentToUpdate.paidAmount || 0);

                    if (!paymentToUpdate.paymentHistory) {
                        paymentToUpdate.paymentHistory = [];
                    }
                    if (remainingAmount > 0) {
                        paymentToUpdate.paymentHistory.push({
                            amount: remainingAmount,
                            date: new Date().toISOString(),
                            paidPrincipal: installmentPrincipal - (paymentToUpdate.paymentHistory.reduce((acc, p) => acc + p.paidPrincipal, 0) || 0),
                            paidInterest: installmentInterest - (paymentToUpdate.paymentHistory.reduce((acc, p) => acc + p.paidInterest, 0) || 0),
                            paidPenalty: installmentPenalty - (paymentToUpdate.paymentHistory.reduce((acc, p) => acc + p.paidPenalty, 0) || 0),
                            recordedBy: currentUser.email
                        });
                    }

                    paymentToUpdate.paidAmount = totalInstallmentDue;
                    paymentToUpdate.status = 'Paid';
                    paymentToUpdate.paidDate = new Date().toISOString();

                    const allPaid = loanToUpdate.paymentSchedule.every(p => p.status === 'Paid');
                    if (allPaid) {
                        loanToUpdate.status = 'Paid';
                    }

                    await updateDoc(doc(db, borrowersPath, borrowerId), { loans: updatedLoans });
                    await addDoc(collection(db, activityLogPath), {
                        action: 'marked as paid',
                        details: `an installment for a loan for ${borrowerDoc.borrowerName}`,
                        timestamp: serverTimestamp(),
                        user: currentUser.email
                    });
                    showAlert('Success', 'Installment marked as paid.');
                 } finally {
                    toggleButtonSpinner(button, false);
                 }
            });
        }
        
        async function handleRescheduleClick(e) {
            const { borrowerId, loanId, paymentIndex } = e.currentTarget.dataset;
            const button = e.currentTarget;

            showConfirm('Confirm Reschedule', 'This will reschedule the due date for this and all future payments. Are you sure?', async (confirmed) => {
                if (!confirmed) return;
                toggleButtonSpinner(button, true);
                try {
                    const borrowerRef = doc(db, borrowersPath, borrowerId);
                    const borrowerSnap = await getDoc(borrowerRef);
                    if (!borrowerSnap.exists()) {
                        return showAlert('Error', 'Borrower not found in database.');
                    }
                    const borrowerDoc = borrowerSnap.data();
                    const updatedLoans = JSON.parse(JSON.stringify(borrowerDoc.loans));
                    const targetLoan = updatedLoans.find(l => l.loanId === loanId);
                    
                    if (!targetLoan) {
                        return showAlert('Error', 'Loan not found in borrower records.');
                    }

                    if (!targetLoan.reloanHistory) {
                        targetLoan.reloanHistory = [];
                    }
                    targetLoan.reloanHistory.push({
                        reloanDate: new Date().toISOString(),
                        rescheduledInstallmentIndex: parseInt(paymentIndex),
                        recordedBy: currentUser.email
                    });

                    let nextDueDate = new Date(targetLoan.paymentSchedule[parseInt(paymentIndex)].dueDate); 
                    for(let i = parseInt(paymentIndex); i < targetLoan.paymentSchedule.length; i++) {
                        if (targetLoan.paymentSchedule[i].status !== 'Paid') {
                            const freq = targetLoan.paymentFrequency;
                            if (freq === 'weekly') nextDueDate.setDate(nextDueDate.getDate() + 7);
                            else if (freq === 'bi-weekly') nextDueDate.setDate(nextDueDate.getDate() + 14);
                            else nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                            targetLoan.paymentSchedule[i].dueDate = nextDueDate.toISOString().split('T')[0];
                        }
                    }
                    targetLoan.returnDate = targetLoan.paymentSchedule[targetLoan.paymentSchedule.length - 1].dueDate;
                    
                    await updateDoc(doc(db, borrowersPath, borrowerId), { loans: updatedLoans });
                    await addDoc(collection(db, activityLogPath), {
                        action: 'rescheduled a loan',
                        details: `for ${borrowerDoc.borrowerName}`,
                        timestamp: serverTimestamp(),
                        user: currentUser.email
                    });
                    showAlert('Success', 'Schedule updated.');
                } catch(error) {
                    console.error("Error during reschedule:", error);
                    showAlert('Error', 'An unexpected error occurred during reschedule.');
                } finally {
                    toggleButtonSpinner(button, false);
                }
            });
        }

        async function handleEditNotesClick(e) {
            const { borrowerId, loanId } = e.currentTarget.dataset;
            const borrowerRef = doc(db, borrowersPath, borrowerId);
            const borrowerSnap = await getDoc(borrowerRef);
            if (!borrowerSnap.exists()) {
                return showAlert('Error', 'Borrower not found in database.');
            }
            const borrowerDoc = borrowerSnap.data();
            const loan = borrowerDoc.loans.find(l => l.loanId === loanId);

            const modal = document.getElementById('editNotesModal');
            const form = document.getElementById('editNotesForm');
            const notesText = document.getElementById('loanNotesText');

            notesText.value = loan.notes || '';

            form.onsubmit = async (submitEvent) => {
                const button = submitEvent.submitter;
                toggleButtonSpinner(button, true);
                try {
                    submitEvent.preventDefault();
                    // Re-fetch the latest data right before updating
                    const currentSnap = await getDoc(borrowerRef);
                    const currentData = currentSnap.data();
                    const updatedLoans = JSON.parse(JSON.stringify(currentData.loans));

                    const loanToUpdate = updatedLoans.find(l => l.loanId === loanId);
                    loanToUpdate.notes = notesText.value.trim();

                    await updateDoc(borrowerRef, { loans: updatedLoans });
                     await addDoc(collection(db, activityLogPath), {
                        action: 'updated notes',
                        details: `for loan for ${currentData.borrowerName}`,
                        timestamp: serverTimestamp(),
                        user: currentUser.email
                    });
                    modal.style.display = 'none';
                    showAlert('Success', 'Notes updated.');
                } finally {
                    toggleButtonSpinner(button, false);
                }
            };

            modal.style.display = 'flex';
        }
        
        async function handleEditLoanClick(e) {
            const { borrowerId, loanId } = e.currentTarget.dataset;
            const borrower = allBorrowers.find(b => b.id === borrowerId);
            if (!borrower) return showAlert('Error', 'Borrower not found.');
            const loan = borrower.loans.find(l => l.loanId === loanId);
            if (!loan) return showAlert('Error', 'Loan not found.');
            
            const editLoanModal = document.getElementById('editLoanModal');
            const editLoanForm = document.getElementById('editLoanForm');
            
            // --- UPDATED HTML FOR THE MODAL ---
            editLoanForm.innerHTML = `
                <input type="hidden" name="borrowerId" value="${borrowerId}">
                <input type="hidden" name="loanId" value="${loanId}">
                <div>
                    <label for="editLoanAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Amount (₱)</label>
                    <input type="number" id="editLoanAmount" name="loanAmount" min="0" step="0.01" required value="${loan.loanAmount}" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                </div>

                <div id="editInterestRateSection">
                    <label for="editInterestRate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Interest Rate (%)</label>
                    <input type="number" id="editInterestRate" name="interestRate" min="0" step="0.1" value="${loan.interestRate || 0}" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                </div>

                <div id="editCustomInterestSection" class="hidden">
                    <label for="editCustomInterest" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Interest (₱)</label>
                    <input type="number" id="editCustomInterest" name="customInterest" min="0" step="0.01" value="${loan.customInterest || 0}" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                </div>

                <div class="flex items-center">
                    <input id="editCustomInterestCheckbox" name="isCustomInterest" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="editCustomInterestCheckbox" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Custom Interest</label>
                </div>

                 <div>
                    <label for="editLoanDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Date</label>
                    <input type="date" id="editLoanDate" name="loanDate" required value="${loan.loanDate}" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="editReturnDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Final Due Date</label>
                    <input type="date" id="editReturnDate" name="returnDate" required value="${loan.returnDate || ''}" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                </div>
                <div class="flex items-center mt-4 p-3 bg-yellow-50 dark:bg-gray-700 rounded-md">
                    <input id="resetPenaltyCheckbox" name="resetPenalty" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                    <label for="resetPenaltyCheckbox" class="ml-2 block text-sm text-red-700 dark:text-red-400 font-medium">Reset Penalty (This will move all overdue payments to today's date)</label>
                </div>
                <button type="submit" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg">
                    <span class="button-text">Update Loan</span>
                    <svg class="spinner-icon w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            `;

            // --- LOGIC TO HANDLE CHECKBOX AND VISIBILITY ---
            const customInterestCheckbox = document.getElementById('editCustomInterestCheckbox');
            const interestRateSection = document.getElementById('editInterestRateSection');
            const customInterestSection = document.getElementById('editCustomInterestSection');

            // Set initial state from loan data
            customInterestCheckbox.checked = loan.isCustomInterest || false;

            const toggleInterestFields = () => {
                if (customInterestCheckbox.checked) {
                    interestRateSection.style.display = 'none';
                    customInterestSection.style.display = 'block';
                } else {
                    interestRateSection.style.display = 'block';
                    customInterestSection.style.display = 'none';
                }
            };
            
            toggleInterestFields(); // Call on modal open
            customInterestCheckbox.addEventListener('change', toggleInterestFields); // Add listener for changes

            // --- UPDATED SUBMISSION LOGIC ---
            editLoanForm.onsubmit = async (submitEvent) => {
                 submitEvent.preventDefault();
                 const button = submitEvent.submitter;
                 toggleButtonSpinner(button, true);
                 
                try {
                    const formData = new FormData(editLoanForm);
                    const loanAmount = parseFloat(formData.get('loanAmount'));
                    const interestRate = parseFloat(formData.get('interestRate')) || 0;
                    const customInterest = parseFloat(formData.get('customInterest')) || 0;
                    const isCustomInterest = formData.get('isCustomInterest') === 'on';
                    const loanDate = formData.get('loanDate');
                    const returnDate = formData.get('returnDate');
                    const resetPenalty = formData.get('resetPenalty') === 'on';

                    if (isNaN(loanAmount) || loanAmount <= 0) {
                        return showAlert('Validation Error', 'Please enter a valid loan amount.');
                    }
                    if (!loanDate || !returnDate) {
                         return showAlert('Validation Error', 'Please select both a loan date and a final due date.');
                    }

                    const borrowerRef = doc(db, borrowersPath, borrowerId);
                    const borrowerDoc = await getDoc(borrowerRef);
                    const borrowerData = borrowerDoc.data();
                    const loans = borrowerData.loans.map(l => {
                        if (l.loanId === loanId) {
                            const updatedLoan = { 
                                ...l, 
                                loanAmount, 
                                interestRate, 
                                customInterest,
                                isCustomInterest,
                                loanDate, 
                                returnDate 
                            };
                            
                            if (resetPenalty) {
                                const todayStr = new Date().toISOString().split('T')[0];
                                const today = new Date(todayStr);

                                updatedLoan.paymentSchedule.forEach(payment => {
                                    const dueDate = new Date(payment.dueDate);
                                    if (payment.status !== 'Paid' && dueDate < today) {
                                        payment.dueDate = todayStr;
                                    }
                                });
                                if (updatedLoan.paymentSchedule.length > 0) {
                                     updatedLoan.returnDate = updatedLoan.paymentSchedule[updatedLoan.paymentSchedule.length - 1].dueDate;
                                }
                                if (!updatedLoan.reloanHistory) updatedLoan.reloanHistory = [];
                                updatedLoan.reloanHistory.push({
                                    reloanDate: new Date().toISOString(),
                                    rescheduledInstallmentIndex: 'Penalty Reset',
                                    recordedBy: currentUser.email
                                });
                            }
                            return updatedLoan;
                        }
                        return l;
                    });
                    
                    await updateDoc(borrowerRef, { loans });

                    showAlert('Success', 'Loan updated successfully.');
                    editLoanModal.style.display = 'none';

                } catch (error) {
                    console.error("Error updating loan:", error);
                    showAlert('Error', 'Failed to update loan.');
                } finally {
                    toggleButtonSpinner(button, false);
                }
            };
            
            editLoanModal.style.display = 'flex';
        }


        function renderLoanTable() {
            const tableBody = document.getElementById('loanTableBody');
            tableBody.innerHTML = '';
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            let flatLoans = [];
            allBorrowers.forEach(borrower => {
                borrower.loans.forEach(loan => {
                     const isFullyPaid = loan.status === 'Paid';
                    let hasDelayedPayment = false;
                    let totalPenalty = 0;

                    if (!isFullyPaid && loan.paymentSchedule) {
                        loan.paymentSchedule.forEach(p => {
                            if (p.status !== 'Paid' && new Date(p.dueDate) < currentDate) {
                                hasDelayedPayment = true;
                                const timeDiff = currentDate.getTime() - new Date(p.dueDate).getTime();
                                const daysDelayed = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                                totalPenalty += (loan.loanAmount * (appSettings.defaultPenaltyRate / 100)) * daysDelayed;
                            }
                        });
                    }
                    const overallStatus = isFullyPaid ? 'Paid' : hasDelayedPayment ? 'Overdue' : 'Active';
                    const interest = loan.isCustomInterest ? loan.customInterest : loan.loanAmount * (loan.interestRate / 100);
                    const totalDue = loan.loanAmount + interest + totalPenalty;

                    flatLoans.push({
                        borrowerName: borrower.borrowerName,
                        loanType: loan.loanType,
                        productName: loan.productName,
                        loanAmount: loan.loanAmount,
                        interest: interest,
                        totalPenalty: totalPenalty,
                        totalDue: totalDue,
                        loanDate: loan.loanDate,
                        status: overallStatus
                    });
                });
            });

            flatLoans.sort((a, b) => {
                const valA = a[sortState.column];
                const valB = b[sortState.column];
                const direction = sortState.direction === 'asc' ? 1 : -1;

                if (typeof valA === 'string') {
                    return valA.localeCompare(valB) * direction;
                } else {
                    return (valA - valB) * direction;
                }
            });

            flatLoans.forEach(loan => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 dark:hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${loan.borrowerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${loan.loanType === 'Product' ? loan.productName : loan.loanType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">₱${loan.loanAmount.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">₱${loan.interest.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-500">₱${loan.totalPenalty.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800 dark:text-gray-200">₱${loan.totalDue.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${loan.loanDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            loan.status === 'Paid' ? 'bg-green-100 text-green-800' :
                            loan.status === 'Overdue' ? 'bg-red-100 text-red-800' :
                            'bg-yellow-100 text-yellow-800'
                        }">${loan.status}</span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- CSV Import/Export ---
        function exportToCSV(borrowers) {
            const headers = ['Borrower Name', 'Loan Type', 'Product Name', 'Loan Amount', 'Interest Rate', 'Loan Date', 'Final Due Date', 'Status', 'Notes'];
            const rows = [];

            borrowers.forEach(borrower => {
                borrower.loans.forEach(loan => {
                    const isFullyPaid = loan.status === 'Paid';
                    const currentDate = new Date();
                    currentDate.setHours(0, 0, 0, 0);
                    let hasDelayedPayment = false;
                    if (loan.paymentSchedule && !isFullyPaid) {
                        hasDelayedPayment = loan.paymentSchedule.some(p => p.status !== 'Paid' && new Date(p.dueDate) < currentDate);
                    }
                    const overallStatus = isFullyPaid ? 'Paid' : hasDelayedPayment ? 'Overdue' : 'Active';

                    rows.push([
                        `"${borrower.borrowerName}"`,
                        loan.loanType,
                        loan.productName || '',
                        loan.loanAmount,
                        loan.interestRate,
                        loan.loanDate,
                        loan.returnDate,
                        overallStatus,
                        `"${(loan.notes || '').replace(/"/g, '""')}"`
                    ].join(','));
                });
            });

            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "loan_records.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function importFromCSV(file) {
            if (!file) {
                 toggleButtonSpinner(document.getElementById('importButton'), false);
                 return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n').slice(1);
                const batch = writeBatch(db);
                const borrowersToUpdate = new Map();

                rows.forEach(rowStr => {
                    if (!rowStr.trim()) return;
                    const columns = rowStr.split(',');
                    const borrowerName = columns[0].replace(/"/g, '').trim();

                    const newLoan = {
                        loanId: crypto.randomUUID(),
                        loanType: columns[1],
                        productName: columns[2] || '',
                        loanAmount: parseFloat(columns[3]),
                        interestRate: parseFloat(columns[4]),
                        loanDate: columns[5],
                        status: 'Active',
                        paymentFrequency: 'weekly',
                        numberOfPayments: 1,
                        reloanHistory: [],
                        notes: (columns[8] || '').replace(/"/g, '')
                    };
                    
                    const paymentSchedule = [];
                    const totalInterest = newLoan.loanAmount * (newLoan.interestRate / 100);
                    const installmentAmount = (newLoan.loanAmount + totalInterest) / newLoan.numberOfPayments;
                    let nextDueDate = new Date(newLoan.loanDate);
                    nextDueDate.setDate(nextDueDate.getDate() + 7);
                    
                    paymentSchedule.push({
                        dueDate: nextDueDate.toISOString().split('T')[0],
                        amount: installmentAmount,
                        status: 'Pending',
                        paidAmount: 0,
                        paidDate: null,
                        paymentHistory: []
                    });
                    newLoan.paymentSchedule = paymentSchedule;
                    newLoan.returnDate = paymentSchedule[paymentSchedule.length - 1].dueDate;

                    if (!borrowersToUpdate.has(borrowerName)) {
                        borrowersToUpdate.set(borrowerName, []);
                    }
                    borrowersToUpdate.get(borrowerName).push(newLoan);
                });

                for (const [name, loansToAdd] of borrowersToUpdate.entries()) {
                    const q = query(collection(db, borrowersPath), where("borrowerName", "==", name));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        const newBorrowerRef = doc(collection(db, borrowersPath));
                        batch.set(newBorrowerRef, { borrowerName: name, loans: loansToAdd, createdAt: serverTimestamp() });
                    } else {
                        const borrowerRef = querySnapshot.docs[0].ref;
                        batch.update(borrowerRef, { loans: arrayUnion(...loansToAdd) });
                    }
                }

                try {
                    await batch.commit();
                    showAlert('Success', 'CSV data imported successfully!');
                } catch (error) {
                    console.error("Error importing CSV: ", error);
                    showAlert('Import Error', 'Failed to import CSV data. Please check the file format and console.');
                } finally {
                    toggleButtonSpinner(document.getElementById('importButton'), false);
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
