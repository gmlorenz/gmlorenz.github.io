<!DOCTYPE html>
<html>
<head>
    <title>123 - Fixpoint Extractor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f4f6f8;
            font-family: 'Open Sans', sans-serif;
            color: #333;
        }
        h5, h4 {
            font-family: 'Roboto Slab', serif;
            color: #0d47a1;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .result {
            background: #e3f2fd;
            padding: 20px;
            margin-top: 20px;
            white-space: pre-wrap;
            border-left: 4px solid #2196f3;
            font-family: 'Courier New', monospace;
            min-height: 100px;
            border-radius: 4px;
            overflow-x: auto;
            position: relative;
        }
        .result-buttons {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 1;
        }
        .result-buttons .expand-button,
        .result-buttons .view-data-result-button {
            background-color: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            transition: background-color 0.3s ease;
            margin-left: 5px;
        }
        .result-buttons .expand-button:hover,
        .result-buttons .view-data-result-button:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }
        .result-buttons .expand-button i.material-icons,
        .result-buttons .view-data-result-button i.material-icons {
            font-size: 18px;
            color: #333;
        }
        .result table.striped tbody tr:nth-child(odd) {
            background-color: #bbdefb;
        }
        .result table.striped tbody tr:nth-child(even) {
            background-color: #e3f2fd;
        }
        .result table th {
            background-color: #1976d2;
            color: white;
        }
        .result table td, .result table th {
            padding: 12px 15px;
            border: 1px solid #b0bec5;
        }
        .result table {
            border-collapse: collapse;
            width: 100%;
        }
        .modal textarea {
            height: 150px;
            overflow-y: auto;
            resize: none;
        }
        .modal-content textarea.materialize-textarea {
            height: 150px !important;
            overflow-y: auto;
            resize: none;
        }
        .input-field {
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .input-field input:focus + label,
        .input-field textarea:focus + label {
            color: #2196f3 !important;
        }
        .input-field input:focus,
        .input-field textarea:focus {
            border-bottom: 1px solid #2196f3 !important;
            box-shadow: 0 1px 0 0 #2196f3 !important;
        }
        .input-field select:focus {
            outline: 1px solid #2196f3;
        }
        .btn {
            margin-top: 15px;
            margin-bottom: 15px;
            margin-right: 10px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn.blue { background-color: #2196f3 !important; }
        .btn.green { background-color: #4CAF50 !important; }
        .btn.orange.darken-2 { background-color: #f57c00 !important; }
        .btn.red.darken-2 { background-color: #d32f2f !important; }
        .btn.purple.darken-2 { background-color: #7b1fa2 !important; }
        .btn.red { background-color: #f44336 !important; }
        .btn.blue.darken-1 { background-color: #1976d2 !important; }
        .btn.deep-purple.darken-2 { background-color: #512da8 !important; }
        .btn.grey.darken-1 { background-color: #757575 !important; }
        .right-align {
            margin-bottom: 20px;
        }
        .center-align {
            margin-top: 25px;
            margin-bottom: 25px;
        }
        #all-results {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 30px;
        }
        #all-results h5 {
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .modal-content h5 {
            margin-bottom: 20px;
        }
        .modal-content .input-field {
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .modal-footer a {
            margin-left: 10px;
        }
        #login-modal {
            max-width: 400px;
            border-radius: 8px;
            margin: auto;
        }
        #login-modal .modal-content {
            padding: 30px;
            text-align: center;
            background-color: #ffffff;
        }
        #login-modal .modal-content h5 {
            margin-bottom: 25px;
            color: #0d47a1;
        }
        #login-modal .input-field {
            margin-bottom: 20px;
        }
        #login-modal .modal-footer {
            padding: 15px;
            text-align: center;
            background-color: #e3f2fd;
            border-top: 1px solid #bbdefb;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        #login-modal .btn {
            width: 100%;
            margin-right: 0;
            background-color: #2196f3 !important;
        }
        #logout-button {
            margin-left: auto;
        }
        #fullscreen-results-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        #fullscreen-results-content {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 95%;
            overflow: auto;
            position: relative;
        }
        #fullscreen-results-content .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            transition: background-color 0.3s ease;
            z-index: 2;
        }
        #fullscreen-results-content .close-button:hover {
            background-color: rgba(255, 255, 255, 1);
        }
        #fullscreen-results-content .close-button i.material-icons {
            font-size: 18px;
            color: #333;
        }
        #view-data-modal {
            max-width: 95%;
            max-height: 95%;
            width: 95%;
            height: 95%;
            top: 2.5% !important;
            transform: translate(-50%, 0%) !important;
            left: 50% !important;
        }
        #view-data-modal .modal-content {
            overflow-y: auto;
            max-height: calc(100% - 60px);
            padding-bottom: 0;
        }
        #view-data-modal table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        #view-data-modal table th,
        #view-data-modal table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }
        #view-data-modal table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        #view-data-table-container .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
            }
            .btn {
                margin-right: 5px;
                margin-bottom: 10px;
            }
            .center-align {
                margin-top: 15px;
                margin-bottom: 15px;
            }
            #all-results {
                max-height: 400px;
            }
            #fullscreen-results-content {
                max-width: 95%;
                max-height: 95%;
            }
            #view-data-modal {
                max-width: 95%;
                width: 95%;
                height: 95%;
                top: 2.5% !important;
                transform: translate(-50%, 0%) !important;
                left: 50% !important;
            }
        }
        /* Custom styles for Quality and Bonus */
        .quality-green {
            background-color: #e8f5e9; /* Light Green */
            color: #2e7d32; /* Dark Green */
            font-weight: bold;
        }
        .quality-orange {
            background-color: #fff3e0; /* Light Orange */
            color: #ef6c00; /* Dark Orange */
            font-weight: bold;
        }
        .quality-red { /* For bonus below 50% or 0% */
            background-color: #ffebee; /* Light Red */
            color: #c62828; /* Dark Red */
            font-weight: bold;
        }
        .tech-id-highlight { /* For bold Tech IDs */
            font-weight: bold;
        }
        .salary-highlight { /* Style for Estimated Salary */
            background-color: #f0f0f0; /* Light Gray */
            color: #333; /* Darker text */
            font-weight: bold;
        }
        .tech-id-red-highlight { /* For Tech IDs less than 6 digits */
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h5 class="center-align">Login</h5>
            <div class="input-field">
                <select id="login-role">
                    <option value="" disabled selected>Choose your role</option>
                    <option value="tl">Login as TL</option>
                    <option value="tech">Login as Tech</option>
                </select>
                <label for="login-role">Select Role</label>
            </div>
            <div class="input-field" id="tl-code-input" style="display: none;">
                <input id="tl-login-code" type="password">
                <label for="tl-login-code">TL Login Code</label>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn blue" id="login-button">Login</a>
        </div>
    </div>

    <div class="container" id="main-app-content" style="display: none;">
        <h5 class="center-align">123 EXTRACTOR v2.5</h5>
        <div class="right-align" style="margin-top: 10px;">
            <a class="btn-floating btn-large green modal-trigger" href="#add-project-modal" id="add-project-button">
                <i class="material-icons">add</i>
            </a>
        </div>
        <div class="input-field">
            <select id="project-selector">
                <option value="" disabled selected>Select a saved project</option>
            </select>
            <label for="project-selector">Load Project</label>
        </div>
        <div class="center-align">
            <button class="btn orange darken-2" id="edit-project">
                <i class="material-icons left">edit</i>Edit Project
            </button>
            <button class="btn red darken-2" id="delete-project">
                <i class="material-icons left">delete</i>Delete Project
            </button>
            <button class="btn blue-grey darken-1 modal-trigger" href="#view-data-modal" id="view-project-data-button">
                <i class="material-icons left">table_chart</i>View Data
            </button>
        </div>
        <div class="input-field">
            <input id="tech-id" type="text" placeholder="e.g. TECH123">
            <label for="tech-id">Search TECH ID</label>
        </div>
        <div class="center-align">
            <button class="btn blue" id="search-button">
                <i class="material-icons left">search</i>Search
            </button>
            <button class="btn green" id="calculate-all-button">
                <i class="material-icons left">calculate</i>Per Project Total
            </button>
            <button class="btn purple darken-2 modal-trigger" href="#multiplier-modal" id="calculate-all-projects-button">
                <i class="material-icons left">grid_on</i>All Projects Total
            </button>
        </div>
        <div class="center-align" style="margin-top: 10px;">
            <button class="btn orange" id="export-button">
                <i class="material-icons left">file_download</i>Download CSV
            </button>
            <button class="btn red" id="clear-data-button">
                <i class="material-icons left">clear_all</i>Clear All Data
            </button>
        </div>
        <div class="center-align" style="margin-top: 10px;">
            <button class="btn blue darken-1" id="copy-all-projects-json">
                <i class="material-icons left">content_copy</i>Copy All Projects Data
            </button>
            <button class="btn deep-purple darken-2" id="auto-fetch-external-json">
                <i class="material-icons left">cloud_download</i>Update Projects Online
            </button>
        </div>
        <div id="output" class="result z-depth-1">
        </div>
        <div id="all-results" class="result z-depth-1" style="margin-top: 20px; max-height: 600px; overflow-y: auto;">
        </div>
        <div id="multiplier-modal" class="modal">
            <div class="modal-content">
                <h5>Enter Multiplier</h5>
                <div class="input-field">
                    <input id="total-multiplier" type="number" value="1" step="0.01">
                    <label for="total-multiplier">Multiplier</label>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close btn grey">Cancel</a>
                <a href="#!" class="btn green" id="apply-multiplier">Apply Multiplier</a>
            </div>
        </div>
        <div id="add-project-modal" class="modal">
            <div class="modal-content">
                <h5 id="modal-title">Add New Project</h5>
                <div class="input-field">
                    <input id="project-name" type="text">
                    <label for="project-name">Project Name</label>
                </div>
                <div class="input-field">
                    <textarea id="raw-data" class="materialize-textarea" placeholder="Paste your fixpoints data here..."></textarea>
                    <label for="raw-data">Fixpoints Data</label>
                </div>
                <div class="row">
                    <div class="input-field col s6">
                        <select id="modal-size">
                            <option value="3in">3IN</option>
                            <option value="9in">9IN</option>
                        </select>
                        <label for="modal-size">Project Size</label>
                    </div>
                    <div class="input-field col s6">
                        <label>
                            <input type="checkbox" id="modal-ir-check" />
                            <span>IR Multiplier</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close btn green" id="save-project-modal-button">Save Project</a>
            </div>
        </div>
        <div class="center-align" style="margin-top: 20px;">
            <button class="btn waves-effect waves-light grey darken-1" id="logout-button">
                <i class="material-icons left">logout</i>Logout / Change Role
            </button>
        </div>
    </div>

    <div id="view-data-modal" class="modal">
        <div class="modal-content">
            <h5 id="view-data-modal-title">Project Data</h5>
            <div id="view-data-table-container" style="overflow-x: auto;">
                <div class="spinner-container" id="view-data-spinner" style="display: none;">
                    <div class="preloader-wrapper active">
                        <div class="spinner-layer spinner-blue-only">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn grey">Close</a>
        </div>
    </div>

    <div id="fullscreen-results-modal">
        <div id="fullscreen-results-content">
            <button class="close-button"><i class="material-icons">close</i></button>
        </div>
    </div>

    <div id="loader-spinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
        <div class="preloader-wrapper active">
            <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                    <div class="circle"></div>
                </div>
                <div class="gap-patch">
                    <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                    <div class="circle"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script>
        // --- Configuration ---
        const HARDCODED_PROJECTS_JSON_URL = 'https://raw.githubusercontent.com/serhgs/project_data.json/refs/heads/main/update.json';
        const HARDCODED_TL_CODE_URL = 'https://raw.githubusercontent.com/gmlorenz/gmlorenz.github.io/refs/heads/main/projects_data.json';
        const PRICES = [
            { "3in": 2.19, "9in": 0.99 },
            { "3in": 5.86, "9in": 2.08 },
            { "3in": 7.44, "9in": 2.78 },
            { "3in": 2.29, "9in": 1.57 },
            { "3in": 1.55, "9in": 0.60 },
            { "3in": 1.84, "9in": 0.78 },
            { "3in": 1.00, "9in": 1.00 },
            { "3in": 3.74, "9in": 3.74 },
            { "3in": 1.73, "9in": 1.73 }
        ];

        // --- DOM Elements ---
        const projectSelector = document.getElementById('project-selector');
        const rawDataInput = document.getElementById('raw-data');
        const projectNameInput = document.getElementById('project-name');
        const techIdInput = document.getElementById('tech-id');
        const outputDiv = document.getElementById('output');
        const allResultsDiv = document.getElementById('all-results');
        const addProjectModal = document.querySelector('#add-project-modal');
        const modalTitle = document.getElementById('modal-title');
        const saveProjectModalButton = document.getElementById('save-project-modal-button');
        const clearDataButton = document.getElementById('clear-data-button');
        const addProjectButton = document.getElementById('add-project-button');
        const mainAppContent = document.getElementById('main-app-content');
        const logoutButton = document.getElementById('logout-button');
        const loginModal = document.getElementById('login-modal');
        const loginRoleSelect = document.getElementById('login-role');
        const tlCodeInputDiv = document.getElementById('tl-code-input');
        const tlLoginCodeInput = document.getElementById('tl-login-code');
        const loginButtonElement = document.getElementById('login-button');
        const fullscreenResultsModal = document.getElementById('fullscreen-results-modal');
        const fullscreenResultsContent = document.getElementById('fullscreen-results-content');
        const fullscreenCloseButton = fullscreenResultsContent.querySelector('.close-button');
        const viewDataModal = document.getElementById('view-data-modal');
        const viewDataTableContainer = document.getElementById('view-data-table-container');
        const viewDataModalTitle = document.getElementById('view-data-modal-title');
        const viewDataSpinner = document.getElementById('view-data-spinner');
        const multiplierInput = document.getElementById('total-multiplier');
        const applyMultiplierButton = document.getElementById('apply-multiplier');
        const modalSizeSelect = document.getElementById('modal-size');
        const modalIrCheck = document.getElementById('modal-ir-check');
        const viewProjectDataButton = document.getElementById('view-project-data-button');
        const autoFetchButton = document.getElementById('auto-fetch-external-json');


        // --- Global State ---
        let activeProjectData = '';
        let allCalculatedResults = [];
        let lastResult = '';
        let allProjectsAggregatedResults = {};
        let editingProjectName = null;
        let isLoggedInAsTL = false;

        // --- Utility Functions ---
        /**
         * Displays a Materialize toast message.
         * @param {string} html - The HTML content of the toast.
         * @param {string} classes - CSS classes to apply to the toast.
         */
        function showToast(html, classes = '') {
            M.toast({ html, classes });
        }

        /**
         * Shows the loading spinner.
         */
        function showLoader() {
            const loader = document.getElementById('loader-spinner');
            if (loader) loader.style.display = 'block';
        }

        /**
         * Hides the loading spinner.
         */
        function hideLoader() {
            const loader = document.getElementById('loader-spinner');
            if (loader) loader.style.display = 'none';
        }

        /**
         * Safely stores data in local storage, compressing the value.
         * @param {string} key - The storage key.
         * @param {string} value - The value to store.
         * @returns {boolean} - True on success, false on failure.
         */
        function safeSetLocalStorage(key, value) {
            try {
                const compressedValue = LZString.compressToUTF16(value);
                if (compressedValue === null) {
                    throw new Error("Compression failed.");
                }
                localStorage.setItem(key, compressedValue);
                return true;
            } catch (e) {
                if (e instanceof DOMException && e.name === 'QuotaExceededError') {
                    showToast('Local storage full! Could not save project.', 'red');
                } else {
                    showToast(`Error saving project data to local storage. ${e.message}`, 'red');
                    console.error("Local storage save error:", e);
                }
                return false;
            }
        }

        /**
         * Safely retrieves data from local storage, decompressing the value.
         * Handles migration from uncompressed data.
         * @param {string} key - The storage key.
         * @returns {string|null} - The retrieved value, or null on failure.
         */
        function safeGetLocalStorage(key) {
            try {
                const value = localStorage.getItem(key);
                if (value === null) {
                    return null;
                }

                let decompressedValue = LZString.decompressFromUTF16(value);
                if (decompressedValue !== null) {
                    return decompressedValue;
                }

                console.warn(`Decompression failed for key "${key}". Attempting to load as uncompressed data.`);
                return value; // Return original value if decompression fails, might be uncompressed
            } catch (e) {
                console.error(`Error retrieving or decompressing data for key "${key}":`, e);
                showToast('Error loading project data. Data might be corrupted.', 'red');
                return null;
            }
        }

        // --- UI Component Functions ---

        /**
         * Loads the project list into the dropdown selector.
         */
        function loadProjectList() {
            projectSelector.innerHTML = '<option value="" disabled selected>Select a saved project</option>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('tl_project_')) {
                    const name = key.replace('tl_project_', '');
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    projectSelector.appendChild(option);
                }
            }
            M.FormSelect.init(projectSelector);
        }

        /**
         * Adds buttons to a result container.
         * @param {HTMLElement} targetDiv - The container to add buttons to.
         */
        function addResultButtons(targetDiv) {
            const existingButtons = targetDiv.querySelector('.result-buttons');
            if (existingButtons) {
                existingButtons.remove();
            }

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'result-buttons';

            if (targetDiv.id === 'output' && lastResult) {
                const viewDataButton = document.createElement('button');
                viewDataButton.className = 'view-data-result-button';
                viewDataButton.innerHTML = '<i class="material-icons">table_chart</i>';
                viewDataButton.title = 'View Raw Data for this TECH ID';
                viewDataButton.addEventListener('click', () => {
                    if (!activeProjectData || !activeProjectData.data) {
                        showToast('No data loaded for the selected project to view.', 'orange');
                        return;
                    }
                    displayDataTableInModal(activeProjectData.data, lastResult.techID);
                });
                buttonsContainer.appendChild(viewDataButton);
            }

            const expandButton = document.createElement('button');
            expandButton.className = 'expand-button';
            expandButton.innerHTML = '<i class="material-icons">fullscreen</i>';
            expandButton.title = 'Expand Results';
            expandButton.addEventListener('click', () => {
                let contentToExpand = targetDiv.cloneNode(true);
                const clonedButtonsContainer = contentToExpand.querySelector('.result-buttons');
                if (clonedButtonsContainer) {
                    clonedButtonsContainer.remove();
                }

                fullscreenResultsContent.innerHTML = '';
                fullscreenResultsContent.appendChild(contentToExpand);

                const closeButton = document.createElement('button');
                closeButton.classList.add('close-button');
                closeButton.innerHTML = '<i class="material-icons">close</i>';
                closeButton.addEventListener('click', hideFullscreenModal);
                fullscreenResultsContent.appendChild(closeButton);

                fullscreenResultsModal.style.display = 'flex';
            });
            buttonsContainer.appendChild(expandButton);

            targetDiv.prepend(buttonsContainer);
        }

        /**
         * Removes result buttons from a container.
         * @param {HTMLElement} containerElement - The container to remove buttons from.
         */
        function removeResultButtons(containerElement) {
            const existingButtonsContainer = containerElement.querySelector('.result-buttons');
            if (existingButtonsContainer) {
                existingButtonsContainer.remove();
            }
        }

        /**
         * Hides the fullscreen modal.
         */
        function hideFullscreenModal() {
            fullscreenResultsModal.style.display = 'none';
            fullscreenResultsContent.innerHTML = '';
        }

        /**
         * Displays data in the view-data-modal.
         * @param {string} rawDataString - The raw data as a string.
         * @param {string} [techIDFilter=''] - Optional TECH ID to filter rows by.
         */
        function displayDataTableInModal(rawDataString, techIDFilter = '') {
            viewDataTableContainer.innerHTML = '';
            viewDataSpinner.style.display = 'flex';

            setTimeout(() => {
                const rows = String(rawDataString).split(/\r?\n/).filter(r => r.trim() !== "");

                if (rows.length === 0) {
                    viewDataTableContainer.innerHTML = '<p>No data available for this project.</p>';
                } else {
                    const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim()) || [];
                    const headersUpperCase = headers.map(h => h.toUpperCase()); // For internal lookup
                    const fixIdIndex = headersUpperCase.indexOf("FIX1_ID");

                    let tableHtml = '<table class="striped"><thead><tr>';

                    headers.forEach(headerText => {
                        tableHtml += `<th>${headerText}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';

                    let foundRows = false;
                    rows.forEach(row => {
                        const fields = row.split(/[\t,]/).map(f => f.trim());

                        // Apply filter if techIDFilter is provided and FIX1_ID column exists
                        if (techIDFilter === '' || fixIdIndex === -1 || (fixIdIndex !== -1 && fields[fixIdIndex]?.toUpperCase() === techIDFilter)) {
                            foundRows = true;
                            tableHtml += '<tr>';
                            fields.forEach(field => {
                                tableHtml += `<td>${field}</td>`;
                            });
                            tableHtml += '</tr>';
                        }
                    });

                    tableHtml += '</tbody></table>';

                    if (foundRows || techIDFilter === '') { // Display table if rows found or no filter applied
                        viewDataTableContainer.innerHTML = tableHtml;
                    } else { // No rows found for the specific TECH ID filter
                        viewDataTableContainer.innerHTML = `<p>No data found for TECH ID: ${techIDFilter}.</p>`;
                    }
                }

                let modalTitleText = `Data for Project: ${projectSelector.value || 'Loaded Project'}`;
                if (techIDFilter) {
                    modalTitleText += ` (Filtered by TECH ID: ${techIDFilter})`;
                }
                viewDataModalTitle.textContent = modalTitleText;

                viewDataSpinner.style.display = 'none';
                M.Modal.getInstance(viewDataModal).open();
            }, 50);
        }


        /**
         * Displays the data for a selected project in a modal.
         */
        function viewProjectData() {
            const selectedProjectName = projectSelector.value;
            if (!selectedProjectName) {
                showToast('Please select a project to view data.', 'orange');
                return;
            }

            if (!activeProjectData || !activeProjectData.data) {
                showToast('No data loaded for the selected project.', 'orange');
                return;
            }

            displayDataTableInModal(activeProjectData.data); // Call the reusable function without a filter
        }


        /**
         * Determines the bonus percentage based on quality percentage.
         * @param {number} qualityPercentage - The calculated quality percentage.
         * @returns {number} The bonus percentage (e.g., 0, 5, 120).
         */
        function getBonusPercentage(qualityPercentage) {
            if (qualityPercentage < 77.50) return 0;
            if (qualityPercentage >= 100.00) return 120; // Maximum bonus

            // Define the bonus structure as an array of objects for easier lookup
            const bonusTiers = [
                { quality: 77.50, bonus: 5 },
                { quality: 78.00, bonus: 10 },
                { quality: 78.50, bonus: 15 },
                { quality: 79.00, bonus: 20 },
                { quality: 79.50, bonus: 25 },
                { quality: 80.00, bonus: 30 },
                { quality: 80.50, bonus: 35 },
                { quality: 81.00, bonus: 40 },
                { quality: 81.50, bonus: 45 },
                { quality: 82.00, bonus: 50 },
                { quality: 82.50, bonus: 55 },
                { quality: 83.00, bonus: 57 },
                { quality: 83.50, bonus: 60 },
                { quality: 84.00, bonus: 62 },
                { quality: 84.50, bonus: 64 },
                { quality: 85.00, bonus: 66 },
                { quality: 85.50, bonus: 68 },
                { quality: 86.00, bonus: 70 },
                { quality: 86.50, bonus: 73 },
                { quality: 87.00, bonus: 75 },
                { quality: 87.50, bonus: 78 },
                { quality: 88.00, bonus: 80 },
                { quality: 88.50, bonus: 83 },
                { quality: 89.00, bonus: 85 },
                { quality: 89.50, bonus: 87 },
                { quality: 90.00, bonus: 88 },
                { quality: 90.50, bonus: 90 },
                { quality: 91.00, bonus: 91 },
                { quality: 91.50, bonus: 93 },
                { quality: 92.00, bonus: 94 },
                { quality: 92.50, bonus: 95 },
                { quality: 93.00, bonus: 96 },
                { quality: 93.50, bonus: 97 },
                { quality: 94.00, bonus: 98 },
                { quality: 94.50, bonus: 99 },
                { quality: 95.00, bonus: 100 },
                { quality: 95.50, bonus: 102 },
                { quality: 96.00, bonus: 104 },
                { quality: 96.50, bonus: 106 },
                { quality: 97.00, bonus: 108 },
                { quality: 97.50, bonus: 110 },
                { quality: 98.00, bonus: 112 },
                { quality: 98.50, bonus: 114 },
                { quality: 99.00, bonus: 116 },
                { quality: 99.50, bonus: 118 }
            ];

            // Iterate from the highest quality to find the matching tier
            for (let i = bonusTiers.length - 1; i >= 0; i--) {
                if (qualityPercentage >= bonusTiers[i].quality) {
                    return bonusTiers[i].bonus;
                }
            }
            return 0; // Default for anything below 77.50%
        }

        /**
         * Calculates points and counts for a single row of raw data.
         * @param {string[]} fields - The fields of the row.
         * @param {string[]} headers - The headers of the data.
         * @param {string} size - The project size (3in or 9in).
         * @param {boolean} ir - Whether the IR multiplier is applied.
         * @returns {object} - An object containing row points, category counts, and category points.
         */
        function calculateRowDetails(fields, headers, size, ir) {
            const indexes = {
                category: headers.indexOf("CATEGORY"),
                i3qa: headers.indexOf("I3QA_CAT"),
                rv1cat: headers.indexOf("RV1_CAT"),
                afp1cat: headers.indexOf("AFP1_CAT"),
                rv1label: headers.indexOf("RV1_LABEL"),
                i3qalabel: headers.indexOf("I3QA_LABEL"),
                afp2cat: headers.indexOf("AFP2_CAT"),
                rv2cat: headers.indexOf("RV2_CAT")
            };

            let rowPoints = 0;
            let categoryCounts = Array(9).fill(0);
            let categoryPoints = Array(9).fill(0);

            [indexes.category, indexes.i3qa, indexes.rv1cat, indexes.afp1cat, indexes.afp2cat, indexes.rv2cat].forEach(idx => {
                if (idx !== -1 && fields[idx]) {
                    const val = parseInt(fields[idx].trim());
                    if (!isNaN(val) && val >= 1 && val <= 9) {
                        const price = PRICES[val - 1][size];
                        const rowMultiplier = ir ? 2 : 1;
                        const currentCategoryPoints = price * rowMultiplier;
                        rowPoints += currentCategoryPoints;
                        categoryCounts[val - 1]++;
                        categoryPoints[val - 1] += currentCategoryPoints;
                    }
                }
            });

            return { rowPoints, categoryCounts, categoryPoints };
        }

        /**
         * Calculates points, counts, and details for a single TECH ID within raw data.
         * @param {string} raw - The raw data string.
         * @param {string} techIDValue - The TECH ID to calculate for.
         * @param {string} size - The project size.
         * @param {boolean} ir - Whether the IR multiplier is applied.
         * @returns {object|null} - The calculation results, or null if FIX1_ID is missing.
         */
        function calculateDetailsForTechIDInRaw(raw, techIDValue, size, ir) {
            // Ensure 'raw' is treated as a string before splitting
            const rows = String(raw).split(/\r?\n/).filter(r => r.trim() !== "");
            const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim().toUpperCase()) || [];
            const indexes = {
                fixId: headers.indexOf("FIX1_ID"),
                afp1stat: headers.indexOf("AFP1_STAT"),
                rv1label: headers.indexOf("RV1_LABEL"),
                i3qalabel: headers.indexOf("I3QA_LABEL"),
                rv2label: headers.indexOf("RV2_LABEL"),
                category: headers.indexOf("CATEGORY"),
                i3qa: headers.indexOf("I3QA_CAT"),
                rv1cat: headers.indexOf("RV1_CAT"),
                afp1cat: headers.indexOf("AFP1_CAT"),
                afp2cat: headers.indexOf("AFP2_CAT"),
                rv2cat: headers.indexOf("RV2_CAT")
            };

            if (indexes.fixId === -1) {
                return null;
            }

            let totalPoints = 0;
            let additionalFixPoints = 0;
            let excessiveFixPoints = 0;
            let missFixPoints = 0;
            let incorrectCounting = 0;
            let incorrectPointsValue = 0;
            const categoryPoints = Array(9).fill(0);
            const categoryCounts = Array(9).fill(0);

            const matched = rows.filter(row => {
                const fields = row.split(/[\t,]/);
                return fields[indexes.fixId]?.trim().toUpperCase() === techIDValue;
            });

            matched.forEach(row => {
                const fields = row.split(/[\t,]/);
                let isIncorrectRow = false;

                if (indexes.rv1label !== -1 && fields[indexes.rv1label]) {
                    if (fields[indexes.rv1label].toUpperCase().includes("E")) {
                        excessiveFixPoints++;
                    }
                    if (fields[indexes.rv1label].toUpperCase().includes("M")) {
                        missFixPoints++;
                    }
                    if (fields[indexes.rv1label].toUpperCase().includes("I")) {
                        incorrectCounting++;
                        isIncorrectRow = true;
                    }
                }
                if (indexes.i3qalabel !== -1 && fields[indexes.i3qalabel]) {
                    if (fields[indexes.i3qalabel].toUpperCase().includes("M")) {
                        missFixPoints++;
                    }
                }
                if (indexes.rv2label !== -1 && fields[indexes.rv2label]) {
                    if (fields[indexes.rv2label].toUpperCase().includes("E")) {
                        excessiveFixPoints++;
                    }
                    if (fields[indexes.rv2label].toUpperCase().includes("M")) {
                        missFixPoints++;
                    }
                    if (fields[indexes.rv2label].toUpperCase().includes("I")) {
                        incorrectCounting++;
                        isIncorrectRow = true;
                    }
                }

                if (indexes.afp1stat !== -1 && fields[indexes.afp1stat] && fields[indexes.afp1stat].toUpperCase() === "AA") {
                    additionalFixPoints++;
                }

                const rowDetails = calculateRowDetails(fields, headers, size, ir);
                totalPoints += rowDetails.rowPoints;
                rowDetails.categoryCounts.forEach((count, index) => {
                    categoryCounts[index] += count;
                });
                // APPLYING REFINED LOGIC HERE: Directly aggregate categoryPoints
                rowDetails.categoryPoints.forEach((points, index) => {
                    categoryPoints[index] += points;
                });

                if (isIncorrectRow) {
                    incorrectPointsValue += rowDetails.rowPoints;
                }
            });

            const correctPoints = totalPoints - incorrectPointsValue;
            const qualityPercentage = (totalPoints > 0) ? (correctPoints / totalPoints) * 100 : 0;
            const bonusPercentage = getBonusPercentage(qualityPercentage); // Use the new function
            const qualityBonus = totalPoints * (bonusPercentage / 100); // Calculate bonus based on percentage
            const estimatedSalary = totalPoints + qualityBonus; // Calculate Estimated Salary

            return {
                techID: techIDValue,
                totalPoints: totalPoints, // This is the base total points for this techID in this project
                additionalFixPoints: additionalFixPoints,
                excessiveFixPoints: excessiveFixPoints,
                missFixPoints: missFixPoints,
                incorrectCounting: incorrectCounting,
                incorrectPointsValue: incorrectPointsValue,
                qualityPercentage: qualityPercentage,
                bonusPercentage: bonusPercentage, // Store the bonus percentage for display/export
                qualityBonus: qualityBonus,
                estimatedSalary: estimatedSalary, // Add Estimated Salary
                categoryPoints: categoryPoints,
                categoryCounts: categoryCounts
            };
        }

        // --- Main Functions ---

        /**
         * Saves a project to local storage.  Handles both adding and editing.
         */
        function saveProject() {
            const name = projectNameInput.value.trim();
            const data = rawDataInput.value.trim();
            const size = modalSizeSelect.value;
            const ir = modalIrCheck.checked;

            if (!name || !data) {
                showToast('Please enter a project name and data.', 'red');
                return;
            }

            // Ensure the payload is consistently { data: string, size: string, ir: boolean }
            const payload = JSON.stringify({ data, size, ir });
            const storageKey = `tl_project_${name}`;

            if (editingProjectName && editingProjectName !== name) {
                localStorage.removeItem(`tl_project_${editingProjectName}`);
            }

            if (safeSetLocalStorage(storageKey, payload)) {
                showToast(`Project '${name}' saved!`, 'green');
                loadProjectList();
                M.Modal.getInstance(addProjectModal).close();
                projectNameInput.value = '';
                rawDataInput.value = '';
                modalSizeSelect.value = '3in';
                modalIrCheck.checked = false;
                M.FormSelect.init(modalSizeSelect);
                M.updateTextFields();
                editingProjectName = null;
            }
        }

        /**
         * Deletes the selected project from local storage.
         */
        function deleteSelectedProject() {
            const selected = projectSelector.value;
            if (!selected) {
                showToast('No project selected.', 'red');
                return;
            }
            if (confirm(`Are you sure you want to delete project '${selected}'?`)) {
                localStorage.removeItem(`tl_project_${selected}`);
                showToast(`Project '${selected}' deleted.`, 'orange');
                loadProjectList();
                activeProjectData = '';
                outputDiv.textContent = '';
                allResultsDiv.innerHTML = '';
                allCalculatedResults = [];
                lastResult = '';
                allProjectsAggregatedResults = {};
                editingProjectName = null;
            }
        }

        /**
         * Calculates and displays the results for a single TECH ID search.
         */
        function searchTechID() {
            const raw = activeProjectData?.data;
            const techIDValue = techIdInput.value.trim().toUpperCase();
            const size = activeProjectData?.size;
            const ir = activeProjectData?.ir;

            outputDiv.innerHTML = '';
            allResultsDiv.innerHTML = '';
            lastResult = '';
            allCalculatedResults = [];
            allProjectsAggregatedResults = {};

            if (!raw || !techIDValue || !size) {
                outputDiv.innerHTML = '<p>Please load a project first and enter a TECH ID to search.</p>';
                addResultButtons(outputDiv);
                return;
            }

            const result = calculateDetailsForTechIDInRaw(raw, techIDValue, size, ir);

            if (result) {
                // Determine Tech ID highlight class
                const techIdHighlightClass = result.techID.length < 6 ? 'tech-id-red-highlight' : 'tech-id-highlight';

                let outputHtml = `<h5>Search Results for TECH ID: <span class="${techIdHighlightClass}">${result.techID}</span></h5>`;
                outputHtml += `<p><strong>Project Total Points: ${result.totalPoints.toFixed(2)}</strong></p>`;
                outputHtml += '<table class="striped"><thead><tr>';
                outputHtml += '<th>Metric</th><th>Value</th><th>Count/N/A</th>';
                outputHtml += '</tr></thead><tbody>';

                result.categoryPoints.forEach((total, i) => {
                    outputHtml += `<tr><td>CAT ${i + 1}</td><td>${total.toFixed(2)}</td><td>${result.categoryCounts[i]}</td></tr>`;
                });

                outputHtml += `<tr><td>Additional FixPoints</td><td>N/A</td><td>${result.additionalFixPoints}</td></tr>`;
                outputHtml += `<tr><td>Excessive FixPoints</td><td>N/A</td><td>${result.excessiveFixPoints}</td></tr>`;
                outputHtml += `<tr><td>Miss FixPoints</td><td>N/A</td><td>${result.missFixPoints}</td></tr>`;
                outputHtml += `<tr><td>Incorrect Counting</td><td>N/A</td><td>${result.incorrectCounting}</td></tr>`;
                outputHtml += `<tr><td>Incorrect Points Value</td><td>${result.incorrectPointsValue.toFixed(2)}</td><td>N/A</td></tr>`;
                outputHtml += `<tr><td>Total Points</td><td>${result.totalPoints.toFixed(2)}</td><td>N/A</td></tr>`; // Reordered
                outputHtml += `<tr><td>Quality Percentage</td><td>${result.qualityPercentage.toFixed(2)}%</td><td>N/A</td></tr>`;
                outputHtml += `<tr><td>Bonus Percentage</td><td>${result.bonusPercentage.toFixed(2)}%</td><td>N/A</td></tr>`; // Display bonus percentage
                outputHtml += `<tr><td>Quality Bonus</td><td>${result.qualityBonus.toFixed(2)}</td><td>N/A</td></tr>`;
                outputHtml += `<tr><td class="salary-highlight">Estimated Salary</td><td class="salary-highlight">${result.estimatedSalary.toFixed(2)}</td><td class="salary-highlight">N/A</td></tr>`; // Display Estimated Salary
                outputHtml += '</tbody></table>';

                outputDiv.innerHTML = outputHtml;
                lastResult = result;
            } else {
                outputDiv.innerHTML = `<p>TECH ID '${techIDValue}' not found or error in data in the loaded project.</p>`;
            }
            addResultButtons(outputDiv);
        }

        /**
         * Calculates and displays the total points for all TECH IDs in the loaded project.
         */
        function calculateAllTechIDs() {
            const raw = activeProjectData?.data;
            const size = activeProjectData?.size;
            const ir = activeProjectData?.ir;

            if (!raw || !size) {
                allResultsDiv.innerHTML = '<p>Please load a project first.</p>';
                allCalculatedResults = [];
                allProjectsAggregatedResults = {};
                addResultButtons(allResultsDiv);
                return;
            }

            // Ensure 'raw' is treated as a string before splitting
            const rows = String(raw).split(/\r?\n/).filter(r => r.trim() !== "");
            const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim().toUpperCase()) || [];
            const fixIdIndex = headers.indexOf("FIX1_ID");

            if (fixIdIndex === -1) {
                allResultsDiv.innerHTML = '<p>Error: FIX1_ID column not found in the loaded project.</p>';
                allCalculatedResults = [];
                allProjectsAggregatedResults = {};
                addResultButtons(allResultsDiv);
                return;
            }

            const techIDs = new Set();
            rows.forEach(row => {
                const fields = row.split(/[\t,]/);
                const techID = fields[fixIdIndex]?.trim().toUpperCase();
                if (techID) {
                    techIDs.add(techID);
                }
            });

            allCalculatedResults = [];
            let tableHtml = '<table class="striped"><thead><tr>';

            const tableHeaders = [
                'TECH ID',
                ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Points`),
                ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Count`),
                'Additional FixPoints', 'Excessive FixPoints', 'Miss FixPoints', 'Incorrect Counting', 'Incorrect Points Value',
                'Total Points', // Moved here
                'Quality %', 'Bonus %',
                'Quality Bonus', 'Estimated Salary' // Add Estimated Salary
            ];

            tableHeaders.forEach(headerText => {
                tableHtml += `<th>${headerText}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            techIDs.forEach(techID => {
                const result = calculateDetailsForTechIDInRaw(raw, techID, size, ir);
                if (result) {
                    allCalculatedResults.push(result);
                    const qualityClass = result.qualityPercentage === 100 ? 'quality-green' : 'quality-orange';
                    const techIdHighlightClass = result.techID.length < 6 ? 'tech-id-red-highlight' : 'tech-id-highlight'; // Apply tech-id-highlight class

                    // Determine class for Quality Bonus column
                    let bonusClass = '';
                    if (result.bonusPercentage >= 100) {
                        bonusClass = 'quality-green';
                    } else if (result.bonusPercentage >= 50) {
                        bonusClass = 'quality-orange';
                    } else if (result.bonusPercentage < 50 && result.bonusPercentage > 0) {
                        bonusClass = 'quality-red';
                    } else {
                        bonusClass = 'quality-red';
                    }

                    tableHtml += '<tr>';
                    tableHtml += `<td class="${techIdHighlightClass}">${result.techID}</td>`; // Apply highlight class
                    result.categoryPoints.forEach(total => {
                        tableHtml += `<td>${total.toFixed(2)}</td>`;
                    });
                    result.categoryCounts.forEach(count => {
                        tableHtml += `<td>${count}</td>`;
                    });
                    tableHtml += `<td>${result.additionalFixPoints}</td>`;
                    tableHtml += `<td>${result.excessiveFixPoints}</td>`;
                    tableHtml += `<td>${result.missFixPoints}</td>`;
                    tableHtml += `<td>${result.incorrectCounting}</td>`;
                    tableHtml += `<td>${result.incorrectPointsValue.toFixed(2)}</td>`;
                    tableHtml += `<td>${result.totalPoints.toFixed(2)}</td>`; // Reordered
                    tableHtml += `<td class="${qualityClass}">${result.qualityPercentage.toFixed(2)}%</td>`;
                    tableHtml += `<td class="${bonusClass}">${result.bonusPercentage.toFixed(2)}%</td>`; // Apply class here for Bonus %
                    tableHtml += `<td class="${bonusClass}">${result.qualityBonus.toFixed(2)}</td>`; // Apply class here for Quality Bonus
                    tableHtml += `<td class="salary-highlight">${result.estimatedSalary.toFixed(2)}</td>`; // Apply highlight for Estimated Salary
                    tableHtml += '</tr>';
                }
            });
            tableHtml += '</tbody></table>';

            allResultsDiv.innerHTML = `<h5>Results for Loaded Project</h5>${tableHtml}`;
            outputDiv.textContent = '';
            allProjectsAggregatedResults = {};
            addResultButtons(allResultsDiv);
        }

        /**
         * Calculates and displays the total points across all projects.
         */
        function calculateTotalAcrossAllProjects() {
            const multiplier = parseFloat(multiplierInput.value) || 1;
            allProjectsAggregatedResults = {};
            let processingErrors = [];

            // 1. Collect all raw project data first
            const allProjectsRawData = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('tl_project_')) {
                    const projectName = key.replace('tl_project_', '');
                    const projectDataString = safeGetLocalStorage(key);

                    if (projectDataString !== null) {
                        try {
                            const project = JSON.parse(projectDataString);
                            if (project && typeof project === 'object' && 'data' in project && 'size' in project && 'ir' in project) {
                                allProjectsRawData.push({
                                    name: projectName,
                                    data: String(project.data), // Ensure data is string
                                    size: project.size,
                                    ir: project.ir
                                });
                            } else {
                                processingErrors.push(`Project '${projectName}': Invalid project data structure.`);
                            }
                        } catch (e) {
                            if (e instanceof SyntaxError) {
                                processingErrors.push(`Project '${projectName}': Error parsing project data (invalid JSON format) - ${e.message}`);
                            } else {
                                processingErrors.push(`Project '${projectName}': Error processing data - ${e.message}`);
                            }
                            console.error(`Error processing project '${projectName}':`, e);
                        }
                    } else {
                        processingErrors.push(`Project '${projectName}': Could not retrieve data from local storage.`);
                    }
                }
            }

            // 2. Identify all unique TECH IDs across all projects
            const allUniqueTechIDs = new Set();
            allProjectsRawData.forEach(project => {
                const rows = project.data.split(/\r?\n/).filter(r => r.trim() !== "");
                if (rows.length > 0) {
                    const headerRow = rows.shift();
                    const headers = headerRow.split(/[\t,]/).map(h => h.trim().toUpperCase());
                    const fixIdIndex = headers.indexOf("FIX1_ID");

                    if (fixIdIndex === -1) {
                        // This error is already pushed above for the project, no need to duplicate for each techID within it.
                        // processingErrors.push(`Project '${project.name}': FIX1_ID column not found.`);
                        return;
                    }

                    rows.forEach(row => {
                        const fields = row.split(/[\t,]/);
                        const techID = fields[fixIdIndex]?.trim().toUpperCase();
                        if (techID) {
                            allUniqueTechIDs.add(techID);
                        }
                    });
                }
            });

            // 3. For each unique TECH ID, aggregate results by iterating through ALL projects
            allUniqueTechIDs.forEach(techID => {
                // Initialize aggregated result structure for this TECH ID
                allProjectsAggregatedResults[techID] = {
                    baseTotalPoints: 0, // Sum of totalPoints from each project's calculateDetailsForTechIDInRaw
                    incorrectPointsValue: 0,
                    additionalFixPoints: 0,
                    excessiveFixPoints: 0,
                    missFixPoints: 0,
                    incorrectCounting: 0,
                    categoryPoints: Array(9).fill(0),
                    categoryCounts: Array(9).fill(0),
                    // These will be calculated after aggregation
                    totalPoints: 0,
                    qualityPercentage: 0,
                    bonusPercentage: 0,
                    qualityBonus: 0,
                    estimatedSalary: 0
                };

                allProjectsRawData.forEach(project => {
                    // Calculate details for this techID specifically within this project
                    const projectSpecificResult = calculateDetailsForTechIDInRaw(project.data, techID, project.size, project.ir);

                    if (projectSpecificResult) {
                        // Aggregate values from projectSpecificResult into the overall aggregated result for this TECH ID
                        allProjectsAggregatedResults[techID].baseTotalPoints += projectSpecificResult.totalPoints;
                        allProjectsAggregatedResults[techID].incorrectPointsValue += projectSpecificResult.incorrectPointsValue;
                        allProjectsAggregatedResults[techID].additionalFixPoints += projectSpecificResult.additionalFixPoints;
                        allProjectsAggregatedResults[techID].excessiveFixPoints += projectSpecificResult.excessiveFixPoints;
                        allProjectsAggregatedResults[techID].missFixPoints += projectSpecificResult.missFixPoints;
                        allProjectsAggregatedResults[techID].incorrectCounting += projectSpecificResult.incorrectCounting;

                        projectSpecificResult.categoryPoints.forEach((points, index) => {
                            allProjectsAggregatedResults[techID].categoryPoints[index] += points;
                        });
                        projectSpecificResult.categoryCounts.forEach((count, index) => {
                            allProjectsAggregatedResults[techID].categoryCounts[index] += count;
                        });
                    }
                });

                // Now calculate the final derived metrics for this aggregated TECH ID
                const aggregatedResult = allProjectsAggregatedResults[techID];

                // Apply multiplier to the accumulated baseTotalPoints
                aggregatedResult.totalPoints = aggregatedResult.baseTotalPoints * multiplier;

                // Quality calculation remains based on original base points, not multiplied points
                const correctPointsAggregated = aggregatedResult.baseTotalPoints - aggregatedResult.incorrectPointsValue;
                aggregatedResult.qualityPercentage = (aggregatedResult.baseTotalPoints > 0) ? (correctPointsAggregated / aggregatedResult.baseTotalPoints) * 100 : 0;

                aggregatedResult.bonusPercentage = getBonusPercentage(aggregatedResult.qualityPercentage);
                // Quality bonus is calculated on the base points, before the global multiplier
                aggregatedResult.qualityBonus = aggregatedResult.baseTotalPoints * (aggregatedResult.bonusPercentage / 100);

                // Estimated salary is the total points (after multiplier) plus the quality bonus (from base points)
                aggregatedResult.estimatedSalary = aggregatedResult.totalPoints + aggregatedResult.qualityBonus;
            });

            let grandTotal = 0;
            for (const techID in allProjectsAggregatedResults) {
                if (allProjectsAggregatedResults.hasOwnProperty(techID)) {
                    grandTotal += allProjectsAggregatedResults[techID].totalPoints; // Grand total sums points AFTER multiplier
                }
            }

            let tableHtml = `<h5>Totals Across All Projects (Multiplier: ${multiplier.toFixed(2)})</h5>`; // Display multiplier in title
            if (Object.keys(allProjectsAggregatedResults).length === 0) {
                tableHtml += '<p>No TECH IDs found across all projects.</p>';
            } else {
                tableHtml += '<table class="striped"><thead><tr>';
                const aggregatedHeaders = [
                    'TECH ID',
                    ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Points`),
                    ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Count`),
                    'Additional FixPoints', 'Excessive FixPoints', 'Miss FixPoints', 'Incorrect Counting', 'Incorrect Points Value', 'Total Points (w/ Multiplier)', 'Quality %', 'Bonus %',
                    'Quality Bonus', 'Estimated Salary'
                ];

                aggregatedHeaders.forEach(headerText => {
                    tableHtml += `<th>${headerText}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';

                Object.entries(allProjectsAggregatedResults).sort((a, b) => a[0].localeCompare(b[0])).forEach(([techID, result]) => {
                    const qualityClass = result.qualityPercentage === 100 ? 'quality-green' : (result.qualityPercentage >= 77.50 ? 'quality-orange' : 'quality-red'); // Added quality-red for < 77.50%
                    const techIdHighlightClass = techID.length < 6 ? 'tech-id-red-highlight' : 'tech-id-highlight';

                    let bonusClass = '';
                    if (result.bonusPercentage >= 100) {
                        bonusClass = 'quality-green';
                    } else if (result.bonusPercentage > 0) { // Any positive bonus
                        bonusClass = 'quality-orange';
                    } else { // 0% bonus
                        bonusClass = 'quality-red';
                    }

                    tableHtml += '<tr>';
                    tableHtml += `<td class="${techIdHighlightClass}">${techID}</td>`;
                    result.categoryPoints.forEach(total => {
                        tableHtml += `<td>${total.toFixed(2)}</td>`;
                    });
                    result.categoryCounts.forEach(count => {
                        tableHtml += `<td>${count}</td>`;
                    });
                    tableHtml += `<td>${result.additionalFixPoints}</td>`;
                    tableHtml += `<td>${result.excessiveFixPoints}</td>`;
                    tableHtml += `<td>${result.missFixPoints}</td>`;
                    tableHtml += `<td>${result.incorrectCounting}</td>`;
                    tableHtml += `<td>${result.incorrectPointsValue.toFixed(2)}</td>`;
                    tableHtml += `<td>${result.totalPoints.toFixed(2)}</td>`;
                    tableHtml += `<td class="${qualityClass}">${result.qualityPercentage.toFixed(2)}%</td>`;
                    tableHtml += `<td class="${bonusClass}">${result.bonusPercentage.toFixed(2)}%</td>`;
                    tableHtml += `<td class="${bonusClass}">${result.qualityBonus.toFixed(2)}</td>`;
                    tableHtml += `<td class="salary-highlight">${result.estimatedSalary.toFixed(2)}</td>`;
                    tableHtml += '</tr>';
                });
                tableHtml += '</tbody></table>';
                tableHtml += `<h4 style="margin-top: 20px;">Team Total Points: ${grandTotal.toFixed(2)} points</h4>`;
            }

            if (processingErrors.length > 0) {
                tableHtml += '<div class="card red lighten-5"><div class="card-content red-text text-darken-4"><span class="card-title">Processing Warnings/Errors</span><ul>';
                processingErrors.forEach(error => {
                    tableHtml += `<li>${error}</li>`;
                });
                tableHtml += '</ul></div></div>';
            }

            allResultsDiv.innerHTML = tableHtml;
            outputDiv.textContent = '';
            allCalculatedResults = [];
            addResultButtons(allResultsDiv);

            M.Modal.getInstance(document.getElementById('multiplier-modal')).close();
        }

        /**
         * Exports data to a CSV file.
         * @param {string} filename - The name of the CSV file.
         * @param {object[]|object} data - The data to export.
         */
        function exportToCsv(filename, data) {
            if (!data || (Array.isArray(data) && data.length === 0)) {
                showToast('No data to export.', 'red');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            let headers = [];

            if (Array.isArray(data)) { // This handles the 'Per Project Total' and 'All Projects Total' data
                headers = [
                    'TECH ID',
                    ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Points`),
                    ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Count`),
                    'Additional FixPoints', 'Excessive FixPoints', 'Miss FixPoints', 'Incorrect Counting', 'Incorrect Points Value', 'Total Points (w/ Multiplier)', 'Quality %', 'Bonus %',
                    'Quality Bonus', 'Estimated Salary' // Add Estimated Salary
                ];
            } else { // This handles the single 'Search Results for TECH ID' data
                headers = ['Metric', 'Value', 'Count/N/A']; // Adjusted headers for clarity in single export
            }

            csvContent += headers.join(",") + "\n";

            if (Array.isArray(data)) {
                data.forEach(item => {
                    let row = [];
                    row.push(item.techID);
                    item.categoryPoints.forEach(points => row.push(points.toFixed(2)));
                    item.categoryCounts.forEach(count => row.push(count));
                    row.push(item.additionalFixPoints);
                    row.push(item.excessiveFixPoints);
                    row.push(item.missFixPoints);
                    row.push(item.incorrectCounting);
                    row.push(item.incorrectPointsValue.toFixed(2));
                    row.push(item.totalPoints.toFixed(2));
                    row.push(item.qualityPercentage.toFixed(2) + '%');
                    row.push(item.bonusPercentage.toFixed(2) + '%'); // Export bonus percentage
                    row.push(item.qualityBonus.toFixed(2));
                    row.push(item.estimatedSalary.toFixed(2)); // Export Estimated Salary
                    csvContent += row.join(",") + "\n";
                });
            } else {
                csvContent += `"Total Points",${data.totalPoints.toFixed(2)},N/A\n`;
                data.categoryPoints.forEach((total, i) => {
                    csvContent += `"CAT ${i + 1}",${total.toFixed(2)},${data.categoryCounts[i]}\n`;
                });
                csvContent += `"Additional FixPoints",${data.additionalFixPoints},N/A\n`; // Changed N/A position for consistency
                csvContent += `"Excessive FixPoints",${data.excessiveFixPoints},N/A\n`;
                csvContent += `"Miss FixPoints",${data.missFixPoints},N/A\n`;
                csvContent += `"Incorrect Counting",${data.incorrectCounting},N/A\n`;
                csvContent += `"Incorrect Points Value",${data.incorrectPointsValue.toFixed(2)},N/A\n`;
                csvContent += `"Quality Percentage",${data.qualityPercentage.toFixed(2)}%,N/A\n`;
                csvContent += `"Bonus Percentage",${data.bonusPercentage.toFixed(2)}%,N/A\n`; // Export bonus percentage
                csvContent += `"Quality Bonus",${data.qualityBonus.toFixed(2)},N/A\n`;
                csvContent += `"Estimated Salary",${data.estimatedSalary.toFixed(2)},N/A\n`; // Export Estimated Salary
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('CSV exported successfully!', 'green');
        }

        /**
         * Fetches and updates projects from an external JSON URL.
         */
        async function autoFetchExternalJson() {
            showLoader();
            showToast('Attempting to update projects online...', 'blue');
            try {
                const response = await fetch(HARDCODED_PROJECTS_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const compressedText = await response.text();
                const decompressedText = LZString.decompressFromBase64(compressedText);

                if (decompressedText === null) {
                    throw new Error("Decompression failed. Data might not be LZString compressed (Base64) or is corrupted.");
                }

                // The external JSON is expected to be an array of objects,
                // where each object is like: { name: "ProjectName", data: { data: "raw_data_string", size: "3in", ir: false } }
                const externalProjects = JSON.parse(decompressedText);

                let updatedCount = 0;
                let addedCount = 0;

                if (!Array.isArray(externalProjects)) {
                    throw new Error("External JSON is not an array of projects.");
                }

                for (const project of externalProjects) {
                    // Expect project to be { name: "...", data: { data: "...", size: "...", ir: "..." } }
                    // So, project.data is actually the object we want to save in local storage.
                    if (project.name && typeof project.data === 'object' && project.data !== null && 'data' in project.data && 'size' in project.data && 'ir' in project.data) {
                        const storageKey = `tl_project_${project.name}`;
                        const newPayload = JSON.stringify(project.data); // Stringify the nested project.data object directly

                        const existingStoredString = safeGetLocalStorage(storageKey);
                        let existingParsedData = null;

                        if (existingStoredString) {
                            try {
                                existingParsedData = JSON.parse(existingStoredString);
                            } catch (parseError) {
                                console.warn(`Error parsing existing project '${project.name}' from local storage during auto-fetch comparison:`, parseError);
                                existingParsedData = null; // Treat as different to force update
                            }
                        }

                        // Compare the new payload string with the existing parsed data's stringified version
                        if (existingParsedData && JSON.stringify(existingParsedData) === newPayload) {
                            // Project exists and is identical, do nothing
                        } else {
                            if (safeSetLocalStorage(storageKey, newPayload)) {
                                if (existingParsedData) {
                                    updatedCount++;
                                } else {
                                    addedCount++;
                                }
                            }
                        }
                    } else {
                        console.warn("Skipping invalid project entry from online source (missing name or valid data object):", project);
                    }
                }
                loadProjectList();
                showToast(`Projects updated! Added: ${addedCount}, Updated: ${updatedCount}`, 'green');

            } catch (e) {
                let errorMessage = `Failed to update projects: ${e.message}`;
                if (e instanceof SyntaxError) {
                    errorMessage = `Failed to update projects: The fetched data is not valid JSON after decompression. Please check the source URL and data format.`;
                } else if (e.message.includes("Decompression failed")) {
                    errorMessage = `Failed to update projects: The fetched data could not be decompressed. It might not be LZString Base64 compressed or is corrupted.`;
                }
                showToast(errorMessage, 'red');
                console.error("Auto-fetch error:", e);
            } finally {
                hideLoader();
            }
        }

        /**
         * Verifies the TL login code.
         * @param {string} enteredCode - The code entered by the user.
         * @returns {Promise<boolean>} - A promise that resolves to true if the code is correct, false otherwise.
         */
        async function verifyTlLoginCode(enteredCode) {
            try {
                const response = await fetch(HARDCODED_TL_CODE_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const tlCodeData = await response.json();
                return tlCodeData.code === enteredCode;
            } catch (e) {
                showToast(`Error fetching TL login code: ${e.message}`, 'red');
                console.error("TL code fetch error:", e);
                return false;
            }
        }

        /**
         * Updates button visibility based on the user's login role.
         */
        function updateButtonVisibility() {
            const tlButtons = [
                document.getElementById('add-project-button'),
                document.getElementById('edit-project'),
                document.getElementById('delete-project'),
                document.getElementById('copy-all-projects-json')
            ];

            tlButtons.forEach(button => {
                if (button) {
                    button.style.display = isLoggedInAsTL ? 'inline-block' : 'none';
                }
            });

            // These buttons are always visible for both roles
            document.getElementById('calculate-all-button').style.display = 'inline-block';
            document.getElementById('calculate-all-projects-button').style.display = 'inline-block';
            document.getElementById('export-button').style.display = 'inline-block';
            document.getElementById('search-button').style.display = 'inline-block';
            document.getElementById('view-project-data-button').style.display = 'inline-block';
            document.getElementById('auto-fetch-external-json').style.display = 'inline-block';
            document.getElementById('clear-data-button').style.display = 'inline-block';
        }

        // --- Event Listeners ---

        document.getElementById('search-button').addEventListener('click', searchTechID);
        document.getElementById('calculate-all-button').addEventListener('click', calculateAllTechIDs);
        document.getElementById('calculate-all-projects-button').addEventListener('click', () => {
            M.Modal.getInstance(document.getElementById('multiplier-modal')).open();
        });
        applyMultiplierButton.addEventListener('click', calculateTotalAcrossAllProjects);
        projectSelector.addEventListener('change', () => {
            const selectedProjectName = projectSelector.value;
            const projectDataString = safeGetLocalStorage(`tl_project_${selectedProjectName}`);

            if (projectDataString) {
                try {
                    activeProjectData = JSON.parse(projectDataString);
                    showToast(`Project '${selectedProjectName}' loaded.`, 'blue');
                    outputDiv.textContent = '';
                    allResultsDiv.innerHTML = '';
                    lastResult = '';
                    allCalculatedResults = [];
                    allProjectsAggregatedResults = {};
                    if (isLoggedInAsTL) {
                        // Ensure rawDataInput gets the string content, not a nested object
                        rawDataInput.value = activeProjectData.data;
                        projectNameInput.value = selectedProjectName;
                        modalSizeSelect.value = activeProjectData.size;
                        modalIrCheck.checked = activeProjectData.ir;
                        M.updateTextFields();
                        M.FormSelect.init(modalSizeSelect);
                        editingProjectName = selectedProjectName;
                    }
                } catch (e) {
                    showToast(`Error parsing project data for '${selectedProjectName}'. Data might be corrupted or in an old format. Try clearing local storage.`, 'red');
                    console.error("Project data parse error:", e);
                    activeProjectData = '';
                }
            } else {
                activeProjectData = '';
                outputDiv.textContent = '';
                allResultsDiv.innerHTML = '';
                lastResult = '';
                allCalculatedResults = [];
                allProjectsAggregatedResults = {};
                if (isLoggedInAsTL) {
                    projectNameInput.value = '';
                    rawDataInput.value = '';
                    modalSizeSelect.value = '3in';
                    modalIrCheck.checked = false;
                    M.updateTextFields();
                    M.FormSelect.init(modalSizeSelect);
                }
                editingProjectName = null;
            }
        });

        document.getElementById('edit-project').addEventListener('click', () => {
            const selectedProjectName = projectSelector.value;
            if (!selectedProjectName) {
                showToast('Please select a project to edit.', 'red');
                return;
            }
            const projectDataString = safeGetLocalStorage(`tl_project_${selectedProjectName}`);
            if (projectDataString) {
                try {
                    const project = JSON.parse(projectDataString);
                    projectNameInput.value = selectedProjectName;
                    rawDataInput.value = project.data; // This assumes project.data is directly the string
                    modalSizeSelect.value = project.size;
                    modalIrCheck.checked = project.ir;
                    M.updateTextFields();
                    M.FormSelect.init(modalSizeSelect);
                    modalTitle.textContent = 'Edit Project';
                    saveProjectModalButton.textContent = 'Update Project';
                    editingProjectName = selectedProjectName;
                    M.Modal.getInstance(addProjectModal).open();
                } catch (e) {
                     showToast(`Error loading project data for editing '${selectedProjectName}'. Data might be corrupted. Try re-saving.`, 'red');
                     console.error("Edit project data load error:", e);
                }
            } else {
                showToast('Error: Could not load project data for editing.', 'red');
            }
        });

        document.getElementById('delete-project').addEventListener('click', deleteSelectedProject);

        addProjectModal.addEventListener('click', (event) => {
            if (event.target && event.target.id === 'add-project-button') {
                modalTitle.textContent = 'Add New Project';
                saveProjectModalButton.textContent = 'Save Project';
                projectNameInput.value = '';
                rawDataInput.value = '';
                modalSizeSelect.value = '3in';
                modalIrCheck.checked = false;
                M.updateTextFields();
                M.FormSelect.init(modalSizeSelect);
                editingProjectName = null;
            }
        });

        saveProjectModalButton.addEventListener('click', saveProject);
        clearDataButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear ALL saved projects from local storage? This action cannot be undone.')) {
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key.startsWith('tl_project_')) {
                        localStorage.removeItem(key);
                    }
                }
                loadProjectList();
                activeProjectData = '';
                outputDiv.textContent = '';
                allResultsDiv.innerHTML = '';
                allCalculatedResults = [];
                lastResult = '';
                allProjectsAggregatedResults = {};
                showToast('All projects cleared!', 'green');
            }
        });

        document.getElementById('export-button').addEventListener('click', () => {
            if (Object.keys(allProjectsAggregatedResults).length > 0) {
                exportToCsv('all_projects_summary.csv', Object.values(allProjectsAggregatedResults));
            } else if (allCalculatedResults.length > 0) {
                exportToCsv('per_project_summary.csv', allCalculatedResults);
            } else if (lastResult) {
                exportToCsv(`tech_id_${lastResult.techID}_details.csv`, lastResult);
            } else {
                showToast('No results to export. Please perform a calculation first.', 'red');
            }
        });

        document.getElementById('copy-all-projects-json').addEventListener('click', () => {
            const allProjectsDataForExport = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('tl_project_')) {
                    const projectName = key.replace('tl_project_', '');
                    const projectDataString = safeGetLocalStorage(key); // Get decompressed string
                    if (projectDataString !== null) { // Check if retrieval was successful (found and potentially decompressed)
                        try {
                            const projectData = JSON.parse(projectDataString); // Parse it into an object {data: "raw_string", size: "3in", ir: false}
                            // The external JSON (update.json) is an array where each item is like:
                            // { name: "ProjectName", data: { data: "raw_data_string", size: "3in", ir: false } }
                            // So, we need to push an object structured like this:
                            allProjectsDataForExport.push({
                                name: projectName,
                                data: projectData // projectData itself is the {data: raw_string, size, ir} object
                            });
                        } catch (e) {
                            console.error(`Error parsing project JSON for key ${key} during copy:`, e);
                            showToast(`Error copying project '${projectName}'. Data might be corrupted.`, 'red');
                        }
                    }
                }
            }

            if (allProjectsDataForExport.length === 0) {
                showToast('No saved projects found to copy.', 'orange');
                return;
            }

            try {
                const jsonString = JSON.stringify(allProjectsDataForExport); // Stringify the array of project objects
                const compressed = LZString.compressToBase64(jsonString); // Compress the entire stringified array to Base64

                console.log("--- DEBUG: Copy All Projects Data ---");
                console.log("Decompressed JSON string to be copied (should be array of objects):", jsonString);
                console.log("Compressed Base64 string to be copied:", compressed);
                console.log("-------------------------------------");

                navigator.clipboard.writeText(compressed).then(() => {
                    showToast('All project data (compressed) copied to clipboard!', 'green');
                }).catch(err => {
                    showToast('Failed to copy to clipboard.', 'red');
                    console.error('Failed to copy text: ', err);
                });
            } catch (e) {
                showToast('Compression or stringify error during copy.', 'red');
                console.error('Copy compression error:', e);
            }
        });

        document.getElementById('auto-fetch-external-json').addEventListener('click', autoFetchExternalJson);

        loginRoleSelect.addEventListener('change', () => {
            if (loginRoleSelect.value === 'tl') {
                tlCodeInputDiv.style.display = 'block';
                tlLoginCodeInput.setAttribute('required', 'required');
            } else {
                tlCodeInputDiv.style.display = 'none';
                tlLoginCodeInput.removeAttribute('required');
            }
            M.updateTextFields();
        });

        loginButtonElement.addEventListener('click', async () => {
            const selectedRole = loginRoleSelect.value;
            if (selectedRole === 'tl') {
                const enteredCode = tlLoginCodeInput.value;
                if (await verifyTlLoginCode(enteredCode)) {
                    isLoggedInAsTL = true;
                    showToast('Logged in as TL!', 'green');
                    M.Modal.getInstance(loginModal).close();
                    mainAppContent.style.display = 'block';
                    loadProjectList();
                    updateButtonVisibility();
                } else {
                    showToast('Incorrect TL code. Please try again.', 'red');
                    isLoggedInAsTL = false;
                }
            } else {
                isLoggedInAsTL = false;
                showToast('Logged in as Tech!', 'green');
                M.Modal.getInstance(loginModal).close();
                mainAppContent.style.display = 'block';
                loadProjectList();
                updateButtonVisibility();
            }
        });

        logoutButton.addEventListener('click', () => {
            isLoggedInAsTL = false;
            showToast('Logged out. Select role to continue.', 'blue');
            mainAppContent.style.display = 'none';
            outputDiv.textContent = '';
            allResultsDiv.innerHTML = '';
            lastResult = '';
            allCalculatedResults = [];
            allProjectsAggregatedResults = {};
            loginRoleSelect.value = '';
            tlLoginCodeInput.value = '';
            tlCodeInputDiv.style.display = 'none';
            M.FormSelect.init(loginRoleSelect);
            M.updateTextFields();
            M.Modal.getInstance(loginModal).open();
        });

        fullscreenCloseButton.addEventListener('click', () => {
            M.Modal.getInstance(fullscreenResultsModal).close();
        });

        fullscreenResultsModal.addEventListener('click', (event) => {
            if (event.target === fullscreenResultsModal) {
                hideFullscreenModal();
            }
        });
        if (viewProjectDataButton) {
             viewProjectDataButton.addEventListener('click', viewProjectData);
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            document.body.style.display = 'none';

            M.FormSelect.init(projectSelector);
            M.FormSelect.init(loginRoleSelect);
            M.FormSelect.init(modalSizeSelect);
            M.Modal.init(document.querySelectorAll('.modal'), {
                dismissible: false,
                onOpenEnd: (modalEl) => {
                    if (modalEl.id === 'add-project-modal') {
                        M.textareaAutoResize(document.getElementById('raw-data'));
                    }
                }
            });

            const loginModalInstance = M.Modal.getInstance(loginModal);

            document.body.style.display = 'block';

            if (loginModalInstance) {
                loginModalInstance.open();
            } else {
                console.error("Login modal not found or not initialized by Materialize.");
                mainAppContent.style.display = 'block';
                loadProjectList();
                updateButtonVisibility();
            }
        });
    </script>
</body>
</html>
