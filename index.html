<!DOCTYPE html>
<html>
<head>
    <title>123 - Fixpoint Extractor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="icon.png" type="image/png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Define your eye-friendly purple palette (Light Mode) */
            --primary-purple: #8E7DBF; /* Muted Purple */
            --primary-purple-dark: #5B4A8C; /* Deeper Muted Purple */
            --primary-purple-light: #F5F2F9; /* Very light purple for backgrounds */
            --accent-purple: #9C7CDA; /* Slightly brighter accent purple */

            --light-bg: #F8F7FB; /* Soft, almost white background */
            --medium-bg: #EFEFEF; /* Light neutral grey */
            --dark-text: #444444; /* Dark charcoal grey for main text */
            --light-text: #FFFFFF; /* White text */

            /* Softer action colors */
            --info-blue: #64b5f6; /* Light Blue 300 */
            --success-green: #81c784; /* Light Green 300 */
            --warning-orange: #ffb74d; /* Amber 300 */
            --danger-red: #e57373; /* Red 300 */
        }

        /* Dark Mode Colors */
        body.dark-mode {
            --primary-purple: #9C7CDA; /* Brighter muted purple for dark mode */
            --primary-purple-dark: #8E7DBF; /* Still a deep purple, slightly lighter than light mode's dark */
            --primary-purple-light: #3A305D; /* Darker purple for elements */
            --accent-purple: #B08FD9; /* A bit brighter accent */

            --light-bg: #2C273B; /* Deep dark purple background */
            --medium-bg: #443C5C; /* Medium dark purple for elements */
            --dark-text: #E0E0E0; /* Light grey for text */
            --light-text: #222222; /* Dark text for contrast on light elements (e.g. table headers) */

            /* Adjusted action colors for dark mode */
            --info-blue: #64b5f6; /* Keep light blue for visibility */
            --success-green: #81c784; /* Keep light green for visibility */
            --warning-orange: #ffb74d; /* Keep amber for visibility */
            --danger-red: #e57373; /* Keep red for visibility */
        }

        body {
            padding: 20px;
            background-color: var(--light-bg); /* Soft light background */
            font-family: 'Open Sans', sans-serif;
            color: var(--dark-text); /* Dark charcoal text */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for dark mode */
        }
        h5, h4 {
            font-family: 'Roboto Slab', serif;
            color: var(--primary-purple-dark); /* Deeper muted purple for headings */
            transition: color 0.3s ease; /* Smooth transition for dark mode */
        }
        .container {
            background-color: var(--light-text); /* White in light, dark grey in dark */
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode .container {
            background-color: #3A305D; /* Darker background for container in dark mode */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .container:hover {
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }
        body.dark-mode .container:hover {
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        .result {
            background: var(--primary-purple-light);
            padding: 20px;
            margin-top: 20px;
            white-space: pre-wrap;
            border-left: 4px solid var(--primary-purple);
            font-family: 'Courier New', monospace;
            min-height: 100px;
            border-radius: 8px;
            overflow-x: auto;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        body.dark-mode .result {
            background: #443C5C; /* Darker background for results in dark mode */
            border-left-color: var(--primary-purple);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .result-buttons {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 1;
        }
        .result-buttons .expand-button,
        .result-buttons .view-data-result-button {
            background-color: rgba(0, 0, 0, 0.05);
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            cursor: pointer;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-left: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        body.dark-mode .result-buttons .expand-button,
        body.dark-mode .result-buttons .view-data-result-button {
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .result-buttons .expand-button:hover,
        .result-buttons .view-data-result-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        body.dark-mode .result-buttons .expand-button:hover,
        body.dark-mode .result-buttons .view-data-result-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .result-buttons .expand-button i.material-icons,
        .result-buttons .view-data-result-button i.material-icons {
            font-size: 20px;
            color: var(--dark-text);
        }
        .result table.striped tbody tr:nth-child(odd) {
            background-color: var(--primary-purple-light);
        }
        body.dark-mode .result table.striped tbody tr:nth-child(odd) {
            background-color: #443C5C; /* Darker odd rows */
        }
        .result table.striped tbody tr:nth-child(even) {
            background-color: #ede7f6;
        }
        body.dark-mode .result table.striped tbody tr:nth-child(even) {
            background-color: #3A305D; /* Darker even rows */
        }
        .result table th {
            background-color: var(--primary-purple-dark);
            color: var(--light-text);
            padding: 14px 18px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.dark-mode .result table th {
            background-color: var(--primary-purple-dark);
            color: var(--dark-text); /* Dark text on light header */
        }
        .result table td, .result table th {
            padding: 12px 15px;
            border: 1px solid #d1c4e9;
            transition: border-color 0.3s ease;
        }
        body.dark-mode .result table td, body.dark-mode .result table th {
            border-color: #5B4A8C; /* Darker border */
        }
        .result table {
            border-collapse: collapse;
            width: 100%;
        }
        .modal textarea {
            height: 150px;
            overflow-y: auto;
            resize: none;
        }
        .modal-content textarea.materialize-textarea {
            height: 150px !important;
            overflow-y: auto;
            resize: none;
        }
        .input-field {
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .input-field input:focus + label,
        .input-field textarea:focus + label {
            color: var(--primary-purple) !important;
        }
        .input-field input:focus,
        .input-field textarea:focus {
            border-bottom: 1px solid var(--primary-purple) !important;
            box-shadow: 0 1px 0 0 var(--primary-purple) !important;
        }
        .input-field select:focus {
            outline: 1px solid var(--primary-purple);
        }
        /* Dark Mode Input Field adjustments */
        body.dark-mode .input-field label {
            color: var(--dark-text) !important; /* Light label text */
        }
        body.dark-mode .input-field input,
        body.dark-mode .input-field textarea {
            color: var(--dark-text); /* Light input text */
            border-bottom-color: var(--primary-purple-dark) !important;
        }
        body.dark-mode .input-field input:focus,
        body.dark-mode .input-field textarea:focus {
            border-bottom: 1px solid var(--accent-purple) !important;
            box-shadow: 0 1px 0 0 var(--accent-purple) !important;
        }
        body.dark-mode .input-field input[type=text]:not(.browser-default):focus:not([readonly]) + label,
        body.dark-mode .input-field input[type=password]:not(.browser-default):focus:not([readonly]) + label,
        body.dark-mode .input-field textarea.materialize-textarea:focus:not([readonly]) + label {
            color: var(--accent-purple) !important;
        }
        body.dark-mode .input-field .caret { /* For select dropdown arrow */
            fill: var(--dark-text);
        }
        body.dark-mode .select-wrapper input.select-dropdown {
            color: var(--dark-text);
        }
        body.dark-mode .dropdown-content li > a,
        body.dark-mode .dropdown-content li > span {
            color: var(--dark-text);
        }
        body.dark-mode .dropdown-content {
            background-color: var(--medium-bg);
        }

        /* Button Styling - Modern, subtle shadows, consistent hover */
        .btn, .btn-large, .btn-small, .btn-flat {
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            margin-top: 15px;
            margin-bottom: 15px;
            margin-right: 12px;
            text-transform: none;
            font-weight: 600;
            color: var(--light-text); /* Ensure text color is light for all buttons */
        }
        .btn:hover, .btn-large:hover, .btn-small:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: translateY(-2px);
            opacity: 1;
        }
        .btn i.material-icons.left {
            margin-right: 8px;
        }
        .btn i.material-icons.tiny { 
            font-size: 1em;
            vertical-align: sub;
        }


        /* Specific Button Colors - Eye-Friendly Purple Theme Mapping */
        .btn.blue, .btn.blue.darken-1 { background-color: var(--primary-purple) !important; }
        .btn.blue:hover, .btn.blue.darken-1:hover { background-color: var(--primary-purple-dark) !important; }

        .btn.green { background-color: var(--success-green) !important; }
        .btn.green:hover { background-color: #66bb6a !important; }

        .btn.orange, .btn.orange.darken-2 { background-color: var(--warning-orange) !important; } 
        .btn.orange:hover, .btn.orange.darken-2:hover { background-color: #ffa726 !important; }


        .btn.red, .btn.red.darken-2 { background-color: var(--danger-red) !important; }
        .btn.red:hover, .btn.red.darken-2:hover { background-color: #ef5350 !important; }

        .btn.purple.darken-2 { background-color: var(--primary-purple-dark) !important; }
        .btn.purple.darken-2:hover { background-color: #4527a0 !important; }

        .btn.deep-purple.darken-2 { background-color: var(--primary-purple-dark) !important; }
        .btn.deep-purple.darken-2:hover { background-color: #4527a0 !important; }

        .btn.grey.darken-1 { background-color: #9e9e9e !important; }
        .btn.grey.darken-1:hover { background-color: #757575 !important; }
        
        .btn.blue-grey.darken-1 { background-color: #546e7a !important; } 
        .btn.blue-grey.darken-1:hover { background-color: #455a64 !important; }


        /* Floating Action Button specific */
        .btn-floating.btn-large.green {
            background-color: var(--accent-purple) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-floating.btn-large.green:hover {
            background-color: #8367d3 !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transform: translateY(-3px);
        }

        /* Dark Mode Toggle Button */
        #dark-mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--medium-bg); 
            color: var(--dark-text); 
            border-radius: 50%;
            width: 44px; 
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            z-index: 999; 
        }
        #dark-mode-toggle:hover {
            background-color: var(--primary-purple-light); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        body.dark-mode #dark-mode-toggle {
            background-color: #5B4A8C; 
            color: var(--dark-text); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        body.dark-mode #dark-mode-toggle:hover {
            background-color: #6A5B9C;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        #dark-mode-toggle i.material-icons {
            font-size: 24px;
        }

        .right-align {
            margin-bottom: 20px;
        }
        .center-align {
            margin-top: 25px;
            margin-bottom: 25px;
        }
        #all-results {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 30px;
        }
        #all-results h5 {
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        body.dark-mode #all-results h5 {
            border-bottom-color: #555; 
        }
        .modal-content h5 {
            margin-bottom: 20px;
        }
        .modal-content .input-field {
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .modal-footer a.btn, .modal-footer a.btn-flat { /* Ensure buttons in footer have margin */
            margin-left: 10px;
        }
        /* Modal specific styling for dark mode */
        .modal {
            background-color: #ffffff; 
            transition: background-color 0.3s ease;
        }
        body.dark-mode .modal {
            background-color: #3A305D; 
        }
        body.dark-mode .modal .modal-content {
            color: var(--dark-text); 
        }
        body.dark-mode .modal .modal-footer {
            background-color: #443C5C; 
            border-top-color: #5B4A8C;
        }

        #login-modal {
            max-width: 450px;
            border-radius: 12px;
            margin: auto;
            overflow: hidden;
        }
        #login-modal .modal-content {
            padding: 35px;
            text-align: center;
            background-color: #ffffff;
        }
        body.dark-mode #login-modal .modal-content {
            background-color: #3A305D; 
        }
        #login-modal .modal-content h5 {
            margin-bottom: 30px;
            color: var(--primary-purple-dark);
        }
        #login-modal .input-field {
            margin-bottom: 25px;
        }
        #login-modal .modal-footer {
            padding: 20px;
            text-align: center;
            background-color: var(--primary-purple-light);
            border-top: 1px solid #d1c4e9;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        body.dark-mode #login-modal .modal-footer {
            background-color: #443C5C;
            border-top-color: #5B4A8C;
        }
        #login-modal .btn {
            width: 100%;
            margin-right: 0;
            background-color: var(--primary-purple) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        #login-modal .btn:hover {
            background-color: var(--primary-purple-dark) !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
        }
        
        #fullscreen-results-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        #fullscreen-results-content {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            max-width: 95%;
            max-height: 95%;
            overflow: auto;
            position: relative;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        body.dark-mode #fullscreen-results-content {
            background-color: #3A305D;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }
        #fullscreen-results-content .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(255, 255, 255, 0.85);
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 2;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        body.dark-mode #fullscreen-results-content .close-button {
            background-color: rgba(0, 0, 0, 0.3);
            color: var(--dark-text);
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }
        #fullscreen-results-content .close-button:hover {
            background-color: rgba(255, 255, 255, 0.95);
            transform: rotate(90deg);
        }
        body.dark-mode #fullscreen-results-content .close-button:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }
        #fullscreen-results-content .close-button i.material-icons {
            font-size: 22px;
            color: var(--dark-text);
        }
        #view-data-modal {
            max-width: 95%;
            max-height: 95%;
            width: 95%;
            height: 95%;
            top: 2.5% !important;
            transform: translate(-50%, 0%) !important;
            left: 50% !important;
            border-radius: 12px;
        }
        #view-data-modal .modal-content {
            overflow-y: auto;
            max-height: calc(100% - 70px); 
            padding-bottom: 0;
        }
        #view-data-modal table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #view-data-modal table th,
        #view-data-modal table td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: left;
            white-space: nowrap;
        }
        body.dark-mode #view-data-modal table th,
        body.dark-mode #view-data-modal table td {
            border-color: #5B4A8C;
        }
        #view-data-modal table th {
            background-color: var(--primary-purple-light);
            color: var(--dark-text);
            font-weight: bold;
        }
        body.dark-mode #view-data-modal table th {
            background-color: var(--primary-purple-dark);
            color: var(--dark-text);
        }
        #view-data-table-container .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
            }
            .btn {
                /* margin-right: 8px; */ /* Adjusted by specific button or class */
                /* margin-bottom: 12px; */ /* Adjusted by specific button or class */
            }
            .center-align {
                margin-top: 15px;
                margin-bottom: 15px;
            }
            #all-results {
                max-height: 400px;
            }
            #fullscreen-results-content {
                max-width: 95%;
                max-height: 95%;
            }
            #view-data-modal { 
                max-width: 95%;
                width: 95%;
                height: 95%;
                top: 2.5% !important;
                transform: translate(-50%, 0%) !important;
                left: 50% !important;
            }
            #dark-mode-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
            #dark-mode-toggle i.material-icons {
                font-size: 20px;
            }
            
             .center-align .btn { 
                display: block;
                width: calc(100% - 16px); 
                margin-left: 8px;
                margin-right: 8px;
                margin-bottom: 12px; /* Add bottom margin for stacking */
            }
            .center-align .btn:last-child {
                margin-bottom: 0;
            }
            /* Ensure FAB doesn't get caught by .center-align .btn rule */
            .right-align .btn-floating {
                display: inline-flex !important; /* Materialize default for FAB */
                width: 56px !important; /* Materialize default */
            }

        }
        /* Custom styles for Quality and Bonus */
        .quality-green {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        body.dark-mode .quality-green {
            background-color: #2e7d32; 
            color: #e8f5e9; 
        }
        .quality-orange {
            background-color: #fff3e0;
            color: #ef6c00;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        body.dark-mode .quality-orange {
            background-color: #ef6c00; 
            color: #fff3e0; 
        }
        .quality-red {
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        body.dark-mode .quality-red {
            background-color: #c62828; 
            color: #ffebee; 
        }
        .tech-id-highlight {
            font-weight: bold;
            color: var(--primary-purple-dark);
        }
        .salary-highlight {
            background-color: #f0f0f0;
            color: #333;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        body.dark-mode .salary-highlight {
            background-color: #5B4A8C; 
            color: var(--dark-text); 
        }
        .tech-id-red-highlight {
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        body.dark-mode .tech-id-red-highlight {
            background-color: #c62828;
            color: #ffebee;
        }

        /* Spinner color */
        .spinner-layer.spinner-blue-only .circle-clipper .circle,
        .spinner-layer.spinner-blue-only .gap-patch .circle {
            border-color: var(--primary-purple) !important;
        }
        .preloader-wrapper.active .spinner-layer.spinner-blue-only .circle-clipper.left,
        .preloader-wrapper.active .spinner-layer.spinner-blue-only .circle-clipper.right {
            border-color: var(--primary-purple) !important;
        }
    </style>
</head>
<body>
    <button id="dark-mode-toggle">
        <i class="material-icons">brightness_high</i>
    </button>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h5 class="center-align">Login</h5>
            <div class="input-field">
                <select id="login-role">
                    <option value="" disabled selected>Choose your role</option>
                    <option value="tl">Login as TL</option>
                    <option value="tech">Login as Tech</option>
                </select>
                <label for="login-role">Select Role</label>
            </div>
            <div class="input-field" id="tl-code-input" style="display: none;">
                <input id="tl-login-code" type="password">
                <label for="tl-login-code">TL Login Code</label>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn blue" id="login-button">Login</a>
        </div>
    </div>

    <div class="container" id="main-app-content" style="display: none;">
        <h5 class="center-align">123 EXTRACTOR v2.5</h5>
        <div class="right-align" style="margin-top: 10px;">
            <a class="btn-floating btn-large green modal-trigger" href="#add-project-modal" id="add-project-button">
                <i class="material-icons">add</i>
            </a>
        </div>
        <div class="input-field">
            <select id="project-selector">
                <option value="" disabled selected>Select a saved project</option>
            </select>
            <label for="project-selector">Load Project</label>
        </div>
        <div class="center-align">
            <button class="btn orange darken-2" id="edit-project">
                <i class="material-icons left">edit</i>Edit Project
            </button>
            <button class="btn red darken-2" id="delete-project">
                <i class="material-icons left">delete</i>Delete Project
            </button>
            <button class="btn blue-grey darken-1 modal-trigger" href="#view-data-modal" id="view-project-data-button">
                <i class="material-icons left">table_chart</i>View Data
            </button>
        </div>
        <div class="input-field">
            <input id="tech-id" type="text" placeholder="e.g. TECH123">
            <label for="tech-id">Search TECH ID</label>
        </div>
        <div class="center-align">
            <button class="btn blue" id="search-button">
                <i class="material-icons left">search</i>Search
            </button>
            <button class="btn green" id="calculate-all-button">
                <i class="material-icons left">calculate</i>Per Project Total
            </button>
            <button class="btn purple darken-2 modal-trigger" href="#multiplier-modal" id="calculate-all-projects-button">
                <i class="material-icons left">grid_on</i>All Projects Total
            </button>
        </div>
        <div class="center-align" style="margin-top: 10px;">
            <button class="btn orange" id="export-button">
                <i class="material-icons left">file_download</i>Download CSV
            </button>
            <button class="btn red" id="clear-data-button">
                <i class="material-icons left">clear_all</i>Clear All Data
            </button>
        </div>
        <div class="center-align" style="margin-top: 10px;">
            <button class="btn blue darken-1" id="copy-all-projects-json">
                <i class="material-icons left">content_copy</i>Copy All Projects Data
            </button>
            <button class="btn deep-purple darken-2" id="auto-fetch-external-json">
                <i class="material-icons left">cloud_download</i>Update Projects Online
            </button>
        </div>
        <div id="output" class="result z-depth-1">
        </div>
        <div id="all-results" class="result z-depth-1" style="margin-top: 20px; max-height: 600px; overflow-y: auto;">
        </div>
        <div id="multiplier-modal" class="modal">
            <div class="modal-content">
                <h5>Enter Multiplier</h5>
                <div class="input-field">
                    <input id="total-multiplier" type="number" value="1" step="0.01">
                    <label for="total-multiplier">Multiplier</label>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close btn grey">Cancel</a>
                <a href="#!" class="btn green" id="apply-multiplier">Apply Multiplier</a>
            </div>
        </div>
        <div id="add-project-modal" class="modal">
            <div class="modal-content">
                <h5 id="modal-title">Add New Project</h5>
                <div class="input-field">
                    <input id="project-name" type="text">
                    <label for="project-name">Project Name</label>
                </div>
                <div class="input-field">
                    <textarea id="raw-data" class="materialize-textarea" placeholder="Paste your fixpoints data here..."></textarea>
                    <label for="raw-data">Fixpoints Data</label>
                </div>
                <div class="row">
                    <div class="input-field col s6">
                        <select id="modal-size">
                            <option value="3in">3IN</option>
                            <option value="9in">9IN</option>
                        </select>
                        <label for="modal-size">Project Size</label>
                    </div>
                    <div class="input-field col s6">
                        <label>
                            <input type="checkbox" id="modal-ir-check" />
                            <span>IR Multiplier</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close btn green" id="save-project-modal-button">Save Project</a>
            </div>
        </div>
        <div class="center-align" style="margin-top: 20px;">
            <a href="instructions.html" target="_blank" class="btn waves-effect waves-light grey darken-1" id="instructions-button" style="margin-right: 12px;">
                <i class="material-icons left">help_outline</i>Instructions
            </a>
            <button class="btn waves-effect waves-light grey darken-1" id="logout-button">
                <i class="material-icons left">logout</i>Logout / Change Role
            </button>
        </div>
    </div>

    <div id="view-data-modal" class="modal">
        <div class="modal-content">
            <h5 id="view-data-modal-title">Project Data</h5>
            <div id="view-data-table-container" style="overflow-x: auto;">
                <div class="spinner-container" id="view-data-spinner" style="display: none;">
                    <div class="preloader-wrapper active">
                        <div class="spinner-layer spinner-blue-only">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn grey">Close</a>
        </div>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h5 id="confirmation-modal-title">Confirm Action</h5>
            <p id="confirmation-modal-message"></p>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn grey darken-1" id="confirmation-cancel-button">Cancel</a>
            <a href="#!" class="modal-close btn red darken-2" id="confirmation-confirm-button">Confirm</a>
        </div>
    </div>

    <div id="fullscreen-results-modal">
        <div id="fullscreen-results-content">
            <button class="close-button"><i class="material-icons">close</i></button>
        </div>
    </div>

    <div id="loader-spinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
        <div class="preloader-wrapper active">
            <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                    <div class="circle"></div>
                </div>
                <div class="gap-patch">
                    <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                    <div class="circle"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script>
        // --- Configuration ---
        const HARDCODED_PROJECTS_JSON_URL = 'https://raw.githubusercontent.com/serhgs/project_data.json/refs/heads/main/update.json';
        const HARDCODED_TL_CODE_URL = 'https://raw.githubusercontent.com/gmlorenz/gmlorenz.github.io/refs/heads/main/projects_data.json';
        const PRICES = [
            { "3in": 2.19, "9in": 0.99 }, { "3in": 5.86, "9in": 2.08 }, { "3in": 7.44, "9in": 2.78 },
            { "3in": 2.29, "9in": 1.57 }, { "3in": 1.55, "9in": 0.60 }, { "3in": 1.84, "9in": 0.78 },
            { "3in": 1.00, "9in": 1.00 }, { "3in": 3.74, "9in": 3.74 }, { "3in": 1.73, "9in": 1.73 }
        ];

        // --- DOM Elements ---
        const projectSelector = document.getElementById('project-selector');
        const rawDataInput = document.getElementById('raw-data');
        const projectNameInput = document.getElementById('project-name');
        const techIdInput = document.getElementById('tech-id');
        const outputDiv = document.getElementById('output');
        const allResultsDiv = document.getElementById('all-results');
        const addProjectModal = document.querySelector('#add-project-modal'); 
        const modalTitle = document.getElementById('modal-title');
        const saveProjectModalButton = document.getElementById('save-project-modal-button');
        const clearDataButton = document.getElementById('clear-data-button');
        const addProjectButton = document.getElementById('add-project-button'); 
        const mainAppContent = document.getElementById('main-app-content');
        const logoutButton = document.getElementById('logout-button');
        const loginModal = document.getElementById('login-modal');
        const loginRoleSelect = document.getElementById('login-role');
        const tlCodeInputDiv = document.getElementById('tl-code-input');
        const tlLoginCodeInput = document.getElementById('tl-login-code');
        const loginButtonElement = document.getElementById('login-button');
        const fullscreenResultsModal = document.getElementById('fullscreen-results-modal');
        const fullscreenResultsContent = document.getElementById('fullscreen-results-content');
        const fullscreenCloseButton = fullscreenResultsContent.querySelector('.close-button');
        const viewDataModal = document.getElementById('view-data-modal');
        const viewDataTableContainer = document.getElementById('view-data-table-container');
        const viewDataModalTitle = document.getElementById('view-data-modal-title');
        const viewDataSpinner = document.getElementById('view-data-spinner');
        const multiplierInput = document.getElementById('total-multiplier');
        const applyMultiplierButton = document.getElementById('apply-multiplier');
        const modalSizeSelect = document.getElementById('modal-size');
        const modalIrCheck = document.getElementById('modal-ir-check');
        const viewProjectDataButton = document.getElementById('view-project-data-button');
        const autoFetchButton = document.getElementById('auto-fetch-external-json');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const calcAllProjectsBtn = document.getElementById('calculate-all-projects-button'); // Added declaration
        const exportBtn = document.getElementById('export-button'); // Added declaration


        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmationConfirmButton = document.getElementById('confirmation-confirm-button');
        const confirmationCancelButton = document.getElementById('confirmation-cancel-button');

        // --- Global State ---
        let activeProjectData = ''; 
        let allCalculatedResults = []; 
        let lastResult = ''; 
        let allProjectsAggregatedResults = {}; 
        let editingProjectName = null;
        let isLoggedInAsTL = false;
        let confirmPromiseResolve = null;

        // --- Utility Functions ---
        function showToast(html, classes = '') { M.toast({ html, classes }); }
        function showLoader() { const l = document.getElementById('loader-spinner'); if (l) l.style.display = 'block'; }
        function hideLoader() { const l = document.getElementById('loader-spinner'); if (l) l.style.display = 'none'; }

        function safeSetLocalStorage(key, value) {
            try {
                const compressedValue = LZString.compressToUTF16(value);
                if (compressedValue === null) throw new Error("Compression failed.");
                localStorage.setItem(key, compressedValue);
                return true;
            } catch (e) {
                showToast(e.name === 'QuotaExceededError' ? 'Local storage full!' : `Error saving to local storage: ${e.message}`, 'red');
                console.error("Local storage save error:", e);
                return false;
            }
        }

        function safeGetLocalStorage(key) {
            try {
                const value = localStorage.getItem(key);
                if (value === null) return null;
                let decompressedValue = LZString.decompressFromUTF16(value);
                if (decompressedValue !== null) return decompressedValue;
                console.warn(`Decompression failed for key "${key}". Attempting as uncompressed.`);
                return value; 
            } catch (e) {
                console.error(`Error retrieving/decompressing key "${key}":`, e);
                showToast('Error loading data. Data might be corrupted.', 'red');
                return null;
            }
        }

        function showCustomConfirm(message, title = 'Confirm Action') {
            return new Promise(resolve => {
                confirmationModalTitle.textContent = title;
                confirmationModalMessage.textContent = message;
                M.Modal.getInstance(confirmationModal).open();
                confirmPromiseResolve = resolve;
            });
        }

        // --- UI Component Functions ---
        function loadProjectList() {
            projectSelector.innerHTML = '<option value="" disabled selected>Select a saved project</option>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('tl_project_')) {
                    const name = key.replace('tl_project_', '');
                    const option = document.createElement('option');
                    option.value = name; option.textContent = name;
                    projectSelector.appendChild(option);
                }
            }
            M.FormSelect.init(projectSelector);
        }

        function addResultButtons(targetDiv) {
            const existingButtons = targetDiv.querySelector('.result-buttons');
            if (existingButtons) existingButtons.remove();

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'result-buttons';

            if (targetDiv.id === 'output' && lastResult && lastResult.techID) { 
                const viewDataBtn = document.createElement('button');
                viewDataBtn.className = 'view-data-result-button tooltipped';
                viewDataBtn.setAttribute('data-position', 'left');
                viewDataBtn.setAttribute('data-tooltip', 'View Raw Data for this TECH ID');
                viewDataBtn.innerHTML = '<i class="material-icons">table_chart</i>';
                viewDataBtn.addEventListener('click', () => {
                    if (!activeProjectData || !activeProjectData.data) {
                        showToast('No project data loaded to view details.', 'orange'); return;
                    }
                    displayDataTableInModal(activeProjectData.data, lastResult.techID);
                });
                buttonsContainer.appendChild(viewDataBtn);
                M.Tooltip.init(viewDataBtn); 
            }

            const expandButton = document.createElement('button');
            expandButton.className = 'expand-button tooltipped';
            expandButton.setAttribute('data-position', 'left');
            expandButton.setAttribute('data-tooltip', 'Expand Results');
            expandButton.innerHTML = '<i class="material-icons">fullscreen</i>';
            expandButton.addEventListener('click', () => {
                let contentToExpand = targetDiv.cloneNode(true);
                const clonedButtonsContainer = contentToExpand.querySelector('.result-buttons');
                if (clonedButtonsContainer) clonedButtonsContainer.remove();

                fullscreenResultsContent.innerHTML = '';
                fullscreenResultsContent.appendChild(contentToExpand);

                let existingCloseBtn = fullscreenResultsContent.querySelector('.close-button');
                if(!existingCloseBtn) { 
                    const closeBtn = document.createElement('button');
                    closeBtn.classList.add('close-button');
                    closeBtn.innerHTML = '<i class="material-icons">close</i>';
                    fullscreenResultsContent.appendChild(closeBtn);
                    closeBtn.addEventListener('click', hideFullscreenModal);
                } else { 
                    existingCloseBtn.removeEventListener('click', hideFullscreenModal);
                    existingCloseBtn.addEventListener('click', hideFullscreenModal);
                }
                fullscreenResultsModal.style.display = 'flex';
            });
            buttonsContainer.appendChild(expandButton);
            M.Tooltip.init(expandButton); 

            targetDiv.prepend(buttonsContainer);
        }
        
        function hideFullscreenModal() {
            fullscreenResultsModal.style.display = 'none';
            fullscreenResultsContent.innerHTML = ''; 
        }

        function displayDataTableInModal(rawDataString, techIDFilter = '') {
            viewDataTableContainer.innerHTML = ''; 
            viewDataSpinner.style.display = 'flex'; 

            setTimeout(() => {
                const rows = String(rawDataString).split(/\r?\n/).filter(r => r.trim() !== "");
                if (rows.length === 0) {
                    viewDataTableContainer.innerHTML = '<p>No data available.</p>';
                } else {
                    const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim()) || [];
                    const headersUpperCase = headers.map(h => h.toUpperCase());
                    const fixIdIndex = headersUpperCase.indexOf("FIX1_ID");
                    let tableHtml = '<table class="striped responsive-table"><thead><tr>';
                    headers.forEach(h => tableHtml += `<th>${h}</th>`);
                    tableHtml += '</tr></thead><tbody>';
                    let foundRows = false;
                    const filterUpper = techIDFilter.toUpperCase();
                    rows.forEach(row => {
                        const fields = row.split(/[\t,]/).map(f => f.trim());
                        if (techIDFilter === '' || fixIdIndex === -1 || (fields[fixIdIndex]?.toUpperCase() === filterUpper)) {
                            foundRows = true;
                            tableHtml += '<tr>';
                            fields.forEach(f => tableHtml += `<td>${f}</td>`);
                            tableHtml += '</tr>';
                        }
                    });
                    tableHtml += '</tbody></table>';
                    viewDataTableContainer.innerHTML = (foundRows || techIDFilter === '') ? tableHtml : `<p>No data found for TECH ID: ${techIDFilter}.</p>`;
                }
                let modalTitleText = `Data for Project: ${projectSelector.value || 'Loaded Project'}`;
                if (techIDFilter) modalTitleText += ` (Filtered by TECH ID: ${techIDFilter})`;
                viewDataModalTitle.textContent = modalTitleText;
                viewDataSpinner.style.display = 'none';
                M.Modal.getInstance(viewDataModal).open();
            }, 50);
        }

        function viewProjectData() {
            const selectedProjectName = projectSelector.value;
            if (!selectedProjectName) { showToast('Please select a project.', 'orange'); return; }
            if (!activeProjectData || !activeProjectData.data) {
                const storedData = safeGetLocalStorage(`tl_project_${selectedProjectName}`);
                if (storedData) try { activeProjectData = JSON.parse(storedData); } catch (e) { /* handled below */ }
            }
            if (!activeProjectData || !activeProjectData.data) {
                showToast('No data loaded for the selected project.', 'orange'); return;
            }
            displayDataTableInModal(activeProjectData.data);
        }

        function getBonusPercentage(qualityPercentage) {
            if (qualityPercentage < 77.50) return 0; if (qualityPercentage >= 100.00) return 120;
            const bonusTiers = [
                { q: 77.50, b: 5 }, { q: 78.00, b: 10 }, { q: 78.50, b: 15 }, { q: 79.00, b: 20 }, { q: 79.50, b: 25 },
                { q: 80.00, b: 30 }, { q: 80.50, b: 35 }, { q: 81.00, b: 40 }, { q: 81.50, b: 45 }, { q: 82.00, b: 50 },
                { q: 82.50, b: 55 }, { q: 83.00, b: 57 }, { q: 83.50, b: 60 }, { q: 84.00, b: 62 }, { q: 84.50, b: 64 },
                { q: 85.00, b: 66 }, { q: 85.50, b: 68 }, { q: 86.00, b: 70 }, { q: 86.50, b: 73 }, { q: 87.00, b: 75 },
                { q: 87.50, b: 78 }, { q: 88.00, b: 80 }, { q: 88.50, b: 83 }, { q: 89.00, b: 85 }, { q: 89.50, b: 87 },
                { q: 90.00, b: 88 }, { q: 90.50, b: 90 }, { q: 91.00, b: 91 }, { q: 91.50, b: 93 }, { q: 92.00, b: 94 },
                { q: 92.50, b: 95 }, { q: 93.00, b: 96 }, { q: 93.50, b: 97 }, { q: 94.00, b: 98 }, { q: 94.50, b: 99 },
                { q: 95.00, b: 100 }, { q: 95.50, b: 102 }, { q: 96.00, b: 104 }, { q: 96.50, b: 106 }, { q: 97.00, b: 108 },
                { q: 97.50, b: 110 }, { q: 98.00, b: 112 }, { q: 98.50, b: 114 }, { q: 99.00, b: 116 }, { q: 99.50, b: 118 }
            ];
            for (let i = bonusTiers.length - 1; i >= 0; i--) if (qualityPercentage >= bonusTiers[i].q) return bonusTiers[i].b;
            return 0;
        }

        function calculateRowDetails(fields, headers, size, ir) {
            const catCols = ["CATEGORY", "I3QA_CAT", "RV1_CAT", "AFP1_CAT", "AFP2_CAT", "RV2_CAT"];
            let rowPoints = 0;
            let categoryCounts = Array(9).fill(0);
            let categoryPoints = Array(9).fill(0);
            catCols.forEach(colName => {
                const idx = headers.indexOf(colName); // Headers are already uppercase
                if (idx !== -1 && fields[idx]) {
                    const val = parseInt(fields[idx].trim());
                    if (!isNaN(val) && val >= 1 && val <= 9) {
                        const price = PRICES[val - 1][size];
                        if (typeof price !== 'number') { console.warn(`Invalid price for ${colName} ${val}, size ${size}`); return; }
                        const currentCatPoints = price * (ir ? 2 : 1);
                        rowPoints += currentCatPoints;
                        categoryCounts[val - 1]++;
                        categoryPoints[val - 1] += currentCatPoints;
                    }
                }
            });
            return { rowPoints, categoryCounts, categoryPoints };
        }

        function calculateDetailsForTechIDInRaw(raw, techIDValue, size, ir) {
            const rows = String(raw).split(/\r?\n/).filter(r => r.trim() !== "");
            if (rows.length === 0) return null;
            const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim().toUpperCase()) || [];
            const idx = {
                fixId: headers.indexOf("FIX1_ID"), afp1stat: headers.indexOf("AFP1_STAT"),
                rv1lbl: headers.indexOf("RV1_LABEL"), i3qalbl: headers.indexOf("I3QA_LABEL"), rv2lbl: headers.indexOf("RV2_LABEL"),
                rv1cat: headers.indexOf("RV1_CAT"), rv2cat: headers.indexOf("RV2_CAT")
            };
            if (idx.fixId === -1) { console.error("FIX1_ID column not found in headers:", headers); return null; }

            let totalPoints = 0, addFix = 0, excFix = 0, missFix = 0, incCnt = 0, incPtsVal = 0;
            const aggCatPts = Array(9).fill(0), aggCatCnts = Array(9).fill(0);
            const techIDUpper = techIDValue.toUpperCase();
            const matchedRows = rows.filter(row => row.split(/[\t,]/)[idx.fixId]?.trim().toUpperCase() === techIDUpper);
            if (matchedRows.length === 0) return null;

            matchedRows.forEach(row => {
                const fields = row.split(/[\t,]/).map(f => f.trim());
                const rowDetails = calculateRowDetails(fields, headers, size, ir);
                totalPoints += rowDetails.rowPoints;
                rowDetails.categoryCounts.forEach((c, i) => aggCatCnts[i] += c);
                rowDetails.categoryPoints.forEach((p, i) => aggCatPts[i] += p);

                if (idx.rv1lbl !== -1 && fields[idx.rv1lbl]) {
                    const lbl = fields[idx.rv1lbl].toUpperCase();
                    if (lbl.includes("E")) excFix++; if (lbl.includes("M")) missFix++;
                    if (lbl.includes("I")) {
                        incCnt++;
                        if (idx.rv1cat !== -1 && fields[idx.rv1cat]) {
                            const cat = parseInt(fields[idx.rv1cat]);
                            if (!isNaN(cat) && cat >= 1 && cat <= 9) {
                                const price = PRICES[cat - 1][size];
                                if (typeof price === 'number') incPtsVal += price * (ir ? 2 : 1);
                            }
                        }
                    }
                }
                if (idx.i3qalbl !== -1 && fields[idx.i3qalbl]?.toUpperCase().includes("M")) missFix++;
                if (idx.rv2lbl !== -1 && fields[idx.rv2lbl]) {
                    const lbl = fields[idx.rv2lbl].toUpperCase();
                    if (lbl.includes("E")) excFix++; if (lbl.includes("M")) missFix++;
                    if (lbl.includes("I")) {
                        incCnt++;
                        if (idx.rv2cat !== -1 && fields[idx.rv2cat]) {
                            const cat = parseInt(fields[idx.rv2cat]);
                            if (!isNaN(cat) && cat >= 1 && cat <= 9) {
                                const price = PRICES[cat - 1][size];
                                if (typeof price === 'number') incPtsVal += price * (ir ? 2 : 1);
                            }
                        }
                    }
                }
                if (idx.afp1stat !== -1 && fields[idx.afp1stat]?.toUpperCase() === "AA") addFix++;
            });

            const correctPts = totalPoints - incPtsVal;
            const qualPerc = (totalPoints > 0) ? Math.max(0, (correctPts / totalPoints) * 100) : 0;
            const bonusPerc = getBonusPercentage(qualPerc);
            const qualBonus = totalPoints * (bonusPerc / 100);
            const estSalary = totalPoints + qualBonus;

            return {
                techID: techIDValue, totalPoints, additionalFixPoints: addFix, excessiveFixPoints: excFix,
                missFixPoints: missFix, incorrectCounting: incCnt, incorrectPointsValue: incPtsVal,
                qualityPercentage: qualPerc, bonusPercentage: bonusPerc, qualityBonus: qualBonus,
                estimatedSalary: estSalary, categoryPoints: aggCatPts, categoryCounts: aggCatCnts
            };
        }

        // --- Main Functions ---
        function saveProject() {
            const name = projectNameInput.value.trim();
            const data = rawDataInput.value.trim();
            const size = modalSizeSelect.value;
            const ir = modalIrCheck.checked;
            if (!name || !data) { showToast('Project name and data are required.', 'red'); return; }
            const payload = JSON.stringify({ data, size, ir });
            const key = `tl_project_${name}`;
            if (editingProjectName && editingProjectName !== name) localStorage.removeItem(`tl_project_${editingProjectName}`);
            if (safeSetLocalStorage(key, payload)) {
                showToast(`Project '${name}' saved!`, 'green');
                loadProjectList(); M.Modal.getInstance(addProjectModal).close();
                projectNameInput.value = ''; rawDataInput.value = ''; modalSizeSelect.value = '3in'; modalIrCheck.checked = false;
                M.FormSelect.init(modalSizeSelect); M.updateTextFields(); editingProjectName = null;
            }
        }

        async function deleteSelectedProject() {
            const selected = projectSelector.value;
            if (!selected) { showToast('No project selected.', 'orange'); return; }
            if (await showCustomConfirm(`Delete project '${selected}'? This cannot be undone.`, 'Delete Project')) {
                localStorage.removeItem(`tl_project_${selected}`);
                showToast(`Project '${selected}' deleted.`, 'orange');
                loadProjectList(); activeProjectData = ''; outputDiv.innerHTML = ''; allResultsDiv.innerHTML = '';
                allCalculatedResults = []; lastResult = ''; allProjectsAggregatedResults = {}; techIdInput.value = '';
                if (editingProjectName === selected || projectNameInput.value === selected) {
                    projectNameInput.value = ''; rawDataInput.value = ''; modalSizeSelect.value = '3in'; modalIrCheck.checked = false;
                    M.FormSelect.init(modalSizeSelect); M.updateTextFields(); editingProjectName = null;
                }
                projectSelector.value = ""; M.FormSelect.init(projectSelector);
            }
        }

        function searchTechID() {
            const techIDVal = techIdInput.value.trim();
            if (!activeProjectData || !activeProjectData.data) { outputDiv.innerHTML = '<p>Please load a project first.</p>'; addResultButtons(outputDiv); return; }
            if (!techIDVal) { outputDiv.innerHTML = '<p>Please enter a TECH ID.</p>'; addResultButtons(outputDiv); return; }
            outputDiv.innerHTML = ''; allResultsDiv.innerHTML = ''; lastResult = '';
            const result = calculateDetailsForTechIDInRaw(activeProjectData.data, techIDVal, activeProjectData.size, activeProjectData.ir);
            if (result) {
                const hlClass = result.techID.length < 6 ? 'tech-id-red-highlight' : 'tech-id-highlight';
                let html = `<h5>Results for TECH ID: <span class="${hlClass}">${result.techID}</span> (Project: ${projectSelector.value})</h5>`;
                html += `<p><strong>Total Points: ${result.totalPoints.toFixed(2)}</strong></p><table class="striped responsive-table"><thead><tr><th>Metric</th><th>Value</th><th>Count/N/A</th></tr></thead><tbody>`;
                result.categoryPoints.forEach((pts, i) => html += `<tr><td>CAT ${i + 1} Points</td><td>${pts.toFixed(2)}</td><td>${result.categoryCounts[i]}</td></tr>`);
                html += `<tr><td>Additional FixPoints</td><td>N/A</td><td>${result.additionalFixPoints}</td></tr>`;
                html += `<tr><td>Excessive FixPoints</td><td>N/A</td><td>${result.excessiveFixPoints}</td></tr>`;
                html += `<tr><td>Miss FixPoints</td><td>N/A</td><td>${result.missFixPoints}</td></tr>`;
                html += `<tr><td>Incorrect Counting</td><td>N/A</td><td>${result.incorrectCounting}</td></tr>`;
                html += `<tr><td>Incorrect Points Value</td><td>${result.incorrectPointsValue.toFixed(2)}</td><td>N/A</td></tr>`;
                html += `<tr><td>Quality %</td><td>${result.qualityPercentage.toFixed(2)}%</td><td>N/A</td></tr>`;
                html += `<tr><td>Bonus %</td><td>${result.bonusPercentage.toFixed(2)}%</td><td>N/A</td></tr>`;
                html += `<tr><td>Quality Bonus</td><td>${result.qualityBonus.toFixed(2)}</td><td>N/A</td></tr>`;
                html += `<tr><td class="salary-highlight">Estimated Salary</td><td class="salary-highlight">${result.estimatedSalary.toFixed(2)}</td><td class="salary-highlight">N/A</td></tr>`;
                html += '</tbody></table>'; outputDiv.innerHTML = html; lastResult = result;
            } else {
                outputDiv.innerHTML = `<p>TECH ID '${techIDVal}' not found or error in project '${projectSelector.value}'.</p>`; lastResult = '';
            }
            addResultButtons(outputDiv);
        }

        function calculateAllTechIDs() {
            if (!activeProjectData || !activeProjectData.data) { allResultsDiv.innerHTML = '<p>Load a project first.</p>'; addResultButtons(allResultsDiv); return; }
            const { data, size, ir } = activeProjectData;
            const rows = String(data).split(/\r?\n/).filter(r => r.trim() !== "");
            if (rows.length === 0) { allResultsDiv.innerHTML = '<p>No data rows in project.</p>'; addResultButtons(allResultsDiv); return; }
            const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim().toUpperCase()) || [];
            const fixIdIdx = headers.indexOf("FIX1_ID");
            if (fixIdIdx === -1) { allResultsDiv.innerHTML = '<p>FIX1_ID column not found.</p>'; addResultButtons(allResultsDiv); return; }
            const techIDs = new Set(rows.map(r => r.split(/[\t,]/)[fixIdIdx]?.trim().toUpperCase()).filter(id => id));
            if (techIDs.size === 0) { allResultsDiv.innerHTML = '<p>No TECH IDs found.</p>'; addResultButtons(allResultsDiv); return; }

            allCalculatedResults = [];
            let tableHtml = `<table class="striped responsive-table"><thead><tr><th>TECH ID</th>`;
            Array.from({ length: 9 }).forEach((_, i) => tableHtml += `<th>CAT ${i + 1} Pts</th><th>CAT ${i + 1} Cnt</th>`);
            tableHtml += `<th>Add.Fix</th><th>Exc.Fix</th><th>Miss.Fix</th><th>Inc.Cnt</th><th>Inc.PtsVal</th><th>Total Pts</th><th>Qual.%</th><th>Bonus%</th><th>Qual.Bonus</th><th>Est.Salary</th></tr></thead><tbody>`;
            techIDs.forEach(id => {
                const res = calculateDetailsForTechIDInRaw(data, id, size, ir); // Pass original data string
                if (res) {
                    allCalculatedResults.push(res);
                    const qClass = res.qualityPercentage === 100 ? 'ql-grn' : (res.qualityPercentage >= 77.5 ? 'ql-org' : 'ql-red');
                    const bClass = res.bonusPercentage >= 100 ? 'ql-grn' : (res.bonusPercentage > 0 ? 'ql-org' : 'ql-red');
                    const idClass = id.length < 6 ? 'tech-id-red-highlight' : 'tech-id-highlight';
                    tableHtml += `<tr><td class="${idClass}">${id}</td>`;
                    res.categoryPoints.forEach((p, i) => tableHtml += `<td>${p.toFixed(2)}</td><td>${res.categoryCounts[i]}</td>`);
                    tableHtml += `<td>${res.additionalFixPoints}</td><td>${res.excessiveFixPoints}</td><td>${res.missFixPoints}</td><td>${res.incorrectCounting}</td><td>${res.incorrectPointsValue.toFixed(2)}</td>`;
                    tableHtml += `<td><b>${res.totalPoints.toFixed(2)}</b></td><td class="${qClass}">${res.qualityPercentage.toFixed(2)}%</td><td class="${bClass}">${res.bonusPercentage.toFixed(2)}%</td><td class="${bClass}">${res.qualityBonus.toFixed(2)}</td><td class="salary-highlight">${res.estimatedSalary.toFixed(2)}</td></tr>`;
                }
            });
            tableHtml += '</tbody></table>';
            allResultsDiv.innerHTML = `<h5>Results for Project: ${projectSelector.value}</h5>${tableHtml}`;
            outputDiv.innerHTML = ''; lastResult = ''; allProjectsAggregatedResults = {}; addResultButtons(allResultsDiv);
        }
        
        function calculateTotalAcrossAllProjects() {
            const multiplier = parseFloat(multiplierInput.value) || 1;
            if (isNaN(multiplier) || multiplier < 0) { showToast('Multiplier must be non-negative.', 'red'); return; }
            allProjectsAggregatedResults = {}; let errors = [];
            const projects = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('tl_project_')) {
                    const stored = safeGetLocalStorage(key);
                    if (stored) try { projects.push({ name: key.replace('tl_project_', ''), ...JSON.parse(stored) }); } catch (e) { errors.push(`Error parsing ${key}`); }
                }
            }
            if (projects.length === 0) { allResultsDiv.innerHTML = '<p>No projects found.</p>'; addResultButtons(allResultsDiv); M.Modal.getInstance(document.getElementById('multiplier-modal')).close(); return; }
            const allTechs = new Set();
            projects.forEach(p => {
                const rows = String(p.data).split(/\r?\n/).filter(r => r.trim() !== "");
                if (rows.length > 0) {
                    const hdrs = rows.shift()?.split(/[\t,]/).map(h => h.trim().toUpperCase());
                    const idIdx = hdrs?.indexOf("FIX1_ID");
                    if (idIdx !== -1) rows.forEach(r => { const id = r.split(/[\t,]/)[idIdx]?.trim().toUpperCase(); if (id) allTechs.add(id); });
                }
            });
            if (allTechs.size === 0) { allResultsDiv.innerHTML = '<p>No TECH IDs across projects.</p>'; addResultButtons(allResultsDiv); M.Modal.getInstance(document.getElementById('multiplier-modal')).close(); return; }

            allTechs.forEach(id => {
                let baseSum = 0, incPtsSum = 0, addFixSum = 0, excFixSum = 0, missFixSum = 0, incCntSum = 0;
                let catPtsSum = Array(9).fill(0), catCntsSum = Array(9).fill(0);
                projects.forEach(p => {
                    const res = calculateDetailsForTechIDInRaw(p.data, id, p.size, p.ir);
                    if (res) {
                        baseSum += res.totalPoints; incPtsSum += res.incorrectPointsValue; addFixSum += res.additionalFixPoints;
                        excFixSum += res.excessiveFixPoints; missFixSum += res.missFixPoints; incCntSum += res.incorrectCounting;
                        res.categoryPoints.forEach((pts, i) => catPtsSum[i] += pts);
                        res.categoryCounts.forEach((cnt, i) => catCntsSum[i] += cnt);
                    }
                });
                const totalWithMult = baseSum * multiplier;
                const qualPerc = (baseSum > 0) ? Math.max(0, ((baseSum - incPtsSum) / baseSum) * 100) : 0;
                const bonusPerc = getBonusPercentage(qualPerc);
                const qualBonus = baseSum * (bonusPerc / 100);
                allProjectsAggregatedResults[id] = {
                    techID: id, baseTotalPointsSum: baseSum, incorrectPointsValueSum: incPtsSum, additionalFixPointsSum: addFixSum,
                    excessiveFixPointsSum: excFixSum, missFixPointsSum: missFixSum, incorrectCountingSum: incCntSum,
                    categoryPointsSum: catPtsSum, categoryCountsSum: catCntsSum, totalPointsWithMultiplier: totalWithMult,
                    qualityPercentage: qualPerc, bonusPercentage: bonusPerc, qualityBonus, estimatedSalary: totalWithMult + qualBonus
                };
            });

            let grandTotal = Object.values(allProjectsAggregatedResults).reduce((sum, r) => sum + r.totalPointsWithMultiplier, 0);
            let tableHtml = `<h5>Totals Across All Projects (Multiplier: ${multiplier.toFixed(2)})</h5>`;
            tableHtml += `<table class="striped responsive-table"><thead><tr><th>TECH ID</th>`;
            Array.from({ length: 9 }).forEach((_, i) => tableHtml += `<th>CAT ${i + 1} Pts Sum</th><th>CAT ${i + 1} Cnt Sum</th>`);
            tableHtml += `<th>Add.FixSum</th><th>Exc.FixSum</th><th>Miss.FixSum</th><th>Inc.CntSum</th><th>Inc.PtsValSum</th><th>BaseTotalSum</th><th>Total(w/Mult)</th><th>Qual%</th><th>Bonus%</th><th>Qual.Bonus</th><th>Est.Salary</th></tr></thead><tbody>`;
            Object.values(allProjectsAggregatedResults).sort((a,b)=>a.techID.localeCompare(b.techID)).forEach(r => {
                 const qClass = r.qualityPercentage === 100 ? 'ql-grn' : (r.qualityPercentage >= 77.5 ? 'ql-org' : 'ql-red');
                 const bClass = r.bonusPercentage >= 100 ? 'ql-grn' : (r.bonusPercentage > 0 ? 'ql-org' : 'ql-red');
                 const idClass = r.techID.length < 6 ? 'tech-id-red-highlight' : 'tech-id-highlight';
                tableHtml += `<tr><td class="${idClass}">${r.techID}</td>`;
                r.categoryPointsSum.forEach((p, i) => tableHtml += `<td>${p.toFixed(2)}</td><td>${r.categoryCountsSum[i]}</td>`);
                tableHtml += `<td>${r.additionalFixPointsSum}</td><td>${r.excessiveFixPointsSum}</td><td>${r.missFixPointsSum}</td><td>${r.incorrectCountingSum}</td><td>${r.incorrectPointsValueSum.toFixed(2)}</td>`;
                tableHtml += `<td>${r.baseTotalPointsSum.toFixed(2)}</td><td><b>${r.totalPointsWithMultiplier.toFixed(2)}</b></td><td class="${qClass}">${r.qualityPercentage.toFixed(2)}%</td><td class="${bClass}">${r.bonusPercentage.toFixed(2)}%</td><td class="${bClass}">${r.qualityBonus.toFixed(2)}</td><td class="salary-highlight">${r.estimatedSalary.toFixed(2)}</td></tr>`;
            });
            tableHtml += `</tbody></table><h4 style="margin-top:20px;">Team Total (w/ Multiplier): ${grandTotal.toFixed(2)}</h4>`;
            if (errors.length > 0) tableHtml += `<div class="card red lighten-4" style="margin-top:20px;"><div class="card-content red-text text-darken-4"><p><strong>Warnings:</strong> ${errors.join(', ')}</p></div></div>`;
            allResultsDiv.innerHTML = tableHtml; outputDiv.innerHTML = ''; allCalculatedResults = []; addResultButtons(allResultsDiv);
            M.Modal.getInstance(document.getElementById('multiplier-modal')).close();
        }

        function exportToCsv(filename, data, type) {
            if (!data || (Array.isArray(data) && data.length === 0) || (typeof data === 'object' && Object.keys(data).length === 0)) {
                showToast('No data to export.', 'red'); return;
            }
            let csv = "", hdrs = [], rws = [];
            if (type === 'single' && data.techID) {
                hdrs = ['Metric', 'Value', 'Count/N/A'];
                rws.push([`TECH ID`, `${data.techID}`, `N/A`]);
                data.categoryPoints.forEach((pts, i) => rws.push([`CAT ${i+1} Pts`, `${pts.toFixed(2)}`, `${data.categoryCounts[i]}`]));
                ['additionalFixPoints', 'excessiveFixPoints', 'missFixPoints', 'incorrectCounting'].forEach(k => rws.push([k, 'N/A', data[k]]));
                ['incorrectPointsValue', 'totalPoints', 'qualityBonus', 'estimatedSalary'].forEach(k => rws.push([k, data[k].toFixed(2), 'N/A']));
                ['qualityPercentage', 'bonusPercentage'].forEach(k => rws.push([k, `${data[k].toFixed(2)}%`, 'N/A']));
            } else if (type === 'perProject' && Array.isArray(data)) {
                hdrs = ['TECH ID', ...Array(9).fill(0).map((_,i)=>`CAT ${i+1} Pts`), ...Array(9).fill(0).map((_,i)=>`CAT ${i+1} Cnt`), 'Add.Fix', 'Exc.Fix', 'Miss.Fix', 'Inc.Cnt', 'Inc.PtsVal', 'Total Pts', 'Qual.%', 'Bonus%', 'Qual.Bonus', 'Est.Salary'];
                data.forEach(item => {
                    let r = [item.techID]; item.categoryPoints.forEach(p=>r.push(p.toFixed(2))); item.categoryCounts.forEach(c=>r.push(c));
                    r.push(item.additionalFixPoints, item.excessiveFixPoints, item.missFixPoints, item.incorrectCounting, item.incorrectPointsValue.toFixed(2), item.totalPoints.toFixed(2), `${item.qualityPercentage.toFixed(2)}%`, `${item.bonusPercentage.toFixed(2)}%`, item.qualityBonus.toFixed(2), item.estimatedSalary.toFixed(2));
                    rws.push(r);
                });
            } else if (type === 'allProjectsAggregated' && typeof data === 'object') {
                hdrs = ['TECH ID', ...Array(9).fill(0).map((_,i)=>`CAT ${i+1} Pts Sum`), ...Array(9).fill(0).map((_,i)=>`CAT ${i+1} Cnt Sum`), 'Add.FixSum', 'Exc.FixSum', 'Miss.FixSum', 'Inc.CntSum', 'Inc.PtsValSum', 'BaseTotalSum', 'Total(w/Mult)', 'Qual.%', 'Bonus%', 'Qual.Bonus', 'Est.Salary'];
                Object.values(data).forEach(item => {
                    let r = [item.techID]; item.categoryPointsSum.forEach(p=>r.push(p.toFixed(2))); item.categoryCountsSum.forEach(c=>r.push(c));
                    r.push(item.additionalFixPointsSum, item.excessiveFixPointsSum, item.missFixPointsSum, item.incorrectCountingSum, item.incorrectPointsValueSum.toFixed(2), item.baseTotalPointsSum.toFixed(2), item.totalPointsWithMultiplier.toFixed(2), `${item.qualityPercentage.toFixed(2)}%`, `${item.bonusPercentage.toFixed(2)}%`, item.qualityBonus.toFixed(2), item.estimatedSalary.toFixed(2));
                    rws.push(r);
                });
            } else { showToast('No valid data for export.', 'red'); return; }
            csv += hdrs.join(",") + "\n";
            rws.forEach(rA => csv += rA.map(f => `"${String(f).replace(/"/g, '""')}"`).join(",") + "\n");
            const link = document.createElement("a"); link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + csv));
            link.setAttribute("download", filename); document.body.appendChild(link); link.click(); document.body.removeChild(link);
            showToast('CSV exported!', 'green');
        }

        async function autoFetchExternalJson() {
            showLoader(); showToast('Updating projects online...', 'blue');
            try {
                const resp = await fetch(HARDCODED_PROJECTS_JSON_URL);
                if (!resp.ok) throw new Error(`HTTP ${resp.status} - ${resp.statusText}`);
                const compTxt = await resp.text(); if (!compTxt) throw new Error("Fetched data empty.");
                const decompTxt = LZString.decompressFromBase64(compTxt);
                if (!decompTxt) throw new Error("Decompression failed or data invalid.");
                const extData = JSON.parse(decompTxt);
                if (!extData || typeof extData !== 'object') throw new Error("External data not a valid JSON object.");
                let upd = 0, add = 0;
                if (extData.projects && Array.isArray(extData.projects)) {
                    extData.projects.forEach(p => {
                        if (p.name && typeof p.data === 'object' && p.data && 'data' in p.data && 'size' in p.data && typeof p.data.ir === 'boolean') {
                            const key = `tl_project_${p.name}`, newPayload = JSON.stringify(p.data);
                            const oldStr = safeGetLocalStorage(key); let oldParsed = null;
                            if (oldStr) try { oldParsed = JSON.parse(oldStr); } catch(e){}
                            if (!oldParsed || JSON.stringify(oldParsed) !== newPayload) {
                                if (safeSetLocalStorage(key, newPayload)) { if (oldParsed) upd++; else add++; }
                            }
                        } else console.warn("Skipping invalid project from online:", p);
                    });
                    showToast(`Projects: Added ${add}, Updated ${upd}.`, 'green'); loadProjectList();
                } else showToast('No "projects" array in online data.', 'orange');
                // Placeholder for notifications if feature is re-added
                if (extData.notifications) console.log("Notifications found:", extData.notifications.length);
            } catch (e) { showToast(`Failed to update: ${e.message}`, 'red'); console.error("Auto-fetch error:", e); }
            finally { hideLoader(); }
        }

        async function verifyTlLoginCode(code) {
            if (!code) return false;
            try {
                const r = await fetch(HARDCODED_TL_CODE_URL); if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const d = await r.json(); return d.code === code;
            } catch (e) { showToast(`Error verifying TL code: ${e.message}`, 'red'); console.error("TL code fetch error:", e); return false; }
        }

        function updateButtonVisibility() {
            const tlOnly = [addProjectButton, document.getElementById('edit-project'), document.getElementById('delete-project'), document.getElementById('copy-all-projects-json')];
            const allRoles = [viewProjectDataButton, document.getElementById('search-button'), document.getElementById('calculate-all-button'), calcAllProjectsBtn, exportBtn, clearDataButton, autoFetchButton, document.getElementById('instructions-button'), logoutButton]; // Use declared const
            tlOnly.forEach(b => { if(b) b.style.display = isLoggedInAsTL ? '' : 'none';});
            allRoles.forEach(b => { if(b) b.style.display = '';});
            if (addProjectButton) addProjectButton.style.display = isLoggedInAsTL ? 'block' : 'none'; // FAB specific
        }

        // --- Event Listeners ---
        document.getElementById('search-button').addEventListener('click', searchTechID);
        document.getElementById('calculate-all-button').addEventListener('click', calculateAllTechIDs);
        
        // Use the declared const calcAllProjectsBtn here
        if(calcAllProjectsBtn) {
            calcAllProjectsBtn.addEventListener('click', () => {
                const multiplierModalInstance = M.Modal.getInstance(document.getElementById('multiplier-modal'));
                if (multiplierModalInstance) multiplierModalInstance.open();
            });
        }
        
        if(applyMultiplierButton) applyMultiplierButton.addEventListener('click', calculateTotalAcrossAllProjects);
        
        projectSelector.addEventListener('change', () => {
            const name = projectSelector.value;
            if (!name) {
                activeProjectData = ''; outputDiv.innerHTML = ''; allResultsDiv.innerHTML = '';
                if (isLoggedInAsTL) { projectNameInput.value = ''; rawDataInput.value = ''; modalSizeSelect.value = '3in'; modalIrCheck.checked = false; M.FormSelect.init(modalSizeSelect); M.updateTextFields(); editingProjectName = null; }
                return;
            }
            const stored = safeGetLocalStorage(`tl_project_${name}`);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (typeof parsed.data !== 'string' || typeof parsed.size !== 'string' || typeof parsed.ir !== 'boolean') throw new Error("Invalid project structure.");
                    activeProjectData = parsed; showToast(`Project '${name}' loaded.`, 'blue');
                    outputDiv.innerHTML = ''; allResultsDiv.innerHTML = ''; lastResult = ''; allCalculatedResults = []; allProjectsAggregatedResults = {};
                    if (isLoggedInAsTL) {
                        projectNameInput.value = name; rawDataInput.value = parsed.data; modalSizeSelect.value = parsed.size; modalIrCheck.checked = parsed.ir;
                        M.updateTextFields(); M.FormSelect.init(modalSizeSelect); editingProjectName = name;
                    }
                } catch (e) { showToast(`Error parsing '${name}': ${e.message}`, 'red'); activeProjectData = ''; }
            } else { activeProjectData = ''; showToast(`Could not load '${name}'.`, 'red'); }
        });

        const editProjectBtn = document.getElementById('edit-project'); // Declare here if not already global
        if(editProjectBtn) editProjectBtn.addEventListener('click', () => {
            if (!isLoggedInAsTL) return; const name = projectSelector.value;
            if (!name) { showToast('Select project to edit.', 'orange'); return; }
            // Ensure activeProjectData is for the selected project. The projectSelector.onchange should handle this.
            if (activeProjectData && activeProjectData.data && activeProjectData.size && typeof activeProjectData.ir === 'boolean' && (editingProjectName === name || projectNameInput.value === name)) { 
                // If form is already populated for this project (e.g. by onchange), just open.
                // Otherwise, (re)populate.
                if (projectNameInput.value !== name) { // Repopulate if form doesn't match
                    projectNameInput.value = name; 
                    rawDataInput.value = activeProjectData.data; 
                    modalSizeSelect.value = activeProjectData.size; 
                    modalIrCheck.checked = activeProjectData.ir;
                    M.updateTextFields(); 
                    M.FormSelect.init(modalSizeSelect);
                }
                modalTitle.textContent = 'Edit Project'; saveProjectModalButton.textContent = 'Update Project';
                editingProjectName = name; M.Modal.getInstance(addProjectModal).open();
            } else { 
                const stored = safeGetLocalStorage(`tl_project_${name}`);
                let projectToEdit = null;
                if(stored) try {projectToEdit = JSON.parse(stored);} catch(e){projectToEdit = null;}
                
                if (projectToEdit && typeof projectToEdit.data === 'string' && typeof projectToEdit.size === 'string' && typeof projectToEdit.ir === 'boolean') {
                     activeProjectData = projectToEdit; // Update activeProjectData
                     projectNameInput.value = name; rawDataInput.value = projectToEdit.data; modalSizeSelect.value = projectToEdit.size; modalIrCheck.checked = projectToEdit.ir;
                     M.updateTextFields(); M.FormSelect.init(modalSizeSelect);
                     modalTitle.textContent = 'Edit Project'; saveProjectModalButton.textContent = 'Update Project';
                     editingProjectName = name; M.Modal.getInstance(addProjectModal).open();
                } else {
                    showToast('Error loading project data for editing. Try re-selecting.', 'red');
                }
            }
        });

        if(document.getElementById('delete-project')) document.getElementById('delete-project').addEventListener('click', deleteSelectedProject);
        if(addProjectButton) addProjectButton.addEventListener('click', () => { // FAB
            if (!isLoggedInAsTL) return;
            modalTitle.textContent = 'Add New Project'; saveProjectModalButton.textContent = 'Save Project';
            projectNameInput.value = ''; rawDataInput.value = ''; modalSizeSelect.value = '3in'; modalIrCheck.checked = false;
            M.updateTextFields(); M.FormSelect.init(modalSizeSelect); editingProjectName = null;
        });
        if(saveProjectModalButton) saveProjectModalButton.addEventListener('click', saveProject);
        if(clearDataButton) clearDataButton.addEventListener('click', async () => {
            if (await showCustomConfirm('Clear ALL saved projects? Cannot be undone.', 'Clear All Data')) {
                let keys = []; for (let i=0; i<localStorage.length; i++) if(localStorage.key(i).startsWith('tl_project_')) keys.push(localStorage.key(i));
                keys.forEach(k => localStorage.removeItem(k));
                loadProjectList(); activeProjectData = ''; outputDiv.innerHTML = ''; allResultsDiv.innerHTML = '';
                allCalculatedResults = []; lastResult = ''; allProjectsAggregatedResults = {}; techIdInput.value = '';
                projectNameInput.value = ''; rawDataInput.value = ''; M.updateTextFields(); projectSelector.value = ""; M.FormSelect.init(projectSelector);
                showToast('All projects cleared!', 'green');
            }
        });

        if(exportBtn) exportBtn.addEventListener('click', () => { // Use declared const
            let data, type, fname;
            if (Object.keys(allProjectsAggregatedResults).length > 0) { data = allProjectsAggregatedResults; type = 'allProjectsAggregated'; fname = 'all_projects_summary'; }
            else if (allCalculatedResults.length > 0) { data = allCalculatedResults; type = 'perProject'; fname = `${(projectSelector.value || 'current').replace(/[^a-z0-9]/gi, '_')}_summary`; }
            else if (lastResult && lastResult.techID) { data = lastResult; type = 'single'; fname = `tech_${lastResult.techID}_${(projectSelector.value || 'proj').replace(/[^a-z0-9]/gi, '_')}`; }
            else { showToast('No results to export.', 'orange'); return; }
            exportToCsv(`${fname}.csv`, data, type);
        });

        const copyAllProjectsJsonBtn = document.getElementById('copy-all-projects-json'); // Declare if not global
        if(copyAllProjectsJsonBtn) copyAllProjectsJsonBtn.addEventListener('click', () => {
            if (!isLoggedInAsTL) return; let projects = []; let hasProj = false;
            for (let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('tl_project_')) {
                    hasProj = true; const name = key.replace('tl_project_', ''); const stored = safeGetLocalStorage(key);
                    if (stored) try { projects.push({ name, data: JSON.parse(stored) }); } catch (e) { console.error(`Corrupt ${key}`); showToast(`Corrupt ${name}`, 'red'); return; }
                }
            }
            if (!hasProj) { showToast('No projects to copy.', 'orange'); return; }
            const exportObj = { projects }; 
            try {
                const comp = LZString.compressToBase64(JSON.stringify(exportObj));
                navigator.clipboard.writeText(comp).then(() => showToast('Projects data (for online update) copied!', 'green'), () => showToast('Copy failed.', 'red'));
            } catch (e) { showToast('Compression error.', 'red'); console.error(e); }
        });

        if(autoFetchButton) autoFetchButton.addEventListener('click', autoFetchExternalJson);
        loginRoleSelect.addEventListener('change', () => {
            tlCodeInputDiv.style.display = loginRoleSelect.value === 'tl' ? 'block' : 'none';
            if(loginRoleSelect.value === 'tl') tlLoginCodeInput.setAttribute('required', 'required'); else tlLoginCodeInput.removeAttribute('required');
            M.updateTextFields();
        });
        loginButtonElement.addEventListener('click', async () => {
            showLoader(); const role = loginRoleSelect.value;
            if (!role) { showToast('Select a role.', 'orange'); hideLoader(); return; }
            if (role === 'tl') {
                const code = tlLoginCodeInput.value; if (!code) { showToast('Enter TL Code.', 'orange'); hideLoader(); return; }
                if (await verifyTlLoginCode(code)) {
                    isLoggedInAsTL = true; showToast('Logged in as TL!', 'green');
                    M.Modal.getInstance(loginModal).close(); mainAppContent.style.display = 'block';
                    loadProjectList(); updateButtonVisibility();
                } else { showToast('Incorrect TL code.', 'red'); isLoggedInAsTL = false; }
            } else { // Tech
                isLoggedInAsTL = false; showToast('Logged in as Tech!', 'green');
                M.Modal.getInstance(loginModal).close(); mainAppContent.style.display = 'block';
                loadProjectList(); updateButtonVisibility();
            }
            hideLoader();
        });
        if(logoutButton) logoutButton.addEventListener('click', () => {
            isLoggedInAsTL = false; showToast('Logged out.', 'blue'); mainAppContent.style.display = 'none';
            outputDiv.innerHTML = ''; allResultsDiv.innerHTML = ''; lastResult = ''; allCalculatedResults = []; allProjectsAggregatedResults = {}; activeProjectData = ''; techIdInput.value = '';
            loginRoleSelect.value = ''; tlLoginCodeInput.value = ''; tlCodeInputDiv.style.display = 'none';
            M.FormSelect.init(loginRoleSelect); M.updateTextFields();
            M.Modal.getInstance(loginModal)?.open();
        });
        if(fullscreenCloseButton) fullscreenCloseButton.addEventListener('click', hideFullscreenModal);
        fullscreenResultsModal.addEventListener('click', e => { if (e.target === fullscreenResultsModal) hideFullscreenModal(); });
        if(viewProjectDataButton) viewProjectDataButton.addEventListener('click', viewProjectData);

        function applyDarkModePreference() {
            let mode = localStorage.getItem('darkMode') || 'disabled';
            document.body.classList.toggle('dark-mode', mode === 'enabled');
            darkModeToggle.querySelector('i').textContent = mode === 'enabled' ? 'brightness_4' : 'brightness_high';
        }
        darkModeToggle.addEventListener('click', () => {
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'disabled' : 'enabled');
            applyDarkModePreference();
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.body.style.display = 'none'; 
            applyDarkModePreference();
            M.Modal.init(document.querySelectorAll('.modal'), { dismissible: false }); 
            
            confirmationConfirmButton.addEventListener('click', () => { if (confirmPromiseResolve) { confirmPromiseResolve(true); confirmPromiseResolve = null; }});
            confirmationCancelButton.addEventListener('click', () => { if (confirmPromiseResolve) { confirmPromiseResolve(false); confirmPromiseResolve = null; }});
            M.FormSelect.init(projectSelector); M.FormSelect.init(loginRoleSelect); M.FormSelect.init(modalSizeSelect);
            M.updateTextFields(); M.Tooltip.init(document.querySelectorAll('.tooltipped')); 
            const loginInst = M.Modal.getInstance(loginModal);
            document.body.style.display = 'block';
            if (loginInst) loginInst.open(); else console.error("Login modal init failed.");
        });
    </script>
</body>
</html>
