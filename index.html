<!DOCTYPE html>
<html>
<head>
    <title>123 - Fixpoint Extractor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="icon.png" type="image/png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
    :root {
        /* --- MODIFIED Light Mode Palette (Neutral with Blue Accent) --- */
        --primary-accent: #007bff;          /* Clear Blue for primary actions/accents */
        --primary-accent-dark: #0056b3;    /* Darker blue for hover/headings */
        --primary-accent-light: #cfe2ff;   /* Light blue for backgrounds/highlights */

        --light-bg: #FFFFFF;               /* Body background - White */
        --medium-bg: #F8F9FA;             /* Container background, subtle distinctions - Very Light Grey */
        --content-bg: #FFFFFF;             /* Background for content areas like containers - White */

        --dark-text: #212529;              /* Main text color - Dark Grey/Black */
        --light-text: #FFFFFF;             /* Text on dark backgrounds - White */
        --muted-text: #6C757D;             /* Muted text for secondary info */

        /* Softer action colors (mostly kept from original, but ensure they work with new base) */
        --info-blue: #5bc0de; /* Adjusted for better harmony if needed, original: #64b5f6 */
        --success-green: #28a745; /* Standard success green, original: #81c784 */
        --warning-orange: #ffc107; /* Standard warning orange, original: #ffb74d */
        --danger-red: #dc3545;   /* Standard danger red, original: #e57373 */
    }

    /* Dark Mode Colors */
    body.dark-mode {
        /* --- MODIFIED Dark Mode Palette --- */
        --primary-accent: #3FA9FF;          /* Lighter blue for dark mode */
        --primary-accent-dark: #1A8CFF;    /* Darker/saturated blue for dark mode accents */
        --primary-accent-light: #03294e;   /* Dark, subtly bluish for backgrounds, original: #2A3B4D */

        --light-bg: #12181f;                /* Body background - Very Dark Blue/Grey */
        --medium-bg: #1c232b;              /* Container background - Dark Desaturated Blue */
        --content-bg: #1c232b;              /* Background for content areas */

        --dark-text: #EAEAEA;               /* Main text color - Light Grey */
        --light-text: #121212;              /* Text on light backgrounds (less common for main content) */
        --muted-text: #A0A0A0;              /* Muted text for dark mode */

        /* Adjusted action colors for dark mode (ensure visibility) */
        --info-blue: #64b5f6;       /* Kept from original for visibility */
        --success-green: #81c784;   /* Kept from original for visibility */
        --warning-orange: #ffb74d;  /* Kept from original for visibility */
        --danger-red: #e57373;      /* Kept from original for visibility */
    }

    body {
        padding: 20px;
        background-color: var(--light-bg);
        font-family: 'Open Sans', sans-serif;
        color: var(--dark-text);
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    h5, h4 {
        font-family: 'Roboto Slab', serif;
        color: var(--primary-accent-dark);
        transition: color 0.3s ease;
    }
    .container {
        background-color: var(--content-bg);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    body.dark-mode .container {
        background-color: var(--medium-bg);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .container:hover {
        box-shadow: 0 6px 15px rgba(0,0,0,0.12);
    }
    body.dark-mode .container:hover {
        box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    }
    .result {
        background: var(--medium-bg);
        padding: 20px;
        margin-top: 20px;
        white-space: pre-wrap;
        border-left: 4px solid var(--primary-accent);
        font-family: 'Courier New', monospace;
        min-height: 100px;
        border-radius: 8px;
        overflow-x: auto;
        position: relative;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    body.dark-mode .result {
        background: #232B33;
        border-left-color: var(--primary-accent);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .result-buttons {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 1;
    }
    .result-buttons .expand-button,
    .result-buttons .view-data-result-button {
        background-color: rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 50%;
        width: 34px;
        height: 34px;
        cursor: pointer;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        transition: background-color 0.3s ease, transform 0.2s ease;
        margin-left: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    body.dark-mode .result-buttons .expand-button,
    body.dark-mode .result-buttons .view-data-result-button {
        background-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .result-buttons .expand-button:hover,
    .result-buttons .view-data-result-button:hover {
        background-color: rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    body.dark-mode .result-buttons .expand-button:hover,
    body.dark-mode .result-buttons .view-data-result-button:hover {
        background-color: rgba(255, 255, 255, 0.15);
    }
    .result-buttons .expand-button i.material-icons,
    .result-buttons .view-data-result-button i.material-icons {
        font-size: 20px;
        color: var(--dark-text);
    }
    .result table.striped tbody tr:nth-child(odd) {
        background-color: #f0f3f5;
    }
    body.dark-mode .result table.striped tbody tr:nth-child(odd) {
        background-color: var(--primary-accent-light);
    }
    .result table.striped tbody tr:nth-child(even) {
        background-color: var(--content-bg);
    }
    body.dark-mode .result table.striped tbody tr:nth-child(even) {
        background-color: var(--medium-bg);
    }
    .result table th {
        background-color: var(--primary-accent-dark);
        color: var(--light-text);
        padding: 14px 18px;
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark-mode .result table th {
        background-color: var(--primary-accent-dark);
        color: var(--dark-text);
    }
    .result table td, .result table th {
        padding: 12px 15px;
        border: 1px solid #dee2e6;
        transition: border-color 0.3s ease;
    }
    body.dark-mode .result table td, body.dark-mode .result table th {
        border-color: #454d55;
    }
    .result table {
        border-collapse: collapse;
        width: 100%;
    }

    .modal textarea {
        height: 150px;
        overflow-y: auto;
        resize: none;
    }
    .modal-content textarea.materialize-textarea {
        height: 150px !important;
        overflow-y: auto;
        resize: none;
    }
    .input-field {
        margin-top: 25px;
        margin-bottom: 20px;
    }
    .input-field input:focus + label,
    .input-field textarea:focus + label {
        color: var(--primary-accent) !important;
    }
    .input-field input:focus,
    .input-field textarea:focus {
        border-bottom: 1px solid var(--primary-accent) !important;
        box-shadow: 0 1px 0 0 var(--primary-accent) !important;
    }
    .input-field select:focus {
        outline: 1px solid var(--primary-accent);
    }
    body.dark-mode .input-field label {
        color: var(--dark-text) !important;
    }
    body.dark-mode .input-field input,
    body.dark-mode .input-field textarea {
        color: var(--dark-text);
        border-bottom-color: var(--primary-accent-dark) !important;
    }
    body.dark-mode .input-field input:focus,
    body.dark-mode .input-field textarea:focus {
        border-bottom: 1px solid var(--primary-accent) !important;
        box-shadow: 0 1px 0 0 var(--primary-accent) !important;
    }
    body.dark-mode .input-field input[type=text]:not(.browser-default):focus:not([readonly]) + label,
    body.dark-mode .input-field input[type=password]:not(.browser-default):focus:not([readonly]) + label,
    body.dark-mode .input-field textarea.materialize-textarea:focus:not([readonly]) + label {
        color: var(--primary-accent) !important;
    }
    body.dark-mode .input-field .caret {
        fill: var(--dark-text);
    }
    body.dark-mode .select-wrapper input.select-dropdown {
        color: var(--dark-text);
    }
    body.dark-mode .dropdown-content li > a,
    body.dark-mode .dropdown-content li > span {
        color: var(--dark-text);
    }
    body.dark-mode .dropdown-content {
        background-color: var(--medium-bg);
    }

    .btn, .btn-large, .btn-small, .btn-flat {
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        margin-top: 15px;
        margin-bottom: 15px;
        margin-right: 12px;
        text-transform: none;
        font-weight: 600;
        color: var(--light-text);
    }
    .btn:hover, .btn-large:hover, .btn-small:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transform: translateY(-2px);
        opacity: 1;
    }
    .btn i.material-icons.left {
        margin-right: 8px;
    }

    .btn.blue, .btn.blue.darken-1 { background-color: var(--primary-accent) !important; }
    .btn.blue:hover, .btn.blue.darken-1:hover { background-color: var(--primary-accent-dark) !important; }
    .btn.green { background-color: var(--success-green) !important; }
    .btn.green:hover { background-color: #218838 !important; }
    .btn.orange.darken-2, .btn.orange { background-color: var(--warning-orange) !important; color: #212529 !important; }
    .btn.orange.darken-2:hover, .btn.orange:hover { background-color: #e0a800 !important; }
    .btn.red, .btn.red.darken-2 { background-color: var(--danger-red) !important; }
    .btn.red:hover, .btn.red.darken-2:hover { background-color: #c82333 !important; }
    .btn.purple.darken-2, .btn.deep-purple.darken-2 { background-color: var(--primary-accent) !important; }
    .btn.purple.darken-2:hover, .btn.deep-purple.darken-2:hover { background-color: var(--primary-accent-dark) !important; }
    .btn.grey.darken-1 { background-color: #6c757d !important; }
    .btn.grey.darken-1:hover { background-color: #5a6268 !important; }
    .btn.grey { background-color: #adb5bd !important; color: #212529 !important}
    .btn.grey:hover { background-color: #90989f !important; }

    .btn-floating.btn-large.green {
        background-color: var(--primary-accent) !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .btn-floating.btn-large.green:hover {
        background-color: var(--primary-accent-dark) !important;
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        transform: translateY(-3px);
    }

    #dark-mode-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: #e9ecef;
        color: var(--dark-text);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        z-index: 999;
    }
    #dark-mode-toggle:hover {
        background-color: #ced4da;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    body.dark-mode #dark-mode-toggle {
        background-color: #343a40;
        color: var(--dark-text);
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    body.dark-mode #dark-mode-toggle:hover {
        background-color: #495057;
        box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }
    #dark-mode-toggle i.material-icons {
        font-size: 24px;
    }

    .right-align { margin-bottom: 20px; }
    .center-align { margin-top: 25px; margin-bottom: 25px; }
    #all-results { max-height: 600px; overflow-y: auto; margin-top: 30px; }
    #all-results h5 { margin-bottom: 15px; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }
    body.dark-mode #all-results h5 { border-bottom-color: #495057; }
    .modal-content h5 { margin-bottom: 20px; }
    .modal-content .input-field { margin-top: 15px; margin-bottom: 15px; }
    .modal-footer a { margin-left: 10px; }
    .modal { background-color: var(--content-bg); transition: background-color 0.3s ease; }
    body.dark-mode .modal { background-color: var(--medium-bg); }
    body.dark-mode .modal .modal-content { color: var(--dark-text); }
    body.dark-mode .modal .modal-footer { background-color: #232a31; border-top-color: #343a40; }

    #login-modal { max-width: 450px; border-radius: 12px; margin: auto; overflow: hidden; }
    #login-modal .modal-content { padding: 35px; text-align: center; background-color: var(--content-bg); }
    body.dark-mode #login-modal .modal-content { background-color: var(--medium-bg); }
    #login-modal .modal-content h5 { margin-bottom: 30px; color: var(--primary-accent-dark); }
    #login-modal .input-field { margin-bottom: 25px; }
    #login-modal .modal-footer { padding: 20px; text-align: center; background-color: var(--medium-bg); border-top: 1px solid #dee2e6; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
    body.dark-mode #login-modal .modal-footer { background-color: #232a31; border-top-color: #343a40; }
    #login-modal .btn { width: 100%; margin-right: 0; background-color: var(--primary-accent) !important; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    #login-modal .btn:hover { background-color: var(--primary-accent-dark) !important; box-shadow: 0 6px 12px rgba(0,0,0,0.25); }
    #logout-button { margin-left: auto; }

    #fullscreen-results-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 1000; display: none; justify-content: center; align-items: center; overflow-y: auto; }
    #fullscreen-results-content { background-color: var(--content-bg); padding: 20px; border-radius: 12px; max-width: 95%; max-height: 95%; overflow: auto; position: relative; box-shadow: 0 8px 20px rgba(0,0,0,0.25); }
    body.dark-mode #fullscreen-results-content { background-color: var(--medium-bg); box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
    #fullscreen-results-content .close-button { position: absolute; top: 15px; right: 15px; background-color: rgba(222, 226, 230, 0.85); border: none; border-radius: 50%; width: 38px; height: 38px; cursor: pointer; display: flex; justify-content: center; align-items: center; padding: 0; transition: background-color 0.3s ease, transform 0.2s ease; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    body.dark-mode #fullscreen-results-content .close-button { background-color: rgba(0, 0, 0, 0.3); color: var(--dark-text); box-shadow: 0 2px 5px rgba(0,0,0,0.4); }
    #fullscreen-results-content .close-button:hover { background-color: rgba(206, 212, 218, 0.95); transform: rotate(90deg); }
    body.dark-mode #fullscreen-results-content .close-button:hover { background-color: rgba(0, 0, 0, 0.4); }
    #fullscreen-results-content .close-button i.material-icons { color: var(--dark-text); }

    #view-data-modal { max-width: 95%; max-height: 95%; width: 95%; height: 95%; top: 2.5% !important; transform: translate(-50%, 0%) !important; left: 50% !important; border-radius: 12px; }
    #view-data-modal .modal-content { overflow-y: auto; max-height: calc(100% - 70px); padding-bottom: 0; }
    #view-data-modal table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    #view-data-modal table th, #view-data-modal table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; white-space: nowrap; }
    body.dark-mode #view-data-modal table th, body.dark-mode #view-data-modal table td { border-color: #454d55; }
    #view-data-modal table th { background-color: #e9ecef; color: var(--dark-text); font-weight: bold; }
    body.dark-mode #view-data-modal table th { background-color: var(--primary-accent-dark); color: var(--dark-text); }
    #view-data-table-container .spinner-container { display: flex; justify-content: center; align-items: center; min-height: 200px; }

    @media (max-width: 600px) {
        body { padding: 10px; }
        .container { padding: 20px; }
        .btn { margin-right: 8px; margin-bottom: 12px; }
        .center-align { margin-top: 15px; margin-bottom: 15px; }
        #all-results { max-height: 400px; }
        #fullscreen-results-content { max-width: 95%; max-height: 95%; }
        #view-data-modal { max-width: 95%; width: 95%; height: 95%; top: 2.5% !important; transform: translate(-50%, 0%) !important; left: 50% !important; }
        #dark-mode-toggle { top: 10px; right: 10px; width: 40px; height: 40px; }
        #dark-mode-toggle i.material-icons { font-size: 20px; }
    }
    .quality-green { background-color: #d4edda; color: #155724; font-weight: bold; padding: 4px 8px; border-radius: 4px; }
    body.dark-mode .quality-green { background-color: #28a745; color: #ffffff; }
    .quality-orange { background-color: #fff3cd; color: #856404; font-weight: bold; padding: 4px 8px; border-radius: 4px; }
    body.dark-mode .quality-orange { background-color: #ffc107; color: #212529; }
    .quality-red { background-color: #f8d7da; color: #721c24; font-weight: bold; padding: 4px 8px; border-radius: 4px; }
    body.dark-mode .quality-red { background-color: #dc3545; color: #ffffff; }
    .tech-id-highlight { font-weight: bold; color: var(--primary-accent-dark); }
    .salary-highlight { background-color: #e9ecef; color: var(--dark-text); font-weight: bold; padding: 4px 8px; border-radius: 4px; }
    body.dark-mode .salary-highlight { background-color: #343a40; color: var(--dark-text); }
    .tech-id-red-highlight { background-color: #f8d7da; color: #721c24; font-weight: bold; padding: 4px 8px; border-radius: 4px; }
    body.dark-mode .tech-id-red-highlight { background-color: #721c24; color: #f8d7da; }
    .tech-id-orange-highlight { background-color: #fff3cd; color: #856404; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
    body.dark-mode .tech-id-orange-highlight { background-color: #856404; color: #fff3cd; }

    .spinner-layer.spinner-blue-only .circle-clipper .circle,
    .spinner-layer.spinner-blue-only .gap-patch .circle { border-color: var(--primary-accent) !important; }
    .preloader-wrapper.active .spinner-layer.spinner-blue-only .circle-clipper.left,
    .preloader-wrapper.active .spinner-layer.spinner-blue-only .circle-clipper.right { border-color: var(--primary-accent) !important; }

    #multiplier-modal .input-field select[multiple] {
        display: block;
        width: 100%;
        height: auto;
        max-height: 150px; /* Adjust this value as needed (e.g., 200px) */
        overflow-y: auto;
        background-color: #fff; 
        border: 1px solid #9e9e9e; 
        border-radius: 3px;
        padding: 5px;
    }

    body.dark-mode #multiplier-modal .input-field select[multiple] {
        background-color: var(--medium-bg); 
        border-color: var(--primary-accent-dark); 
        color: var(--dark-text); 
    }

    body.dark-mode #multiplier-modal .input-field select[multiple] option {
        background-color: var(--medium-bg); 
        color: var(--dark-text); 
    }

    #multiplier-modal .modal-content {
       overflow-y: auto; 
    }

    /* MODIFIED: CSS for hiding filter section */
    .filter-section-hidden {
        display: none;
    }
    </style>
</head>
<body>
    <button id="dark-mode-toggle">
        <i class="material-icons">brightness_high</i>
    </button>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h5 class="center-align">Login</h5>
            <div class="input-field">
                <select id="login-role">
                    <option value="" disabled selected>Choose your role</option>
                    <option value="tl">Login as TL</option>
                    <option value="tech">Login as Tech</option>
                </select>
                <label for="login-role">Select Role</label>
            </div>
            <div class="input-field" id="tl-code-input" style="display: none;">
                <input id="tl-login-code" type="password">
                <label for="tl-login-code">TL Login Code</label>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn blue" id="login-button">Login</a>
        </div>
    </div>

    <div class="container" id="main-app-content" style="display: none;">
        <h5 class="center-align">123 EXTRACTOR</h5>
        <div class="right-align" style="margin-top: 10px;">
            <a class="btn-floating btn-large green modal-trigger" href="#add-project-modal" id="add-project-button">
                <i class="material-icons">add</i>
            </a>
        </div>
        <div class="input-field">
            <select id="project-selector">
                <option value="" disabled selected>Select a saved project</option>
            </select>
            <label for="project-selector">Load Project</label>
        </div>
        <div class="center-align">
            <button class="btn orange darken-2" id="edit-project">
                <i class="material-icons left">edit</i>Edit Project
            </button>
            <button class="btn red darken-2" id="delete-project">
                <i class="material-icons left">delete</i>Delete Project
            </button>
            <button class="btn blue-grey darken-1 modal-trigger" href="#view-data-modal" id="view-project-data-button">
                <i class="material-icons left">table_chart</i>View Data
            </button>
        </div>
        <div class="input-field">
            <input id="tech-id" type="text" placeholder="e.g. TECH123">
            <label for="tech-id">Search TECH ID</label>
        </div>
        <div class="center-align">
            <button class="btn blue" id="search-button">
                <i class="material-icons left">search</i>Search
            </button>
            <button class="btn green" id="calculate-all-button">
                <i class="material-icons left">calculate</i>Per Project Total
            </button>
            <button class="btn purple darken-2 modal-trigger" href="#multiplier-modal" id="calculate-all-projects-button">
                <i class="material-icons left">grid_on</i>All Projects Total
            </button>
        </div>
        <div class="center-align" style="margin-top: 10px;">
            <button class="btn orange" id="export-button">
                <i class="material-icons left">file_download</i>Download CSV
            </button>
             <button class="btn cyan" id="generate-tl-dashboard-button" style="display: none;">
                <i class="material-icons left">dashboard</i>View Report
            </button>
            <button class="btn red" id="clear-data-button">
                <i class="material-icons left">clear_all</i>Clear All Data
            </button>
        </div>
        <div class="center-align" style="margin-top: 10px;">
            <button class="btn blue darken-1" id="copy-all-projects-json">
                <i class="material-icons left">content_copy</i>Copy All Projects Data
            </button>
            <button class="btn deep-purple darken-2" id="auto-fetch-external-json">
                <i class="material-icons left">cloud_download</i>Update Projects Online
            </button>
        </div>
        <div id="all-results" class="result z-depth-1" style="margin-top: 20px; max-height: 600px; overflow-y: auto;">
            </div>

        <div id="multiplier-modal" class="modal">
            <div class="modal-content">
                <h5>Enter Multiplier & Filter Projects</h5>

                <div style="margin-bottom: 10px;">
                     <button type="button" id="toggle-filter-visibility-btn" class="btn-small waves-effect waves-light orange darken-1">Hide Filters</button>
                </div>

                <div id="project-filter-wrapper">
                    <div class="input-field" style="margin-top:0; margin-bottom: 10px;"> <div style="margin-bottom: 10px;"> <button type="button" id="filter-select-all-btn" class="btn-small waves-effect waves-light blue" style="margin-right: 5px; margin-bottom: 5px; margin-top:0;">Select All</button>
                            <button type="button" id="filter-deselect-all-btn" class="btn-small waves-effect waves-light grey" style="margin-bottom: 5px; margin-top:0;">Deselect All</button>
                        </div>
                        <select multiple id="project-filter-selector">
                            <option value="" disabled>Select projects to include (default all)</option>
                            </select>
                        <label for="project-filter-selector" class="active">Filter Projects (Optional)</label>
                    </div>
                </div>

                <div class="input-field" style="margin-top: 25px;">
                    <input id="total-multiplier" type="number" value="1" step="0.01">
                    <label for="total-multiplier">Multiplier</label>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close btn grey">Cancel</a>
                <a href="#!" class="btn green" id="apply-multiplier">Apply & Calculate</a>
            </div>
        </div>

        <div id="add-project-modal" class="modal">
            <div class="modal-content">
                <h5 id="modal-title">Add New Project</h5>
                <div class="input-field">
                    <input id="project-name" type="text">
                    <label for="project-name">Project Name</label>
                </div>
                <div class="input-field">
                    <textarea id="raw-data" class="materialize-textarea" placeholder="Paste your fixpoints data here..."></textarea>
                    <label for="raw-data">Fixpoints Data</label>
                </div>
                <div class="row">
                    <div class="input-field col s6">
                        <select id="modal-size">
                            <option value="3in">3IN</option>
                            <option value="9in">9IN</option>
                        </select>
                        <label for="modal-size">Project Size</label>
                    </div>
                    <div class="input-field col s6">
                        <label>
                            <input type="checkbox" id="modal-ir-check" />
                            <span>IR Additive (1.5pts)</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close btn grey">Cancel</a>
                <a href="#!" class="modal-close btn green" id="save-project-modal-button">Save Project</a>
            </div>
        </div>
        <div class="center-align" style="margin-top: 20px;">
            <button class="btn waves-effect waves-light grey darken-1" id="logout-button">
                <i class="material-icons left">logout</i>Logout / Change Role
            </button>
        </div>
    </div>

    <div id="view-data-modal" class="modal">
        <div class="modal-content">
            <h5 id="view-data-modal-title">Project Data</h5>
            <div id="view-data-table-container" style="overflow-x: auto;">
                <div class="spinner-container" id="view-data-spinner" style="display: none;">
                    <div class="preloader-wrapper active">
                        <div class="spinner-layer spinner-blue-only">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn grey">Close</a>
        </div>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h5 id="confirmation-modal-title">Confirm Action</h5>
            <p id="confirmation-modal-message"></p>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn grey darken-1" id="confirmation-cancel-button">Cancel</a>
            <a href="#!" class="modal-close btn red darken-2" id="confirmation-confirm-button">Confirm</a>
        </div>
    </div>

    <div id="fullscreen-results-modal">
        <div id="fullscreen-results-content">
            <button class="close-button"><i class="material-icons">close</i></button>
        </div>
    </div>

    <div id="loader-spinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
        <div class="preloader-wrapper active">
            <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                    <div class="circle"></div>
                </div>
                <div class="gap-patch">
                    <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                    <div class="circle"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script>
        // --- Configuration ---
        const HARDCODED_PROJECTS_JSON_URL = 'https://raw.githubusercontent.com/serhgs/project_data.json/refs/heads/main/update.json';
        const HARDCODED_TL_CODE_URL = 'https://raw.githubusercontent.com/gmlorenz/gmlorenz.github.io/refs/heads/main/projects_data.json';
        const PRICES = [
            { "3in": 2.19, "9in": 0.99 }, { "3in": 5.86, "9in": 2.08 }, { "3in": 7.44, "9in": 2.78 },
            { "3in": 2.29, "9in": 1.57 }, { "3in": 1.55, "9in": 0.60 }, { "3in": 1.84, "9in": 0.78 },
            { "3in": 1.00, "9in": 1.00 }, { "3in": 3.74, "9in": 3.74 }, { "3in": 1.73, "9in": 1.73 }
        ];

        // --- DOM Elements ---
        const projectSelector = document.getElementById('project-selector');
        const rawDataInput = document.getElementById('raw-data');
        const projectNameInput = document.getElementById('project-name');
        const techIdInput = document.getElementById('tech-id');
        const allResultsDiv = document.getElementById('all-results');
        const addProjectModal = document.querySelector('#add-project-modal');
        const modalTitle = document.getElementById('modal-title');
        const saveProjectModalButton = document.getElementById('save-project-modal-button');
        const clearDataButton = document.getElementById('clear-data-button');
        const addProjectButton = document.getElementById('add-project-button');
        const mainAppContent = document.getElementById('main-app-content');
        const logoutButton = document.getElementById('logout-button');
        const loginModal = document.getElementById('login-modal');
        const loginRoleSelect = document.getElementById('login-role');
        const tlCodeInputDiv = document.getElementById('tl-code-input');
        const tlLoginCodeInput = document.getElementById('tl-login-code');
        const loginButtonElement = document.getElementById('login-button');
        const fullscreenResultsModal = document.getElementById('fullscreen-results-modal');
        const fullscreenResultsContent = document.getElementById('fullscreen-results-content');
        const fullscreenCloseButton = fullscreenResultsContent.querySelector('.close-button');
        const viewDataModal = document.getElementById('view-data-modal');
        const viewDataTableContainer = document.getElementById('view-data-table-container');
        const viewDataModalTitle = document.getElementById('view-data-modal-title');
        const viewDataSpinner = document.getElementById('view-data-spinner');
        const multiplierInput = document.getElementById('total-multiplier');
        const applyMultiplierButton = document.getElementById('apply-multiplier');
        const modalSizeSelect = document.getElementById('modal-size');
        const modalIrCheck = document.getElementById('modal-ir-check');
        const viewProjectDataButton = document.getElementById('view-project-data-button');
        const autoFetchButton = document.getElementById('auto-fetch-external-json');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmationConfirmButton = document.getElementById('confirmation-confirm-button');
        const confirmationCancelButton = document.getElementById('confirmation-cancel-button');
        const generateTlDashboardButton = document.getElementById('generate-tl-dashboard-button');
        const projectFilterSelectorForTotal = document.getElementById('project-filter-selector');
        const filterSelectAllBtn = document.getElementById('filter-select-all-btn'); 
        const filterDeselectAllBtn = document.getElementById('filter-deselect-all-btn'); 
        const toggleFilterVisibilityBtn = document.getElementById('toggle-filter-visibility-btn'); // MODIFIED: Added
        const projectFilterWrapper = document.getElementById('project-filter-wrapper'); // MODIFIED: Added


        // --- Global State ---
        let activeProjectData = '';
        let allCalculatedResults = [];
        let lastResult = '';
        let allProjectsAggregatedResults = {};
        let editingProjectName = null;
        let isLoggedInAsTL = false;
        let confirmPromiseResolve = null;
        let lastSelectedProjectFilters = []; 
        let isProjectFilterVisible = true; // MODIFIED: To track filter visibility, default true


        // --- Utility Functions ---
        function showToast(html, classes = '') { M.toast({ html, classes }); }
        function showLoader() { const loader = document.getElementById('loader-spinner'); if (loader) loader.style.display = 'block'; }
        function hideLoader() { const loader = document.getElementById('loader-spinner'); if (loader) loader.style.display = 'none'; }
        function safeSetLocalStorage(key, value) {
            try {
                const compressedValue = LZString.compressToUTF16(value);
                if (compressedValue === null) throw new Error("Compression failed.");
                localStorage.setItem(key, compressedValue); return true;
            } catch (e) {
                if (e instanceof DOMException && e.name === 'QuotaExceededError') showToast('Local storage full! Could not save project.', 'red');
                else { showToast(`Error saving project data to local storage. ${e.message}`, 'red'); console.error("Local storage save error:", e); }
                return false;
            }
        }
        function safeGetLocalStorage(key) {
            try {
                const value = localStorage.getItem(key); if (value === null) return null;
                let decompressedValue = LZString.decompressFromUTF16(value); if (decompressedValue !== null) return decompressedValue;
                console.warn(`Decompression failed for key "${key}". Attempting to load as uncompressed data.`); return value;
            } catch (e) {
                console.error(`Error retrieving or decompressing data for key "${key}":`, e);
                showToast('Error loading project data. Data might be corrupted.', 'red'); return null;
            }
        }
        function showCustomConfirm(message, title = 'Confirm Action') {
            return new Promise(resolve => {
                confirmationModalTitle.textContent = title; confirmationModalMessage.textContent = message;
                M.Modal.getInstance(confirmationModal).open(); confirmPromiseResolve = resolve;
            });
        }

        // --- UI Component Functions ---
        function loadProjectList() {
            projectSelector.innerHTML = '<option value="" disabled selected>Select a saved project</option>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tl_project_')) {
                    const name = key.replace('tl_project_', '');
                    const option = document.createElement('option'); option.value = name; option.textContent = name;
                    projectSelector.appendChild(option);
                }
            }
            M.FormSelect.init(projectSelector);
        }

        function populateProjectFilterSelector() {
            if (!projectFilterSelectorForTotal) return;
            const currentScrollTop = projectFilterSelectorForTotal.scrollTop; 

            projectFilterSelectorForTotal.innerHTML = '<option value="" disabled>Select projects (default all)</option>';
            let projectFound = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tl_project_')) {
                    const name = key.replace('tl_project_', '');
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    if (lastSelectedProjectFilters.includes(name)) { 
                        option.selected = true;
                    }
                    projectFilterSelectorForTotal.appendChild(option);
                    projectFound = true;
                }
            }
            if (!projectFound) {
                 const noProjectsOption = document.createElement('option');
                 noProjectsOption.value = "";
                 noProjectsOption.disabled = true;
                 noProjectsOption.selected = true;
                 noProjectsOption.textContent = 'No projects found to filter';
                 projectFilterSelectorForTotal.appendChild(noProjectsOption);
            }
            M.FormSelect.init(projectFilterSelectorForTotal);
            projectFilterSelectorForTotal.scrollTop = currentScrollTop;
        }

        // MODIFIED: Function to update filter visibility UI
        function updateFilterVisibilityUI() {
            if (!projectFilterWrapper || !toggleFilterVisibilityBtn) return;

            if (isProjectFilterVisible) {
                projectFilterWrapper.classList.remove('filter-section-hidden');
                toggleFilterVisibilityBtn.textContent = 'Hide Filters';
                toggleFilterVisibilityBtn.classList.remove('blue'); // Ensure blue is removed
                toggleFilterVisibilityBtn.classList.add('orange', 'darken-1');
            } else {
                projectFilterWrapper.classList.add('filter-section-hidden');
                toggleFilterVisibilityBtn.textContent = 'Show Filters';
                toggleFilterVisibilityBtn.classList.remove('orange', 'darken-1'); // Ensure orange is removed
                toggleFilterVisibilityBtn.classList.add('blue');
            }
        }


        function addResultButtonsToAllResults(isSingleSearchResult = false) {
            const targetDiv = allResultsDiv;
            const existingButtons = targetDiv.querySelector('.result-buttons');
            if (existingButtons) existingButtons.remove();
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'result-buttons';
            if (isSingleSearchResult && lastResult && lastResult._foundRowsCount > 0) {
                const viewDataButton = document.createElement('button');
                viewDataButton.className = 'view-data-result-button';
                viewDataButton.innerHTML = '<i class="material-icons">table_chart</i>';
                viewDataButton.title = 'View Raw Data for this TECH ID';
                viewDataButton.addEventListener('click', () => {
                    if (!activeProjectData || !activeProjectData.data) { showToast('No data loaded for project.', 'orange'); return; }
                    if (lastResult.techID) displayDataTableInModal(activeProjectData.data, lastResult.techID);
                    else showToast('TECH ID not in last result.', 'orange');
                });
                buttonsContainer.appendChild(viewDataButton);
            }
            const expandButton = document.createElement('button');
            expandButton.className = 'expand-button';
            expandButton.innerHTML = '<i class="material-icons">fullscreen</i>';
            expandButton.title = 'Expand Results';
            expandButton.addEventListener('click', () => {
                let contentToExpand = targetDiv.cloneNode(true);
                const clonedButtonsContainer = contentToExpand.querySelector('.result-buttons');
                if (clonedButtonsContainer) clonedButtonsContainer.remove();
                fullscreenResultsContent.innerHTML = ''; fullscreenResultsContent.appendChild(contentToExpand);
                const closeButtonFS = document.createElement('button');
                closeButtonFS.classList.add('close-button'); closeButtonFS.innerHTML = '<i class="material-icons">close</i>';
                closeButtonFS.addEventListener('click', hideFullscreenModal);
                fullscreenResultsContent.appendChild(closeButtonFS);
                fullscreenResultsModal.style.display = 'flex';
            });
            buttonsContainer.appendChild(expandButton);
            targetDiv.prepend(buttonsContainer);
        }

        function hideFullscreenModal() { fullscreenResultsModal.style.display = 'none'; fullscreenResultsContent.innerHTML = ''; }

        function displayDataTableInModal(rawDataString, techIDFilter = '') {
            viewDataTableContainer.innerHTML = ''; viewDataSpinner.style.display = 'flex';
            setTimeout(() => {
                const rows = String(rawDataString).split(/\r?\n/).filter(r => r.trim() !== "");
                if (rows.length === 0) viewDataTableContainer.innerHTML = '<p>No data.</p>';
                else {
                    const headersTextOriginal = rows.shift();
                    if (!headersTextOriginal) { viewDataTableContainer.innerHTML = '<p>No header.</p>'; viewDataSpinner.style.display = 'none'; M.Modal.getInstance(viewDataModal).open(); return; }
                    const headers = headersTextOriginal.split(/[\t,]/).map(h => h.trim());
                    const headersUpperCase = headers.map(h => h.toUpperCase());
                    const fixIdIndex = headersUpperCase.indexOf("FIX1_ID");
                    let tableHtml = '<table class="striped"><thead><tr>';
                    headers.forEach(h => tableHtml += `<th>${h}</th>`); tableHtml += '</tr></thead><tbody>';
                    let foundRows = false;
                    rows.forEach(row => {
                        const fields = row.split(/[\t,]/).map(f => f.trim());
                        if (techIDFilter === '' || fixIdIndex === -1 || (fixIdIndex !== -1 && fields[fixIdIndex]?.toUpperCase() === techIDFilter.toUpperCase())) {
                            foundRows = true; tableHtml += '<tr>';
                            fields.forEach(f => tableHtml += `<td>${f}</td>`); tableHtml += '</tr>';
                        }
                    });
                    tableHtml += '</tbody></table>';
                    if (foundRows || techIDFilter === '') viewDataTableContainer.innerHTML = tableHtml;
                    else viewDataTableContainer.innerHTML = `<p>No data for TECH ID: ${techIDFilter}.</p>`;
                }
                let modalTitleText = `Data for Project: ${projectSelector.value || 'Loaded'}`;
                if (techIDFilter) modalTitleText += ` (Filtered: ${techIDFilter})`;
                viewDataModalTitle.textContent = modalTitleText;
                viewDataSpinner.style.display = 'none'; M.Modal.getInstance(viewDataModal).open();
            }, 50);
        }

        function viewProjectData() {
            const name = projectSelector.value; if (!name) { showToast('Select project.', 'orange'); return; }
            if (!activeProjectData || !activeProjectData.data) { showToast('No data for project.', 'orange'); return; }
            displayDataTableInModal(activeProjectData.data);
        }

        function getBonusPercentage(qualityPercentage) {
            if (qualityPercentage < 77.50) return 0; if (qualityPercentage >= 100.00) return 120;
            const bonusTiers = [
                { quality: 77.50, bonus: 5 }, { quality: 78.00, bonus: 10 }, { quality: 78.50, bonus: 15 }, { quality: 79.00, bonus: 20 },
                { quality: 79.50, bonus: 25 }, { quality: 80.00, bonus: 30 }, { quality: 80.50, bonus: 35 }, { quality: 81.00, bonus: 40 },
                { quality: 81.50, bonus: 45 }, { quality: 82.00, bonus: 50 }, { quality: 82.50, bonus: 55 }, { quality: 83.00, bonus: 57 },
                { quality: 83.50, bonus: 60 }, { quality: 84.00, bonus: 62 }, { quality: 84.50, bonus: 64 }, { quality: 85.00, bonus: 66 },
                { quality: 85.50, bonus: 68 }, { quality: 86.00, bonus: 70 }, { quality: 86.50, bonus: 73 }, { quality: 87.00, bonus: 75 },
                { quality: 87.50, bonus: 78 }, { quality: 88.00, bonus: 80 }, { quality: 88.50, bonus: 83 }, { quality: 89.00, bonus: 85 },
                { quality: 89.50, bonus: 87 }, { quality: 90.00, bonus: 88 }, { quality: 90.50, bonus: 90 }, { quality: 91.00, bonus: 91 },
                { quality: 91.50, bonus: 93 }, { quality: 92.00, bonus: 94 }, { quality: 92.50, bonus: 95 }, { quality: 93.00, bonus: 96 },
                { quality: 93.50, bonus: 97 }, { quality: 94.00, bonus: 98 }, { quality: 94.50, bonus: 99 }, { quality: 95.00, bonus: 100 },
                { quality: 95.50, bonus: 102 }, { quality: 96.00, bonus: 104 }, { quality: 96.50, bonus: 106 }, { quality: 97.00, bonus: 108 },
                { quality: 97.50, bonus: 110 }, { quality: 98.00, bonus: 112 }, { quality: 98.50, bonus: 114 }, { quality: 99.00, bonus: 116 },
                { quality: 99.50, bonus: 118 }
            ];
            for (let i = bonusTiers.length - 1; i >= 0; i--) if (qualityPercentage >= bonusTiers[i].quality) return bonusTiers[i].bonus;
            return 0;
        }

        function calculateRowDetails(fields, headers, size, ir) {
            const idxMap = { cat: headers.indexOf("CATEGORY"), i3qa: headers.indexOf("I3QA_CAT"), rv1: headers.indexOf("RV1_CAT"), afp1: headers.indexOf("AFP1_CAT"), afp2: headers.indexOf("AFP2_CAT"), rv2: headers.indexOf("RV2_CAT") };
            let pts = 0, counts = Array(9).fill(0), catPts = Array(9).fill(0);
            [idxMap.cat, idxMap.i3qa, idxMap.rv1, idxMap.afp1, idxMap.afp2, idxMap.rv2].forEach(idx => {
                if (idx !== -1 && fields[idx] && fields[idx].trim() !== "") {
                    const val = parseInt(fields[idx].trim());
                    if (!isNaN(val) && val >= 1 && val <= 9) {
                        const pObj = PRICES[val - 1];
                        if (pObj && pObj[size] !== undefined) { let cPts = pObj[size]; if (ir) cPts += 1.5; pts += cPts; counts[val-1]++; catPts[val-1] += cPts; }
                        else console.warn(`Price for cat ${val}, size ${size} missing.`);
                    }
                }
            });
            return { rowPoints: pts, categoryCounts: counts, categoryPoints: catPts };
        }

        function calculateDetailsForTechIDInRaw(raw, techIDValue, size, ir) {
            const allRows = String(raw).split(/\r?\n/).filter(r => r.trim() !== "");
            if (allRows.length === 0) return null;
            const headerRow = allRows.shift(); if (!headerRow) return null;
            const headers = headerRow.split(/[\t,]/).map(h => h.trim().toUpperCase());
            const idx = { fixId: headers.indexOf("FIX1_ID"), afp1stat: headers.indexOf("AFP1_STAT"), rv1lbl: headers.indexOf("RV1_LABEL"), i3qalbl: headers.indexOf("I3QA_LABEL"), rv2lbl: headers.indexOf("RV2_LABEL"), cat: headers.indexOf("CATEGORY"), i3qa: headers.indexOf("I3QA_CAT"), rv1cat: headers.indexOf("RV1_CAT"), afp1cat: headers.indexOf("AFP1_CAT"), afp2cat: headers.indexOf("AFP2_CAT"), rv2cat: headers.indexOf("RV2_CAT") };
            if (idx.fixId === -1) { console.error("FIX1_ID missing"); return null; }

            let tp=0, afp=0, efp=0, mfp=0, ic=0, ipv=0, cp=Array(9).fill(0), cc=Array(9).fill(0);
            let hasIncorrectWithEmptyCat = false;

            const matchedRows = allRows.filter(row => row.split(/[\t,]/)[idx.fixId]?.trim().toUpperCase() === techIDValue);

            matchedRows.forEach(row => {
                const f = row.split(/[\t,]/).map(x => x.trim());
                if (!hasIncorrectWithEmptyCat && idx.rv1lbl !== -1 && f[idx.rv1lbl]?.toUpperCase().includes("I")) { if (idx.rv1cat !== -1 && f[idx.rv1cat] !== undefined && f[idx.rv1cat] === "") hasIncorrectWithEmptyCat = true; }
                if (!hasIncorrectWithEmptyCat && idx.rv2lbl !== -1 && f[idx.rv2lbl]?.toUpperCase().includes("I")) { if (idx.rv2cat !== -1 && f[idx.rv2cat] !== undefined && f[idx.rv2cat] === "") hasIncorrectWithEmptyCat = true; }

                if (idx.rv1lbl !== -1 && f[idx.rv1lbl]) { const l = f[idx.rv1lbl].toUpperCase(); if (l.includes("E")) efp++; if (l.includes("M")) mfp++; if (l.includes("I")) ic++; }
                if (idx.i3qalbl !== -1 && f[idx.i3qalbl]?.toUpperCase().includes("M")) mfp++;
                if (idx.rv2lbl !== -1 && f[idx.rv2lbl]) { const l = f[idx.rv2lbl].toUpperCase(); if (l.includes("E")) efp++; if (l.includes("M")) mfp++; if (l.includes("I")) ic++; }
                if (idx.afp1stat !== -1 && f[idx.afp1stat]?.toUpperCase() === "AA") afp++;

                const rd = calculateRowDetails(f, headers, size, ir); tp += rd.rowPoints;
                rd.categoryCounts.forEach((c,i) => cc[i]+=c); rd.categoryPoints.forEach((p,i) => cp[i]+=p);

                if (idx.rv1lbl !== -1 && f[idx.rv1lbl]?.toUpperCase().includes("I")) { if (idx.rv1cat !== -1 && f[idx.rv1cat] !== undefined && f[idx.rv1cat] !== "") { const v=parseInt(f[idx.rv1cat]); if(!isNaN(v)&&v>=1&&v<=9){ const p=PRICES[v-1]?.[size]; if(p!==undefined){let pts=p;if(ir)pts+=1.5;ipv+=pts;}}}}
                if (idx.rv2lbl !== -1 && f[idx.rv2lbl]?.toUpperCase().includes("I")) { if (idx.rv2cat !== -1 && f[idx.rv2cat] !== undefined && f[idx.rv2cat] !== "") { const v=parseInt(f[idx.rv2cat]); if(!isNaN(v)&&v>=1&&v<=9){ const p=PRICES[v-1]?.[size]; if(p!==undefined){let pts=p;if(ir)pts+=1.5;ipv+=pts;}}}}
            });
            const correctPts = tp - ipv, qp = (tp > 0) ? (correctPts / tp) * 100 : 0, bp = getBonusPercentage(qp), qb = tp * (bp/100), es = tp + qb;
            return { techID:techIDValue, totalPoints:tp, additionalFixPoints:afp, excessiveFixPoints:efp, missFixPoints:mfp, incorrectCounting:ic, incorrectPointsValue:ipv, qualityPercentage:qp, bonusPercentage:bp, qualityBonus:qb, estimatedSalary:es, categoryPoints:cp, categoryCounts:cc, hasIncorrectWithEmptyCat, _foundRowsCount: matchedRows.length };
        }

        // --- Main Functions ---
        function saveProject() {
            const name = projectNameInput.value.trim(), data = rawDataInput.value.trim(), size = modalSizeSelect.value, ir = modalIrCheck.checked;
            if (!name || !data) { showToast('Enter project name and data.', 'red'); return; }
            const payload = JSON.stringify({ data, size, ir }), key = `tl_project_${name}`;
            if (editingProjectName && editingProjectName !== name) localStorage.removeItem(`tl_project_${editingProjectName}`);
            if (safeSetLocalStorage(key, payload)) {
                showToast(`'${name}' saved!`, 'green'); loadProjectList(); M.Modal.getInstance(addProjectModal).close();
                projectNameInput.value=''; rawDataInput.value=''; modalSizeSelect.value='3in'; modalIrCheck.checked=false;
                M.FormSelect.init(modalSizeSelect); M.updateTextFields(); editingProjectName=null;
                if (projectSelector.value === name) projectSelector.dispatchEvent(new Event('change'));
            }
        }
        async function deleteSelectedProject() {
            const sel = projectSelector.value; if (!sel) { showToast('No project selected.', 'red'); return; }
            if (await showCustomConfirm(`Delete project '${sel}'?`, 'Delete Project')) {
                localStorage.removeItem(`tl_project_${sel}`); showToast(`'${sel}' deleted.`, 'orange');
                loadProjectList(); activeProjectData=''; allResultsDiv.innerHTML=''; allCalculatedResults=[];lastResult='';allProjectsAggregatedResults={};
                editingProjectName=null; projectSelector.value=""; M.FormSelect.init(projectSelector);
            }
        }

        function searchTechID() {
            const raw = activeProjectData?.data, inputID = techIdInput.value.trim(), searchID = inputID.toUpperCase(),
                  size = activeProjectData?.size, ir = activeProjectData?.ir;
            allResultsDiv.innerHTML = ''; lastResult=''; allCalculatedResults=[]; allProjectsAggregatedResults={};
            if (!raw || !inputID || !size) {
                allResultsDiv.innerHTML = '<p>Load project and enter TECH ID.</p>'; addResultButtonsToAllResults(true); return;
            }
            const result = calculateDetailsForTechIDInRaw(raw, searchID, size, ir);
            if (result && result._foundRowsCount > 0) {
                let idClass = 'tech-id-highlight';
                if (result.hasIncorrectWithEmptyCat) idClass = 'tech-id-orange-highlight';
                else if (result.techID.length < 6) idClass = 'tech-id-red-highlight';
                
                let html = `<h5>Search Results for TECH ID: <span class="${idClass}">${result.techID}</span> (Project: ${projectSelector.value||'N/A'})</h5>`;
                html += `<p><strong>Project Total Points: ${result.totalPoints.toFixed(2)}</strong></p>`;
                html += '<table class="striped"><thead><tr><th>Metric</th><th>Value</th><th>Count/N/A</th></tr></thead><tbody>';
                result.categoryPoints.forEach((t,i)=>html+=`<tr><td>CAT ${i+1}</td><td>${t.toFixed(2)}</td><td>${result.categoryCounts[i]}</td></tr>`);
                html+=`<tr><td>Additional FixPoints</td><td>N/A</td><td>${result.additionalFixPoints}</td></tr>`;
                html+=`<tr><td>Excessive FixPoints</td><td>N/A</td><td>${result.excessiveFixPoints}</td></tr>`;
                html+=`<tr><td>Miss FixPoints</td><td>N/A</td><td>${result.missFixPoints}</td></tr>`;
                html+=`<tr><td>Incorrect Counting</td><td>N/A</td><td>${result.incorrectCounting}</td></tr>`;
                html+=`<tr><td>Incorrect Points Value</td><td>${result.incorrectPointsValue.toFixed(2)}</td><td>N/A</td></tr>`;
                html+=`<tr><td>Total Points</td><td>${result.totalPoints.toFixed(2)}</td><td>N/A</td></tr>`;
                html+=`<tr><td>Quality Percentage</td><td>${result.qualityPercentage.toFixed(2)}%</td><td>N/A</td></tr>`;
                html+=`<tr><td>Bonus Percentage</td><td>${result.bonusPercentage.toFixed(2)}%</td><td>N/A</td></tr>`;
                html+=`<tr><td>Quality Bonus</td><td>${result.qualityBonus.toFixed(2)}</td><td>N/A</td></tr>`;
                html+=`<tr><td class="salary-highlight">Estimated Salary</td><td class="salary-highlight">${result.estimatedSalary.toFixed(2)}</td><td class="salary-highlight">N/A</td></tr>`;
                html += '</tbody></table>';
                if (result.hasIncorrectWithEmptyCat) {
                    html += `<p class="status-notification"><strong>STATUS:</strong> Have incorrect data but no Category</p>`;
                }
                allResultsDiv.innerHTML = html; lastResult = result;
            } else {
                allResultsDiv.innerHTML = `<p>TECH ID '${inputID}' not found in the loaded project.</p>`; lastResult='';
            }
            addResultButtonsToAllResults(true);
        }

        function calculateAllTechIDs() {
            const raw=activeProjectData?.data, size=activeProjectData?.size, ir=activeProjectData?.ir;
            allResultsDiv.innerHTML=''; allCalculatedResults=[]; lastResult=''; allProjectsAggregatedResults={};
            if(!raw||!size){allResultsDiv.innerHTML='<p>Load project.</p>';addResultButtonsToAllResults(false);return}
            const rows=String(raw).split(/\r?\n/).filter(r=>r.trim()!==""); if(rows.length===0){allResultsDiv.innerHTML='<p>No data rows.</p>';addResultButtonsToAllResults(false);return}
            const hr=rows.shift(); if(!hr){allResultsDiv.innerHTML='<p>No header.</p>';addResultButtonsToAllResults(false);return}
            const h=hr.split(/[\t,]/).map(x=>x.trim().toUpperCase()), fixIdx=h.indexOf("FIX1_ID");
            if(fixIdx===-1){allResultsDiv.innerHTML='<p>FIX1_ID missing.</p>';addResultButtonsToAllResults(false);return}
            const ids=new Set(); rows.forEach(r=>{const f=r.split(/[\t,]/),id=f[fixIdx]?.trim().toUpperCase();if(id)ids.add(id)});
            if(ids.size===0){allResultsDiv.innerHTML='<p>No TECH IDs.</p>';addResultButtonsToAllResults(false);return}
            let tbl='<table class="striped"><thead><tr>';
            const th=['ID','CAT1 Pts','CAT2 Pts','CAT3 Pts','CAT4 Pts','CAT5 Pts','CAT6 Pts','CAT7 Pts','CAT8 Pts','CAT9 Pts',
                        'CAT1 Ct','CAT2 Ct','CAT3 Ct','CAT4 Ct','CAT5 Ct','CAT6 Ct','CAT7 Ct','CAT8 Ct','CAT9 Ct',
                        'Add.FP','Exc.FP','Miss.FP','Inc.Ct','Inc.PtsVal','TotalPts','Qual%','Bonus%','QualBonus','Salary'];
            th.forEach(x=>tbl+=`<th>${x}</th>`);tbl+='</tr></thead><tbody>';
            ids.forEach(id=>{ const res=calculateDetailsForTechIDInRaw(raw,id,size,ir); if(res){
                allCalculatedResults.push(res);
                const qCls=res.qualityPercentage===100?'quality-green':(res.qualityPercentage>=77.5?'quality-orange':'quality-red');
                const idCls=res.techID.length<6?'tech-id-red-highlight':'tech-id-highlight';
                let bCls=res.bonusPercentage>=100?'quality-green':(res.bonusPercentage>0?'quality-orange':'quality-red');
                tbl+=`<tr><td class="${idCls}">${res.techID}</td>`;
                res.categoryPoints.forEach(t=>tbl+=`<td>${t.toFixed(2)}</td>`);res.categoryCounts.forEach(c=>tbl+=`<td>${c}</td>`);
                tbl+=`<td>${res.additionalFixPoints}</td><td>${res.excessiveFixPoints}</td><td>${res.missFixPoints}</td><td>${res.incorrectCounting}</td>`;
                tbl+=`<td>${res.incorrectPointsValue.toFixed(2)}</td><td>${res.totalPoints.toFixed(2)}</td>`;
                tbl+=`<td class="${qCls}">${res.qualityPercentage.toFixed(2)}%</td><td class="${bCls}">${res.bonusPercentage.toFixed(2)}%</td>`;
                tbl+=`<td class="${bCls}">${res.qualityBonus.toFixed(2)}</td><td class="salary-highlight">${res.estimatedSalary.toFixed(2)}</td></tr>`;
            }});
            tbl+='</tbody></table>'; allResultsDiv.innerHTML=`<h5>Results for Loaded Project: ${projectSelector.value||'N/A'}</h5>${tbl}`; addResultButtonsToAllResults(false);
        }

        function calculateTotalAcrossAllProjects() {
            const multiplier = parseFloat(multiplierInput.value) || 1;
            const selectedProjectNamesForFilter = projectFilterSelectorForTotal ? M.FormSelect.getInstance(projectFilterSelectorForTotal).getSelectedValues() : [];

            lastSelectedProjectFilters = [...selectedProjectNamesForFilter]; 

            allResultsDiv.innerHTML = '';
            allProjectsAggregatedResults = {};
            lastResult = '';
            allCalculatedResults = [];
            let processingErrors = [];
            const allProjectsRawData = [];
            let hasProjectsToProcess = false; 

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tl_project_')) {
                    const projectName = key.replace('tl_project_', '');

                    if (selectedProjectNamesForFilter && selectedProjectNamesForFilter.length > 0 && !selectedProjectNamesForFilter.includes(projectName)) {
                        continue; 
                    }

                    hasProjectsToProcess = true; 
                    const projectDataString = safeGetLocalStorage(key);
                    if (projectDataString !== null) {
                        try {
                            const project = JSON.parse(projectDataString);
                            if (project && typeof project === 'object' && 'data' in project && 'size' in project && 'ir' in project) {
                                allProjectsRawData.push({ name: projectName, data: String(project.data), size: project.size, ir: project.ir });
                            } else { processingErrors.push(`Project '${projectName}': Invalid structure.`); }
                        } catch (e) { processingErrors.push(`Project '${projectName}': Parse error - ${e.message}`); }
                    } else { processingErrors.push(`Project '${projectName}': Could not retrieve.`); }
                }
            }

            if (!hasProjectsToProcess) {
                let message = '<p>No projects saved to calculate totals.</p>';
                if (selectedProjectNamesForFilter && selectedProjectNamesForFilter.length > 0) {
                    message = '<p>No projects matched the selected filter criteria, or the selected projects have no data.</p>';
                }
                allResultsDiv.innerHTML = message;
                addResultButtonsToAllResults(false);
                const multiplierModalElem = document.getElementById('multiplier-modal');
                if (multiplierModalElem) M.Modal.getInstance(multiplierModalElem).close();
                return;
            }

            const allUniqueTechIDsAggregated = new Set();
            allProjectsRawData.forEach(project => {
                const projectRows = project.data.split(/\r?\n/).filter(r => r.trim() !== "");
                if (projectRows.length > 0) {
                    const headerRow = projectRows.shift(); if (!headerRow) return;
                    const headers = headerRow.split(/[\t,]/).map(h => h.trim().toUpperCase());
                    const fixIdIndex = headers.indexOf("FIX1_ID"); if (fixIdIndex === -1) return;
                    projectRows.forEach(row => {
                        const fields = row.split(/[\t,]/);
                        const techID = fields[fixIdIndex]?.trim().toUpperCase();
                        if (techID) allUniqueTechIDsAggregated.add(techID);
                    });
                }
            });

            if (allUniqueTechIDsAggregated.size === 0) {
                allResultsDiv.innerHTML = '<p>No TECH IDs found across the selected/available projects for aggregation.</p>';
                addResultButtonsToAllResults(false);
                const multiplierModalElem = document.getElementById('multiplier-modal');
                if (multiplierModalElem) M.Modal.getInstance(multiplierModalElem).close();
                return;
            }

            allUniqueTechIDsAggregated.forEach(techID => {
                allProjectsAggregatedResults[techID] = {
                    baseTotalPoints: 0, incorrectPointsValue: 0, additionalFixPoints: 0, excessiveFixPoints: 0,
                    missFixPoints: 0, incorrectCounting: 0, categoryPoints: Array(9).fill(0), categoryCounts: Array(9).fill(0),
                    totalPoints: 0, qualityPercentage: 0, bonusPercentage: 0, qualityBonus: 0, estimatedSalary: 0
                };
                allProjectsRawData.forEach(project => { 
                    const result = calculateDetailsForTechIDInRaw(project.data, techID, project.size, project.ir);
                    if (result && result._foundRowsCount > 0) { 
                        const agg = allProjectsAggregatedResults[techID];
                        agg.baseTotalPoints += result.totalPoints; agg.incorrectPointsValue += result.incorrectPointsValue;
                        agg.additionalFixPoints += result.additionalFixPoints; agg.excessiveFixPoints += result.excessiveFixPoints;
                        agg.missFixPoints += result.missFixPoints; agg.incorrectCounting += result.incorrectCounting;
                        result.categoryPoints.forEach((p, i) => agg.categoryPoints[i] += p);
                        result.categoryCounts.forEach((c, i) => agg.categoryCounts[i] += c);
                    }
                });
                const aggRes = allProjectsAggregatedResults[techID];
                if (aggRes.baseTotalPoints > 0) {
                    const correctAgg = aggRes.baseTotalPoints - aggRes.incorrectPointsValue;
                    aggRes.qualityPercentage = (correctAgg / aggRes.baseTotalPoints) * 100;
                    aggRes.bonusPercentage = getBonusPercentage(aggRes.qualityPercentage);
                    aggRes.qualityBonus = aggRes.baseTotalPoints * (aggRes.bonusPercentage / 100);
                    aggRes.totalPoints = aggRes.baseTotalPoints * multiplier; 
                    aggRes.estimatedSalary = aggRes.totalPoints + aggRes.qualityBonus; 
                } else { 
                    aggRes.qualityPercentage = 0;
                    aggRes.bonusPercentage = 0;
                    aggRes.qualityBonus = 0;
                    aggRes.totalPoints = 0;
                    aggRes.estimatedSalary = 0;
                }
            });

            let grandTotalSalary = 0;
            const techIDsToRemove = []; 
            Object.entries(allProjectsAggregatedResults).forEach(([techID, r]) => {
                if (r.baseTotalPoints === 0 && r.additionalFixPoints === 0 && r.excessiveFixPoints === 0 && r.missFixPoints === 0) { 
                    techIDsToRemove.push(techID);
                } else {
                    grandTotalSalary += r.estimatedSalary;
                }
            });
            techIDsToRemove.forEach(techID => delete allProjectsAggregatedResults[techID]);

            let tableTitleText = `Totals Across ${ (selectedProjectNamesForFilter && selectedProjectNamesForFilter.length > 0) ? 'Selected Projects' : 'All Projects'} (Multiplier: ${multiplier.toFixed(2)})`;
            if (selectedProjectNamesForFilter && selectedProjectNamesForFilter.length > 0) {
                tableTitleText += `<br><small style="font-size: 0.7em;">Filtered Projects: ${selectedProjectNamesForFilter.join(', ')}</small>`;
            }
            let tableHtml = `<h5>${tableTitleText}</h5>`;

            if (Object.keys(allProjectsAggregatedResults).length === 0) {
                 allResultsDiv.innerHTML = `<h5>${tableTitleText}</h5><p>No data to display for the selected criteria.</p>`;
                 addResultButtonsToAllResults(false);
                 const multiplierModalElem = document.getElementById('multiplier-modal');
                 if (multiplierModalElem) M.Modal.getInstance(multiplierModalElem).close();
                 return;
            }

            tableHtml += '<table class="striped"><thead><tr>';
            const aggHeaders = ['TECH ID', ...Array.from({ length: 9 }, (_, i) => `CAT ${i+1} Pts`), ...Array.from({ length: 9 }, (_, i) => `CAT ${i+1} Ct`), 'Add.FP', 'Exc.FP', 'Miss.FP', 'Inc.Ct', 'Inc.PtsVal', 'BasePts', 'Qual%', 'Bonus%', 'BonusVal', 'Salary(w/M)'];
            aggHeaders.forEach(h => tableHtml += `<th>${h}</th>`); tableHtml += '</tr></thead><tbody>';

            Object.entries(allProjectsAggregatedResults).sort((a, b) => a[0].localeCompare(b[0])).forEach(([techID, result]) => {
                const qualityClass = result.qualityPercentage >= 100 ? 'quality-green' : (result.qualityPercentage >= 77.50 ? 'quality-orange' : 'quality-red');
                const techIdHighlightClass = techID.length < 6 ? 'tech-id-red-highlight' : 'tech-id-highlight';
                let bonusClass = result.bonusPercentage >= 100 ? 'quality-green' : (result.bonusPercentage > 0 ? 'quality-orange' : 'quality-red');
                tableHtml += `<tr><td class="${techIdHighlightClass}">${techID}</td>`;
                result.categoryPoints.forEach(t => tableHtml += `<td>${t.toFixed(2)}</td>`); result.categoryCounts.forEach(c => tableHtml += `<td>${c}</td>`);
                tableHtml += `<td>${result.additionalFixPoints}</td><td>${result.excessiveFixPoints}</td><td>${result.missFixPoints}</td><td>${result.incorrectCounting}</td>`;
                tableHtml += `<td>${result.incorrectPointsValue.toFixed(2)}</td><td>${result.baseTotalPoints.toFixed(2)}</td>`;
                tableHtml += `<td class="${qualityClass}">${result.qualityPercentage.toFixed(2)}%</td><td class="${bonusClass}">${result.bonusPercentage.toFixed(2)}%</td>`;
                tableHtml += `<td class="${bonusClass}">${result.qualityBonus.toFixed(2)}</td><td class="salary-highlight">${result.estimatedSalary.toFixed(2)}</td></tr>`;
            });
            tableHtml += `</tbody></table><h4 style="margin-top:20px">Team Total Estimated Salary (Filtered, w/ Multiplier): ${grandTotalSalary.toFixed(2)}</h4>`;
            
            if (processingErrors.length > 0) {
                tableHtml += '<div class="card red lighten-5" style="margin-top:15px;"><div class="card-content red-text text-darken-4"><span class="card-title">Processing Warnings</span><ul>';
                processingErrors.forEach(e => tableHtml += `<li>${e}</li>`); tableHtml += '</ul></div></div>';
            }
            allResultsDiv.innerHTML = tableHtml;
            addResultButtonsToAllResults(false);
            const multiplierModalElem = document.getElementById('multiplier-modal');
            if (multiplierModalElem) M.Modal.getInstance(multiplierModalElem).close();
        }


        async function generateTlDashboard() {
            if (!isLoggedInAsTL) {
                showToast('This report is for TLs only.', 'orange');
                return;
            }
            showLoader();
            allResultsDiv.innerHTML = ''; 
            lastResult = ''; allCalculatedResults = []; allProjectsAggregatedResults = {}; 

            const allProjectsFromStorage = []; 
            let dashboardProcessingErrors = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tl_project_')) {
                    const projectName = key.replace('tl_project_', '');
                    const projectDataString = safeGetLocalStorage(key);
                    if (projectDataString) {
                        try {
                            const project = JSON.parse(projectDataString);
                            if (project && typeof project === 'object' && project.data && project.size) {
                                allProjectsFromStorage.push({ name: projectName, ...project }); 
                            } else {
                                dashboardProcessingErrors.push(`Project '${projectName}': Invalid data structure.`);
                            }
                        } catch (e) {
                            dashboardProcessingErrors.push(`Project '${projectName}': Parse error - ${e.message}`);
                        }
                    } else {
                        dashboardProcessingErrors.push(`Project '${projectName}': Could not retrieve data.`);
                    }
                }
            }

            let totalProjects = allProjectsFromStorage.length;
            let dashboardHtml = `<div class="dashboard-section"><h2>TL Dashboard</h2></div>`;

            if (totalProjects === 0) {
                dashboardHtml += "<p>No projects found to generate a dashboard.</p>";
                allResultsDiv.innerHTML = dashboardHtml; 
                addResultButtonsToAllResults(false);
                hideLoader();
                return;
            }

            let grandTotalBasePoints = 0;
            let grandTotalCorrectPoints = 0;
            let grandTotalBaseSalary = 0;
            const uniqueTechIDsAcrossAllProjects = new Set();
            const shortTechIDsFound = new Set();
            const techIDsWithIncorrectEmptyCatIssue = new Set();
            
            const projectSummariesForDashboard = []; 

            for (const projData of allProjectsFromStorage) { 
                let currentProjectTotalBasePoints = 0;
                let currentProjectTotalCorrectPoints = 0;
                let currentProjectTotalBaseSalary = 0;
                const techIDsInCurrentProject = new Set();

                const rows = String(projData.data).split(/\r?\n/).filter(r => r.trim() !== "");
                if (rows.length > 0) {
                    const headerRow = rows.shift();
                    if (headerRow) {
                        const headers = headerRow.split(/[\t,]/).map(h => h.trim().toUpperCase());
                        const fixIdIndex = headers.indexOf("FIX1_ID");
                        const rv1LabelIndex = headers.indexOf("RV1_LABEL");
                        const rv1CatIndex = headers.indexOf("RV1_CAT");
                        const rv2LabelIndex = headers.indexOf("RV2_LABEL");
                        const rv2CatIndex = headers.indexOf("RV2_CAT");

                        if (fixIdIndex !== -1) {
                            rows.forEach(rowStr => {
                                const fields = rowStr.split(/[\t,]/).map(f => f.trim());
                                const techID = fields[fixIdIndex]?.toUpperCase();
                                if (techID) {
                                    techIDsInCurrentProject.add(techID);
                                    uniqueTechIDsAcrossAllProjects.add(techID);
                                    if (techID.length > 0 && techID.length < 6) {
                                        shortTechIDsFound.add(techID);
                                    }
                                    let currentTechHasIssue = false;
                                    if (rv1LabelIndex !== -1 && fields[rv1LabelIndex]?.toUpperCase().includes("I")) {
                                        if (rv1CatIndex !== -1 && fields[rv1CatIndex] !== undefined && fields[rv1CatIndex] === "") {
                                            currentTechHasIssue = true;
                                        }
                                    }
                                    if (!currentTechHasIssue && rv2LabelIndex !== -1 && fields[rv2LabelIndex]?.toUpperCase().includes("I")) {
                                        if (rv2CatIndex !== -1 && fields[rv2CatIndex] !== undefined && fields[rv2CatIndex] === "") {
                                            currentTechHasIssue = true;
                                        }
                                    }
                                    if(currentTechHasIssue) {
                                        techIDsWithIncorrectEmptyCatIssue.add(techID);
                                    }
                                }
                            });
                        }
                        
                        techIDsInCurrentProject.forEach(techID => {
                            const details = calculateDetailsForTechIDInRaw(projData.data, techID, projData.size, projData.ir);
                            if (details) {
                                currentProjectTotalBasePoints += details.totalPoints;
                                currentProjectTotalCorrectPoints += (details.totalPoints - details.incorrectPointsValue);
                                currentProjectTotalBaseSalary += details.estimatedSalary;
                            }
                        });
                    }
                }
                const projectAvgQuality = currentProjectTotalBasePoints > 0 ? (currentProjectTotalCorrectPoints / currentProjectTotalBasePoints) * 100 : 0;
                projectSummariesForDashboard.push({ 
                    name: projData.name,
                    isIr: projData.ir,
                    techCount: techIDsInCurrentProject.size,
                    basePoints: currentProjectTotalBasePoints,
                    avgQuality: projectAvgQuality,
                    baseSalary: currentProjectTotalBaseSalary
                });

                grandTotalBasePoints += currentProjectTotalBasePoints;
                grandTotalCorrectPoints += currentProjectTotalCorrectPoints;
                grandTotalBaseSalary += currentProjectTotalBaseSalary;
            }

            dashboardHtml += `<div class="dashboard-section"><h5>Overall Performance Summary</h5>`;
            dashboardHtml += `<p><strong>Total Projects:</strong> ${totalProjects}</p>`;
            dashboardHtml += `<p><strong>Total Unique Tech IDs:</strong> ${uniqueTechIDsAcrossAllProjects.size}</p>`;
            const overallWeightedQuality = grandTotalBasePoints > 0 ? (grandTotalCorrectPoints / grandTotalBasePoints) * 100 : 0;
            dashboardHtml += `<p><strong>Grand Total Base Points (All Projects):</strong> ${grandTotalBasePoints.toFixed(2)}</p>`;
            dashboardHtml += `<p><strong>Overall Weighted Quality % (All Projects):</strong> ${overallWeightedQuality.toFixed(2)}%</p>`;
            dashboardHtml += `<p><strong>Grand Total Estimated Base Salary (All Projects):</strong> ${grandTotalBaseSalary.toFixed(2)}</p></div>`;

            dashboardHtml += `<div class="dashboard-section"><h5>Project-Level Summaries</h5>`;
            if (projectSummariesForDashboard.length > 0) {
                dashboardHtml += `<table class="striped responsive-table"><thead><tr><th>Project Name</th><th>IR</th><th>Techs</th><th>Base Points</th><th>Avg Quality %</th><th>Est. Base Salary</th></tr></thead><tbody>`;
                projectSummariesForDashboard.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => { 
                    dashboardHtml += `<tr><td>${p.name}</td><td>${p.isIr ? 'Yes' : 'No'}</td><td>${p.techCount}</td><td>${p.basePoints.toFixed(2)}</td><td>${p.avgQuality.toFixed(2)}%</td><td>${p.baseSalary.toFixed(2)}</td></tr>`;
                });
                dashboardHtml += `</tbody></table>`;
            } else { dashboardHtml += `<p>No project data to summarize.</p>`; }
            dashboardHtml += `</div>`;

            const irProjectSummariesForDashboard = projectSummariesForDashboard.filter(p => p.isIr); 
            let irTotalBasePointsDisplay = 0; 
            let irTotalBaseSalaryDisplay = 0;
            dashboardHtml += `<div class="dashboard-section"><h5>IR Projects Summary</h5>`;
            if (irProjectSummariesForDashboard.length > 0) {
                dashboardHtml += `<table class="striped responsive-table"><thead><tr><th>Project Name</th><th>Techs</th><th>Base Points</th><th>Avg Quality %</th><th>Est. Base Salary</th></tr></thead><tbody>`;
                irProjectSummariesForDashboard.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => { 
                    dashboardHtml += `<tr><td>${p.name}</td><td>${p.techCount}</td><td>${p.basePoints.toFixed(2)}</td><td>${p.avgQuality.toFixed(2)}%</td><td>${p.baseSalary.toFixed(2)}</td></tr>`;
                    irTotalBasePointsDisplay += p.basePoints;
                    irTotalBaseSalaryDisplay += p.baseSalary;
                });
                dashboardHtml += `</tbody></table>`;
                dashboardHtml += `<p style="margin-top:10px;"><strong>Total for IR Projects - Base Points:</strong> ${irTotalBasePointsDisplay.toFixed(2)}</p>`;
                dashboardHtml += `<p><strong>Total for IR Projects - Estimated Base Salary:</strong> ${irTotalBaseSalaryDisplay.toFixed(2)}</p>`;
            } else { dashboardHtml += `<p>No IR projects found.</p>`; }
            dashboardHtml += `</div>`;
            
            dashboardHtml += `<div class="dashboard-section"><h5>Data Quality & Attention Areas</h5>`;
            dashboardHtml += `<h6>Error Inputs Tech ID:</h6>`;
            if (shortTechIDsFound.size > 0) {
                dashboardHtml += `<table class="striped dashboard-data-quality-table responsive-table"><thead><tr><th>Incorrect Tech ID</th></tr></thead><tbody>`;
                Array.from(shortTechIDsFound).sort().forEach(id => dashboardHtml += `<tr><td><span class="tech-id-red-highlight">${id}</span></td></tr>`);
                dashboardHtml += `</tbody></table>`;
            } else {
                dashboardHtml += `<p> Incorrect tech ID display here...</p>`;
            }
            dashboardHtml += `<h6 style="margin-top: 20px;">Tech with "Incorrect" but no Category/Points value...</h6>`;
            if (techIDsWithIncorrectEmptyCatIssue.size > 0) {
                dashboardHtml += `<ul class="dashboard-list">`;
                Array.from(techIDsWithIncorrectEmptyCatIssue).sort().forEach(id => dashboardHtml += `<li>${id}</li>`);
                dashboardHtml += `</ul>`;
            } else {
                dashboardHtml += `<p>No Tech IDs found with this specific "Incorrect + Empty Category" issue.</p>`;
            }
            dashboardHtml += `</div>`;

            if (dashboardProcessingErrors.length > 0) {
                dashboardHtml += `<div class="dashboard-section"><h5>Dashboard Generation Warnings/Errors</h5><ul class="dashboard-list">`;
                dashboardProcessingErrors.forEach(error => dashboardHtml += `<li>${error}</li>`);
                dashboardHtml += `</ul></div>`;
            }

            allResultsDiv.innerHTML = dashboardHtml;
            addResultButtonsToAllResults(false); 
            hideLoader();
        }


        function exportToCsv(filename, dataToExport) {
            if(!dataToExport||(Array.isArray(dataToExport)&&dataToExport.length===0)||(typeof dataToExport==='object'&&Object.keys(dataToExport).length===0&&dataToExport.constructor===Object)){showToast('No data to export.','red');return}
            let csv="data:text/csv;charset=utf-8,",hdrs=[],isArr=Array.isArray(dataToExport);
            if(isArr){const s=dataToExport[0]||{};hdrs=['ID','CAT1 Pts','CAT2 Pts','CAT3 Pts','CAT4 Pts','CAT5 Pts','CAT6 Pts','CAT7 Pts','CAT8 Pts','CAT9 Pts','CAT1 Ct','CAT2 Ct','CAT3 Ct','CAT4 Ct','CAT5 Ct','CAT6 Ct','CAT7 Ct','CAT8 Ct','CAT9 Ct','Add.FP','Exc.FP','Miss.FP','Inc.Ct','Inc.PtsVal',s.hasOwnProperty('baseTotalPoints')?'BasePts':'TotalPts','Qual%','Bonus%',s.hasOwnProperty('baseTotalPoints')?'Bonus(Base)':'Bonus',s.hasOwnProperty('baseTotalPoints')?'Salary(w/M)':'Salary']}else hdrs=['Metric','Value','Count/N/A'];
            csv+=hdrs.join(",")+"\n";
            if(isArr){const isAgg=dataToExport[0]?.hasOwnProperty('baseTotalPoints');dataToExport.forEach(it=>{let r=[it.techID,...it.categoryPoints.map(p=>p.toFixed(2)),...it.categoryCounts,it.additionalFixPoints,it.excessiveFixPoints,it.missFixPoints,it.incorrectCounting,it.incorrectPointsValue.toFixed(2),isAgg?it.baseTotalPoints.toFixed(2):it.totalPoints.toFixed(2),it.qualityPercentage.toFixed(2)+'%',it.bonusPercentage.toFixed(2)+'%',it.qualityBonus.toFixed(2),it.estimatedSalary.toFixed(2)];csv+=r.join(",")+"\n"})}else{const it=dataToExport;it.categoryPoints.forEach((t,i)=>csv+=`"CAT ${i+1}",${t.toFixed(2)},${it.categoryCounts[i]}\n`);csv+=`"Add.FP",N/A,${it.additionalFixPoints}\n`;csv+=`"Exc.FP",N/A,${it.excessiveFixPoints}\n`;csv+=`"Miss.FP",N/A,${it.missFixPoints}\n`;csv+=`"Inc.Ct",N/A,${it.incorrectCounting}\n`;csv+=`"Inc.PtsVal",${it.incorrectPointsValue.toFixed(2)},N/A\n`;csv+=`"TotalPts",${it.totalPoints.toFixed(2)},N/A\n`;csv+=`"Qual%",${it.qualityPercentage.toFixed(2)}%,N/A\n`;csv+=`"Bonus%",${it.bonusPercentage.toFixed(2)}%,N/A\n`;csv+=`"Bonus",${it.qualityBonus.toFixed(2)},N/A\n`;csv+=`"Salary",${it.estimatedSalary.toFixed(2)},N/A\n`}
            const enc=encodeURI(csv),lnk=document.createElement("a");lnk.setAttribute("href",enc);lnk.setAttribute("download",filename);document.body.appendChild(lnk);lnk.click();document.body.removeChild(lnk);showToast('CSV exported!','green');
        }
        async function autoFetchExternalJson(){showLoader();showToast('Updating projects online...','blue');try{const r=await fetch(HARDCODED_PROJECTS_JSON_URL);if(!r.ok)throw new Error(`HTTP ${r.status}`);const ct=await r.text(),dt=LZString.decompressFromBase64(ct);if(dt===null)throw new Error("Decompress fail.");const ep=JSON.parse(dt);if(!Array.isArray(ep))throw new Error("JSON not array.");let uC=0,aC=0,eC=0;for(const p of ep){if(p.name&&typeof p.data==='object'&&p.data!==null&&'data'in p.data&&'size'in p.data&&'ir'in p.data){const sk=`tl_project_${p.name}`,np=JSON.stringify(p.data);const es=safeGetLocalStorage(sk);let epd=null;if(es)try{epd=JSON.parse(es)}catch(e){console.warn(`Parse '${p.name}':`,e)}if(!epd||JSON.stringify(epd)!==np){if(safeSetLocalStorage(sk,np)){if(epd)uC++;else aC++}else eC++}}else{console.warn("Invalid online project:",p);eC++}}loadProjectList();let msg=`Online: Added:${aC}, Updated:${uC}.`;if(eC>0)msg+=` Errors:${eC}.`;showToast(msg,eC>0?'orange':'green');if(projectSelector.value&&activeProjectData){const cn=projectSelector.value,up=ep.find(x=>x.name===cn);if(up&&JSON.stringify(activeProjectData)!==JSON.stringify(up.data)){projectSelector.dispatchEvent(new Event('change'));showToast(`'${cn}' updated. Reloaded.`,'blue')}}}catch(e){showToast(`Update fail: ${e.message}`,'red');console.error("Fetch err:",e)}finally{hideLoader()}}
        async function verifyTlLoginCode(c){if(!c)return false;showLoader();try{const r=await fetch(HARDCODED_TL_CODE_URL);if(!r.ok)throw new Error(`HTTP ${r.status}`);const d=await r.json();return d.code===c}catch(e){showToast(`TL Code fetch err: ${e.message}`,'red');console.error("TL Code err:",e);return false}finally{hideLoader()}}
        
        function updateButtonVisibility() {
            const tlElements = [addProjectButton, document.getElementById('edit-project'), document.getElementById('delete-project'),
                                document.getElementById('copy-all-projects-json'), 
                                generateTlDashboardButton 
                            ];
            const commonElements = [document.getElementById('search-button'), document.getElementById('calculate-all-button'),
                                    document.getElementById('calculate-all-projects-button'), document.getElementById('export-button'), 
                                    viewProjectDataButton,
                                    clearDataButton,      
                                    autoFetchButton       
                                   ];
            
            tlElements.forEach(el => { if (el) el.style.display = isLoggedInAsTL ? 'inline-block' : 'none'; });
            commonElements.forEach(el => { if(el) el.style.display = 'inline-block'; }); 
        }

        // --- Event Listeners ---
        document.getElementById('search-button').addEventListener('click', searchTechID);
        document.getElementById('calculate-all-button').addEventListener('click', calculateAllTechIDs);
        document.getElementById('calculate-all-projects-button').addEventListener('click',()=> {
            const multiplierModalElem = document.getElementById('multiplier-modal');
            if (multiplierModalElem) M.Modal.getInstance(multiplierModalElem).open();
        });
        applyMultiplierButton.addEventListener('click', calculateTotalAcrossAllProjects);
        if(generateTlDashboardButton) generateTlDashboardButton.addEventListener('click', generateTlDashboard);

        projectSelector.addEventListener('change',()=>{const name=projectSelector.value;allResultsDiv.innerHTML='';lastResult='';allCalculatedResults=[];allProjectsAggregatedResults={};if(!name){activeProjectData='';if(isLoggedInAsTL){projectNameInput.value='';rawDataInput.value='';modalSizeSelect.value='3in';modalIrCheck.checked=false;M.FormSelect.init(modalSizeSelect);M.updateTextFields();editingProjectName=null}return}const pds=safeGetLocalStorage(`tl_project_${name}`);if(pds){try{activeProjectData=JSON.parse(pds);activeProjectData.name=name;showToast(`'${name}' loaded.`,'blue');if(isLoggedInAsTL){projectNameInput.value=name;rawDataInput.value=activeProjectData.data;modalSizeSelect.value=activeProjectData.size;modalIrCheck.checked=activeProjectData.ir;M.updateTextFields();M.FormSelect.init(modalSizeSelect);editingProjectName=name}}catch(e){showToast(`Parse '${name}' err.`,'red');console.error("Parse err:",e);activeProjectData=''}}else{showToast(`Load '${name}' fail.`,'red');activeProjectData='';if(isLoggedInAsTL){projectNameInput.value='';rawDataInput.value='';modalSizeSelect.value='3in';modalIrCheck.checked=false;M.FormSelect.init(modalSizeSelect);M.updateTextFields();editingProjectName=null}}});
        document.getElementById('edit-project').addEventListener('click',()=>{const name=projectSelector.value;if(!name){showToast('Select project.','red');return}if(activeProjectData&&activeProjectData.name===name&&isLoggedInAsTL){projectNameInput.value=name;rawDataInput.value=activeProjectData.data;modalSizeSelect.value=activeProjectData.size;modalIrCheck.checked=activeProjectData.ir;M.FormSelect.init(modalSizeSelect);M.updateTextFields();M.textareaAutoResize(rawDataInput);modalTitle.textContent='Edit Project';saveProjectModalButton.textContent='Update Project';editingProjectName=name;M.Modal.getInstance(addProjectModal).open()}else{const pds=safeGetLocalStorage(`tl_project_${name}`);if(pds){try{const p=JSON.parse(pds);projectNameInput.value=name;rawDataInput.value=p.data;modalSizeSelect.value=p.size;modalIrCheck.checked=p.ir;M.FormSelect.init(modalSizeSelect);M.updateTextFields();M.textareaAutoResize(rawDataInput);editingProjectName=name;modalTitle.textContent='Edit Project';saveProjectModalButton.textContent='Update Project';M.Modal.getInstance(addProjectModal).open()}catch(e){showToast(`Load '${name}' for edit fail.`,'red')}}else showToast('Load project for edit fail.','red')}});
        document.getElementById('delete-project').addEventListener('click',deleteSelectedProject);
        addProjectButton.addEventListener('click',()=>{modalTitle.textContent='Add New Project';saveProjectModalButton.textContent='Save Project';projectNameInput.value='';rawDataInput.value='';modalSizeSelect.value='3in';modalIrCheck.checked=false;M.FormSelect.init(modalSizeSelect);M.updateTextFields();M.textareaAutoResize(rawDataInput);editingProjectName=null;M.Modal.getInstance(addProjectModal).open()});
        saveProjectModalButton.addEventListener('click',saveProject);
        clearDataButton.addEventListener('click',async()=>{if(await showCustomConfirm('Clear ALL projects? Cannot undo.','Clear All Data')){const k=[];for(let i=0;i<localStorage.length;i++)if(localStorage.key(i)?.startsWith('tl_project_'))k.push(localStorage.key(i));k.forEach(x=>localStorage.removeItem(x));loadProjectList();activeProjectData='';allResultsDiv.innerHTML='';allCalculatedResults=[];lastResult='';allProjectsAggregatedResults={};projectSelector.value="";M.FormSelect.init(projectSelector);showToast('All projects cleared!','green')}});
        document.getElementById('export-button').addEventListener('click',()=>{if(Object.keys(allProjectsAggregatedResults).length>0)exportToCsv('all_projects.csv',Object.values(allProjectsAggregatedResults));else if(allCalculatedResults.length>0)exportToCsv('project_summary.csv',allCalculatedResults);else if(lastResult&&lastResult._foundRowsCount>0)exportToCsv(`tech_${lastResult.techID}.csv`,lastResult);else showToast('No results to export.','red')});
        document.getElementById('copy-all-projects-json').addEventListener('click',()=>{const all=[];let has=false;for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k?.startsWith('tl_project_')){has=true;const pN=k.replace('tl_project_','');const pS=safeGetLocalStorage(k);if(pS)try{all.push({name:pN,data:JSON.parse(pS)})}catch(e){console.error(`Parse ${k} for copy:`,e)}}}if(!has||all.length===0){showToast('No projects to copy.','orange');return}try{const c=LZString.compressToBase64(JSON.stringify(all));navigator.clipboard.writeText(c).then(()=>showToast('All projects copied (compressed)!','green')).catch(e=>{showToast('Copy fail.','red');console.error('Copy err:',e)})}catch(e){showToast('Compress err.','red');console.error('Compress err:',e)}});
        autoFetchButton.addEventListener('click',autoFetchExternalJson);
        loginRoleSelect.addEventListener('change',()=>{tlCodeInputDiv.style.display=loginRoleSelect.value==='tl'?'block':'none';if(loginRoleSelect.value==='tl')tlLoginCodeInput.setAttribute('required','required');else tlLoginCodeInput.removeAttribute('required');M.updateTextFields()});
        loginButtonElement.addEventListener('click',async()=>{const r=loginRoleSelect.value;showLoader();if(r==='tl'){if(!tlLoginCodeInput.value){showToast('Enter TL Code.','orange');hideLoader();return}if(await verifyTlLoginCode(tlLoginCodeInput.value)){isLoggedInAsTL=true;showToast('Logged in as TL!','green');M.Modal.getInstance(loginModal).close();mainAppContent.style.display='block';loadProjectList();updateButtonVisibility()}else{showToast('Incorrect TL code.','red');isLoggedInAsTL=false}}else if(r==='tech'){isLoggedInAsTL=false;showToast('Logged in as Tech!','green');M.Modal.getInstance(loginModal).close();mainAppContent.style.display='block';loadProjectList();updateButtonVisibility()}else showToast('Select role.','orange');hideLoader()});
        logoutButton.addEventListener('click',()=>{isLoggedInAsTL=false;showToast('Logged out.','blue');mainAppContent.style.display='none';allResultsDiv.innerHTML='';lastResult='';allCalculatedResults=[];allProjectsAggregatedResults={};activeProjectData='';loginRoleSelect.value='';tlLoginCodeInput.value='';tlCodeInputDiv.style.display='none';M.FormSelect.init(loginRoleSelect);M.updateTextFields();M.Modal.getInstance(loginModal).open()});
        if(fullscreenCloseButton)fullscreenCloseButton.addEventListener('click',hideFullscreenModal);
        fullscreenResultsModal.addEventListener('click',e=>{if(e.target===fullscreenResultsModal)hideFullscreenModal()});
        if(viewProjectDataButton)viewProjectDataButton.addEventListener('click',viewProjectData);
        function applyDarkModePreference(){const p=localStorage.getItem('darkMode'),e=p==='enabled';document.body.classList.toggle('dark-mode',e);darkModeToggle.querySelector('i').textContent=e?'brightness_4':'brightness_high';if(p!=='enabled'&&p!=='disabled')localStorage.setItem('darkMode','disabled')}
        darkModeToggle.addEventListener('click',()=>{localStorage.setItem('darkMode',document.body.classList.contains('dark-mode')?'disabled':'enabled');applyDarkModePreference()});
        
        document.addEventListener('DOMContentLoaded',()=>{
            document.body.style.display='none';
            applyDarkModePreference();
            updateFilterVisibilityUI(); // MODIFIED: Set initial filter visibility state

            document.querySelectorAll('.modal').forEach(modalElem => {
                if (modalElem.id !== 'multiplier-modal' && modalElem.id !== 'login-modal' && modalElem.id !== 'confirmation-modal') {
                     M.Modal.init(modalElem, {
                        dismissible: true,
                        onOpenEnd: el => { if (el.id === 'add-project-modal') M.textareaAutoResize(rawDataInput); }
                    });
                }
            });

            const multiplierModalElem = document.getElementById('multiplier-modal');
            if (multiplierModalElem) {
                M.Modal.init(multiplierModalElem, {
                    dismissible: true,
                    onOpenStart: function() {
                        populateProjectFilterSelector();
                        updateFilterVisibilityUI(); // MODIFIED: Update filter visibility on modal open
                    }
                });
            }

            const loginModalInstance = document.getElementById('login-modal');
            if (loginModalInstance) {
                M.Modal.init(loginModalInstance, { dismissible: false });
            }
            
            const confirmationModalInstance = document.getElementById('confirmation-modal');
            if (confirmationModalInstance) {
                 M.Modal.init(confirmationModalInstance, { dismissible: false });
            }

            confirmationConfirmButton.addEventListener('click',()=>{if(confirmPromiseResolve)confirmPromiseResolve(true);confirmPromiseResolve=null; M.Modal.getInstance(confirmationModal).close()});
            confirmationCancelButton.addEventListener('click',()=>{if(confirmPromiseResolve)confirmPromiseResolve(false);confirmPromiseResolve=null; M.Modal.getInstance(confirmationModal).close()});
            
            if (filterSelectAllBtn) {
                filterSelectAllBtn.addEventListener('click', () => {
                    const options = projectFilterSelectorForTotal.options;
                    for (let i = 0; i < options.length; i++) {
                        if (!options[i].disabled) { 
                            options[i].selected = true;
                        }
                    }
                    M.FormSelect.init(projectFilterSelectorForTotal); 
                });
            }

            if (filterDeselectAllBtn) {
                filterDeselectAllBtn.addEventListener('click', () => {
                    const options = projectFilterSelectorForTotal.options;
                    for (let i = 0; i < options.length; i++) {
                        options[i].selected = false; 
                    }
                    M.FormSelect.init(projectFilterSelectorForTotal); 
                });
            }
            
            // MODIFIED: Event listener for toggle filter visibility button
            if (toggleFilterVisibilityBtn && projectFilterWrapper) {
                toggleFilterVisibilityBtn.addEventListener('click', () => {
                    isProjectFilterVisible = !isProjectFilterVisible;
                    updateFilterVisibilityUI();
                });
            }
            // ---

            M.FormSelect.init(document.querySelectorAll('select')); 
            M.updateTextFields();
            document.body.style.display='block';
            
            const lmInstance = M.Modal.getInstance(loginModal);
            if(lmInstance) lmInstance.open();
            else{
                console.error("Login modal instance could not be retrieved for opening.");
                mainAppContent.style.display='block';
                loadProjectList();
                updateButtonVisibility();
            }
        });
    </script>
</body>
</html>
