<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Loan Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 50;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal {
            max-height: 90vh;
            overflow-y: auto;
        }
        .filter-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #receiptModal, #receiptModal * {
                visibility: visible;
            }
            #receiptModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="fixed bottom-4 right-4 z-50">
        <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 shadow-lg bg-white dark:bg-gray-800">
            <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.121-3.536a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 18a1 1 0 011-1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM3.05 13.657a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zm1.414-9.9a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM16 10a1 1 0 01-1-1h-1a1 1 0 110-2h1a1 1 0 011 1zM4 10a1 1 0 01-1-1H2a1 1 0 110-2h1a1 1 0 011 1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
        </button>
    </div>

    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-800">
        <div class="max-w-md w-full bg-white dark:bg-gray-700 p-8 rounded-xl shadow-lg">
            <h2 class="text-center text-3xl font-extrabold text-gray-900 dark:text-white mb-6">
                Sign in to your account
            </h2>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="sr-only">Username</label>
                    <input id="username" name="username" type="text" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white bg-white dark:bg-gray-800 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Username">
                </div>
                <div>
                    <label for="password" class="sr-only">Password</label>
                    <input id="password" name="password" type="password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white bg-white dark:bg-gray-800 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                </div>
                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Sign in
                </button>
            </form>
        </div>
    </div>

    <div id="mainApp" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl hidden">

        <header class="bg-white dark:bg-gray-800 shadow-md rounded-xl p-6 mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Smart Loan Tracker</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage product and money loans with interest calculation.</p>
                </div>
                <div class="flex items-center mt-4 sm:mt-0 flex-wrap gap-2">
                     <button id="howItWorksButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">How It Works</button>
                     <button id="importButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Import CSV</button>
                     <button id="exportButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Export CSV</button>
                     <button id="historyButton" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-md shadow-lg">Loaner History</button>
                    <div class="text-sm text-gray-600 dark:text-gray-300 text-right">
                        <span class="font-semibold">Logged in as:</span>
                        <span id="loggedInUser" class="break-all"></span>
                    </div>
                    <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Logout</button>
                </div>
            </div>
        </header>

        <div id="notificationArea" class="mb-8 space-y-2"></div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-1 space-y-8">
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md">
                    <button id="addNewLoanerButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md shadow-lg">
                        ADD NEW LOAN
                    </button>
                </div>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-center border-b dark:border-gray-700 pb-4 mb-5">
                        <h2 class="text-2xl font-semibold">Summary & Profits</h2>
                         <div id="summaryFilterButtons" class="flex space-x-1 mt-4 sm:mt-0">
                            <button data-filter="weekly" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Weekly</button>
                            <button data-filter="monthly" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Monthly</button>
                            <button data-filter="custom" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Custom</button>
                        </div>
                    </div>
                    <div id="summaryDateRange" class="hidden flex items-center space-x-2 mb-4">
                        <input type="date" id="startDate" class="text-xs p-1 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                        <span>to</span>
                        <input type="date" id="endDate" class="text-xs p-1 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                    </div>
                    <div id="summaryContent" class="space-y-3 text-sm">
                        <div class="flex justify-between"><span>Total Principal Loaned:</span> <span id="totalPrincipal" class="font-medium">₱0.00</span></div>
                        <div class="flex justify-between"><span>Potential Profit (Interest):</span> <span id="totalInterest" class="font-medium text-blue-600">₱0.00</span></div>
                        <div class="flex justify-between"><span>Potential Profit (Penalties):</span> <span id="totalPenalties" class="font-medium text-red-600">₱0.00</span></div>
                        <div class="flex justify-between font-bold border-t dark:border-gray-700 pt-2"><span>Total Potential Profit:</span> <span id="totalProfit" class="text-green-600">₱0.00</span></div>
                        <div class="flex justify-between mt-4"><span>Active Loans:</span> <span id="activeLoans" class="font-medium">0</span></div>
                        <div class="flex justify-between"><span>Completed Loans:</span> <span id="completedLoans" class="font-medium">0</span></div>
                    </div>
                    <div class="mt-6">
                        <canvas id="loanTypeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <div class="border-b dark:border-gray-700 pb-4 mb-5">
                        <div class="flex flex-col sm:flex-row justify-between items-center">
                             <h2 class="text-2xl font-semibold">Loan Records</h2>
                             <div class="mt-4 sm:mt-0">
                                <input type="text" id="searchLoaner" placeholder="Search by name..." class="w-full sm:w-auto px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm dark:bg-gray-700">
                            </div>
                        </div>
                        <div id="filterButtons" class="flex flex-wrap gap-2 mt-4">
                            <button data-filter="all" class="filter-btn active px-3 py-1 rounded-md text-sm">All</button>
                            <button data-filter="active" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Active</button>
                            <button data-filter="overdue" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">With Penalty</button>
                            <button data-filter="paid" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Paid</button>
                            <button data-filter="Product" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Product</button>
                            <button data-filter="E-Loan" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">E-Loan</button>
                            <button data-filter="Long Term E-Loan" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Long Term</button>
                        </div>
                    </div>
                    <div id="loanList" class="space-y-4">
                        <p id="loadingMessage" class="text-center text-gray-500 dark:text-gray-400 py-8">Please log in to see records.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="alertModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-sm m-4">
            <div class="p-6">
                <h3 id="alertTitle" class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Alert</h3>
                <div class="mt-2">
                    <p id="alertMessage" class="text-sm text-gray-500 dark:text-gray-400">Your message here.</p>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="alertOkButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 id="confirmTitle" class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Confirmation</h3>
                        <div class="mt-2">
                            <p id="confirmMessage" class="text-sm text-gray-500 dark:text-gray-400">Are you sure?</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmOkButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    Confirm
                </button>
                <button type="button" id="confirmCancelButton" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="addLoanModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                 <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Add New Loan</h3>
                     <button id="closeAddLoanButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <form id="addLoanForm" class="space-y-4">
                    </form>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl m-4">
            <div class="p-6">
                <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3">
                     <h3 id="historyModalTitle" class="text-2xl font-semibold text-gray-900 dark:text-white">Loaner History</h3>
                     <button id="closeHistoryButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <div id="historyContent" class="mt-4 space-y-4">
                    </div>
            </div>
        </div>
    </div>

    <div id="howItWorksModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl m-4">
            <div class="p-6">
                <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">How It Works: Loan Logic & Calculations</h3>
                     <button id="closeHowItWorksButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <div class="mt-4 space-y-4 text-gray-700 dark:text-gray-300">
                    <div>
                        <h4 class="font-bold text-lg">Loan Types</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>Product:</strong> Defaults to 0% interest. Used for tracking physical items with a monetary value.</li>
                            <li><strong>E-Loan:</strong> Defaults to 20% interest, 1 payment, and weekly frequency. Designed for short-term cash loans.</li>
                            <li><strong>Long Term E-Loan:</strong> Defaults to 20% interest. For cash loans with multiple payments.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Core Calculations</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>Interest:</strong> Calculated as a simple, one-time percentage of the principal: <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">Principal * (Interest Rate / 100)</code>.</li>
                            <li><strong>Installment Amount:</strong> The total amount (Principal + Interest) is divided equally by the number of payments: <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">(Principal + Interest) / Number of Payments</code>.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Penalty System</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li>A penalty of 5% of the original loan amount is applied for <span class="font-bold">each day</span> an installment is overdue.</li>
                            <li><strong>Formula:</strong> <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">(Principal * 0.05) * Days Delayed</code>.</li>
                            <li>The total penalty is the sum of penalties for all overdue, unpaid installments.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Button Functions</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>Mark Paid:</strong> Settles the full installment amount, including any accrued penalties for that specific payment.</li>
                            <li><strong>Pay Interest Only:</strong> This button pays off any accrued penalty for an installment and reschedules it and all subsequent payments. The new due date is calculated from the original due date of the rescheduled payment, not from today.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="csvFileInput" class="hidden" accept=".csv">

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- Environment and Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'product-loan-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { // Fallback configuration
                apiKey: "AIzaSyCg8sobR2ZzIu5pp8PhrQ2st8k7MEe1jTg",
                authDomain: "loan-tracker-e1fc4.firebaseapp.com",
                projectId: "loan-tracker-e1fc4",
                storageBucket: "loan-tracker-e1fc4.firebasestorage.app",
                messagingSenderId: "1032339865550",
                appId: "1:1032339865550:web:6015ff89f037776011759f"
            };

        // Initialize Firebase App and Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let isLoggedIn = false;
        let confirmCallback = null;
        let unsubscribeFromLoans = null;
        let allLoans = [];
        let currentFilter = 'all';
        let loanTypeChart = null;
        
        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        
        // --- Theme Toggling ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
                localStorage.setItem('color-theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
                localStorage.setItem('color-theme', 'light');
            }
        };

        const savedTheme = localStorage.getItem('color-theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            applyTheme(prefersDark ? 'dark' : 'light');
        }

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('color-theme');
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });

        // --- Custom Modals ---
        function showAlert(title, message) {
            const alertTitle = document.getElementById('alertTitle');
            const alertMessage = document.getElementById('alertMessage');
            const alertModal = document.getElementById('alertModal');
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertModal.style.display = 'flex';
        }
        document.getElementById('alertOkButton').addEventListener('click', () => document.getElementById('alertModal').style.display = 'none');

        function showConfirm(title, message, callback) {
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmModal = document.getElementById('confirmModal');
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmCallback = callback;
            confirmModal.style.display = 'flex';
        }
        document.getElementById('confirmOkButton').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        });
        document.getElementById('confirmCancelButton').addEventListener('click', () => {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        });
        
        // --- Authentication (Built-in) ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;

            if (username === 'mae111' && password === '248617') {
                isLoggedIn = true;
                loginForm.reset();
                showMainApp(username);
            } else {
                showAlert('Login Failed', 'Invalid username or password.');
            }
        });

        function initializeMainAppEventListeners() {
            document.getElementById('logoutButton').addEventListener('click', () => {
                isLoggedIn = false;
                if (unsubscribeFromLoans) {
                    unsubscribeFromLoans();
                    unsubscribeFromLoans = null;
                }
                showLoginScreen();
            });
            
            const addLoanForm = document.getElementById('addLoanForm');
            addLoanForm.innerHTML = `
                <div>
                    <label for="modalBorrowerName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Borrower's Name</label>
                    <input type="text" id="modalBorrowerName" name="borrowerName" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="modalLoanType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Type</label>
                    <select id="modalLoanType" name="loanType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="Product">Product</option>
                        <option value="E-Loan">E-Loan</option>
                        <option value="Long Term E-Loan">Long Term E-Loan</option>
                    </select>
                </div>
                <div id="modalProductNameField">
                    <label for="modalProductName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Product Name</label>
                    <input type="text" id="modalProductName" name="productName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="space-y-4">
                        <div>
                        <label for="modalLoanAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Amount (₱)</label>
                        <input type="number" id="modalLoanAmount" name="loanAmount" min="0" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modalInterestRate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Interest Rate (%)</label>
                        <input type="number" id="modalInterestRate" name="interestRate" min="0" step="0.1" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modalNumberOfPayments" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Number of Payments (Gives)</label>
                        <input type="number" id="modalNumberOfPayments" name="numberOfPayments" min="1" step="1" value="1" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                        <div>
                        <label for="modalPaymentFrequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Frequency</label>
                        <select id="modalPaymentFrequency" name="paymentFrequency" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="weekly">Weekly</option>
                            <option value="bi-weekly">Bi-Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="modalLoanDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Date</label>
                    <input type="date" id="modalLoanDate" name="loanDate" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Add Loan Record
                </button>
            `;

            document.getElementById('addNewLoanerButton').addEventListener('click', () => {
                 document.getElementById('addLoanModal').style.display = 'flex';
            });
            document.getElementById('closeAddLoanButton').addEventListener('click', () => {
                 document.getElementById('addLoanModal').style.display = 'none';
            });
            
            document.getElementById('modalLoanType').addEventListener('change', (e) => {
                const interestRateInput = document.getElementById('modalInterestRate');
                const numberOfPaymentsInput = document.getElementById('modalNumberOfPayments');
                const paymentFrequencySelect = document.getElementById('modalPaymentFrequency');
                const productNameField = document.getElementById('modalProductNameField');

                if (e.target.value === 'E-Loan') {
                    productNameField.style.display = 'none';
                    interestRateInput.value = 20;
                    numberOfPaymentsInput.value = 1;
                    paymentFrequencySelect.value = 'weekly';
                } else if (e.target.value === 'Long Term E-Loan') {
                     productNameField.style.display = 'none';
                     interestRateInput.value = 20;
                } else if (e.target.value === 'Product') {
                    productNameField.style.display = 'block';
                    interestRateInput.value = 0;
                }
            });

            document.getElementById('historyButton').addEventListener('click', () => showLoanerHistory(allLoans));
            document.getElementById('closeHistoryButton').addEventListener('click', () => document.getElementById('historyModal').style.display = 'none');
            document.getElementById('howItWorksButton').addEventListener('click', () => document.getElementById('howItWorksModal').style.display = 'flex');
            document.getElementById('closeHowItWorksButton').addEventListener('click', () => document.getElementById('howItWorksModal').style.display = 'none');
            
            document.getElementById('importButton').addEventListener('click', () => document.getElementById('csvFileInput').click());
            document.getElementById('exportButton').addEventListener('click', () => exportToCSV(allLoans));
            document.getElementById('csvFileInput').addEventListener('change', (e) => importFromCSV(e.target.files[0]));

            document.getElementById('searchLoaner').addEventListener('input', () => renderLoanList());

            document.getElementById('filterButtons').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('#filterButtons .filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    e.target.classList.add('active');
                    e.target.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    renderLoanList();
                }
            });

            document.getElementById('summaryFilterButtons').addEventListener('click', (e) => {
                 if (e.target.classList.contains('filter-btn')) {
                    const filter = e.target.dataset.filter;
                    document.querySelectorAll('#summaryFilterButtons .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    if (filter === 'custom') {
                        document.getElementById('summaryDateRange').style.display = 'flex';
                    } else {
                        document.getElementById('summaryDateRange').style.display = 'none';
                        updateSummary(allLoans, filter);
                    }
                }
            });

            [document.getElementById('startDate'), document.getElementById('endDate')].forEach(input => {
                input.addEventListener('change', () => {
                    updateSummary(allLoans, 'custom');
                });
            });
            
            addLoanForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!isLoggedIn) {
                    showAlert('Error', 'You are not logged in.');
                    return;
                }

                const borrowerName = document.getElementById('modalBorrowerName').value.trim();
                const loanType = document.getElementById('modalLoanType').value;
                const loanDate = document.getElementById('modalLoanDate').value;
                const loanAmount = parseFloat(document.getElementById('modalLoanAmount').value);
                const interestRate = parseFloat(document.getElementById('modalInterestRate').value) || 0;
                const numberOfPayments = parseInt(document.getElementById('modalNumberOfPayments').value) || 1;
                const paymentFrequency = document.getElementById('modalPaymentFrequency').value;

                if (isNaN(loanAmount) || loanAmount <= 0) {
                    showAlert('Validation Error', 'Please enter a valid loan amount.');
                    return;
                }
                
                let loanData = {
                    borrowerName,
                    loanType,
                    loanDate,
                    loanAmount,
                    interestRate,
                    numberOfPayments,
                    paymentFrequency,
                    status: 'Active',
                    paidPenalties: 0, 
                    createdAt: serverTimestamp()
                };

                if (loanType === 'Product') {
                    const productName = document.getElementById('modalProductName').value.trim();
                    if (!productName) {
                        showAlert('Validation Error', 'Please enter a product name.');
                        return;
                    }
                    loanData.productName = productName;
                }

                const paymentSchedule = [];
                const totalInterest = loanAmount * (interestRate / 100);
                const installmentAmount = (loanAmount + totalInterest) / numberOfPayments;
                let nextDueDate = new Date(loanDate);

                for(let i = 0; i < numberOfPayments; i++) {
                    if (paymentFrequency === 'weekly') {
                        nextDueDate.setDate(nextDueDate.getDate() + 7);
                    } else if (paymentFrequency === 'bi-weekly') {
                        nextDueDate.setDate(nextDueDate.getDate() + 14);
                    } else { 
                        nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                    }
                    paymentSchedule.push({
                        dueDate: nextDueDate.toISOString().split('T')[0],
                        amount: installmentAmount,
                        status: 'Pending'
                    });
                }
                loanData.paymentSchedule = paymentSchedule;
                loanData.returnDate = paymentSchedule[paymentSchedule.length - 1].dueDate;

                try {
                    await addDoc(collection(db, sharedDataPath), loanData);
                    addLoanForm.reset();
                    document.getElementById('modalLoanType').dispatchEvent(new Event('change'));
                    document.getElementById('addLoanModal').style.display = 'none';
                    showAlert('Success', 'Loan record added successfully!');
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showAlert('Database Error', 'Failed to add loan record. Check Firestore rules and console.');
                }
            });
        }

        function showMainApp(username) {
            document.getElementById('loggedInUser').textContent = username;
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
            initializeMainAppEventListeners();
            loadLoans();
        }

        function showLoginScreen() {
            mainApp.style.display = 'none';
            loginScreen.style.display = 'flex';
            const loanList = document.getElementById('loanList');
            if (loanList) {
                loanList.innerHTML = '<p id="loadingMessage" class="text-center text-gray-500 dark:text-gray-400 py-8">Please log in to see records.</p>';
            }
        }

        // --- Firestore Operations ---
        const sharedDataPath = `artifacts/${appId}/loans`;

        function loadLoans() {
            if (!isLoggedIn) return;
            
            const loadingMsgEl = document.getElementById('loadingMessage');
            if(loadingMsgEl) loadingMsgEl.textContent = 'Loading loan records...';

            const q = query(collection(db, sharedDataPath));

            unsubscribeFromLoans = onSnapshot(q, (querySnapshot) => {
                allLoans = [];
                querySnapshot.forEach(doc => {
                    allLoans.push({ id: doc.id, ...doc.data() });
                });

                allLoans.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                
                renderLoanList();
                updateSummary(allLoans, 'weekly'); // Default summary to weekly
                updateNotifications(allLoans);

            }, (error) => {
                console.error("Error fetching loans: ", error);
                const loadingMessageEl = document.getElementById('loadingMessage');
                if (loadingMessageEl) {
                   loadingMessageEl.textContent = 'Error loading data. Please check console and refresh.';
                }
                showAlert('Data Error', 'Could not fetch loan records from the database.');
            });
        }

        function renderLoanList() {
            const loadingMessageEl = document.getElementById('loadingMessage');
            if (loadingMessageEl) {
                loadingMessageEl.style.display = 'none';
            }

            const loanList = document.getElementById('loanList');
            loanList.innerHTML = '';
            
            const searchTerm = document.getElementById('searchLoaner').value.toLowerCase();
            let filteredLoans = allLoans;

            if (searchTerm) {
                filteredLoans = filteredLoans.filter(loan => 
                    loan.borrowerName.toLowerCase().includes(searchTerm)
                );
            }

            filteredLoans = filteredLoans.filter(loan => {
                if (currentFilter === 'all') return true;

                const currentDate = new Date();
                currentDate.setHours(0, 0, 0, 0);
                const isFullyPaid = loan.status === 'Paid';
                let hasDelayedPayment = false;
                if (loan.paymentSchedule && !isFullyPaid) {
                    hasDelayedPayment = loan.paymentSchedule.some(p => p.status === 'Pending' && new Date(p.dueDate) < currentDate);
                }
                const overallStatus = isFullyPaid ? 'Paid' : hasDelayedPayment ? 'Overdue' : 'Active';

                if (['active', 'overdue', 'paid'].includes(currentFilter)) {
                    return overallStatus.toLowerCase() === currentFilter;
                } else {
                    return loan.loanType === currentFilter;
                }
            });

            if (filteredLoans.length === 0) {
                 loanList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No loans found for the current filters.</p>`;
                 return;
            }

            filteredLoans.forEach(loan => {
                const loanCard = createLoanCard(loan);
                loanList.appendChild(loanCard);
            });
        }
        
        function updateNotifications(loans) {
            const notificationArea = document.getElementById('notificationArea');
            notificationArea.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            let dueTodayCount = 0;
            let dueTomorrowCount = 0;

            loans.forEach(loan => {
                if (loan.status === 'Active' && loan.paymentSchedule) {
                    loan.paymentSchedule.forEach(p => {
                        if (p.status === 'Pending') {
                            if (p.dueDate === todayStr) dueTodayCount++;
                            if (p.dueDate === tomorrowStr) dueTomorrowCount++;
                        }
                    });
                }
            });

            if (dueTodayCount > 0) {
                const notification = document.createElement('div');
                notification.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4';
                notification.innerHTML = `<p class="font-bold">Due Today</p><p>You have ${dueTodayCount} loan payment(s) due today.</p>`;
                notificationArea.appendChild(notification);
            }
            if (dueTomorrowCount > 0) {
                const notification = document.createElement('div');
                notification.className = 'bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4';
                notification.innerHTML = `<p class="font-bold">Due Tomorrow</p><p>You have ${dueTomorrowCount} loan payment(s) due tomorrow.</p>`;
                notificationArea.appendChild(notification);
            }
        }

        function updateSummary(loans, filter) {
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            let filteredForSummary = loans;

            if (filter === 'weekly') {
                const oneWeekAgo = new Date(currentDate);
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                filteredForSummary = loans.filter(l => new Date(l.loanDate) >= oneWeekAgo);
            } else if (filter === 'monthly') {
                const oneMonthAgo = new Date(currentDate);
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                filteredForSummary = loans.filter(l => new Date(l.loanDate) >= oneMonthAgo);
            } else if (filter === 'custom' && document.getElementById('startDate').value && document.getElementById('endDate').value) {
                const start = new Date(document.getElementById('startDate').value);
                const end = new Date(document.getElementById('endDate').value);
                filteredForSummary = loans.filter(l => {
                    const loanDate = new Date(l.loanDate);
                    return loanDate >= start && loanDate <= end;
                });
            }

            let totalPrincipal = 0;
            let totalInterest = 0;
            let totalPenalties = 0;
            let activeLoans = 0;
            let completedLoans = 0;
           
            filteredForSummary.forEach(loan => {
                totalPrincipal += loan.loanAmount;
                const interest = loan.loanAmount * (loan.interestRate / 100);
                totalInterest += interest;

                let currentLoanPenalty = 0;
                if (loan.paymentSchedule && loan.status !== 'Paid') {
                    loan.paymentSchedule.forEach(p => {
                        const dueDate = new Date(p.dueDate);
                        if (p.status === 'Pending' && dueDate < currentDate) {
                            const timeDiff = currentDate.getTime() - dueDate.getTime();
                            const daysDelayed = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            currentLoanPenalty += (loan.loanAmount * 0.05) * daysDelayed;
                        }
                    });
                }
                totalPenalties += currentLoanPenalty;

                if (loan.status === 'Paid') {
                    completedLoans++;
                } else {
                    activeLoans++;
                }
            });

            document.getElementById('totalPrincipal').textContent = `₱${totalPrincipal.toFixed(2)}`;
            document.getElementById('totalInterest').textContent = `₱${totalInterest.toFixed(2)}`;
            document.getElementById('totalPenalties').textContent = `₱${totalPenalties.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `₱${(totalInterest + totalPenalties).toFixed(2)}`;
            document.getElementById('activeLoans').textContent = activeLoans;
            document.getElementById('completedLoans').textContent = completedLoans;
            
            // Update Chart
            const loanTypeCounts = filteredForSummary.reduce((acc, loan) => {
                acc[loan.loanType] = (acc[loan.loanType] || 0) + 1;
                return acc;
            }, {});

            if (loanTypeChart) {
                loanTypeChart.data.labels = Object.keys(loanTypeCounts);
                loanTypeChart.data.datasets[0].data = Object.values(loanTypeCounts);
                loanTypeChart.update();
            } else {
                 const ctx = document.getElementById('loanTypeChart').getContext('2d');
                 loanTypeChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(loanTypeCounts),
                        datasets: [{
                            label: 'Loan Types',
                            data: Object.values(loanTypeCounts),
                            backgroundColor: [
                                'rgba(129, 140, 248, 0.7)', // indigo-400
                                'rgba(59, 130, 246, 0.7)', // blue-500
                                'rgba(16, 185, 129, 0.7)', // green-500
                            ],
                            borderColor: [
                                'rgba(129, 140, 248, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(16, 185, 129, 1)',
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Loan Type Distribution'
                            }
                        }
                    },
                });
            }
        }

        function showLoanerHistory(loans, specificLoaner = null) {
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            const loanerData = {};

            const loansToProcess = specificLoaner ? loans.filter(l => l.borrowerName === specificLoaner) : loans;
            document.getElementById('historyModalTitle').textContent = specificLoaner ? `History for ${specificLoaner}` : 'Loaner History';

            loansToProcess.forEach(loan => {
                const name = loan.borrowerName;
                if (!loanerData[name]) {
                    loanerData[name] = { count: 0, totalBorrowed: 0, outstandingBalance: 0 };
                }
                loanerData[name].count++;
                loanerData[name].totalBorrowed += loan.loanAmount;
                if (loan.status !== 'Paid') {
                    const interest = loan.loanAmount * (loan.interestRate / 100);
                    let penalty = 0;
                     if (loan.paymentSchedule) {
                        loan.paymentSchedule.forEach(p => {
                            const dueDate = new Date(p.dueDate);
                            if (p.status === 'Pending' && dueDate < currentDate) {
                                const timeDiff = currentDate.getTime() - dueDate.getTime();
                                const daysDelayed = Math.ceil(timeDiff / (1000 * 3600 * 24));
                                penalty += (loan.loanAmount * 0.05) * daysDelayed;
                            }
                        });
                    }
                    const paidAmount = loan.paymentSchedule.filter(p => p.status === 'Paid').reduce((acc, p) => acc + p.amount, 0);
                    const remainingBalance = (loan.loanAmount + interest + penalty) - paidAmount;
                    loanerData[name].outstandingBalance += remainingBalance;
                }
            });

            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = '';
             if (Object.keys(loanerData).length === 0) {
                historyContent.innerHTML = '<p>No history found.</p>';
            }
            for (const name in loanerData) {
                const data = loanerData[name];
                const historyCard = document.createElement('div');
                historyCard.className = 'p-4 bg-gray-100 dark:bg-gray-700 rounded-lg';
                historyCard.innerHTML = `
                    <h4 class="font-bold text-lg">${name}</h4>
                    <div class="text-sm grid grid-cols-3 gap-2 mt-2">
                        <span><strong>Total Loans:</strong> ${data.count}</span>
                        <span><strong>Total Borrowed:</strong> ₱${data.totalBorrowed.toFixed(2)}</span>
                        <span class="font-semibold ${data.outstandingBalance > 0 ? 'text-red-600' : 'text-green-600'}"><strong>Outstanding:</strong> ₱${data.outstandingBalance.toFixed(2)}</span>
                    </div>
                `;
                historyContent.appendChild(historyCard);
            }
            document.getElementById('historyModal').style.display = 'flex';
        }

        function createLoanCard(loan) {
            const card = document.createElement('div');
            const isFullyPaid = loan.status === 'Paid';
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0); 

            let totalPenalty = 0;
            let hasDelayedPayment = false;

            if (loan.paymentSchedule && !isFullyPaid) {
                loan.paymentSchedule.forEach(p => {
                    const dueDate = new Date(p.dueDate);
                    if (p.status === 'Pending' && dueDate < currentDate) {
                        hasDelayedPayment = true;
                        const timeDiff = currentDate.getTime() - dueDate.getTime();
                        const daysDelayed = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        totalPenalty += (loan.loanAmount * 0.05) * daysDelayed;
                    }
                });
            }

            const overallStatus = isFullyPaid ? 'Paid' : hasDelayedPayment ? 'Overdue' : 'Active';

            let title, detailsHtml, scheduleHtml = '';
            const cardColor = loan.loanType === 'E-Loan' ? 'bg-blue-50 dark:bg-blue-900/50 border-blue-200 dark:border-blue-800' : (loan.loanType === 'Long Term E-Loan' ? 'bg-teal-50 dark:bg-teal-900/50 border-teal-200 dark:border-teal-800' : 'bg-purple-50 dark:bg-purple-900/50 border-purple-200 dark:border-purple-800');
            const titleColor = isFullyPaid ? 'text-green-800 dark:text-green-300' : (loan.loanType === 'E-Loan' ? 'text-blue-800 dark:text-blue-300' : (loan.loanType === 'Long Term E-Loan' ? 'text-teal-800 dark:text-teal-300' : 'text-purple-800 dark:text-purple-300'));

            const interest = loan.loanAmount * (loan.interestRate / 100);
            const totalDue = loan.loanAmount + interest + totalPenalty;
            
            title = loan.loanType;
            if (loan.loanType === 'Product') {
                title += `: ${loan.productName}`;
            }

            detailsHtml = `
                <p><strong>Principal:</strong> ₱${loan.loanAmount.toFixed(2)}</p>
                <p><strong>Interest (${loan.interestRate}%):</strong> ₱${interest.toFixed(2)}</p>
                ${totalPenalty > 0 ? `<p class="text-red-600"><strong>Penalty:</strong> ₱${totalPenalty.toFixed(2)}</p>` : ''}
                <p class="font-bold"><strong>Total Due:</strong> ₱${totalDue.toFixed(2)}</p>
            `;

            if(loan.paymentSchedule && loan.paymentSchedule.length > 0) {
                scheduleHtml = '<h4 class="font-semibold text-gray-700 dark:text-gray-300 mt-4 mb-2 col-span-full">Payment Schedule</h4>';
                loan.paymentSchedule.forEach((payment, index) => {
                    const isPaymentPaid = payment.status === 'Paid';
                    const dueDate = new Date(payment.dueDate);
                    const isPaymentDelayed = !isPaymentPaid && dueDate < currentDate;
                    
                    let paymentDetailsHtml;
                    let actionButtonsHtml = '';
                    let daysDelayed = 0;

                    if (!isPaymentPaid) {
                         actionButtonsHtml += `<button data-loan-id="${loan.id}" data-payment-index="${index}" class="payment-paid-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded">Mark Paid</button>`;
                         actionButtonsHtml += `<button data-loan-id="${loan.id}" data-payment-index="${index}" data-frequency="${loan.paymentFrequency}" class="reschedule-btn bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded">Pay Interest Only</button>`;
                    } else {
                         actionButtonsHtml = `<span class="text-xs font-bold text-green-700">PAID</span>`;
                    }

                    if (isPaymentDelayed) {
                        const timeDiff = currentDate.getTime() - dueDate.getTime();
                        daysDelayed = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        const installmentPenalty = (loan.loanAmount * 0.05) * daysDelayed;
                        const installmentTotalDue = payment.amount + installmentPenalty;

                        paymentDetailsHtml = `
                            <div class="text-xs mt-1">
                                <span>Amount: ₱${payment.amount.toFixed(2)}</span>
                                <span class="text-red-600 ml-2">Penalty: ₱${installmentPenalty.toFixed(2)}</span>
                                <span class="font-bold ml-2">Total: ₱${installmentTotalDue.toFixed(2)}</span>
                            </div>
                        `;
                    } else {
                         paymentDetailsHtml = `<span class="text-gray-600 dark:text-gray-400">- ₱${payment.amount.toFixed(2)}</span>`;
                    }
                    
                    scheduleHtml += `
                        <div class="col-span-full p-2 rounded-md ${isPaymentPaid ? 'bg-green-100 dark:bg-green-900/50' : (isPaymentDelayed ? 'bg-red-100 dark:bg-red-900/50' : 'bg-gray-100 dark:bg-gray-700')}">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-medium">${index + 1}. Due: ${payment.dueDate}</span>
                                    ${isPaymentDelayed ? `<span class="ml-2 text-xs font-bold text-red-700">DELAYED (${daysDelayed} day/s)</span>` : ''}
                                </div>
                                <div class="flex space-x-2">
                                    ${actionButtonsHtml}
                                </div>
                            </div>
                            ${paymentDetailsHtml}
                        </div>
                    `;
                });
            }

            card.className = `p-4 rounded-lg border transition-all ${isFullyPaid ? 'bg-green-50 dark:bg-green-900/50 border-green-200 dark:border-green-800' : cardColor} shadow-sm`;
            card.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start">
                    <div>
                        <h3 class="font-bold text-lg ${titleColor}">${title}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 flex items-center">
                            Loaned to: <span class="font-medium ml-1">${loan.borrowerName}</span>
                            <svg data-borrower="${loan.borrowerName}" class="loaner-info-btn h-5 w-5 ml-2 text-blue-500 cursor-pointer hover:text-blue-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                        </p>
                    </div>
                    <div class="mt-2 sm:mt-0 sm:text-right">
                        <span class="text-xs font-semibold px-2 py-1 rounded-full ${
                            overallStatus === 'Paid' ? 'bg-green-200 text-green-800' :
                            overallStatus === 'Overdue' ? 'bg-red-200 text-red-800' :
                            'bg-yellow-200 text-yellow-800'
                        }">
                            ${overallStatus}
                        </span>
                    </div>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-3 pt-3 border-t dark:border-gray-700 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                    <div>
                        <p><strong>Loan Date:</strong> ${loan.loanDate}</p>
                        <p><strong>Final Due Date:</strong> ${loan.returnDate}</p>
                    </div>
                    <div class="md:text-right">
                        ${detailsHtml}
                    </div>
                    ${scheduleHtml}
                </div>
                <div class="mt-4 pt-3 border-t dark:border-gray-700 flex justify-end space-x-2">
                    <button data-id="${loan.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-md transition">Delete</button>
                </div>
            `;
            
            // Event listeners
            card.querySelector('.loaner-info-btn').addEventListener('click', (e) => {
                const borrowerName = e.currentTarget.dataset.borrower;
                showLoanerHistory(allLoans, borrowerName);
            });

            card.querySelectorAll('.payment-paid-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const loanId = e.target.dataset.loanId;
                    const paymentIndex = parseInt(e.target.dataset.paymentIndex);
                    showConfirm('Confirm Payment', 'Are you sure you want to mark this payment as paid?', async () => {
                        const updatedSchedule = [...loan.paymentSchedule];
                        updatedSchedule[paymentIndex].status = 'Paid';

                        const allPaid = updatedSchedule.every(p => p.status === 'Paid');
                        const newStatus = allPaid ? 'Paid' : 'Active';

                        const docRef = doc(db, sharedDataPath, loanId);
                        await updateDoc(docRef, { paymentSchedule: updatedSchedule, status: newStatus });
                        showAlert('Success', 'Payment has been marked as paid.');
                    });
                });
            });

            card.querySelectorAll('.reschedule-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const loanId = e.target.dataset.loanId;
                    const paymentIndex = parseInt(e.target.dataset.paymentIndex);
                    const frequency = e.target.dataset.frequency;

                     showConfirm('Pay Interest & Reschedule', 'This will move the due date for this and all future payments. Are you sure?', async () => {
                        const newSchedule = [...loan.paymentSchedule];
                        let nextDueDate = new Date(newSchedule[paymentIndex].dueDate); 

                        for(let i = paymentIndex; i < newSchedule.length; i++) {
                            if (newSchedule[i].status === 'Pending') {
                                if (frequency === 'weekly') {
                                    nextDueDate.setDate(nextDueDate.getDate() + 7);
                                } else if (frequency === 'bi-weekly') {
                                    nextDueDate.setDate(nextDueDate.getDate() + 14);
                                } else { // monthly
                                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                                }
                                newSchedule[i].dueDate = nextDueDate.toISOString().split('T')[0];
                            }
                        }

                        const docRef = doc(db, sharedDataPath, loanId);
                        await updateDoc(docRef, { 
                            paymentSchedule: newSchedule,
                            returnDate: newSchedule[newSchedule.length - 1].dueDate
                        });
                        showAlert('Success', 'Interest has been paid and the schedule has been updated.');
                    });
                });
            });

            const deleteBtn = card.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', () => {
                showConfirm(
                    'Delete Loan Record',
                    'Are you sure you want to delete this record? This action cannot be undone.',
                    async () => {
                        const docRef = doc(db, sharedDataPath, loan.id);
                        await deleteDoc(docRef).catch(err => {
                            console.error("Error deleting document: ", err);
                            showAlert('Database Error', 'Failed to delete loan record.');
                        });
                    }
                );
            });

            return card;
        }

        function exportToCSV(loans) {
            const headers = ['Borrower Name', 'Loan Type', 'Product Name', 'Loan Amount', 'Interest Rate', 'Loan Date', 'Final Due Date', 'Status'];
            const rows = loans.map(loan => {
                const isFullyPaid = loan.status === 'Paid';
                const currentDate = new Date();
                currentDate.setHours(0, 0, 0, 0);
                let hasDelayedPayment = false;
                if (loan.paymentSchedule && !isFullyPaid) {
                    hasDelayedPayment = loan.paymentSchedule.some(p => p.status === 'Pending' && new Date(p.dueDate) < currentDate);
                }
                const overallStatus = isFullyPaid ? 'Paid' : hasDelayedPayment ? 'Overdue' : 'Active';

                return [
                    `"${loan.borrowerName}"`,
                    loan.loanType,
                    loan.productName || '',
                    loan.loanAmount,
                    loan.interestRate,
                    loan.loanDate,
                    loan.returnDate,
                    overallStatus
                ].join(',');
            });

            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "loan_records.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function importFromCSV(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n').slice(1); // Skip header row
                const batch = writeBatch(db);

                rows.forEach(rowStr => {
                    if (!rowStr) return;
                    const columns = rowStr.split(',');
                    // CSV Template: Borrower Name,Loan Type,Product Name,Loan Amount,Interest Rate,Loan Date,Final Due Date,Status
                    const loanData = {
                        borrowerName: columns[0].replace(/"/g, ''),
                        loanType: columns[1],
                        productName: columns[2] || '',
                        loanAmount: parseFloat(columns[3]),
                        interestRate: parseFloat(columns[4]),
                        loanDate: columns[5],
                        returnDate: columns[6],
                        status: 'Active', // Import as active
                        numberOfPayments: 1, // Default values
                        paymentFrequency: 'weekly',
                        createdAt: serverTimestamp()
                    };
                    
                    // Create a basic payment schedule
                    const totalInterest = loanData.loanAmount * (loanData.interestRate / 100);
                    loanData.paymentSchedule = [{
                        dueDate: loanData.returnDate,
                        amount: loanData.loanAmount + totalInterest,
                        status: 'Pending'
                    }];
                    
                    const docRef = doc(collection(db, sharedDataPath));
                    batch.set(docRef, loanData);
                });

                try {
                    await batch.commit();
                    showAlert('Success', 'CSV data imported successfully!');
                } catch (error) {
                    console.error("Error importing CSV: ", error);
                    showAlert('Import Error', 'Failed to import CSV data. Please check the file format and console.');
                }
            };
            reader.readAsText(file);
        }
        
    </script>
</body>
</html>
