<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Loan Management</title>
    
    <script>
        // Set dark mode preference if needed
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 50;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal {
            max-height: 90vh;
            overflow-y: auto;
        }
        .filter-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        @media print {
            body * { visibility: hidden; }
            #receiptModal, #receiptModal * { visibility: visible; }
            #receiptModal { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-800">
        <div class="max-w-md w-full bg-white dark:bg-gray-700 p-8 rounded-xl shadow-lg text-center">
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-2">
                Smart Loan Tracker
            </h2>
            <p class="mb-6 text-gray-600 dark:text-gray-300">Please sign in to continue</p>
            <button id="googleSignInButton" class="w-full inline-flex justify-center items-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 174 58.4l-62.5 62.5C338.3 99.9 294.9 88 248 88c-88.3 0-160 71.7-160 160s71.7 160 160 160c92.6 0 145.5-68.2 149.9-105.5H248V256h239.8c1.3 7.8 2.2 15.6 2.2 23.8z"></path></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl hidden">

        <header class="bg-white dark:bg-gray-800 shadow-md rounded-xl p-6 mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Smart Loan Tracker</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage product and money loans with interest calculation.</p>
                </div>
                <div class="flex items-center mt-4 sm:mt-0 flex-wrap gap-2">
                     <button id="settingsButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Settings</button>
                     <button id="howItWorksButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">How It Works</button>
                     <button id="importButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Import CSV</button>
                     <button id="exportButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Export CSV</button>
                    <div class="text-sm text-gray-600 dark:text-gray-300 text-right">
                        <span class="font-semibold">Logged in as:</span>
                        <span id="loggedInUser" class="break-all"></span>
                    </div>
                    <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Logout</button>
                </div>
            </div>
        </header>

        <div id="notificationArea" class="mb-8 space-y-2"></div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Add Loan & Summary -->
            <div class="lg:col-span-1 space-y-8">
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md">
                    <button id="addNewLoanerButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md shadow-lg">
                        ADD NEW LOAN
                    </button>
                </div>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-center border-b dark:border-gray-700 pb-4 mb-5">
                        <h2 class="text-2xl font-semibold">Summary & Profits</h2>
                         <div id="summaryFilterButtons" class="flex space-x-1 mt-4 sm:mt-0">
                            <button data-filter="weekly" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Weekly</button>
                            <button data-filter="monthly" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Monthly</button>
                            <button data-filter="custom" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Custom</button>
                        </div>
                    </div>
                    <div id="summaryDateRange" class="hidden flex items-center space-x-2 mb-4">
                        <input type="date" id="startDate" class="text-xs p-1 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                        <span>to</span>
                        <input type="date" id="endDate" class="text-xs p-1 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                    </div>
                    <div id="summaryContent" class="space-y-3 text-sm">
                        <div class="flex justify-between"><span>Total Principal Loaned:</span> <span id="totalPrincipal" class="font-medium">₱0.00</span></div>
                        <div class="flex justify-between"><span>Potential Profit (Interest):</span> <span id="totalInterest" class="font-medium text-blue-600">₱0.00</span></div>
                        <div class="flex justify-between"><span>Potential Profit (Penalties):</span> <span id="totalPenalties" class="font-medium text-red-600">₱0.00</span></div>
                        <div class="flex justify-between font-bold border-t dark:border-gray-700 pt-2"><span>Total Potential Profit:</span> <span id="totalProfit" class="text-green-600">₱0.00</span></div>
                        <div class="flex justify-between mt-4"><span>Active Loans:</span> <span id="activeLoans" class="font-medium">0</span></div>
                        <div class="flex justify-between"><span>Completed Loans:</span> <span id="completedLoans" class="font-medium">0</span></div>
                    </div>
                    <div class="mt-6">
                        <canvas id="loanTypeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Column: Loan Records -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <div class="border-b dark:border-gray-700 pb-4 mb-5">
                        <div class="flex flex-col sm:flex-row justify-between items-center">
                             <h2 class="text-2xl font-semibold">Loan Records</h2>
                             <div class="mt-4 sm:mt-0">
                                <input type="text" id="searchLoaner" placeholder="Search by name..." class="w-full sm:w-auto px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm dark:bg-gray-700">
                            </div>
                        </div>
                        <div id="filterButtons" class="flex flex-wrap gap-2 mt-4">
                            <button data-filter="all" class="filter-btn active px-3 py-1 rounded-md text-sm">All</button>
                            <button data-filter="active" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Active</button>
                            <button data-filter="overdue" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">With Penalty</button>
                            <button data-filter="paid" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Paid</button>
                            <button data-filter="Product" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Product</button>
                            <button data-filter="E-Loan" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">E-Loan</button>
                            <button data-filter="Long Term E-Loan" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Long Term</button>
                        </div>
                    </div>
                    <div id="loanList" class="space-y-4">
                        <p id="loadingMessage" class="text-center text-gray-500 dark:text-gray-400 py-8">Please log in to see records.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="alertModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-sm m-4">
            <div class="p-6">
                <h3 id="alertTitle" class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Alert</h3>
                <div class="mt-2"><p id="alertMessage" class="text-sm text-gray-500 dark:text-gray-400">Your message here.</p></div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="alertOkButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">OK</button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 id="confirmTitle" class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Confirmation</h3>
                        <div class="mt-2"><p id="confirmMessage" class="text-sm text-gray-500 dark:text-gray-400">Are you sure?</p></div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmOkButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Confirm</button>
                <button type="button" id="confirmCancelButton" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <div id="addLoanModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                 <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Add New Loan</h3>
                     <button id="closeAddLoanButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <form id="addLoanForm" class="space-y-4"></form>
            </div>
        </div>
    </div>

    <div id="howItWorksModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl m-4">
            <div class="p-6">
                <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">How It Works: Loan Logic & Calculations</h3>
                     <button id="closeHowItWorksButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <div class="mt-4 space-y-4 text-gray-700 dark:text-gray-300">
                    <div>
                        <h4 class="font-bold text-lg">Loan Types</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>Product:</strong> Defaults to 0% interest. Used for tracking physical items with a monetary value.</li>
                            <li><strong>E-Loan:</strong> Defaults to 20% interest, 1 payment, and weekly frequency. Designed for short-term cash loans.</li>
                            <li><strong>Long Term E-Loan:</strong> Defaults to 20% interest. For cash loans with multiple payments.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Core Calculations</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>Interest:</strong> Calculated as a simple, one-time percentage of the principal: <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">Principal * (Interest Rate / 100)</code>.</li>
                            <li><strong>Installment Amount:</strong> The total amount (Principal + Interest) is divided equally by the number of payments: <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">(Principal + Interest) / Number of Payments</code>.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Penalty System</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li>A penalty of 5% of the original loan amount is applied for <span class="font-bold">each day</span> an installment is overdue.</li>
                            <li><strong>Formula:</strong> <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">(Principal * 0.05) * Days Delayed</code>.</li>
                            <li>The total penalty is the sum of penalties for all overdue, unpaid installments.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Button Functions</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>PAID:</strong> Settles the full installment amount, including any accrued penalties for that specific payment.</li>
                            <li><strong>RELOAN:</strong> This button pays off any accrued penalty for an installment and reschedules it and all subsequent payments. The new due date is calculated from the original due date of the rescheduled payment, not from today.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-2xl m-4">
            <div class="p-6">
                 <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Application Settings</h3>
                     <button id="closeSettingsButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white">Authorized Emails</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">These users can access the application.</p>
                        <div id="authorizedEmailsList" class="mt-4 space-y-2">
                            <!-- Authorized emails will be dynamically inserted here -->
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white">Add New Authorized Email</h4>
                        <form id="addEmailForm" class="mt-2 flex gap-2">
                            <input type="email" id="newAuthEmail" placeholder="user@example.com" required class="flex-grow block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Add</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <input type="file" id="csvFileInput" class="hidden" accept=".csv">

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, serverTimestamp, writeBatch, getDoc, setDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- Environment and Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'product-loan-app-dev';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { // Fallback configuration for local development
                apiKey: "AIzaSyCg8sobR2ZzIu5pp8PhrQ2st8k7MEe1jTg",
                authDomain: "loan-tracker-e1fc4.firebaseapp.com",
                projectId: "loan-tracker-e1fc4",
                storageBucket: "loan-tracker-e1fc4.firebasestorage.app",
                messagingSenderId: "1032339865550",
                appId: "1:1032339865550:web:6015ff89f037776011759f"
            };

        // Initialize Firebase App, Auth, and Firestore
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- Global State ---
        let currentUser = null;
        let confirmCallback = null;
        let unsubscribeFromLoans = null;
        let allLoans = [];
        let currentFilter = 'all';
        let loanTypeChart = null;
        const primaryAdmin = 'cristinemae111@gmail.com';
        
        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const googleSignInButton = document.getElementById('googleSignInButton');
        
        // --- Custom Modals ---
        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }
        document.getElementById('alertOkButton').addEventListener('click', () => document.getElementById('alertModal').style.display = 'none');

        function showConfirm(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        document.getElementById('confirmOkButton').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        });
        document.getElementById('confirmCancelButton').addEventListener('click', () => {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        });
        
        // --- Authentication ---
        googleSignInButton.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => {
                console.error("Google Sign-In Error:", error);
                showAlert('Sign-In Failed', `Error: ${error.message}`);
            });
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                checkAuthorization(user);
            } else {
                currentUser = null;
                showLoginScreen();
            }
        });

        async function checkAuthorization(user) {
            const configRef = doc(db, `artifacts/${appId}/config/app_settings`);
            try {
                const configSnap = await getDoc(configRef);
                let authorizedEmails = [primaryAdmin]; // Default with primary admin

                if (configSnap.exists()) {
                    authorizedEmails = configSnap.data().authorizedEmails || [primaryAdmin];
                } else {
                    // If config doesn't exist, create it with the primary admin
                    await setDoc(configRef, { authorizedEmails: [primaryAdmin] });
                }

                if (authorizedEmails.includes(user.email)) {
                    currentUser = user;
                    showMainApp(user);
                } else {
                    showAlert('Access Denied', 'Your email is not authorized to access this application.');
                    signOut(auth);
                }
            } catch (error) {
                console.error("Error checking authorization:", error);
                showAlert('Authorization Error', 'Could not verify your access rights. Please try again.');
                signOut(auth);
            }
        }

        function initializeMainAppEventListeners() {
            document.getElementById('logoutButton').addEventListener('click', () => {
                if (unsubscribeFromLoans) unsubscribeFromLoans();
                signOut(auth);
            });
            
            // --- Settings Modal Logic ---
            document.getElementById('settingsButton').addEventListener('click', openSettingsModal);
            document.getElementById('closeSettingsButton').addEventListener('click', () => document.getElementById('settingsModal').style.display = 'none');
            document.getElementById('addEmailForm').addEventListener('submit', handleAddAuthorizedEmail);

            // The rest of the event listeners for the main app
            const addLoanForm = document.getElementById('addLoanForm');
            addLoanForm.innerHTML = `
                <div>
                    <label for="modalBorrowerName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Borrower's Name</label>
                    <input type="text" id="modalBorrowerName" name="borrowerName" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="modalLoanType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Type</label>
                    <select id="modalLoanType" name="loanType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="Product">Product</option>
                        <option value="E-Loan">E-Loan</option>
                        <option value="Long Term E-Loan">Long Term E-Loan</option>
                    </select>
                </div>
                <div id="modalProductNameField">
                    <label for="modalProductName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Product Name</label>
                    <input type="text" id="modalProductName" name="productName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="modalLoanAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Amount (₱)</label>
                        <input type="number" id="modalLoanAmount" name="loanAmount" min="0" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modalInterestRate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Interest Rate (%)</label>
                        <input type="number" id="modalInterestRate" name="interestRate" min="0" step="0.1" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modalNumberOfPayments" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Number of Payments (Gives)</label>
                        <input type="number" id="modalNumberOfPayments" name="numberOfPayments" min="1" step="1" value="1" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modalPaymentFrequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Frequency</label>
                        <select id="modalPaymentFrequency" name="paymentFrequency" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="weekly">Weekly</option>
                            <option value="bi-weekly">Bi-Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="modalLoanDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Date</label>
                    <input type="date" id="modalLoanDate" name="loanDate" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg">Add Loan Record</button>
            `;

            document.getElementById('addNewLoanerButton').addEventListener('click', () => document.getElementById('addLoanModal').style.display = 'flex');
            document.getElementById('closeAddLoanButton').addEventListener('click', () => document.getElementById('addLoanModal').style.display = 'none');
            
            document.getElementById('modalLoanType').addEventListener('change', (e) => {
                const interestRateInput = document.getElementById('modalInterestRate');
                const numberOfPaymentsInput = document.getElementById('modalNumberOfPayments');
                const paymentFrequencySelect = document.getElementById('modalPaymentFrequency');
                const productNameField = document.getElementById('modalProductNameField');

                if (e.target.value === 'E-Loan') {
                    productNameField.style.display = 'none';
                    interestRateInput.value = 20;
                    numberOfPaymentsInput.value = 1;
                    paymentFrequencySelect.value = 'weekly';
                } else if (e.target.value === 'Long Term E-Loan') {
                     productNameField.style.display = 'none';
                     interestRateInput.value = 20;
                } else if (e.target.value === 'Product') {
                    productNameField.style.display = 'block';
                    interestRateInput.value = 0;
                }
            });

            document.getElementById('howItWorksButton').addEventListener('click', () => document.getElementById('howItWorksModal').style.display = 'flex');
            document.getElementById('closeHowItWorksButton').addEventListener('click', () => document.getElementById('howItWorksModal').style.display = 'none');
            
            document.getElementById('importButton').addEventListener('click', () => document.getElementById('csvFileInput').click());
            document.getElementById('exportButton').addEventListener('click', () => exportToCSV(allLoans));
            document.getElementById('csvFileInput').addEventListener('change', (e) => importFromCSV(e.target.files[0]));

            document.getElementById('searchLoaner').addEventListener('input', () => renderLoanList());

            document.getElementById('filterButtons').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('#filterButtons .filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    e.target.classList.add('active', 'bg-indigo-600', 'text-white');
                    e.target.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    renderLoanList();
                }
            });

            document.getElementById('summaryFilterButtons').addEventListener('click', (e) => {
                 if (e.target.classList.contains('filter-btn')) {
                    const filter = e.target.dataset.filter;
                    document.querySelectorAll('#summaryFilterButtons .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    if (filter === 'custom') {
                        document.getElementById('summaryDateRange').style.display = 'flex';
                    } else {
                        document.getElementById('summaryDateRange').style.display = 'none';
                        updateSummary(allLoans, filter);
                    }
                }
            });

            [document.getElementById('startDate'), document.getElementById('endDate')].forEach(input => {
                input.addEventListener('change', () => {
                    updateSummary(allLoans, 'custom');
                });
            });
            
            addLoanForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showAlert('Error', 'You are not logged in.');
                    return;
                }

                const borrowerName = document.getElementById('modalBorrowerName').value.trim();
                const loanType = document.getElementById('modalLoanType').value;
                const loanDate = document.getElementById('modalLoanDate').value;
                const loanAmount = parseFloat(document.getElementById('modalLoanAmount').value);
                const interestRate = parseFloat(document.getElementById('modalInterestRate').value) || 0;
                const numberOfPayments = parseInt(document.getElementById('modalNumberOfPayments').value) || 1;
                const paymentFrequency = document.getElementById('modalPaymentFrequency').value;

                if (isNaN(loanAmount) || loanAmount <= 0) {
                    showAlert('Validation Error', 'Please enter a valid loan amount.');
                    return;
                }
                
                let loanData = {
                    borrowerName, loanType, loanDate, loanAmount, interestRate, numberOfPayments, paymentFrequency,
                    status: 'Active', paidPenalties: 0, createdAt: serverTimestamp()
                };

                if (loanType === 'Product') {
                    const productName = document.getElementById('modalProductName').value.trim();
                    if (!productName) {
                        showAlert('Validation Error', 'Please enter a product name.');
                        return;
                    }
                    loanData.productName = productName;
                }

                const paymentSchedule = [];
                const totalInterest = loanAmount * (interestRate / 100);
                const installmentAmount = (loanAmount + totalInterest) / numberOfPayments;
                let nextDueDate = new Date(loanDate);

                for(let i = 0; i < numberOfPayments; i++) {
                    if (paymentFrequency === 'weekly') nextDueDate.setDate(nextDueDate.getDate() + 7);
                    else if (paymentFrequency === 'bi-weekly') nextDueDate.setDate(nextDueDate.getDate() + 14);
                    else nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                    
                    paymentSchedule.push({
                        dueDate: nextDueDate.toISOString().split('T')[0],
                        amount: installmentAmount,
                        status: 'Pending'
                    });
                }
                loanData.paymentSchedule = paymentSchedule;
                loanData.returnDate = paymentSchedule[paymentSchedule.length - 1].dueDate;

                try {
                    await addDoc(collection(db, `artifacts/${appId}/loans`), loanData);
                    addLoanForm.reset();
                    document.getElementById('modalLoanType').dispatchEvent(new Event('change'));
                    document.getElementById('addLoanModal').style.display = 'none';
                    showAlert('Success', 'Loan record added successfully!');
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showAlert('Database Error', 'Failed to add loan record. Check Firestore rules and console.');
                }
            });
        }

        function showMainApp(user) {
            document.getElementById('loggedInUser').textContent = user.email;
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
            initializeMainAppEventListeners();
            loadLoans();
        }

        function showLoginScreen() {
            mainApp.style.display = 'none';
            loginScreen.style.display = 'flex';
            const loanList = document.getElementById('loanList');
            if (loanList) {
                loanList.innerHTML = '<p id="loadingMessage" class="text-center text-gray-500 dark:text-gray-400 py-8">Please log in to see records.</p>';
            }
        }

        // --- Firestore Operations ---
        function loadLoans() {
            if (!currentUser) return;
            
            const loadingMsgEl = document.getElementById('loadingMessage');
            if(loadingMsgEl) loadingMsgEl.textContent = 'Loading loan records...';

            const q = query(collection(db, `artifacts/${appId}/loans`));

            unsubscribeFromLoans = onSnapshot(q, (querySnapshot) => {
                allLoans = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allLoans.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                
                renderLoanList();
                updateSummary(allLoans, 'weekly'); // Default summary to weekly
                updateNotifications(allLoans);

            }, (error) => {
                console.error("Error fetching loans: ", error);
                if (loadingMsgEl) loadingMsgEl.textContent = 'Error loading data. Please check console and refresh.';
                showAlert('Data Error', 'Could not fetch loan records from the database.');
            });
        }
        
        // --- Settings Management ---
        async function openSettingsModal() {
            const configRef = doc(db, `artifacts/${appId}/config/app_settings`);
            const listEl = document.getElementById('authorizedEmailsList');
            listEl.innerHTML = '<p>Loading...</p>';
            document.getElementById('settingsModal').style.display = 'flex';

            try {
                const configSnap = await getDoc(configRef);
                if (configSnap.exists()) {
                    const emails = configSnap.data().authorizedEmails || [];
                    renderAuthorizedEmails(emails);
                } else {
                    listEl.innerHTML = '<p>No authorized emails found.</p>';
                }
            } catch(e) {
                console.error(e);
                listEl.innerHTML = '<p class="text-red-500">Error loading emails.</p>';
            }
        }

        function renderAuthorizedEmails(emails) {
            const listEl = document.getElementById('authorizedEmailsList');
            listEl.innerHTML = '';
            emails.forEach(email => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                item.innerHTML = `<span class="text-sm">${email}</span>`;

                if (email !== primaryAdmin) {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Remove';
                    deleteButton.className = 'text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600';
                    deleteButton.onclick = () => handleDeleteAuthorizedEmail(email);
                    item.appendChild(deleteButton);
                } else {
                     item.innerHTML += `<span class="text-xs font-semibold text-indigo-600 dark:text-indigo-400">ADMIN</span>`;
                }
                listEl.appendChild(item);
            });
        }

        async function handleAddAuthorizedEmail(e) {
            e.preventDefault();
            const input = document.getElementById('newAuthEmail');
            const email = input.value.trim();
            if (!email) return;

            const configRef = doc(db, `artifacts/${appId}/config/app_settings`);
            try {
                await updateDoc(configRef, {
                    authorizedEmails: arrayUnion(email)
                });
                showAlert('Success', `${email} has been added.`);
                input.value = '';
                openSettingsModal(); // Refresh list
            } catch (error) {
                console.error("Error adding email:", error);
                showAlert('Error', 'Could not add email.');
            }
        }

        async function handleDeleteAuthorizedEmail(email) {
            showConfirm('Confirm Deletion', `Are you sure you want to remove ${email}?`, async () => {
                const configRef = doc(db, `artifacts/${appId}/config/app_settings`);
                try {
                    await updateDoc(configRef, {
                        authorizedEmails: arrayRemove(email)
                    });
                    showAlert('Success', `${email} has been removed.`);
                    openSettingsModal(); // Refresh list
                } catch (error) {
                    console.error("Error removing email:", error);
                    showAlert('Error', 'Could not remove email.');
                }
            });
        }

        // --- UI Rendering (Loan List, Summary, etc.) ---
        // NOTE: The rest of the functions (renderLoanList, createLoanCard, updateSummary, etc.)
        // remain largely the same as in your original file. They are included here for completeness.
        // No major logic changes were needed in these functions.

        function renderLoanList() {
            const loadingMessageEl = document.getElementById('loadingMessage');
            if (loadingMessageEl) loadingMessageEl.style.display = 'none';

            const loanList = document.getElementById('loanList');
            loanList.innerHTML = '';
            
            const searchTerm = document.getElementById('searchLoaner').value.toLowerCase();
            let filteredLoans = allLoans;

            if (searchTerm) {
                filteredLoans = filteredLoans.filter(loan => loan.borrowerName.toLowerCase().includes(searchTerm));
            }

            filteredLoans = filteredLoans.filter(loan => {
                if (currentFilter === 'all') return true;
                const isFullyPaid = loan.status === 'Paid';
                let overallStatus = isFullyPaid ? 'Paid' : 'Active';
                if (loan.paymentSchedule && !isFullyPaid) {
                    const hasOverdue = loan.paymentSchedule.some(p => p.status === 'Pending' && new Date(p.dueDate) < new Date());
                    if(hasOverdue) overallStatus = 'Overdue';
                }
                
                if (['active', 'overdue', 'paid'].includes(currentFilter)) {
                    return overallStatus.toLowerCase() === currentFilter;
                }
                return loan.loanType === currentFilter;
            });

            if (filteredLoans.length === 0) {
                 loanList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No loans found for the current filters.</p>`;
                 return;
            }

            filteredLoans.forEach(loan => {
                const loanCard = createLoanCard(loan);
                loanList.appendChild(loanCard);
            });
        }
        
        function updateNotifications(loans) {
            const notificationArea = document.getElementById('notificationArea');
            notificationArea.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            let dueTodayCount = 0;
            let dueTomorrowCount = 0;

            loans.forEach(loan => {
                if (loan.status === 'Active' && loan.paymentSchedule) {
                    loan.paymentSchedule.forEach(p => {
                        if (p.status === 'Pending') {
                            if (p.dueDate === todayStr) dueTodayCount++;
                            if (p.dueDate === tomorrowStr) dueTomorrowCount++;
                        }
                    });
                }
            });

            if (dueTodayCount > 0) {
                const notification = document.createElement('div');
                notification.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md';
                notification.innerHTML = `<p class="font-bold">Due Today</p><p>You have ${dueTodayCount} loan payment(s) due today.</p>`;
                notificationArea.appendChild(notification);
            }
            if (dueTomorrowCount > 0) {
                const notification = document.createElement('div');
                notification.className = 'bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md';
                notification.innerHTML = `<p class="font-bold">Due Tomorrow</p><p>You have ${dueTomorrowCount} loan payment(s) due tomorrow.</p>`;
                notificationArea.appendChild(notification);
            }
        }

        function updateSummary(loans, filter) {
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            let filteredForSummary = loans;

            if (filter === 'weekly') {
                const oneWeekAgo = new Date(currentDate);
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                filteredForSummary = loans.filter(l => new Date(l.loanDate) >= oneWeekAgo);
            } else if (filter === 'monthly') {
                const oneMonthAgo = new Date(currentDate);
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                filteredForSummary = loans.filter(l => new Date(l.loanDate) >= oneMonthAgo);
            } else if (filter === 'custom' && document.getElementById('startDate').value && document.getElementById('endDate').value) {
                const start = new Date(document.getElementById('startDate').value);
                const end = new Date(document.getElementById('endDate').value);
                filteredForSummary = loans.filter(l => {
                    const loanDate = new Date(l.loanDate);
                    return loanDate >= start && loanDate <= end;
                });
            }

            let totalPrincipal = 0, totalInterest = 0, totalPenalties = 0, activeLoans = 0, completedLoans = 0;
           
            filteredForSummary.forEach(loan => {
                totalPrincipal += loan.loanAmount;
                const interest = loan.loanAmount * (loan.interestRate / 100);
                totalInterest += interest;

                let currentLoanPenalty = 0;
                if (loan.paymentSchedule && loan.status !== 'Paid') {
                    loan.paymentSchedule.forEach(p => {
                        const dueDate = new Date(p.dueDate);
                        if (p.status === 'Pending' && dueDate < currentDate) {
                            const timeDiff = currentDate.getTime() - dueDate.getTime();
                            const daysDelayed = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            currentLoanPenalty += (loan.loanAmount * 0.05) * daysDelayed;
                        }
                    });
                }
                totalPenalties += currentLoanPenalty;

                if (loan.status === 'Paid') completedLoans++;
                else activeLoans++;
            });

            document.getElementById('totalPrincipal').textContent = `₱${totalPrincipal.toFixed(2)}`;
            document.getElementById('totalInterest').textContent = `₱${totalInterest.toFixed(2)}`;
            document.getElementById('totalPenalties').textContent = `₱${totalPenalties.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `₱${(totalInterest + totalPenalties).toFixed(2)}`;
            document.getElementById('activeLoans').textContent = activeLoans;
            document.getElementById('completedLoans').textContent = completedLoans;
            
            const loanTypeCounts = filteredForSummary.reduce((acc, loan) => {
                acc[loan.loanType] = (acc[loan.loanType] || 0) + 1;
                return acc;
            }, {});

            if (loanTypeChart) {
                loanTypeChart.data.labels = Object.keys(loanTypeCounts);
                loanTypeChart.data.datasets[0].data = Object.values(loanTypeCounts);
                loanTypeChart.update();
            } else {
                 const ctx = document.getElementById('loanTypeChart').getContext('2d');
                 loanTypeChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(loanTypeCounts),
                        datasets: [{
                            label: 'Loan Types',
                            data: Object.values(loanTypeCounts),
                            backgroundColor: ['rgba(129, 140, 248, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)'],
                            borderColor: ['rgba(129, 140, 248, 1)', 'rgba(59, 130, 246, 1)', 'rgba(16, 185, 129, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Loan Type Distribution' } } },
                });
            }
        }
        
        function createLoanCard(loan) {
            const card = document.createElement('div');
            const isFullyPaid = loan.status === 'Paid';
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0); 

            let totalPenalty = 0;
            let hasDelayedPayment = false;

            if (loan.paymentSchedule && !isFullyPaid) {
                loan.paymentSchedule.forEach(p => {
                    const dueDate = new Date(p.dueDate);
                    if (p.status === 'Pending' && dueDate < currentDate) {
                        hasDelayedPayment = true;
                        const timeDiff = currentDate.getTime() - dueDate.getTime();
                        const daysDelayed = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                        totalPenalty += (loan.loanAmount * 0.05) * daysDelayed;
                    }
                });
            }

            const overallStatus = isFullyPaid ? 'Paid' : hasDelayedPayment ? 'Overdue' : 'Active';
            const cardColor = loan.loanType === 'E-Loan' ? 'bg-blue-50 dark:bg-blue-900/50 border-blue-200 dark:border-blue-800' : (loan.loanType === 'Long Term E-Loan' ? 'bg-teal-50 dark:bg-teal-900/50 border-teal-200 dark:border-teal-800' : 'bg-purple-50 dark:bg-purple-900/50 border-purple-200 dark:border-purple-800');
            const titleColor = isFullyPaid ? 'text-green-800 dark:text-green-300' : (loan.loanType === 'E-Loan' ? 'text-blue-800 dark:text-blue-300' : (loan.loanType === 'Long Term E-Loan' ? 'text-teal-800 dark:text-teal-300' : 'text-purple-800 dark:text-purple-300'));

            const interest = loan.loanAmount * (loan.interestRate / 100);
            const totalDue = loan.loanAmount + interest + totalPenalty;
            const title = loan.loanType === 'Product' ? `Product: ${loan.productName}` : loan.loanType;

            let scheduleHtml = '';
            if(loan.paymentSchedule?.length > 0) {
                scheduleHtml = '<h4 class="font-semibold text-gray-700 dark:text-gray-300 mt-4 mb-2 col-span-full">Payment Schedule</h4>';
                loan.paymentSchedule.forEach((payment, index) => {
                    const isPaymentPaid = payment.status === 'Paid';
                    const dueDate = new Date(payment.dueDate);
                    const isPaymentDelayed = !isPaymentPaid && dueDate < currentDate;
                    
                    let paymentDetailsHtml;
                    let actionButtonsHtml = '';
                    let daysDelayed = 0;

                    if (!isPaymentPaid) {
                         actionButtonsHtml = `<button data-loan-id="${loan.id}" data-payment-index="${index}" class="payment-paid-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded">PAID</button>
                                              <button data-loan-id="${loan.id}" data-payment-index="${index}" data-frequency="${loan.paymentFrequency}" class="reschedule-btn bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold py-1 px-2 rounded">RELOAN</button>`;
                    } else {
                         actionButtonsHtml = `<span class="text-xs font-bold text-green-700">PAID</span>`;
                    }

                    if (isPaymentDelayed) {
                        const timeDiff = currentDate.getTime() - dueDate.getTime();
                        daysDelayed = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                        const installmentPenalty = (loan.loanAmount * 0.05) * daysDelayed;
                        const installmentTotalDue = payment.amount + installmentPenalty;
                        paymentDetailsHtml = `<div class="text-xs mt-1"><span>Amount: ₱${payment.amount.toFixed(2)}</span><span class="text-red-600 ml-2">Penalty: ₱${installmentPenalty.toFixed(2)}</span><span class="font-bold ml-2">Total: ₱${installmentTotalDue.toFixed(2)}</span></div>`;
                    } else {
                         paymentDetailsHtml = `<span class="text-gray-600 dark:text-gray-400">- ₱${payment.amount.toFixed(2)}</span>`;
                    }
                    
                    scheduleHtml += `
                        <div class="col-span-full p-2 rounded-md ${isPaymentPaid ? 'bg-green-100 dark:bg-green-900/50' : (isPaymentDelayed ? 'bg-red-100 dark:bg-red-900/50' : 'bg-gray-100 dark:bg-gray-700')}">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-medium">${index + 1}. Due: ${payment.dueDate}</span>
                                    ${isPaymentDelayed ? `<span class="ml-2 text-xs font-bold text-red-700">DELAYED (${daysDelayed} day/s)</span>` : ''}
                                </div>
                                <div class="flex space-x-2">${actionButtonsHtml}</div>
                            </div>
                            ${paymentDetailsHtml}
                        </div>`;
                });
            }

            card.className = `p-4 rounded-lg border transition-all ${isFullyPaid ? 'bg-green-50 dark:bg-green-900/50 border-green-200 dark:border-green-800' : cardColor} shadow-sm`;
            card.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start">
                    <div>
                        <h3 class="font-bold text-lg ${titleColor}">${title}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Loaned to: <span class="font-medium ml-1">${loan.borrowerName}</span></p>
                    </div>
                    <div class="mt-2 sm:mt-0 sm:text-right">
                        <span class="text-xs font-semibold px-2 py-1 rounded-full ${overallStatus === 'Paid' ? 'bg-green-200 text-green-800' : overallStatus === 'Overdue' ? 'bg-red-200 text-red-800' : 'bg-yellow-200 text-yellow-800'}">${overallStatus}</span>
                    </div>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-3 pt-3 border-t dark:border-gray-700 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                    <div>
                        <p><strong>Loan Date:</strong> ${loan.loanDate}</p>
                        <p><strong>Final Due Date:</strong> ${loan.returnDate}</p>
                    </div>
                    <div class="md:text-right">
                        <p><strong>Principal:</strong> ₱${loan.loanAmount.toFixed(2)}</p>
                        <p><strong>Interest (${loan.interestRate}%):</strong> ₱${interest.toFixed(2)}</p>
                        ${totalPenalty > 0 ? `<p class="text-red-600"><strong>Penalty:</strong> ₱${totalPenalty.toFixed(2)}</p>` : ''}
                        <p class="font-bold"><strong>Total Due:</strong> ₱${totalDue.toFixed(2)}</p>
                    </div>
                    ${scheduleHtml}
                </div>
                <div class="mt-4 pt-3 border-t dark:border-gray-700 flex justify-end space-x-2">
                    <button data-id="${loan.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-md transition">Delete</button>
                </div>`;
            
            card.querySelectorAll('.payment-paid-btn').forEach(btn => btn.addEventListener('click', e => {
                const loanId = e.target.dataset.loanId;
                const paymentIndex = parseInt(e.target.dataset.paymentIndex);
                showConfirm('Confirm Payment', 'Mark this payment as paid?', async () => {
                    const updatedSchedule = [...loan.paymentSchedule];
                    updatedSchedule[paymentIndex].status = 'Paid';
                    const allPaid = updatedSchedule.every(p => p.status === 'Paid');
                    await updateDoc(doc(db, `artifacts/${appId}/loans`, loanId), { paymentSchedule: updatedSchedule, status: allPaid ? 'Paid' : 'Active' });
                    showAlert('Success', 'Payment marked as paid.');
                });
            }));

            card.querySelectorAll('.reschedule-btn').forEach(btn => btn.addEventListener('click', e => {
                const { loanId, paymentIndex, frequency } = e.target.dataset;
                showConfirm('Pay Interest & Reschedule', 'Move due date for this and all future payments?', async () => {
                    const newSchedule = [...loan.paymentSchedule];
                    let nextDueDate = new Date(newSchedule[paymentIndex].dueDate); 
                    for(let i = parseInt(paymentIndex); i < newSchedule.length; i++) {
                        if (newSchedule[i].status === 'Pending') {
                            if (frequency === 'weekly') nextDueDate.setDate(nextDueDate.getDate() + 7);
                            else if (frequency === 'bi-weekly') nextDueDate.setDate(nextDueDate.getDate() + 14);
                            else nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                            newSchedule[i].dueDate = nextDueDate.toISOString().split('T')[0];
                        }
                    }
                    await updateDoc(doc(db, `artifacts/${appId}/loans`, loanId), { paymentSchedule: newSchedule, returnDate: newSchedule[newSchedule.length - 1].dueDate });
                    showAlert('Success', 'Schedule updated.');
                });
            }));

            card.querySelector('.delete-btn').addEventListener('click', () => {
                showConfirm('Delete Loan Record', 'This action cannot be undone. Are you sure?', () => deleteDoc(doc(db, `artifacts/${appId}/loans`, loan.id)));
            });

            return card;
        }

        // --- CSV Import/Export ---
        function exportToCSV(loans) {
            const headers = ['Borrower Name', 'Loan Type', 'Product Name', 'Loan Amount', 'Interest Rate', 'Loan Date', 'Final Due Date', 'Status'];
            const rows = loans.map(loan => [ `"${loan.borrowerName}"`, loan.loanType, loan.productName || '', loan.loanAmount, loan.interestRate, loan.loanDate, loan.returnDate, loan.status ].join(','));
            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "loan_records.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function importFromCSV(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const rows = e.target.result.split('\n').slice(1);
                const batch = writeBatch(db);
                rows.forEach(rowStr => {
                    if (!rowStr) return;
                    const cols = rowStr.split(',');
                    const loanData = {
                        borrowerName: cols[0].replace(/"/g, ''), loanType: cols[1], productName: cols[2] || '',
                        loanAmount: parseFloat(cols[3]), interestRate: parseFloat(cols[4]), loanDate: cols[5],
                        returnDate: cols[6], status: 'Active', numberOfPayments: 1, paymentFrequency: 'weekly',
                        createdAt: serverTimestamp()
                    };
                    const totalInterest = loanData.loanAmount * (loanData.interestRate / 100);
                    loanData.paymentSchedule = [{ dueDate: loanData.returnDate, amount: loanData.loanAmount + totalInterest, status: 'Pending' }];
                    batch.set(doc(collection(db, `artifacts/${appId}/loans`)), loanData);
                });
                try {
                    await batch.commit();
                    showAlert('Success', 'CSV data imported successfully!');
                } catch (error) {
                    console.error("Error importing CSV: ", error);
                    showAlert('Import Error', 'Failed to import CSV data.');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
