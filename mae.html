<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart E-Loan Management</title>
    
    <script>
        // Set dark mode preference if needed
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 50;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal {
            max-height: 90vh;
            overflow-y: auto;
        }
        .filter-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        @media print {
            body * { visibility: hidden; }
            #receiptModal, #receiptModal * { visibility: visible; }
            #receiptModal { position: absolute; left: 0; top: 0; width: 100%; }
        }
        .loan-details-card {
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .dark .loan-details-card {
             background-color: rgba(0, 0, 0, 0.2);
             border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-800">
        <div class="max-w-md w-full bg-white dark:bg-gray-700 p-8 rounded-xl shadow-lg text-center">
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-2">
                Smart Loan Tracker
            </h2>
            <p class="mb-6 text-gray-600 dark:text-gray-300">Please sign in to continue</p>
            <button id="googleSignInButton" class="w-full inline-flex justify-center items-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 174 58.4l-62.5 62.5C338.3 99.9 294.9 88 248 88c-88.3 0-160 71.7-160 160s71.7 160 160 160c92.6 0 145.5-68.2 149.9-105.5H248V256h239.8c1.3 7.8 2.2 15.6 2.2 23.8z"></path></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl hidden">

        <header class="bg-white dark:bg-gray-800 shadow-md rounded-xl p-6 mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Smart E-Loan Tracker</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage product and money loans with interest calculation.</p>
                </div>
                <div class="flex items-center mt-4 sm:mt-0 flex-wrap gap-2">
                     <button id="settingsButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Settings</button>
                     <button id="howItWorksButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">How It Works</button>
                     <!-- <button id="importButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Import CSV</button>
                     <button id="exportButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Export CSV</button> -->
                    <div class="text-sm text-gray-600 dark:text-gray-300 text-right">
                        <span class="font-semibold">Logged in as:</span>
                        <span id="loggedInUser" class="break-all"></span>
                    </div>
                    <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-lg">Logout</button>
                </div>
            </div>
        </header>

        <div id="notificationArea" class="mb-8 space-y-2"></div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Add Loan & Summary -->
            <div class="lg:col-span-1 space-y-8">
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md">
                    <button id="addNewLoanerButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md shadow-lg">
                        ADD NEW LOAN
                    </button>
                </div>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-center border-b dark:border-gray-700 pb-4 mb-5">
                        <h2 class="text-2xl font-semibold">Summary & Profits</h2>
                         <div id="summaryFilterButtons" class="flex space-x-1 mt-4 sm:mt-0">
                            <button data-filter="weekly" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Weekly</button>
                            <button data-filter="monthly" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Monthly</button>
                            <button data-filter="custom" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded-md text-xs">Custom</button>
                        </div>
                    </div>
                    <div id="summaryDateRange" class="hidden flex items-center space-x-2 mb-4">
                        <input type="date" id="startDate" class="text-xs p-1 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                        <span>to</span>
                        <input type="date" id="endDate" class="text-xs p-1 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                    </div>
                    <div id="summaryContent" class="space-y-3 text-sm">
                        <div class="flex justify-between"><span>Total Principal Loaned:</span> <span id="totalPrincipal" class="font-medium">₱0.00</span></div>
                        <div class="flex justify-between"><span>Potential Profit (Interest):</span> <span id="totalInterest" class="font-medium text-blue-600">₱0.00</span></div>
                        <div class="flex justify-between"><span>Potential Profit (Penalties):</span> <span id="totalPenalties" class="font-medium text-red-600">₱0.00</span></div>
                        <div class="flex justify-between font-bold border-t dark:border-gray-700 pt-2"><span>Total Potential Profit:</span> <span id="totalProfit" class="text-green-600">₱0.00</span></div>
                        <div class="flex justify-between mt-4"><span>Active Loans:</span> <span id="activeLoans" class="font-medium">0</span></div>
                        <div class="flex justify-between"><span>Completed Loans:</span> <span id="completedLoans" class="font-medium">0</span></div>
                    </div>
                    <div class="mt-6">
                        <canvas id="loanTypeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Column: Loan Records -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <div class="border-b dark:border-gray-700 pb-4 mb-5">
                        <div class="flex flex-col sm:flex-row justify-between items-center">
                             <h2 class="text-2xl font-semibold">Borrower Records</h2>
                             <div class="mt-4 sm:mt-0">
                                <input type="text" id="searchLoaner" placeholder="Search by name..." class="w-full sm:w-auto px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm dark:bg-gray-700">
                            </div>
                        </div>
                        <div id="filterButtons" class="flex flex-wrap gap-2 mt-4">
                            <button data-filter="all" class="filter-btn active px-3 py-1 rounded-md text-sm">All</button>
                            <button data-filter="active" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Active</button>
                            <button data-filter="overdue" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">With Penalty</button>
                            <button data-filter="paid" class="filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-md text-sm">Paid</button>
                        </div>
                    </div>
                    <div id="borrowerList" class="space-y-6">
                        <p id="loadingMessage" class="text-center text-gray-500 dark:text-gray-400 py-8">Please log in to see records.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="alertModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-sm m-4">
            <div class="p-6">
                <h3 id="alertTitle" class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Alert</h3>
                <div class="mt-2"><p id="alertMessage" class="text-sm text-gray-500 dark:text-gray-400">Your message here.</p></div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="alertOkButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">OK</button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 id="confirmTitle" class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Confirmation</h3>
                        <div class="mt-2"><p id="confirmMessage" class="text-sm text-gray-500 dark:text-gray-400">Are you sure?</p></div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmOkButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Confirm</button>
                <button type="button" id="confirmCancelButton" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <div id="addLoanModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4">
            <div class="p-6">
                 <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Add New Loan</h3>
                     <button id="closeAddLoanButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <form id="addLoanForm" class="space-y-4"></form>
            </div>
        </div>
    </div>

    <div id="howItWorksModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl m-4">
            <div class="p-6">
                <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">How It Works: Loan Logic & Calculations</h3>
                     <button id="closeHowItWorksButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <div class="mt-4 space-y-4 text-gray-700 dark:text-gray-300">
                    <div>
                        <h4 class="font-bold text-lg">Loan Types</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>Product:</strong> Defaults to 0% interest. Used for tracking physical items with a monetary value.</li>
                            <li><strong>E-Loan:</strong> Defaults to 20% interest, 1 payment, and weekly frequency. Designed for short-term cash loans.</li>
                            <li><strong>Long Term E-Loan:</strong> Defaults to 20% interest. For cash loans with multiple payments.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Core Calculations</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>Interest:</strong> Calculated as a simple, one-time percentage of the principal: <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">Principal * (Interest Rate / 100)</code>.</li>
                            <li><strong>Installment Amount:</strong> The total amount (Principal + Interest) is divided equally by the number of payments: <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">(Principal + Interest) / Number of Payments</code>.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Penalty System</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li>A penalty of 5% of the original loan amount is applied for <span class="font-bold">each day</span> an installment is overdue.</li>
                            <li><strong>Formula:</strong> <code class="bg-gray-200 dark:bg-gray-700 p-1 rounded">(Principal * 0.05) * Days Delayed</code>.</li>
                            <li>The total penalty is the sum of penalties for all overdue, unpaid installments.</li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-lg">Button Functions</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                            <li><strong>PAID:</strong> Settles the full installment amount, including any accrued penalties for that specific payment.</li>
                            <li><strong>RELOAN:</strong> This button pays off any accrued penalty for an installment and reschedules it and all subsequent payments. The new due date is calculated from the original due date of the rescheduled payment, not from today.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-backdrop">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-2xl m-4">
            <div class="p-6">
                 <div class="flex justify-between items-center border-b dark:border-gray-700 pb-3 mb-5">
                     <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Application Settings</h3>
                     <button id="closeSettingsButton" class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-white">&times;</button>
                </div>
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white">Authorized Emails</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">These users can access the application.</p>
                        <div id="authorizedEmailsList" class="mt-4 space-y-2">
                            <!-- Authorized emails will be dynamically inserted here -->
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white">Add New Authorized Email</h4>
                        <form id="addEmailForm" class="mt-2 flex gap-2">
                            <input type="email" id="newAuthEmail" placeholder="user@example.com" required class="flex-grow block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Add</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <input type="file" id="csvFileInput" class="hidden" accept=".csv">

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, serverTimestamp, writeBatch, getDoc, setDoc, arrayUnion, arrayRemove, where, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- Environment and Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'product-loan-app-dev';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { // Fallback configuration for local development
                apiKey: "AIzaSyCg8sobR2ZzIu5pp8PhrQ2st8k7MEe1jTg",
                authDomain: "loan-tracker-e1fc4.firebaseapp.com",
                projectId: "loan-tracker-e1fc4",
                storageBucket: "loan-tracker-e1fc4.firebasestorage.app",
                messagingSenderId: "1032339865550",
                appId: "1:1032339865550:web:6015ff89f037776011759f"
            };

        // Initialize Firebase App, Auth, and Firestore
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- Global State ---
        let currentUser = null;
        let confirmCallback = null;
        let unsubscribeFromBorrowers = null;
        let allBorrowers = [];
        let currentFilter = 'all';
        let loanTypeChart = null;
        const primaryAdmin = 'cristinemae111@gmail.com';
        
        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const googleSignInButton = document.getElementById('googleSignInButton');
        
        // --- Custom Modals ---
        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }
        document.getElementById('alertOkButton').addEventListener('click', () => document.getElementById('alertModal').style.display = 'none');

        function showConfirm(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        document.getElementById('confirmOkButton').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        });
        document.getElementById('confirmCancelButton').addEventListener('click', () => {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        });
        
        // --- Authentication ---
        googleSignInButton.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => {
                console.error("Google Sign-In Error:", error);
                showAlert('Sign-In Failed', `Error: ${error.message}`);
            });
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                checkAuthorization(user);
            } else {
                currentUser = null;
                showLoginScreen();
            }
        });

        async function checkAuthorization(user) {
            const configRef = doc(db, `artifacts/${appId}/config/app_settings`);
            try {
                let configSnap = await getDoc(configRef);
                if (!configSnap.exists()) {
                    // If config doesn't exist, create it with the primary admin
                    await setDoc(configRef, { authorizedEmails: [primaryAdmin] });
                    configSnap = await getDoc(configRef); // Re-fetch after creation
                }
                
                const authorizedEmails = configSnap.data().authorizedEmails || [];

                if (authorizedEmails.includes(user.email)) {
                    currentUser = user;
                    showMainApp(user);
                } else {
                    showAlert('Access Denied', 'Your email is not authorized to access this application.');
                    signOut(auth);
                }
            } catch (error) {
                console.error("Error checking authorization:", error);
                showAlert('Authorization Error', 'Could not verify your access rights. Please try again.');
                signOut(auth);
            }
        }
        
        // --- App Initialization ---
        function initializeMainAppEventListeners() {
            document.getElementById('logoutButton').addEventListener('click', () => {
                if (unsubscribeFromBorrowers) unsubscribeFromBorrowers();
                signOut(auth);
            });
            
            // --- Settings Modal Logic ---
            document.getElementById('settingsButton').addEventListener('click', openSettingsModal);
            document.getElementById('closeSettingsButton').addEventListener('click', () => document.getElementById('settingsModal').style.display = 'none');
            document.getElementById('addEmailForm').addEventListener('submit', handleAddAuthorizedEmail);

            // The rest of the event listeners for the main app
            const addLoanForm = document.getElementById('addLoanForm');
            addLoanForm.innerHTML = `
                <div>
                    <label for="modalBorrowerName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Borrower's Name</label>
                    <input type="text" id="modalBorrowerName" name="borrowerName" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="modalLoanType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Type</label>
                    <select id="modalLoanType" name="loanType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="Product">Product</option>
                        <option value="E-Loan">E-Loan</option>
                        <option value="Long Term E-Loan">Long Term E-Loan</option>
                    </select>
                </div>
                <div id="modalProductNameField">
                    <label for="modalProductName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Product Name</label>
                    <input type="text" id="modalProductName" name="productName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="modalLoanAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Amount (₱)</label>
                        <input type="number" id="modalLoanAmount" name="loanAmount" min="0" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modalInterestRate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Interest Rate (%)</label>
                        <input type="number" id="modalInterestRate" name="interestRate" min="0" step="0.1" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modalNumberOfPayments" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Number of Payments (Gives)</label>
                        <input type="number" id="modalNumberOfPayments" name="numberOfPayments" min="1" step="1" value="1" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modalPaymentFrequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Frequency</label>
                        <select id="modalPaymentFrequency" name="paymentFrequency" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="weekly">Weekly</option>
                            <option value="bi-weekly">Bi-Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="modalLoanDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan Date</label>
                    <input type="date" id="modalLoanDate" name="loanDate" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg">Add Loan Record</button>
            `;

            document.getElementById('addNewLoanerButton').addEventListener('click', () => document.getElementById('addLoanModal').style.display = 'flex');
            document.getElementById('closeAddLoanButton').addEventListener('click', () => document.getElementById('addLoanModal').style.display = 'none');
            
            document.getElementById('modalLoanType').addEventListener('change', (e) => {
                const interestRateInput = document.getElementById('modalInterestRate');
                const numberOfPaymentsInput = document.getElementById('modalNumberOfPayments');
                const paymentFrequencySelect = document.getElementById('modalPaymentFrequency');
                const productNameField = document.getElementById('modalProductNameField');

                if (e.target.value === 'E-Loan') {
                    productNameField.style.display = 'none';
                    interestRateInput.value = 20;
                    numberOfPaymentsInput.value = 1;
                    paymentFrequencySelect.value = 'weekly';
                } else if (e.target.value === 'Long Term E-Loan') {
                     productNameField.style.display = 'none';
                     interestRateInput.value = 20;
                } else if (e.target.value === 'Product') {
                    productNameField.style.display = 'block';
                    interestRateInput.value = 0;
                }
            });

            document.getElementById('howItWorksButton').addEventListener('click', () => document.getElementById('howItWorksModal').style.display = 'flex');
            document.getElementById('closeHowItWorksButton').addEventListener('click', () => document.getElementById('howItWorksModal').style.display = 'none');
            
            document.getElementById('searchLoaner').addEventListener('input', () => renderBorrowerList());

            document.getElementById('filterButtons').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('#filterButtons .filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    e.target.classList.add('active', 'bg-indigo-600', 'text-white');
                    e.target.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    renderBorrowerList();
                }
            });

            document.getElementById('summaryFilterButtons').addEventListener('click', (e) => {
                 if (e.target.classList.contains('filter-btn')) {
                    const filter = e.target.dataset.filter;
                    document.querySelectorAll('#summaryFilterButtons .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    if (filter === 'custom') {
                        document.getElementById('summaryDateRange').style.display = 'flex';
                    } else {
                        document.getElementById('summaryDateRange').style.display = 'none';
                        updateSummary(allBorrowers, filter);
                    }
                }
            });

            [document.getElementById('startDate'), document.getElementById('endDate')].forEach(input => {
                input.addEventListener('change', () => {
                    updateSummary(allBorrowers, 'custom');
                });
            });
            
            addLoanForm.addEventListener('submit', handleAddLoanSubmit);
        }

        function showMainApp(user) {
            document.getElementById('loggedInUser').textContent = user.email;
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
            initializeMainAppEventListeners();
            loadBorrowers();
        }

        function showLoginScreen() {
            mainApp.style.display = 'none';
            loginScreen.style.display = 'flex';
            const borrowerList = document.getElementById('borrowerList');
            if (borrowerList) {
                borrowerList.innerHTML = '<p id="loadingMessage" class="text-center text-gray-500 dark:text-gray-400 py-8">Please log in to see records.</p>';
            }
        }

        // --- Firestore Paths ---
        const borrowersPath = `artifacts/${appId}/borrowers`;
        const configPath = `artifacts/${appId}/config/app_settings`;

        // --- Firestore Operations ---
        function loadBorrowers() {
            if (!currentUser) return;
            
            const loadingMsgEl = document.getElementById('loadingMessage');
            if(loadingMsgEl) loadingMsgEl.textContent = 'Loading borrower records...';

            const q = query(collection(db, borrowersPath));

            unsubscribeFromBorrowers = onSnapshot(q, (querySnapshot) => {
                allBorrowers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allBorrowers.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                
                renderBorrowerList();
                updateSummary(allBorrowers, 'weekly');
                updateNotifications(allBorrowers);

            }, (error) => {
                console.error("Error fetching borrowers: ", error);
                if (loadingMsgEl) loadingMsgEl.textContent = 'Error loading data. Please check console and refresh.';
                showAlert('Data Error', 'Could not fetch records from the database.');
            });
        }
        
        async function handleAddLoanSubmit(e) {
            e.preventDefault();
            if (!currentUser) return showAlert('Error', 'You are not logged in.');

            const borrowerName = document.getElementById('modalBorrowerName').value.trim();
            if (!borrowerName) return showAlert('Validation Error', 'Borrower name is required.');

            // Construct the loan object first
            const loanAmount = parseFloat(document.getElementById('modalLoanAmount').value);
            if (isNaN(loanAmount) || loanAmount <= 0) return showAlert('Validation Error', 'Please enter a valid loan amount.');

            const loanDate = document.getElementById('modalLoanDate').value;
            if (!loanDate) return showAlert('Validation Error', 'Loan date is required.');
            
            const newLoan = {
                loanId: crypto.randomUUID(), // Unique ID for this specific loan
                loanType: document.getElementById('modalLoanType').value,
                loanAmount: loanAmount,
                interestRate: parseFloat(document.getElementById('modalInterestRate').value) || 0,
                numberOfPayments: parseInt(document.getElementById('modalNumberOfPayments').value) || 1,
                paymentFrequency: document.getElementById('modalPaymentFrequency').value,
                loanDate: loanDate,
                status: 'Active',
                paidPenalties: 0
            };

            if (newLoan.loanType === 'Product') {
                const productName = document.getElementById('modalProductName').value.trim();
                if (!productName) return showAlert('Validation Error', 'Please enter a product name.');
                newLoan.productName = productName;
            }

            // Calculate payment schedule
            const paymentSchedule = [];
            const totalInterest = newLoan.loanAmount * (newLoan.interestRate / 100);
            const installmentAmount = (newLoan.loanAmount + totalInterest) / newLoan.numberOfPayments;
            let nextDueDate = new Date(newLoan.loanDate);

            for(let i = 0; i < newLoan.numberOfPayments; i++) {
                if (newLoan.paymentFrequency === 'weekly') nextDueDate.setDate(nextDueDate.getDate() + 7);
                else if (newLoan.paymentFrequency === 'bi-weekly') nextDueDate.setDate(nextDueDate.getDate() + 14);
                else nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                
                paymentSchedule.push({
                    dueDate: nextDueDate.toISOString().split('T')[0],
                    amount: installmentAmount,
                    status: 'Pending'
                });
            }
            newLoan.paymentSchedule = paymentSchedule;
            newLoan.returnDate = paymentSchedule[paymentSchedule.length - 1].dueDate;

            // Check if borrower exists
            const q = query(collection(db, borrowersPath), where("borrowerName", "==", borrowerName));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                // New borrower, create new document
                createNewBorrower(borrowerName, newLoan);
            } else {
                // Existing borrower, confirm action
                const existingBorrowerDoc = querySnapshot.docs[0];
                const msg = `A borrower named '${borrowerName}' already exists. Do you want to add this new loan to their record? \n\nClick 'Confirm' to add to existing record. \nClick 'Cancel' to create a new, separate borrower with the same name.`;
                showConfirm('Existing Borrower Found', msg, () => {
                    // User confirms: Add loan to existing borrower
                    updateExistingBorrower(existingBorrowerDoc.id, newLoan);
                });
                // If user cancels, the confirm modal's cancel button will just close it.
                // We need to handle the "create new" case on cancel.
                confirmCallback = () => updateExistingBorrower(existingBorrowerDoc.id, newLoan);
                document.getElementById('confirmCancelButton').onclick = () => {
                    createNewBorrower(borrowerName, newLoan);
                    document.getElementById('confirmModal').style.display = 'none';
                    // Reset the cancel button's behavior
                    document.getElementById('confirmCancelButton').onclick = () => {
                        document.getElementById('confirmModal').style.display = 'none';
                        confirmCallback = null;
                    };
                };
            }
        }

        async function createNewBorrower(name, loan) {
            try {
                await addDoc(collection(db, borrowersPath), {
                    borrowerName: name,
                    loans: [loan],
                    createdAt: serverTimestamp()
                });
                document.getElementById('addLoanForm').reset();
                document.getElementById('addLoanModal').style.display = 'none';
                showAlert('Success', `New borrower '${name}' created with a new loan record.`);
            } catch (error) {
                console.error("Error creating new borrower: ", error);
                showAlert('Database Error', 'Failed to create new borrower.');
            }
        }

        async function updateExistingBorrower(docId, loan) {
             try {
                const borrowerRef = doc(db, borrowersPath, docId);
                await updateDoc(borrowerRef, {
                    loans: arrayUnion(loan)
                });
                document.getElementById('addLoanForm').reset();
                document.getElementById('addLoanModal').style.display = 'none';
                showAlert('Success', `New loan added to existing borrower.`);
            } catch (error) {
                console.error("Error updating existing borrower: ", error);
                showAlert('Database Error', 'Failed to update borrower record.');
            }
        }
        
        // --- Settings Management ---
        async function openSettingsModal() {
            const listEl = document.getElementById('authorizedEmailsList');
            listEl.innerHTML = '<p>Loading...</p>';
            document.getElementById('settingsModal').style.display = 'flex';

            try {
                const configSnap = await getDoc(doc(db, configPath));
                if (configSnap.exists()) {
                    renderAuthorizedEmails(configSnap.data().authorizedEmails || []);
                } else {
                    listEl.innerHTML = '<p>No authorized emails found.</p>';
                }
            } catch(e) {
                console.error(e);
                listEl.innerHTML = '<p class="text-red-500">Error loading emails.</p>';
            }
        }

        function renderAuthorizedEmails(emails) {
            const listEl = document.getElementById('authorizedEmailsList');
            listEl.innerHTML = '';
            emails.forEach(email => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                item.innerHTML = `<span class="text-sm">${email}</span>`;

                if (email !== primaryAdmin) {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Remove';
                    deleteButton.className = 'text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600';
                    deleteButton.onclick = () => handleDeleteAuthorizedEmail(email);
                    item.appendChild(deleteButton);
                } else {
                     item.innerHTML += `<span class="text-xs font-semibold text-indigo-600 dark:text-indigo-400">ADMIN</span>`;
                }
                listEl.appendChild(item);
            });
        }

        async function handleAddAuthorizedEmail(e) {
            e.preventDefault();
            const input = document.getElementById('newAuthEmail');
            const email = input.value.trim();
            if (!email) return;
            try {
                await updateDoc(doc(db, configPath), { authorizedEmails: arrayUnion(email) });
                showAlert('Success', `${email} has been added.`);
                input.value = '';
                openSettingsModal(); // Refresh list
            } catch (error) {
                console.error("Error adding email:", error);
                showAlert('Error', 'Could not add email.');
            }
        }

        async function handleDeleteAuthorizedEmail(email) {
            showConfirm('Confirm Deletion', `Are you sure you want to remove ${email}?`, async () => {
                try {
                    await updateDoc(doc(db, configPath), { authorizedEmails: arrayRemove(email) });
                    showAlert('Success', `${email} has been removed.`);
                    openSettingsModal(); // Refresh list
                } catch (error) {
                    console.error("Error removing email:", error);
                    showAlert('Error', 'Could not remove email.');
                }
            });
        }

        // --- UI Rendering (Borrower List, Summary, etc.) ---
        function renderBorrowerList() {
            const loadingMessageEl = document.getElementById('loadingMessage');
            if (loadingMessageEl) loadingMessageEl.style.display = 'none';

            const borrowerList = document.getElementById('borrowerList');
            borrowerList.innerHTML = '';
            
            const searchTerm = document.getElementById('searchLoaner').value.toLowerCase();
            let filteredBorrowers = allBorrowers;

            if (searchTerm) {
                filteredBorrowers = filteredBorrowers.filter(b => b.borrowerName.toLowerCase().includes(searchTerm));
            }

            // This filtering logic needs to be more nuanced now.
            // A borrower is shown if ANY of their loans match the filter.
            if (currentFilter !== 'all') {
                 filteredBorrowers = filteredBorrowers.filter(borrower => {
                    return borrower.loans.some(loan => {
                        const isFullyPaid = loan.status === 'Paid';
                        let overallStatus = isFullyPaid ? 'Paid' : 'Active';
                        if (loan.paymentSchedule && !isFullyPaid) {
                            const hasOverdue = loan.paymentSchedule.some(p => p.status === 'Pending' && new Date(p.dueDate) < new Date());
                            if (hasOverdue) overallStatus = 'Overdue';
                        }
                        
                        if (['active', 'overdue', 'paid'].includes(currentFilter)) {
                            return overallStatus.toLowerCase() === currentFilter;
                        }
                        return false; // Should not happen with current filters
                    });
                });
            }


            if (filteredBorrowers.length === 0) {
                 borrowerList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No records found for the current filters.</p>`;
                 return;
            }

            filteredBorrowers.forEach(borrower => {
                const borrowerCard = createBorrowerCard(borrower);
                borrowerList.appendChild(borrowerCard);
            });
        }
        
        function updateNotifications(borrowers) {
            const notificationArea = document.getElementById('notificationArea');
            notificationArea.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            let dueTodayCount = 0;
            let dueTomorrowCount = 0;

            borrowers.forEach(b => {
                b.loans.forEach(loan => {
                     if (loan.status === 'Active' && loan.paymentSchedule) {
                        loan.paymentSchedule.forEach(p => {
                            if (p.status === 'Pending') {
                                if (p.dueDate === todayStr) dueTodayCount++;
                                if (p.dueDate === tomorrowStr) dueTomorrowCount++;
                            }
                        });
                    }
                });
            });

            if (dueTodayCount > 0) {
                const notification = document.createElement('div');
                notification.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md';
                notification.innerHTML = `<p class="font-bold">Due Today</p><p>You have ${dueTodayCount} loan payment(s) due today.</p>`;
                notificationArea.appendChild(notification);
            }
            if (dueTomorrowCount > 0) {
                const notification = document.createElement('div');
                notification.className = 'bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md';
                notification.innerHTML = `<p class="font-bold">Due Tomorrow</p><p>You have ${dueTomorrowCount} loan payment(s) due tomorrow.</p>`;
                notificationArea.appendChild(notification);
            }
        }

        function updateSummary(borrowers, filter) {
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            let totalPrincipal = 0, totalInterest = 0, totalPenalties = 0, activeLoans = 0, completedLoans = 0;
            const loanTypeCounts = {};

            borrowers.forEach(b => {
                b.loans.forEach(loan => {
                    // Date filtering for summary
                    const loanDate = new Date(loan.loanDate);
                    let includeInSummary = false;
                    if (filter === 'weekly') {
                        const oneWeekAgo = new Date(currentDate);
                        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                        if (loanDate >= oneWeekAgo) includeInSummary = true;
                    } else if (filter === 'monthly') {
                        const oneMonthAgo = new Date(currentDate);
                        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                        if (loanDate >= oneMonthAgo) includeInSummary = true;
                    } else if (filter === 'custom' && document.getElementById('startDate').value && document.getElementById('endDate').value) {
                         const start = new Date(document.getElementById('startDate').value);
                         const end = new Date(document.getElementById('endDate').value);
                         if (loanDate >= start && loanDate <= end) includeInSummary = true;
                    } else {
                        // Default to including if no date filter matches
                        includeInSummary = true;
                    }

                    if (includeInSummary) {
                        totalPrincipal += loan.loanAmount;
                        const interest = loan.loanAmount * (loan.interestRate / 100);
                        totalInterest += interest;

                        let currentLoanPenalty = 0;
                        if (loan.paymentSchedule && loan.status !== 'Paid') {
                            loan.paymentSchedule.forEach(p => {
                                const dueDate = new Date(p.dueDate);
                                if (p.status === 'Pending' && dueDate < currentDate) {
                                    const timeDiff = currentDate.getTime() - dueDate.getTime();
                                    const daysDelayed = Math.ceil(timeDiff / (1000 * 3600 * 24));
                                    currentLoanPenalty += (loan.loanAmount * 0.05) * daysDelayed;
                                }
                            });
                        }
                        totalPenalties += currentLoanPenalty;

                        loanTypeCounts[loan.loanType] = (loanTypeCounts[loan.loanType] || 0) + 1;
                    }
                    
                    if (loan.status === 'Paid') completedLoans++;
                    else activeLoans++;
                });
            });

            document.getElementById('totalPrincipal').textContent = `₱${totalPrincipal.toFixed(2)}`;
            document.getElementById('totalInterest').textContent = `₱${totalInterest.toFixed(2)}`;
            document.getElementById('totalPenalties').textContent = `₱${totalPenalties.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `₱${(totalInterest + totalPenalties).toFixed(2)}`;
            document.getElementById('activeLoans').textContent = activeLoans;
            document.getElementById('completedLoans').textContent = completedLoans;
            
            if (loanTypeChart) {
                loanTypeChart.data.labels = Object.keys(loanTypeCounts);
                loanTypeChart.data.datasets[0].data = Object.values(loanTypeCounts);
                loanTypeChart.update();
            } else {
                 const ctx = document.getElementById('loanTypeChart').getContext('2d');
                 loanTypeChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(loanTypeCounts),
                        datasets: [{
                            label: 'Loan Types',
                            data: Object.values(loanTypeCounts),
                            backgroundColor: ['rgba(129, 140, 248, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)'],
                            borderColor: ['rgba(129, 140, 248, 1)', 'rgba(59, 130, 246, 1)', 'rgba(16, 185, 129, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Loan Type Distribution' } } },
                });
            }
        }
        
        function createBorrowerCard(borrower) {
            const card = document.createElement('div');
            card.className = 'p-4 rounded-lg border bg-gray-50 dark:bg-gray-800/50 shadow-md space-y-4';
            
            let loansHtml = '';

            borrower.loans.forEach((loan) => {
                const isFullyPaid = loan.status === 'Paid';
                const currentDate = new Date();
                currentDate.setHours(0, 0, 0, 0); 

                let totalPenalty = 0;
                let hasDelayedPayment = false;

                if (loan.paymentSchedule && !isFullyPaid) {
                    loan.paymentSchedule.forEach(p => {
                        const dueDate = new Date(p.dueDate);
                        if (p.status === 'Pending' && dueDate < currentDate) {
                            hasDelayedPayment = true;
                            const timeDiff = currentDate.getTime() - dueDate.getTime();
                            const daysDelayed = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                            totalPenalty += (loan.loanAmount * 0.05) * daysDelayed;
                        }
                    });
                }
                const overallStatus = isFullyPaid ? 'Paid' : hasDelayedPayment ? 'Overdue' : 'Active';
                const title = loan.loanType === 'Product' ? `Product: ${loan.productName}` : loan.loanType;
                const interest = loan.loanAmount * (loan.interestRate / 100);
                const totalDue = loan.loanAmount + interest + totalPenalty;

                let scheduleHtml = '';
                if(loan.paymentSchedule?.length > 0) {
                    scheduleHtml = '<h4 class="font-semibold text-gray-700 dark:text-gray-300 mt-3 mb-2 col-span-full text-sm">Payment Schedule</h4>';
                    loan.paymentSchedule.forEach((payment, index) => {
                        const isPaymentPaid = payment.status === 'Paid';
                        const dueDate = new Date(payment.dueDate);
                        const isPaymentDelayed = !isPaymentPaid && dueDate < currentDate;
                        
                        let paymentDetailsHtml;
                        let actionButtonsHtml = '';
                        let daysDelayed = 0;

                        if (!isPaymentPaid) {
                            actionButtonsHtml = `<button data-borrower-id="${borrower.id}" data-loan-id="${loan.loanId}" data-payment-index="${index}" class="payment-paid-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded">PAID</button>
                                                <button data-borrower-id="${borrower.id}" data-loan-id="${loan.loanId}" data-payment-index="${index}" data-frequency="${loan.paymentFrequency}" class="reschedule-btn bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold py-1 px-2 rounded">RELOAN</button>`;
                        } else {
                            actionButtonsHtml = `<span class="text-xs font-bold text-green-700">PAID</span>`;
                        }

                        if (isPaymentDelayed) {
                            const timeDiff = currentDate.getTime() - dueDate.getTime();
                            daysDelayed = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));
                            const installmentPenalty = (loan.loanAmount * 0.05) * daysDelayed;
                            const installmentTotalDue = payment.amount + installmentPenalty;
                            paymentDetailsHtml = `<div class="text-xs mt-1"><span>Amount: ₱${payment.amount.toFixed(2)}</span><span class="text-red-600 ml-2">Penalty: ₱${installmentPenalty.toFixed(2)}</span><span class="font-bold ml-2">Total: ₱${installmentTotalDue.toFixed(2)}</span></div>`;
                        } else {
                            paymentDetailsHtml = `<span class="text-gray-600 dark:text-gray-400">- ₱${payment.amount.toFixed(2)}</span>`;
                        }
                        
                        scheduleHtml += `
                            <div class="col-span-full p-2 rounded-md ${isPaymentPaid ? 'bg-green-100 dark:bg-green-900/50' : (isPaymentDelayed ? 'bg-red-100 dark:bg-red-900/50' : 'bg-gray-100 dark:bg-gray-700')}">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-medium text-xs">${index + 1}. Due: ${payment.dueDate}</span>
                                        ${isPaymentDelayed ? `<span class="ml-2 text-xs font-bold text-red-700">DELAYED (${daysDelayed} day/s)</span>` : ''}
                                    </div>
                                    <div class="flex space-x-2">${actionButtonsHtml}</div>
                                </div>
                                ${paymentDetailsHtml}
                            </div>`;
                    });
                }
                
                loansHtml += `
                    <div class="loan-details-card p-3 rounded-lg shadow-inner space-y-2">
                        <div class="flex justify-between items-start">
                             <h4 class="font-bold text-md text-indigo-800 dark:text-indigo-300">${title}</h4>
                             <span class="text-xs font-semibold px-2 py-1 rounded-full ${overallStatus === 'Paid' ? 'bg-green-200 text-green-800' : overallStatus === 'Overdue' ? 'bg-red-200 text-red-800' : 'bg-yellow-200 text-yellow-800'}">${overallStatus}</span>
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 pt-2 border-t dark:border-gray-700/50 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 items-start">
                            <div>
                                <p><strong>Loan Date:</strong> ${loan.loanDate}</p>
                                <p><strong>Final Due:</strong> ${loan.returnDate}</p>
                            </div>
                            <div class="md:text-right">
                                <p><strong>Principal:</strong> ₱${loan.loanAmount.toFixed(2)}</p>
                                <p><strong>Interest:</strong> ₱${interest.toFixed(2)}</p>
                                ${totalPenalty > 0 ? `<p class="text-red-600"><strong>Penalty:</strong> ₱${totalPenalty.toFixed(2)}</p>` : ''}
                                <p class="font-bold"><strong>Total Due:</strong> ₱${totalDue.toFixed(2)}</p>
                            </div>
                            <div class="col-span-full space-y-1">${scheduleHtml}</div>
                        </div>
                        <div class="mt-3 pt-2 border-t dark:border-gray-700/50 flex justify-end space-x-2">
                            <button data-borrower-id="${borrower.id}" data-loan-id="${loan.loanId}" class="delete-loan-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-md transition">Delete Loan</button>
                        </div>
                    </div>
                `;
            });

            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-xl text-gray-900 dark:text-white">${borrower.borrowerName}</h3>
                    <button data-borrower-id="${borrower.id}" class="delete-borrower-btn bg-gray-200 dark:bg-gray-700 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-700 dark:text-red-300 text-xs font-bold py-1 px-3 rounded-md transition">Delete All Records for this Borrower</button>
                </div>
                <div class="space-y-3">${loansHtml}</div>
            `;
            
            // --- Event Listeners for buttons inside the card ---
            card.querySelectorAll('.payment-paid-btn').forEach(btn => btn.addEventListener('click', async e => {
                const { borrowerId, loanId, paymentIndex } = e.target.dataset;
                const borrowerDoc = allBorrowers.find(b => b.id === borrowerId);
                const loanIndex = borrowerDoc.loans.findIndex(l => l.loanId === loanId);
                const updatedLoans = [...borrowerDoc.loans];
                
                updatedLoans[loanIndex].paymentSchedule[paymentIndex].status = 'Paid';
                const allPaid = updatedLoans[loanIndex].paymentSchedule.every(p => p.status === 'Paid');
                if (allPaid) {
                    updatedLoans[loanIndex].status = 'Paid';
                }
                await updateDoc(doc(db, borrowersPath, borrowerId), { loans: updatedLoans });
                showAlert('Success', 'Payment marked as paid.');
            }));

            card.querySelectorAll('.reschedule-btn').forEach(btn => btn.addEventListener('click', async e => {
                const { borrowerId, loanId, paymentIndex, frequency } = e.target.dataset;
                 const borrowerDoc = allBorrowers.find(b => b.id === borrowerId);
                const loanIndex = borrowerDoc.loans.findIndex(l => l.loanId === loanId);
                const updatedLoans = [...borrowerDoc.loans];
                const targetLoan = updatedLoans[loanIndex];
                
                let nextDueDate = new Date(targetLoan.paymentSchedule[paymentIndex].dueDate); 
                for(let i = parseInt(paymentIndex); i < targetLoan.paymentSchedule.length; i++) {
                    if (targetLoan.paymentSchedule[i].status === 'Pending') {
                        if (frequency === 'weekly') nextDueDate.setDate(nextDueDate.getDate() + 7);
                        else if (frequency === 'bi-weekly') nextDueDate.setDate(nextDueDate.getDate() + 14);
                        else nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                        targetLoan.paymentSchedule[i].dueDate = nextDueDate.toISOString().split('T')[0];
                    }
                }
                targetLoan.returnDate = targetLoan.paymentSchedule[targetLoan.paymentSchedule.length - 1].dueDate;
                
                await updateDoc(doc(db, borrowersPath, borrowerId), { loans: updatedLoans });
                showAlert('Success', 'Schedule updated.');
            }));

            card.querySelectorAll('.delete-loan-btn').forEach(btn => btn.addEventListener('click', e => {
                const { borrowerId, loanId } = e.target.dataset;
                 showConfirm('Delete Loan', 'Are you sure you want to delete this specific loan record?', async () => {
                    const borrowerDoc = allBorrowers.find(b => b.id === borrowerId);
                    const updatedLoans = borrowerDoc.loans.filter(l => l.loanId !== loanId);
                    if (updatedLoans.length === 0) {
                        // If no loans left, delete the whole borrower doc
                        await deleteDoc(doc(db, borrowersPath, borrowerId));
                    } else {
                        await updateDoc(doc(db, borrowersPath, borrowerId), { loans: updatedLoans });
                    }
                 });
            }));
            
            card.querySelector('.delete-borrower-btn').addEventListener('click', e => {
                const { borrowerId } = e.target.dataset;
                showConfirm('Delete Borrower', 'Are you sure you want to delete this borrower and ALL their loan records? This action cannot be undone.', () => {
                    deleteDoc(doc(db, borrowersPath, borrowerId));
                });
            });

            return card;
        }
    </script>
</body>
</html>
