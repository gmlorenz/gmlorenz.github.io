<!DOCTYPE html>
<html>
<head>
  <title>TL MODE - Fixpoint Search</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      padding: 20px;
    }
    .result {
      background: #f9f9f9;
      padding: 20px;
      margin-top: 20px;
      white-space: pre-wrap;
      border-left: 4px solid #42a5f5;
      font-family: monospace;
    }
   .modal textarea {
    height: 150px;       /* Set a fixed height */
    overflow-y: auto;  /* Add a vertical scrollbar when content overflows */
    resize: none;       /* Optional: Prevent user resizing */
   }
   .modal-content textarea.materialize-textarea { /* If your textarea has the materialize-textarea class */
    height: 150px !important; /* Use !important as a temporary measure to see if it helps */
    overflow-y: auto;
    resize: none;
   }
    /* Add margin to input fields */
    .input-field {
      margin-top: 20px;
      margin-bottom: 10px;
    }

    /* Add margin to buttons */
    .btn {
      margin-top: 15px;
      margin-bottom: 15px;
      margin-right: 10px; /* Add some horizontal spacing between buttons if they appear in a row */
    }

    /* Add margin to the floating action button */
    .right-align {
      margin-bottom: 20px;
    }

    /* Add margin to center-aligned elements */
    .center-align {
      margin-top: 25px;
      margin-bottom: 25px;
    }

    /* Style for the scrollable all results view */
    #all-results {
      max-height: 300px;
      overflow-y: auto;
    }
    #all-results h6 {
      margin-top: 10px;
      margin-bottom: 5px;
    }
    #all-results ul {
      margin-left: 20px;
      margin-bottom: 10px;
    }
    #all-results hr {
      margin-top: 15px;
      margin-bottom: 15px;
      border: 0;
      border-top: 1px solid #ccc;
    }

    /* Add spacing within the modal content */
    .modal-content h5 {
      margin-bottom: 20px;
    }
    .modal-content .input-field {
      margin-top: 15px;
      margin-bottom: 15px;
    }

    /* Add spacing in the modal footer */
    .modal-footer a {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h5 class="center-align">TL MODE EXTRACTOR</h5>
    <div class="right-align" style="margin-top: 10px;">
      <a class="btn-floating btn-large green modal-trigger" href="#add-project-modal">
        <i class="material-icons">add</i>
      </a>
    </div>

    <div class="input-field">
      <select id="project-selector">
        <option value="" disabled selected>Select a saved project</option>
      </select>
      <label for="project-selector">Load Project</label>
    </div>

    <div class="center-align">
      <button class="btn red darken-2" id="delete-project">
        <i class="material-icons left">delete</i>Delete Project
      </button>
    </div>

    <div class="input-field">
      <input id="tech-id" type="text" placeholder="e.g. TECH123">
      <label for="tech-id">Search TECH ID (FIX1_ID)</label>
    </div>

    <div class="center-align">
      <button class="btn blue" id="search-button">
        <i class="material-icons left">search</i>Search
      </button>
      <button class="btn green" id="calculate-all-button">
        <i class="material-icons left">calculate</i>Calculate All
      </button>
    </div>

    <div class="center-align" style="margin-top: 10px;">
      <button class="btn orange" id="export-button">
        <i class="material-icons left">file_download</i>Download CSV
      </button>
    </div>

    <div id="output" class="result z-depth-1"></div>

    <div id="all-results" class="result z-depth-1" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
    </div>

    <div id="add-project-modal" class="modal">
      <div class="modal-content">
        <h5>Add New Project</h5>
        <div class="input-field">
          <input id="project-name" type="text">
          <label for="project-name">Project Name</label>
        </div>
        <div class="input-field">
          <textarea id="raw-data" class="materialize-textarea" placeholder="Paste your fixpoints data here..."></textarea>
          <label for="raw-data">Fixpoints Data</label>
        </div>
        <div class="row">
          <div class="input-field col s6">
            <select id="modal-size">
              <option value="3in">3IN</option>
              <option value="9in">9IN</option>
            </select>
            <label for="modal-size">Project Size</label>
          </div>
          <div class="input-field col s6">
            <label>
              <input type="checkbox" id="modal-ir-check" />
              <span>IR Multiplier</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#!" class="modal-close btn grey">Cancel</a>
        <a href="#!" class="btn green" id="save-project">Save Project</a>
      </div>
    </div>

  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
      let activeProjectData = '';
      let allCalculatedResults = []; // Array to store results from "Calculate All"
      let lastResult = ''; // Still used for single search export

      const prices = [
        { "3in": 2.19, "9in": 0.99 },
        { "3in": 5.86, "9in": 2.08 },
        { "3in": 7.44, "9in": 2.78 },
        { "3in": 2.29, "9in": 1.57 },
        { "3in": 1.55, "9in": 0.60 },
        { "3in": 1.84, "9in": 0.78 },
        { "3in": 1.00, "9in": 1.00 },
        { "3in": 3.74, "9in": 3.74 },
        { "3in": 1.73, "9in": 1.73 }
      ];

      const projectSelector = document.getElementById('project-selector');
      const rawData = document.getElementById('raw-data');
      const projectName = document.getElementById('project-name');
      const techIdInput = document.getElementById('tech-id');
      const output = document.getElementById('output');
      const allResultsDiv = document.getElementById('all-results');

      function loadProjectList() {
        projectSelector.innerHTML = '<option disabled selected>Select a saved project</option>';
        for (let key in localStorage) {
          if (key.startsWith('tl_project_')) {
            const name = key.replace('tl_project_', '');
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            projectSelector.appendChild(option);
          }
        }
        M.FormSelect.init(projectSelector);
      }

      function saveProject() {
        const name = projectName.value.trim();
        const data = rawData.value.trim();
        const size = document.getElementById('modal-size').value;
        const ir = document.getElementById('modal-ir-check').checked;

        if (!name || !data) {
          M.toast({ html: 'Please enter a project name and data.', classes: 'red' });
          return;
        }

        const payload = JSON.stringify({ data, size, ir });
        localStorage.setItem(`tl_project_${name}`, payload);
        M.toast({ html: `Project '${name}' saved!`, classes: 'green' });
        loadProjectList();
        const modalElem = document.querySelector('#add-project-modal');
        const modalInstance = M.Modal.getInstance(modalElem);
        modalInstance.close();
      }

      function deleteSelectedProject() {
        const selected = projectSelector.value;
        if (!selected) {
          M.toast({ html: 'No project selected.', classes: 'red' });
          return;
        }
        if (confirm(`Are you sure you want to delete project '${selected}'?`)) {
          localStorage.removeItem(`tl_project_${selected}`);
          M.toast({ html: `Project '${selected}' deleted.`, classes: 'orange' });
          loadProjectList();
          activeProjectData = '';
          allResultsDiv.innerHTML = '';
          allCalculatedResults = []; // Clear calculated results
        }
      }

      function calculatePointsForTechID(raw, techIDValue, size, ir) {
    const rows = raw.split(/\r?\n/).filter(r => r.trim() !== "");
    const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim().toUpperCase()) || [];
    const indexes = {
        fixId: headers.indexOf("FIX1_ID"),
        category: headers.indexOf("CATEGORY"),
        i3qa: headers.indexOf("I3QA_CAT"),
        rv1cat: headers.indexOf("RV1_CAT"),
        afp1stat: headers.indexOf("AFP1_STAT"), 
        rv1label: headers.indexOf("RV1_LABEL"),
        i3qalabel: headers.indexOf("I3QA_LABEL")
    };

    if (indexes.fixId === -1) {
        return null;
    }

    const catCount = Array(9).fill(0);
    let additionalFixPoints = 0;
    let excessiveFixPoints = 0;
    let missFixPoints = 0;

    const matched = rows.filter(row => {
        const fields = row.split(/[\t,]/);
        return fields[indexes.fixId]?.trim().toUpperCase() === techIDValue;
    });

    matched.forEach(row => {
        const fields = row.split(/[\t,]/);
        let excludeCounts = false;
        if (indexes.rv1label !== -1 && fields[indexes.rv1label]) {
            excludeCounts = fields[indexes.rv1label].toUpperCase().includes("E");
            if (fields[indexes.rv1label].toUpperCase().includes("E")) {
                excessiveFixPoints++;
            }
            if (fields[indexes.rv1label].toUpperCase().includes("M")) {
                missFixPoints++;
            }
        }
        if (indexes.afp1stat !== -1 && fields[indexes.afp1stat] && fields[indexes.afp1stat].toUpperCase() === "AA") { // Corrected column name
            additionalFixPoints++; // Count "AA" in AFP1_STAT
        }
        if (indexes.i3qalabel !== -1 && fields[indexes.i3qalabel] && fields[indexes.i3qalabel].toUpperCase().includes("M")) {
            missFixPoints++;
        }

        if (!excludeCounts) {
            [indexes.category, indexes.i3qa, indexes.rv1cat].forEach(idx => {
                if (idx !== -1 && fields[idx]) {
                    const val = parseInt(fields[idx].trim());
                    if (!isNaN(val) && val >= 1 && val <= 9) {
                        catCount[val - 1]++;
                    }
                }
            });
        }
    });

    const multiplier = ir ? 2 : 1;
    const totalPoints = catCount.reduce((sum, count, i) => {
        const price = prices[i][size];
        return sum + (count * price * multiplier);
    }, 0).toFixed(2);

    const categoryTotals = catCount.map((count, i) => {
        return (count * prices[i][size] * multiplier).toFixed(2);
    });

    return {
        techID: techIDValue,
        totalPoints: totalPoints,
        categoryTotals: categoryTotals,
        additionalFixPoints: additionalFixPoints,
        excessiveFixPoints: excessiveFixPoints,
        missFixPoints: missFixPoints
    };
}

function calculateAllTechIDs() {
    const raw = activeProjectData?.data;
    const size = activeProjectData?.size;
    const ir = activeProjectData?.ir;

    if (!raw || !size) {
        allResultsDiv.textContent = 'Please load a project first.';
        allCalculatedResults = [];
        return;
    }

    const rows = raw.split(/\r?\n/).filter(r => r.trim() !== "");
    const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim().toUpperCase()) || [];
    const fixIdIndex = headers.indexOf("FIX1_ID");

    if (fixIdIndex === -1) {
        allResultsDiv.textContent = 'Error: FIX1_ID column not found.';
        allCalculatedResults = [];
        return;
    }

    const techIDs = new Set();
    rows.forEach(row => {
        const fields = row.split(/[\t,]/);
        const techID = fields[fixIdIndex]?.trim().toUpperCase();
        if (techID) {
            techIDs.add(techID);
        }
    });

    let allResultsHTML = '';
    allCalculatedResults = [];

    techIDs.forEach(techID => {
        const result = calculatePointsForTechID(raw, techID, size, ir);
        if (result) {
            allCalculatedResults.push(result);
            allResultsHTML += `<h6>TECH ID: ${result.techID}</h6>`;
            allResultsHTML += `<p>Total Points: ${result.totalPoints}</p><p>Category Totals:</p><ul>`;
            result.categoryTotals.forEach((total, i) => {
                allResultsHTML += `<li>CAT ${i + 1}: Total: ${total}</li>`;
            });
            allResultsHTML += '</ul>';
            allResultsHTML += `<p>Additional FixPoints: ${result.additionalFixPoints}</p>`;
            allResultsHTML += `<p>Excessive FixPoints: ${result.excessiveFixPoints}</p>`;
            allResultsHTML += `<p>Miss FixPoints: ${result.missFixPoints}</p><hr>`;
        }
    });

    allResultsDiv.innerHTML = allResultsHTML;
}

function searchTechID() {
    const raw = activeProjectData?.data;
    const techIDValue = techIdInput.value.trim().toUpperCase();
    const size = activeProjectData?.size;
    const ir = activeProjectData?.ir;

    if (!raw || !techIDValue || !size) {
        output.textContent = 'Please load a project and enter a TECH ID to search.';
        lastResult = '';
        return;
    }

    const rows = raw.split(/\r?\n/).filter(r => r.trim() !== "");
    const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim().toUpperCase()) || [];
    const indexes = {
        fixId: headers.indexOf("FIX1_ID"),
        category: headers.indexOf("CATEGORY"),
        i3qa: headers.indexOf("I3QA_CAT"),
        rv1cat: headers.indexOf("RV1_CAT"),
        afp1stat: headers.indexOf("AFP1_STAT"), // Corrected column name
        rv1label: headers.indexOf("RV1_LABEL"),
        i3qalabel: headers.indexOf("I3QA_LABEL")
    };

    if (indexes.fixId === -1) {
        output.textContent = 'FIX1_ID column not found.';
        lastResult = '';
        return;
    }

    const catCount = Array(9).fill(0);
    let additionalFixPoints = 0;
    let excessiveFixPoints = 0;
    let missFixPoints = 0;

    const matched = rows.filter(row => {
        const fields = row.split(/[\t,]/);
        return fields[indexes.fixId]?.trim().toUpperCase() === techIDValue;
    });

    const multiplier = ir ? 2 : 1;
    let totalPoints = 0;
    const categoryTotals = Array(9).fill(0);

    matched.forEach(row => {
        const fields = row.split(/[\t,]/);
        let excludeCounts = false;
        if (indexes.rv1label !== -1 && fields[indexes.rv1label]) {
            excludeCounts = fields[indexes.rv1label].toUpperCase().includes("E");
            if (fields[indexes.rv1label].toUpperCase().includes("E")) {
                excessiveFixPoints++;
            }
            if (fields[indexes.rv1label].toUpperCase().includes("M")) {
                missFixPoints++;
            }
        }
        if (indexes.afp1stat !== -1 && fields[indexes.afp1stat] && fields[indexes.afp1stat].toUpperCase() === "AA") { // Corrected column name
            additionalFixPoints++; // Count "AA" in AFP1_STAT
        }
        if (indexes.i3qalabel !== -1 && fields[indexes.i3qalabel] && fields[indexes.i3qalabel].toUpperCase().includes("M")) {
            missFixPoints++;
        }

        if (!excludeCounts) {
            [indexes.category, indexes.i3qa, indexes.rv1cat].forEach(idx => {
                if (idx !== -1 && fields[idx]) {
                    const val = parseInt(fields[idx].trim());
                    if (!isNaN(val) && val >= 1 && val <= 9) {
                        const price = prices[val - 1][size];
                        totalPoints += price * multiplier;
                        categoryTotals[val - 1] += price * multiplier;
                    }
                }
            });
        }
    });

    output.textContent = `TECH ID: ${techIDValue}\nTotal Points: ${totalPoints.toFixed(2)}\nCategory Totals:\n${categoryTotals.map((total, i) => `CAT ${i + 1}: Total: ${total.toFixed(2)}`).join('\n')}\nAdditional FixPoints: ${additionalFixPoints}\nExcessive FixPoints: ${excessiveFixPoints}\nMiss FixPoints: ${missFixPoints}`;
    lastResult = {
        techID: techIDValue,
        totalPoints: totalPoints.toFixed(2),
        categoryTotals: categoryTotals.map(t => t.toFixed(2)),
        additionalFixPoints: additionalFixPoints,
        excessiveFixPoints: excessiveFixPoints,
        missFixPoints: missFixPoints
    };
}

function exportCSV() {
    if (allCalculatedResults.length > 0) {
        // Export all calculated results
        const header = ['TECH ID', 'Total Points', ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Total`), 'Additional FixPoints', 'Excessive FixPoints', 'Miss FixPoints'];
        const rows = allCalculatedResults.map(res => [res.techID, res.totalPoints, ...res.categoryTotals, res.additionalFixPoints, res.excessiveFixPoints, res.missFixPoints]);
        const csvContent = [header, ...rows].map(r => r.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `all_tech_id_summary.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else if (lastResult.techID) {
        // Export single search result (fallback if "Calculate All" hasn't been run)
        const rows = [
            ['TECH ID', 'Total Points'],
            [lastResult.techID, lastResult.totalPoints],
            [],
            ['Category', 'Total'],
            ...lastResult.categoryTotals.map((total, i) => [`CAT ${i + 1}`, total]),
            [],
            ['Additional FixPoints', lastResult.additionalFixPoints],
            ['Excessive FixPoints', lastResult.excessiveFixPoints],
            ['Miss FixPoints', lastResult.missFixPoints]
        ];
        const csvContent = rows.map(r => r.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `summary_${lastResult.techID}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        M.toast({ html: 'Please run "Calculate All" or a single search first.', classes: 'red' });
    }
}

      document.getElementById('save-project').addEventListener('click', saveProject);
      document.getElementById('delete-project').addEventListener('click', deleteSelectedProject);
      document.getElementById('search-button').addEventListener('click', searchTechID);
      document.getElementById('calculate-all-button').addEventListener('click', calculateAllTechIDs);
      document.getElementById('export-button').addEventListener('click', exportCSV);

      projectSelector.addEventListener('change', function () {
        const selected = this.value;
        const project = localStorage.getItem(`tl_project_${selected}`);
        if (project) {
          activeProjectData = JSON.parse(project);
          output.textContent = '';
          allResultsDiv.innerHTML = '';
          allCalculatedResults = []; // Clear calculated results on project load
          lastResult = ''; // Clear last single search result
          M.updateTextFields();
        }
      });

      M.FormSelect.init(document.querySelectorAll('select'));
      M.Modal.init(document.querySelectorAll('.modal'));
      M.updateTextFields();
      loadProjectList();
    });
  </script>
</body>
</html>
